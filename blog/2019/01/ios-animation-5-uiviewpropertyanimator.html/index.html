<!DOCTYPE html>
<html
  lang="zh-cn"
  itemscope
  itemtype="http://schema.org/WebPage"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
          系统学习iOS动画之五：使用UIViewPropertyAnimator - 欣欣向戎
        </title>
    

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="andyron" />
  <meta name="description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati" />

  <meta name="keywords" content="linux, Go, Java, PHP, program, journal, andyron, 博客, 笔记" />






<meta name="generator" content="Hugo 0.128.2" />


<link rel="canonical" href="http://localhost:1313/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.d8d87b982993a745e5e7b6a6cbf257be8c3e82aab5e485f0908ad7e6c3501ab2.css" integrity="sha256-2Nh7mCmTp0Xl57amy/JXvow&#43;gqq15IXwkIrX5sNQGrI=" media="screen" crossorigin="anonymous">






<link rel="stylesheet" href="/css/custom.css">


<meta property="og:url" content="http://localhost:1313/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/">
  <meta property="og:site_name" content="欣欣向戎">
  <meta property="og:title" content="系统学习iOS动画之五：使用UIViewPropertyAnimator">
  <meta property="og:description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2019-01-13T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-07-16T10:03:07+08:00">
    <meta property="article:tag" content="IOS动画">
    <meta property="article:tag" content="UIViewPropertyAnimator">

  <meta itemprop="name" content="系统学习iOS动画之五：使用UIViewPropertyAnimator">
  <meta itemprop="description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati">
  <meta itemprop="datePublished" content="2019-01-13T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-07-16T10:03:07+08:00">
  <meta itemprop="wordCount" content="16635">
  <meta itemprop="keywords" content="IOS动画,UIViewPropertyAnimator">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="系统学习iOS动画之五：使用UIViewPropertyAnimator">
  <meta name="twitter:description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  </head>
  <body>
    <div id="back-to-top"></div>

    <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">欣欣向戎</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/blog/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/index.xml">订阅</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


    
      






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    

    
      
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '002186711602136249422:q1gkomof_em';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

    

    


    <header id="header" class="header">
      <div class="logo-wrapper">
  <a href="/" class="logo">
    
      欣欣向戎
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/blog/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/index.xml">订阅</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

    </header>

    <div id="mobile-panel">
      <main id="main" class="main bg-llight wallpaper">
        <div class="content-wrapper">
    <div id="content" class="content">
      <article class="post">
        
        <header class="post-header">
          <h1 class="post-title">系统学习iOS动画之五：使用UIViewPropertyAnimator</h1>
          

          <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          andyron
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2019-01-13">
      2019-01-13
    </time>
  </div>

  
    <div class="post-meta-lastmod">
      (上次更新:
      2024-07-16)
    </div>
  


  <div class="post-meta__right">
    

    <div class="post-meta-category">
        <a href="http://localhost:1313/categories/ios-animation/"> iOS-Animation </a>
          
      </div>


    
    


    
    
  </div>
</div>

        </header>

        
        <div class="post-content">
          <blockquote>
<p>本文是我学习<a href="https://store.raywenderlich.com/products/ios-animations-by-tutorials">《iOS Animations by Tutorials》</a> 笔记中的一篇。<br>
文中详细代码都放在我的Github上 <a href="https://github.com/andyRon/LearniOSAnimations/tree/master/iOS_Animations_by_Tutorials">andyRon/LearniOSAnimations</a>。</p>
</blockquote>
<p><code>UIViewPropertyAnimator</code>是从iOS10开始引入，它能够创建易于交互，可中断和/或可逆的视图动画。</p>
<p>这个类让某些类型的视图动画更容易创建，值得学习。</p>
<p><code>UIViewPropertyAnimator</code>可以在同一个类中方便地将许多API包装在一起，这样更容易使用。</p>
<p>此外，这个新类不能完全取代了<code>UIView.animate(withDuration...)</code>API集。</p>
<p><strong>内容预览：</strong></p>
<p><a href="/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/#20-UIViewPropertyAnimator入门">20-UIViewPropertyAnimator入门</a></p>
<p><a href="/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/#21-深入UIViewPropertyAnimator">21-深入UIViewPropertyAnimator</a></p>
<p><a href="/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/#22-用UIViewPropertyAnimator进行交互式动画">22-用UIViewPropertyAnimator进行交互式动画</a></p>
<p><a href="/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/#23-用UIViewPropertyAnimator自定义视图控制器转场">23-用UIViewPropertyAnimator自定义视图控制器转场</a></p>
<blockquote>
<p>本文的四个章节都是使用同一个项目 <strong>LockSearch</strong></p>
</blockquote>
<!-- raw HTML omitted -->
<h2 id="20-uiviewpropertyanimator入门">20-UIViewPropertyAnimator入门</h2>
<p>在iOS10之前，创建基于视图的动画的唯一选择是<code>UIView.animate(withDuration: ...)</code>I，但这组API没有为开发人员提供暂停或停止已经运行的动画的处理方式。此外，对于反转，加速或减慢动画，开发人员只能使用基于图层的<code>CAAnimation</code>（核心动画）。</p>
<p><code>UIViewPropertyAnimator</code>就是为了解决上述问题而出现的，它是一个允许保持运行动画的类，允许开发者调整当前运行的动画，并提供有关动画当前状态的详细信息。</p>
<p>当然，简单单一的视图动画直接使用<code>UIView.animate(withDuration: ...)</code>就可以了。</p>
<h3 id="基础动画">基础动画</h3>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> <strong>LockSearch</strong> 。 类似于iOS锁屏时的屏幕。 初始视图控制器有搜索栏，单个窗口小部件和编辑按钮等：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxukdn545vj31c00u0gy0.jpg"></p>
<p><a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> 已经实现了一些与动画无关的功能。 例如，如果点击<strong>Show More</strong>按钮，窗口小部件将展开并显示更多项目。 如果点击编辑，会转到另一个视图控制器，这是一个简单的TableView。</p>
<p>当然，该项目只是模拟iOS中的锁定屏幕，用来学习动画，没有实际的功能，。</p>
<p>打开<code>LockScreenViewController.swift</code>并向该视图控制器添加一个新的<code>viewWillAppear(_:)</code>方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">viewWillAppear</span>(<span style="color:#007020;font-weight:bold">_</span> animated: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    tableView.transform = CGAffineTransform(scaleX: <span style="color:#40a070">0.67</span>, y: <span style="color:#40a070">0.67</span>)
</span></span><span style="display:flex;"><span>    tableView.alpha = <span style="color:#40a070">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了创建简单的缩放和淡入淡出视图动画，首先缩小整个表视图并使其透明。</p>
<p>接下来，在视图控制器的视图出现在屏幕上时创建一个动画师。 将以下内容添加到<code>LockScreenViewController</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">viewDidAppear</span>(<span style="color:#007020;font-weight:bold">_</span> animated: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scale</span> = UIViewPropertyAnimator.<span style="color:#007020;font-weight:bold">init</span>(duration: <span style="color:#40a070">0.33</span>, curve: .easeIn) {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里，您使用<code>UIViewPropertyAnimator</code>的一个<a href="http://andyron.com/2017/swift-14-initialization.html#5-%E7%B1%BB%E7%9A%84%E7%BB%A7%E6%89%BF%E5%92%8C%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B">便利构造器</a>：<code>UIViewPropertyAnimator.init(duration:curve:animations:)</code>。</p>
<p>通过构造器创建动画实例并设置动画的总持续时间和时间曲线。 后一个参数的类型为<code>UIViewAnimationCurve</code>，这是一个枚举类型，有四个类型：<code>easeInOut</code>、<code>easeIn</code>、<code>easeOut</code>、<code>linear</code>。这与<code>UIView.animate(withDuration:...)</code>中的<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#%E5%8A%A8%E7%94%BB%E7%BC%93%E5%8A%A8"><code>option</code></a>是类似的。</p>
<h4 id="添加动画">添加动画</h4>
<p>在<code>viewDidAppear(_:)</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>scale.addAnimations {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.tableView.alpha = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用<code>addAnimations</code>添加动画代码块，就像<code>UIView.animate(withDuration...)</code>的闭包参数<code>animations</code>。 使用动画师的不同之处在于可以添加多个动画块。</p>
<p>除了能够有条件地构建复杂的动画外，还可以添加具有不同延迟的动画。 另一个版本的<code>addAnimations</code>，有两个参数：
<code>animation</code>  动画代码
<code>delayFactor</code>  动画开始前的延迟</p>
<p><code>delayFactor</code>与<code>UIView.animate(withDuration...)</code>中<code>delay</code>不同，它介于0.0到1.0，不是绝对时间是相对时间。</p>
<p>在同一个动画师添加第二个动画，但有一些延迟。继续在上面的代码后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>scale.addAnimations({
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.tableView.transform = .identity
</span></span><span style="display:flex;"><span>}, delayFactor: <span style="color:#40a070">0.33</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>实际延迟时间是<code>delayFactor</code>乘以动画师的剩余持续时间(remaining duration)。 目前尚未启动动画，因此剩余持续时间等于总持续时间。
所以在上面的情况：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>delayFactor(<span style="color:#40a070">0.33</span>) <span style="color:#666">*</span> remainingDuration(=duration <span style="color:#40a070">0.33</span>) = delay of <span style="color:#40a070">0.11</span> seconds
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>为什么第二个参数不是一个简单的秒数值？</strong>
想象动画师已经在运行了，你决定在中途添加一些新的动画。 在这种情况下，剩余持续时间不会等于总持续时间，因为自启动动画以来已经过了一段时间。</p>
<p><img alt="image-20181204120317868" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxuky4tem3j30e2055q37.jpg"></p>
<p>在这种情况下，<code>delayFactor</code>将允许开发者根据剩余可用时间设置延迟动画。 此外，这样设计也确保了不能将延迟设置为长于剩余运行时间。</p>
<p><img alt="image-20181204120335113" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxukyfk6x4j30co054glu.jpg"></p>
<h4 id="添加完成闭包">添加完成闭包</h4>
<p>在<code>viewDidAppear(_:)</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>scale.addCompletion { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#4070a0">&#34;ready&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>addCompletion(_:)</code>就是动画完成闭包，当然，它也可多次调用，来完成多了处理程序。</p>
<p>下面要启动动画，在<code>viewWillAppear(_:)</code>的末尾添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>scale.startAnimation()
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="提取动画">提取动画</h3>
<p>为了代码的清晰，可以把动画代码集中放到一个类中。</p>
<p>创建一个名为<code>AnimatorFactory.swift</code>的新文件，并将其默认内容替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">UIKit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">AnimatorFactory</span> {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后添加一个类型方法，其中包含刚刚编写的动画代码，但默认情况下不运行动画，而是返回动画师：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">scaleUp</span>(view: UIView) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scale</span> = UIViewPropertyAnimator(duration: <span style="color:#40a070">0.33</span>, curve: .easeIn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    scale.addAnimations {
</span></span><span style="display:flex;"><span>        view.alpha = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    scale.addAnimations({
</span></span><span style="display:flex;"><span>        view.transform = .identity
</span></span><span style="display:flex;"><span>    }, delayFactor: <span style="color:#40a070">0.33</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    scale.addCompletion { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>                         print(<span style="color:#4070a0">&#34;ready&#34;</span>)
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> scale
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>该方法将视图作为参数，并在该视图上创建所有动画，最后它返回准备好的动画师。</p>
<p>将<code>LockScreenViewController</code>中的<code>viewDidAppear(_:)</code>替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">viewDidAppear</span>(<span style="color:#007020;font-weight:bold">_</span> animated: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    AnimatorFactory.scaleUp(view: tableView).startAnimation()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样看上去代码更加简洁，清晰，把动画代码从视图控制器移出。</p>
<p>这个动画师工厂🏭类<code>AnimatorFactory</code>集中处理动画代码，这是设计模式中的工厂模式的一个简单应用。😀</p>
<h3 id="运行动画师">运行动画师</h3>
<p>当用户使用搜索栏时，将淡入模糊图层（blurView），并在用户完成搜索时将其淡出。</p>
<p>向<code>LockScreenViewController</code>类添加一个新方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">toggleBlur</span>(<span style="color:#007020;font-weight:bold">_</span> blurred: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    UIViewPropertyAnimator.runningPropertyAnimator(withDuration: <span style="color:#40a070">0.5</span>, delay: <span style="color:#40a070">0.1</span>, options: .curveEaseOut, animations: {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.blurView.alpha = blurred ? <span style="color:#40a070">1</span> : <span style="color:#40a070">0</span>
</span></span><span style="display:flex;"><span>    }, completion: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>UIViewPropertyAnimator.runningPropertyAnimator(withDuration:...)</code>与<code>UIView.animate(withDuration:...)</code>有完全相同的参数，使用也相同。</p>
<p>虽然看起来这可能是一种**“即发即忘”**(“fire-and-forget” )的API，但请注意它确实会返回一个动画实例。 因此，您可以添加更多动画，更多完成块，并且通常与当前正在运行的动画进行交互。</p>
<p>现在让我们看看淡入淡出动画的样子。 LockScreenViewController已设置为搜索栏的委托，因此您只需实现所需的方法即可在正确的时间触发动画。</p>
<p>以扩展的方式为<code>LockScreenViewController</code>遵守搜索栏的代理协议：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">extension</span> <span style="color:#0e84b5;font-weight:bold">LockScreenViewController</span>: UISearchBarDelegate {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">searchBarTextDidBeginEditing</span>(<span style="color:#007020;font-weight:bold">_</span> searchBar: UISearchBar) {
</span></span><span style="display:flex;"><span>    toggleBlur(<span style="color:#007020;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">searchBarTextDidEndEditing</span>(<span style="color:#007020;font-weight:bold">_</span> searchBar: UISearchBar) {
</span></span><span style="display:flex;"><span>    toggleBlur(<span style="color:#007020;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>要为用户提供取消搜索的功能，还要添加以下两种方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">searchBarResultsListButtonClicked</span>(<span style="color:#007020;font-weight:bold">_</span> searchBar: UISearchBar) {
</span></span><span style="display:flex;"><span>    searchBar.resignFirstResponder()
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">searchBar</span>(<span style="color:#007020;font-weight:bold">_</span> searchBar: UISearchBar, textDidChange searchText: <span style="color:#007020">String</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> searchText.isEmpty{
</span></span><span style="display:flex;"><span>      searchBar.resignFirstResponder()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>这将允许用户通过点击右侧按钮解除搜索。</p>
<p>运行，效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxulof5jzqg308q09lwov.gif"></p>
<p>点按搜索栏文本字段，小部件在模糊效果视图下消失；点击搜索栏右侧的按钮时，模糊视图会淡出。</p>
<h3 id="基础关键帧动画">基础关键帧动画</h3>
<p><code>UIViewPropertyAnimator</code>也可以使用<code>UIView.addKeyframe</code>(<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#5-%E5%85%B3%E9%94%AE%E5%B8%A7%E5%8A%A8%E7%94%BB">5-视图的关键帧动画</a>)。下面创建一个简单的图标抖动动画来展示。</p>
<p>在<code>AnimatorFactory</code>中添加类型方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">jiggle</span>(view: UIView) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> UIViewPropertyAnimator.runningPropertyAnimator(withDuration: <span style="color:#40a070">0.33</span>, delay: <span style="color:#40a070">0</span>
</span></span><span style="display:flex;"><span>      , animations: {
</span></span><span style="display:flex;"><span>        UIView.addKeyframe(withRelativeStartTime: <span style="color:#40a070">0.0</span>, relativeDuration: <span style="color:#40a070">0.25</span>, animations: {
</span></span><span style="display:flex;"><span>          view.transform = CGAffineTransform(rotationAngle: <span style="color:#666">-</span>.pi<span style="color:#666">/</span><span style="color:#40a070">8</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        UIView.addKeyframe(withRelativeStartTime: <span style="color:#40a070">0.25</span>, relativeDuration: <span style="color:#40a070">0.75</span>, animations: {
</span></span><span style="display:flex;"><span>          view.transform = CGAffineTransform(rotationAngle: <span style="color:#666">+</span>.pi<span style="color:#666">/</span><span style="color:#40a070">8</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        UIView.addKeyframe(withRelativeStartTime: <span style="color:#40a070">0.75</span>, relativeDuration: <span style="color:#40a070">1.0</span>, animations: {
</span></span><span style="display:flex;"><span>          view.transform = CGAffineTransform.identity
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }, completion: { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一个关键帧向左旋转，第二个关键帧向右旋转，最后第三个关键帧回到原点 。</p>
<p>要确保图标保持在其初始位置，在完成闭包中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-14-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>view.transform = .identity
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面就可以在想要运行这个动画的视图上添加动画了。</p>
<p>打开<code>IconCell.swift</code>（该文件位于Widget子文件夹中）。这是自定义单元类，对应于窗口小部件视图中的每个图标。
在<code>IconCell</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">iconJiggle</span>() {
</span></span><span style="display:flex;"><span>    AnimatorFactory.jiggle(view: icon)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在<strong>Xcode</strong>抱怨<code>AnimatorFactory.jiggle</code>方法返回一个结果没有被使用，这是Xcode善意的提醒😊。</p>
<p><img alt="image-20181204124154609" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxum2bblu4j31gy032t98.jpg"></p>
<p>这个问题很容易解决，只需要在<code>jiggle</code>方法前添加<code>@discardableResult</code>，让Xcode知道这个方法的结果我不要了😏。</p>
<blockquote>
<p><code>discardableResult</code>的<a href="https://docs.swift.org/swift-book/ReferenceManual/Attributes.html">官方解释</a>：</p>
<p>Apply this attribute to a function or method declaration to suppress the compiler warning when the function or method that returns a value is called without using its result.</p>
</blockquote>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  @discardableResult
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">jiggle</span>(view: UIView) -&gt; UIViewPropertyAnimator {
</span></span></code></pre></td></tr></table>
</div>
</div><p>要最终运行动画，在<code>WidgetView.swift</code> 的<code>collectionView(_:didSelectItemAt:)</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">cell</span> = collectionView.cellForItem(at: indexPath) <span style="color:#007020;font-weight:bold">as</span>? IconCell {
</span></span><span style="display:flex;"><span>    cell.iconJiggle()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxumdsesopg308q06075c.gif"></p>
<h3 id="提取模糊动画">提取模糊动画</h3>
<p>把前面的模糊动画也提取到<code>AnimatorFactory</code>中。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>@discardableResult
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">fade</span>(view: UIView, visible: <span style="color:#007020">Bool</span>) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> UIViewPropertyAnimator.runningPropertyAnimator(withDuration: <span style="color:#40a070">0.5</span>, delay: <span style="color:#40a070">0.1</span>, options: .curveEaseOut, animations: {
</span></span><span style="display:flex;"><span>        view.alpha = visible ? <span style="color:#40a070">1.0</span> : <span style="color:#40a070">0.0</span>
</span></span><span style="display:flex;"><span>    }, completion: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>替代<code>LockScreenViewController</code>中的<code>toggleBlur（_:）</code>方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">toggleBlur</span>(<span style="color:#007020;font-weight:bold">_</span> blurred: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    AnimatorFactory.fade(view: blurView, visible: blurred)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="防止动画重叠">防止动画重叠</h3>
<p><strong>如何检查动画师当前是否正在执行其动画？</strong></p>
<p>如果在同一个图标上快速连续点击，会发现抖动动画没有结束就重新开始了。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxumve35v2g308k06076o.gif"></p>
<p>解决这个问题，就需要检测视图是否有动画正在运行。</p>
<p>为<code>IconCell</code>添加一个属性，并修改<code>iconJiggle()</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">animator</span>: UIViewPropertyAnimator?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">iconJiggle</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animator</span> = animator, animator.isRunning {
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    animator = AnimatorFactory.jiggle(view: icon)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>对比可以发现有所不同：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxumwxwqd0g308k0600uv.gif"></p>
<h2 id="21-深入uiviewpropertyanimator">21-深入UIViewPropertyAnimator</h2>
<p>上一章节学习了<code>UIViewPropertyAnimator</code>的基本使用，这一章节学习更多关于<code>UIViewPropertyAnimator</code>的知识。</p>
<blockquote>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> 使用上一章节完成的项目。</p>
</blockquote>
<h3 id="自定义动画计时">自定义动画计时</h3>
<p>前文已经多次提到：<code>easeInOut</code>、<code>easeIn</code>、<code>easeOut</code>、<code>linear</code>（可以理解为物体运动轨迹的曲线类型）。可以参考<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#%E5%8A%A8%E7%94%BB%E7%BC%93%E5%8A%A8">视图动画中的动画缓动</a> 或者<a href="http://andyron.com/2018/iOS-Animation-3-Layer-Animations#%E5%8A%A8%E7%94%BB%E7%BC%93%E5%8A%A8">图层动画中的动画缓动</a>，这边就不再介绍了。</p>
<h4 id="内置时间曲线">内置时间曲线</h4>
<p>目前，当您激活搜索栏时，您会在窗口小部件顶部的模糊视图中淡入淡出。 在此示例中，您将删除该淡入淡出动画并为模糊效果本身设置动画。</p>
<p>之前，激活搜索栏时，就会有一个模糊视图中淡入淡出效果。这个部分删除这个效果，修改成对模糊效果本身设置动画。什么意思呢？ 看完下面的操作，应该能明白。</p>
<p>向<code>LockScreenViewController</code>类添加一个新方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">blurAnimations</span>(<span style="color:#007020;font-weight:bold">_</span> blured: <span style="color:#007020">Bool</span>) -&gt; () -&gt; <span style="color:#007020">Void</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> {   
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">self</span>.blurView.effect = blured ? UIBlurEffect(style: .dark) : <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.tableView.transform = blured ? CGAffineTransform(scaleX: <span style="color:#40a070">0.75</span>, y: <span style="color:#40a070">0.75</span>) : .identity
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.tableView.alpha = blured ? <span style="color:#40a070">0.33</span> : <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除<code>viewDidLoad()</code>中的两行代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>    blurView.alpha = <span style="color:#40a070">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>替代<code>toggleBlur(_:)</code>内容为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">toggleBlur</span>(<span style="color:#007020;font-weight:bold">_</span> blurred: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    UIViewPropertyAnimator(duration: <span style="color:#40a070">0.55</span>, curve: .easeOut, animations: blurAnimations(blurred)).startAnimation()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxur7gcxngg308k09u11x.gif"></p>
<p>请注意模糊不仅仅是淡入或淡出，实际上它会在效果视图中插入模糊量。</p>
<h4 id="贝塞尔曲线">贝塞尔曲线</h4>
<p>有时想要对动画的时间非常具体时，使用这些曲线简单地“开始减速”或“慢慢结束”是不够的。</p>
<p>在<a href="http://andyron.com/2018/iOS-Animation-3-Layer-Animations#10-%E5%8A%A8%E7%94%BB%E7%BB%84%E5%92%8C%E6%97%B6%E9%97%B4%E6%8E%A7%E5%88%B6">10-动画组和时间控制</a> 中学习了使用<code>CAMediaTimingFunction</code>控制图层动画的时间。</p>
<p>之前没有了解背后的原理<strong>贝塞尔曲线</strong>，这边介绍一下它。这边的内容也可应用到图层动画中。</p>
<p><strong>贝塞尔曲线是什么？</strong></p>
<p>让我们从简单的事情开始 —— 一条线。它非常简洁，需要在屏幕上画一条线，只需要定义它的两个点的坐标，开始 <em>(A)</em> 和结束 <em>(B)</em>：</p>
<p><img alt="image-20181204154619268" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxure6zmgcj309q036aa0.jpg"></p>
<p>现在让我们来看看曲线。曲线比线条更有趣，因为它们可以在屏幕上绘制任何东西。例如：</p>
<p><img alt="image-20181204154744302" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxurfnsi7zj30c706cq37.jpg"></p>
<p>在上面看到的是四条曲线放在一起;它们的两端在小白方块的地方相遇。图中有趣的是小绿圈，它们定义了每条曲线。</p>
<p>所以曲线不是随机的。它们也有一些细节，就像线条一样，可以帮助我们通过坐标定义它们。</p>
<p>您可以通过向线条添加控制点来定义曲线。 让我们在之前的行中添加一个控制点：</p>
<p><img alt="image-20181204154909038" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxurh4vhhdj30aw052gly.jpg"></p>
<p>可以想象由连接到线的铅笔绘制的曲线，其起点沿着线AC移动，其终点沿着线CB移动：</p>
<p><img alt="image-20181204154949279" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxurhti255j30fu03ljrn.jpg"></p>
<p>网上找了一个动图：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fyayz6r66pg30a0046tax.gif"></p>
<p>具有一个控制点的Bézier曲线称为 <em>二次曲线</em>。有两个控制点的Bézier曲线叫做 <em>三次曲线</em>（立方贝塞尔曲线）。
我们使用的内置曲线就是三次曲线。</p>
<p>核心动画使用始终以坐标（0,0）开始的三次曲线，它表示动画持续时间的开始。 当然，这些时间曲线的终点始终是（1,1），表示 动画的持续时间和进度的结束。</p>
<p>让我们来看看 <em>ease-in</em> 曲线：</p>
<p><img alt="image-20181204155458179" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxurn6i2vqj309107kdg7.jpg"></p>
<p>随着时间的推移（在坐标空间中从左向右水平移动），曲线在垂直轴上的进展非常小，然后大约在动画持续时间的一半时间后，曲线在垂直轴上的进展非常大，最终在(1, 1)处结束。</p>
<p><em>ease-out</em> 和 <em>ease-in-out</em>曲线分别是：</p>
<p><img alt="image-20181204155513973" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxurngb6dwj30f306tt9l.jpg"></p>
<p>现在已了解Bézier曲线的工作原理，剩下的问题是如何在视觉上设计一些曲线并获得控制点的坐标，方便可以将它们用于iOS动画。</p>
<p>可以使用网站：http://cubic-bezier.com。 这是计算机科学研究员和演讲者Lea Verou的非常方便的网站。 它可以拖动立方Bézier的两个控制点并查看即时动画预览，非常nice😊😊。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxurmuxor9j31br0i5n0t.jpg"></p>
<blockquote>
<p>上面贝塞尔的原理说的不够深刻🤦‍♀️，现在只需了解曲线，通过两个控制点可以画曲线。</p>
</blockquote>
<p>接下来，向项目中添加自定义计时动画。</p>
<p>把<code>LockScreenViewController</code>中的<code>toggleBlur()</code>的现有动画替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">toggleBlur</span>(<span style="color:#007020;font-weight:bold">_</span> blurred: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    UIViewPropertyAnimator(duration: <span style="color:#40a070">0.55</span>, controlPoint1: CGPoint(x: <span style="color:#40a070">0.57</span>, y: <span style="color:#666">-</span><span style="color:#40a070">0.4</span>), controlPoint2: CGPoint(x: <span style="color:#40a070">0.96</span>, y: <span style="color:#40a070">0.87</span>), animations: blurAnimations(blurred)).startAnimation()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这边的<code>controlPoint1</code> 和<code>controlPoint2</code>两个点，就是我们自定义三次曲线的控制点。</p>
<p>可以通过 <a href="http://cubic-bezier.com">http://cubic-bezier.com</a> 网站来选着控制点。</p>
<h4 id="弹簧动画">弹簧动画</h4>
<p>另一个便利构造器<code>UIViewPropertyAnimator(duration:dampingRatio:animations:)</code>，用于定义弹簧动画。</p>
<p>这与<code>UIView.animate(withDuration: delay: usingSpringWithDamping: initialSpringVelocity: options: animations: completion:) </code>类似，只不过初始速度为0。</p>
<h4 id="自定义时间曲线">自定义时间曲线</h4>
<p><code>UIViewPropertyAnimator</code>类还有一个构造器<code>UIViewPropertyAnimator(duration:timingParameters:)</code>。</p>
<p>参数<code>timingParameters</code>必须遵守<code>UITimingCurveProvider</code>协议，有两个类可供我们使用：<a href="https://developer.apple.com/documentation/uikit/uicubictimingparameters"><code>UICubicTimingParameters</code></a>和<a href="https://developer.apple.com/documentation/uikit/uispringtimingparameters"><code>UISpringTimingParameters</code></a>。</p>
<p>下面看看这个构造器的使用方式。</p>
<h4 id="阻尼和速度">阻尼和速度</h4>
<p>添加阻尼和速度的方式如下：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">spring</span> = UISpringTimingParameters(dampingRatio:<span style="color:#40a070">0.5</span>, initialVelocity: CGVector(dx: <span style="color:#40a070">1.0</span>, dy: <span style="color:#40a070">0.2</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animator</span> = UIViewPropertyAnimator(duration: <span style="color:#40a070">1.0</span>, timingParameters: spring)
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意初始速度<code>initialVelocity</code>是<strong>矢量类型</strong>，这个参数是一个可选参数。</p>
<h4 id="自定义弹簧动画">自定义弹簧动画</h4>
<p>如果想对弹簧动画更加具体的设置，可以<code>UISpringTimingParameters</code>的另一个构造器<code>init(mass:stiffness:damping:initialVelocity:)</code>，代码如下：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">spring</span> = UISpringTimingParameters(mass: <span style="color:#40a070">10.0</span>, stiffness: <span style="color:#40a070">5.0</span>, damping: <span style="color:#40a070">30</span>, initialVelocity: CGVector(dx: <span style="color:#40a070">1.0</span>, dy: <span style="color:#40a070">0.2</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animator</span> = UIViewPropertyAnimator(duration: <span style="color:#40a070">1.0</span>, timingParameters: spring) 
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面这些参数的工作原理，可以查看之前的文章<a href="http://andyron.com/2018/iOS-Animation-3-Layer-Animations#11-%E5%9B%BE%E5%B1%82%E5%BC%B9%E7%B0%A7%E5%8A%A8%E7%94%BB">11-图层弹簧动画</a>。</p>
<h3 id="自动布局动画">自动布局动画</h3>
<p>前面的文章<a href="http://andyron.com/2018/iOS-Animation-2-Auto-Layout">系统学习iOS动画之二：自动布局动画</a> 学习了自动布局动画。</p>
<p>使用<code>UIViewPropertyAnimator</code>的布局约束动画与使用<code>UIView.animate(withDuration: ...)</code>创建它们的方式非常相似。 诀窍是更新约束，在动画块中调用<code>layoutIfNeeded()</code>。</p>
<p>在<code>AnimatorFactory</code>中添加一个新的工厂方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>@discardableResult
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animateConstraint</span>(view: UIView, constraint: NSLayoutConstraint, by: CGFloat) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">spring</span> = UISpringTimingParameters(dampingRatio: <span style="color:#40a070">0.55</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animator</span> = UIViewPropertyAnimator(duration: <span style="color:#40a070">1.0</span>, timingParameters: spring)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    animator.addAnimations {
</span></span><span style="display:flex;"><span>        constraint.constant <span style="color:#666">+=</span> by
</span></span><span style="display:flex;"><span>        view.layoutIfNeeded()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> animator
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>LockScreenViewController</code>中<code>viewWillAppear</code>里添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>dateTopConstraint.constant <span style="color:#666">-=</span> <span style="color:#40a070">100</span>
</span></span><span style="display:flex;"><span>view.layoutIfNeeded()
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>viewDidAppear</code>里添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>AnimatorFactory.animateConstraint(view: view, constraint: dateTopConstraint, by: <span style="color:#40a070">150</span>).startAnimation()
</span></span></code></pre></td></tr></table>
</div>
</div><p>这让时间标签的位置，在应用打开时有一个动画。</p>
<p>接下来，在添加一个约束动画。当点击“Show more”时，窗口小部件会加载内容，并需要更改其高度约束。</p>
<p>重新定义<code>WidgetCell.swift</code>中的<code>toggleShowMore(_:)</code>方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">@IBAction</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">toggleShowMore</span>(<span style="color:#007020;font-weight:bold">_</span> sender: UIButton) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.showsMore = <span style="color:#666">!</span><span style="color:#007020;font-weight:bold">self</span>.showsMore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animations</span> = {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.widgetHeight.constant = <span style="color:#007020;font-weight:bold">self</span>.showsMore ? <span style="color:#40a070">230</span> : <span style="color:#40a070">130</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tableView</span> = <span style="color:#007020;font-weight:bold">self</span>.tableView {
</span></span><span style="display:flex;"><span>            tableView.beginUpdates()
</span></span><span style="display:flex;"><span>            tableView.endUpdates()
</span></span><span style="display:flex;"><span>            tableView.layoutIfNeeded()
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">spring</span> = UISpringTimingParameters(mass: <span style="color:#40a070">30</span>, stiffness: <span style="color:#40a070">10</span>, damping: <span style="color:#40a070">300</span>, initialVelocity: CGVector(dx: <span style="color:#40a070">5</span>, dy: <span style="color:#40a070">0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    toggleHeightAnimator = UIViewPropertyAnimator(duration: <span style="color:#40a070">0.0</span>, timingParameters: spring)
</span></span><span style="display:flex;"><span>    toggleHeightAnimator?.addAnimations(animations)
</span></span><span style="display:flex;"><span>    toggleHeightAnimator?.startAnimation()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>toggleShowMore(_:)</code>方法的底部，添加以下代码用来加载窗口小部件中的图标：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-31-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-31-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>widgetView.expanded = showsMore
</span></span><span style="display:flex;"><span>widgetView.reload()
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxuvd8a3hwg308k08cqhn.gif"></p>
<h3 id="视图过渡">视图过渡</h3>
<p>在<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#3-%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB">视图动画的3-过渡动画</a>，学习了视图过渡。现在用<code>UIViewPropertyAnimator</code>做视图过渡。</p>
<p>显示更多按钮的title，&ldquo;Show More&rdquo; 和 &ldquo;Show Less&rdquo; 两者相互淡入淡出动画。</p>
<p>在<code>toggleShowMore（_ :)</code>的<code>toggleHeightAnimator</code>定义之前添加这段代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">textTransition</span> = {
</span></span><span style="display:flex;"><span>    UIView.transition(with: sender, duration: <span style="color:#40a070">0.25</span>, options: .transitionCrossDissolve, animations: {
</span></span><span style="display:flex;"><span>        sender.setTitle(<span style="color:#007020;font-weight:bold">self</span>.showsMore ? <span style="color:#4070a0">&#34;Show Less&#34;</span> : <span style="color:#4070a0">&#34;Show More&#34;</span>, <span style="color:#007020;font-weight:bold">for</span>: .normal)
</span></span><span style="display:flex;"><span>    }, completion: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>toggleHeightAnimator</code>开始之前添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>toggleHeightAnimator?.addAnimations(textTransition, delayFactor: <span style="color:#40a070">0.5</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这将改变按钮标题，具有很好的交叉淡入淡出效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxuvtnlvmbg303m03s772.gif"></p>
<p>效果也可以尝试<code>.transitionFlipFromTop</code>等</p>
<h2 id="22-用uiviewpropertyanimator进行交互式动画">22-用UIViewPropertyAnimator进行交互式动画</h2>
<p>前面两个章节介绍了许多<code>UIViewPropertyAnimator</code> 的使用，例如基本动画，自定义计时和弹簧动画，以及动画的提取。但是，与以前视图动画 <strong>“即发即忘”</strong>(&ldquo;fire-and-forget&rdquo;)API相比，尚未研究使<code>UIViewPropertyAnimator</code>真正有趣的地方。</p>
<p><code>UIView.animate(withDuration:...)</code>提供了动画的设置方法，但是一旦定义动画结束状态，那么动画就会开始执行，而无法控制。</p>
<p><strong>但是如果我们想在动画运行时与之交互，怎么办？</strong> 细说，就是动画不是静态的，而是由用户手势或麦克风输入驱动的，就像在前面图层动画 <a href="http://andyron.com/2018/iOS-Animation-3-Layer-Animations">系统学习iOS动画之三：图层动画</a> 所学的一样。</p>
<p>使用<code>UIViewPropertyAnimator</code> 创建的动画是完全交互式的：可以启动，暂停，改变速度，甚至可以直接调整进度。</p>
<p>由于<code>UIViewPropertyAnimator</code>可以同时驱动预设动画和交互式动画，因而在描述动画师当前的状态时，就有点复杂了😵。下面就看看如何处理动画师的状态。</p>
<blockquote>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> 使用上一章节完成的项目。</p>
</blockquote>
<h3 id="动画状态机">动画状态机</h3>
<p><code>UIViewPropertyAnimator</code>可以检查动画是否已启动(<code>isRunning</code>)，是否已暂停或完全停止(<code>state</code>)，或动画是否已颠倒(<code>isReversed</code>)。</p>
<p><code>UIViewPropertyAnimator</code>有三个描述当前状态的属性：</p>
<p><img alt="image-20181204183027143" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxuw4ytvcqj30et02eaa7.jpg"></p>
<p><code>isRunning</code>（只读）：动画当前是否处于运动状态。 默认为<code>false</code>，在调用<code>startAnimation()</code>时变为<code>true</code>，如果暂停或停止动画，或者动画自然完成，它将再次变为<code>false</code>。</p>
<p><code>isReversed</code>：默认为<code>false</code>，因为我们总是向前开始动画，即动画从开始状态播放到结束状态。 如果更改为<code>true</code>，则动画将颠倒，即从介绍状态到开始状态。</p>
<p><code>state</code> （只读）：</p>
<p><code>state</code>默认为<code>inactive</code>，这通常意味着刚刚创建了动画师，并且还没有调用任何方法。请注意，这与将<code>isRunning</code>设置为<code>false</code>不同，<code>isRunning</code>实际上只关注正在进行的动画，而当<code>state</code>处于<code>inactive</code>时，这实际上意味着动画师还没有做任何事情。</p>
<p><code>state</code> 变成 <code>active</code>的情况有：</p>
<ul>
<li>调用<code>startAnimation()</code>来启动动画</li>
<li>在没有开始动画的情况下调用<code>pauseAnimation()</code></li>
<li>设置<code>fractionComplete</code>属性以将动画“倒回”到某个位置</li>
</ul>
<p>动画自然完成后，<code>state</code>切换回<code>.inactive</code>。</p>
<p>如果在动画师上调用<code>stopAnimation()</code>，它会将其<code>state</code>属性设置为<code>.stopped</code>。在这种状态下，你唯一能做的就是完全放弃动画师或者调用<code>finishAnimation(at:)</code>来完成动画并让动画师回到<code>.inactive</code>。</p>
<p>正如你可能想到的那样，<code>UIViewPropertyAnimator</code>只能按特定顺序在状态之间切换。 它不能直接从<code>inactive</code>到<code>stopped</code>，也不能从<code>stopped</code>直接转为<code>active</code>。</p>
<p>如果设置了<code>pausesOnCompletion</code>，一旦动画师完成了动画的运行而不是自动停止，而是暂停。 这将使我们有机会在暂停状态下继续使用它。</p>
<p>状态流程图：</p>
<p><img alt="image-20181204183357332" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxuw8m1813j30fj05iwf8.jpg"></p>
<p>可能有点绕，之后的使用中，如果有疑问，可以再回到这个部分查看。</p>
<h3 id="交互式3d-touch动画">交互式3D touch动画</h3>
<p>从这个部分开始，将学习创建类似于3D touch交互的交互式动画：</p>
<p><img alt="image-20190101223452030" src="https://ws1.sinaimg.cn/large/006tNc79gy1fz4852t7l1j30eg055jvh.jpg"></p>
<blockquote>
<p>注意：对于本章项目，需要兼容3D touch的iOS设备（没记错的话是6S+）。</p>
<p>听闻👂，3D touch这个技术会被在iPhone上取消，好吧，这边是学习类似3D touch 的动画，它的未来如何，就不过问了。</p>
</blockquote>
<p>3D touch的动画，可以这样描述：当我们手指按压屏幕上的图标时，动画交互式开始，背景越来越模糊，从图标旁渐渐呈现一个菜单，这个过程会随着手指按压的力度变化而前后变化。</p>
<p>放慢的效果为：</p>
<p><img alt="ScreenRecording_01-04-2019 11-13-10.2019-01-04 11_24_37" src="https://ws4.sinaimg.cn/large/006tNc79gy1fz4859kx1gg309q0ha7my.gif"></p>
<p><code>WidgetView.swift</code>中，<code>WidgetView</code>通过扩展遵守<code>UIPreviewInteractionDelegate</code>协议。这个协议中就包括了3D touch过程中一些委托方法。</p>
<p>为了让您开始开发动画本身，<code>UIPreviewInteractionDelegate</code>方法已经连接到LockScreenViewController上调用相关方法。
WidgetView中的代码如下：</p>
<ul>
<li>3D Touch开始时调用<code>LockScreenViewController.startPreview(for:)</code>。</li>
<li>当用户按下的过程中，可能更硬（或更柔和）时，反复调用<code>LockScreenViewController.updatePreview(percent:)</code>。</li>
<li>当peek交互成功完成时，调用<code>LockScreenViewController.finishPreview()</code>。</li>
<li>最后，如果用户在未完成预览手势的情况下抬起手指，则调用<code>LockScreenViewController.cancelPreview()</code>。</li>
</ul>
<p>在<code>LockScreenViewController</code>中添加这三个属性，您需要这些属性来创建窥视交互：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">startFrame</span>: CGRect?
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">previewView</span>: UIView?
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">previewAnimator</span>: UIViewPropertyAnimator?
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>startFrame</code>  来跟踪动画的开始位置。</p>
<p><code>previewView</code>  图标的快照视图，动画期间暂时使用它。
<code>previewAnimator</code>  将成为驱动预览动画的交互式动画师。</p>
<p>再添加一个属性以保持模糊效果以显示图标框：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">previewEffectView</span> = IconEffectView(blur: .extraLight)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>IconEffectView</code>是自定义的<code>UIVisualEffectView</code>的子类，它包含单个标签的简单模糊视图，使用它来模拟从按下的图标弹出的菜单：</p>
<p><img alt="image-20181219112216359" src="https://ws2.sinaimg.cn/large/006tNc79gy1fz485fxzrwj307l04jdgg.jpg"></p>
<p>在<code>LockScreenViewController</code>遵守<code>WidgetsOwnerProtocol</code>协议的扩展中，实现<code>startPreview(for:)</code>方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">startPreview</span>(<span style="color:#007020;font-weight:bold">for</span> forView: UIView) {
</span></span><span style="display:flex;"><span>    previewView?.removeFromSuperview()
</span></span><span style="display:flex;"><span>    previewView = forView.snapshotView(afterScreenUpdates: <span style="color:#007020;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>    view.insertSubview(previewView!, aboveSubview: blurView)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WidgetsOwnerProtocol</code>协议是一个自定义协议。</p>
<p>只要用户开始按下图标，<code>WidgetView</code>就会调用<code>startPreview(for:)</code>。 参数<code>for</code>是用户开始手势的集合单元格图像。</p>
<p>首先删除任何现有的<code>previewView</code>视图，以防万一在屏幕上留下之前的视图。 然后，您可以创建集合视图图标的快照，最后将其添加到模糊效果视图上方的屏幕上。</p>
<p>运行，按压图标。发现图标出现在左上角！😰</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fyupp9utvjg309o0ag0tk.gif"></p>
<p>因为尚未设置其位置。 继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>previewView?.frame = forView.convert(forView.bounds, to: view)
</span></span><span style="display:flex;"><span>startFrame = previewView?.frame
</span></span><span style="display:flex;"><span>addEffectView(below: previewView!)
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在图标副本位置正确了，完全覆盖在原有图标上。 <code>startFrame</code>用来存储起始<code>frame</code>，以供之后使用。</p>
<p>函数<code>addEffectView(below:)</code>添加图标快照下方的模糊框。代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">addEffectView</span>(below forView: UIView) {
</span></span><span style="display:flex;"><span>    previewEffectView.removeFromSuperview()
</span></span><span style="display:flex;"><span>    previewEffectView.frame = forView.frame
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    forView.superview?.insertSubview(previewEffectView, belowSubview: forView)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面创建动画本身，在<code>AnimatorFactory</code>中添加类方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">grow</span>(view: UIVisualEffectView, blurView: UIVisualEffectView) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    view.contentView.alpha = <span style="color:#40a070">0</span>
</span></span><span style="display:flex;"><span>    view.transform = .identity
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animator</span> = UIViewPropertyAnimator(duration: <span style="color:#40a070">0.5</span>, curve: .easeIn)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> animator
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>两个参数，<code>view</code>是动画视图，<code>blurView</code> 是动画的模糊背景。</p>
<p>在返回动画师之前，为动画师添加动画和完成闭包：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addAnimations {
</span></span><span style="display:flex;"><span>    blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>    view.transform = CGAffineTransform(scaleX: <span style="color:#40a070">1.5</span>, y: <span style="color:#40a070">1.5</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>animator.addCompletion { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>动画代码为<code>blurView</code>创建了模糊过渡，为<code>view</code>创建一个普通的转换。</p>
<p>之后，在<code>LockScreenViewController.swift</code>的<code>startPreview()</code>中完成调用：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-41-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>previewAnimator = AnimatorFactory.grow(view: previewEffectView, blurView: blurView)
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在运行，还没有效果，还需要实现<code>updatePreview(percent:)</code>方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-42-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-42-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-42-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">updatePreview</span>(percent: CGFloat) {
</span></span><span style="display:flex;"><span>    previewAnimator?.fractionComplete = max(<span style="color:#40a070">0.01</span>, min(<span style="color:#40a070">0.99</span>, percent))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当<code>WidgetView</code>被按压时，上面个方法会被重复调用。<code>fractionComplete</code>在0.01和0.99范围内，因为我不希望在动画才这段结束，我另外指定的方法完成或取消动画。</p>
<p>运行，效果（放慢）：</p>
<p><img alt="ScreenRecording_01-04-2019 18-29-21.2019-01-04 18_40_04" src="https://ws2.sinaimg.cn/large/006tNc79gy1fz485pn1f7g309q0ewart.gif"></p>
<p>你会（惊喜！）需要更多的动画师。 打开AnimatorFactory.swift并添加一个动画师，它可以解除你的“成长”动画师所做的一切。
您需要此动画师的一种情况是用户取消手势。 当您需要清理UI时，另一个是成功交互的最后阶段。</p>
<p>在<code>AnimatorFactory</code>中添加方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">reset</span>(frame: CGRect, view: UIVisualEffectView, blurView: UIVisualEffectView) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> UIViewPropertyAnimator(duration: <span style="color:#40a070">0.5</span>, dampingRatio: <span style="color:#40a070">0.7</span>, animations: {
</span></span><span style="display:flex;"><span>        view.transform = .identity
</span></span><span style="display:flex;"><span>        view.frame = frame
</span></span><span style="display:flex;"><span>        view.contentView.alpha = <span style="color:#40a070">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        blurView.effect = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>此方法的三个参数分别是原始动画的起始帧，动画视图和背景模糊视图。 动画块将重置交互开始之前状态中的所有属性。</p>
<p>在<code>LockScreenViewController.swift</code>中，实现<code>WidgetsOwnerProtocol</code>协议的另一个方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">cancelPreview</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">previewAnimator</span> = previewAnimator {
</span></span><span style="display:flex;"><span>        previewAnimator.isReversed = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        previewAnimator.startAnimation()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>cancelPreview()</code>是<code>WidgetView</code>被按压后，突然抬起手指时调用的方法，取消正在进行的手势。</p>
<p>到目前为止，你还没有开始你的动画师。 您一直在重复设置<code>fractionComplete</code>，这会以交互方式驱动动画。
但是，一旦用户取消交互，您就无法继续以交互方式驱动动画，因为您没有更多输入。 相反，通过将<code>isReversed</code>设置为<code>true</code>并调用<code>startAnimation()</code>，可以将动画播放到其初始状态。 现在这是<code>UIView.animate(withDuration: ...)</code>无法做到的事情！</p>
<p>再试一次互动。按下动画的一半，然后开始测试<code>cancelPreview()</code>。</p>
<p>当您抬起手指时动画会正确播放，但最终黑暗模糊会突然重新出现。</p>
<p>这个问题植根于你的成长动画师的代码。切换回AnimatorFactory.swift并查看grow中的代码（view：UIVisualEffectView，blurView：UIVisualEffectView） - 更具体地说，这部分：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addCompletion { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>  blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>动画可以向前或向后播放，需要在完成闭包中处理。</p>
<p><code>addCompletion()</code> 的闭包的参数用<code>_</code>省略掉了，它其实是一个枚举类型<code>UIViewAnimatingPosition</code>，表示动画当前进行的情况。它的值可有三个，可以是<code>.start</code>，<code>.end</code>或<code>.current</code>。</p>
<p>将完成闭包替代为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addCompletion { (position) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">switch</span> position {
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">case</span> .start:
</span></span><span style="display:flex;"><span>      blurView.effect = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">case</span> .end:
</span></span><span style="display:flex;"><span>      blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果动画被返回，则删除模糊效果。 如果成功完成，则明确将效果调整为暗模糊效果。</p>
<p>现在有一个新问题。 <em>如果取消对某个图标上的按压，则无法再按下它！</em>
这是因为图标快照仍然位于原始图标上方，挡住按压手势操作。 要解决该问题，值需要在重置动画完成后立即删除快照。</p>
<p>在<code>LockScreenViewController.swift</code>的<code>cancelPreview()</code>中继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>previewAnimator.addCompletion { (position) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">switch</span> position {
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">case</span> .start:
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.previewView?.removeFromSuperview()
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.previewEffectView.removeFromSuperview()
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>注意：</strong>，<code>addCompletion(_:)</code>可以调用多次，不会被下一个替代。</p>
<p>让我们再添加一个动画师来显示图标菜单。 切换到AnimatorFactory.swift并添加到它：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">complete</span>(view: UIVisualEffectView) -&gt; UIViewPropertyAnimator {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">return</span> UIViewPropertyAnimator(duration: <span style="color:#40a070">0.3</span>, dampingRatio: <span style="color:#40a070">0.7</span>, animations: {
</span></span><span style="display:flex;"><span>    view.contentView.alpha = <span style="color:#40a070">1</span>
</span></span><span style="display:flex;"><span>    view.transform = .identity
</span></span><span style="display:flex;"><span>    view.frame = CGRect(x: view.frame.minX <span style="color:#666">-</span> view.frame.minX<span style="color:#666">/</span><span style="color:#40a070">2.5</span>,
</span></span><span style="display:flex;"><span>                        y: view.frame.maxY <span style="color:#666">-</span> <span style="color:#40a070">140</span>,
</span></span><span style="display:flex;"><span>                        width: view.frame.width <span style="color:#666">+</span> <span style="color:#40a070">120</span>,
</span></span><span style="display:flex;"><span>                        height: <span style="color:#40a070">60</span>)
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这一次你创建了一个简单的弹簧动画师。 对于动画师，您可以执行以下操作：</p>
<ul>
<li>淡入“自定义操作”菜单项。</li>
<li>重置转换。</li>
<li>将视图框架直接设置为图标正上方的位置。</li>
</ul>
<p>菜单的位置根据用户按下的图标而变化。</p>
<p>您将水平位置设置为 <code>view.frame.minX - view.frame.minX/2.5</code>，如果图标位于屏幕左侧，则显示右侧菜单，如果图标位于左侧，则显示左侧菜单在屏幕的右侧。请参阅以下差异：</p>
<p><img alt="image-20190102115412511" src="https://ws3.sinaimg.cn/large/006tNc79gy1fz48605cgfj30eq068ta7.jpg"></p>
<p>动画师准备好了，所以打开LockScreenViewController.swift并在WidgetsOwnerProtocol扩展中添加最后一个必需的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">finishPreview</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    previewAnimator?.stopAnimation(<span style="color:#007020;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    previewAnimator?.finishAnimation(at: .end)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    previewAnimator = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当您感觉到触觉反馈时，用户按下3D触摸手势时会调用finishPreview（）。</p>
<p><code>stopAnimation(_:)</code>是停止当前在屏幕上运行的动画。参数为<code>false</code>，动画师状态为<code>stopped</code>；参数为<code>true</code>，动画师状态为<code>inactive</code>并清除所有动画，而且不调用完成闭包。</p>
<p>一旦你将动画师置于停止状态，你就有了一些选择。你在finishPreview（）中追求的是告诉动画师完成它的最终状态。因此，您调用finishAnimation（at：.end）;这将使用计划动画的目标值更新所有视图并调用您的完成。</p>
<p>此手势不再需要previewAnimator，因此您可以将其删除。</p>
<p>您可以使用以下方法之一调用finishAnimation（at :)：</p>
<p><code>start</code>：将动画重置为初始状态。
<code>current</code>：从动画的当前进度更新视图的属性并完成。</p>
<p>调用<code>finishAnimation(at:)</code>后，您的动画师处于<code>inactive</code>。</p>
<p>回到Widgets项目。由于你摆脱了预览动画师，你可以运行完整的动画师来显示菜单。将以下内容附加到finishPreview（）的末尾：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-50-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>AnimatorFactory.complete(view: previewEffectView).startAnimation()
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，按压图标：</p>
<p><img alt="image-20190102115643202" src="https://ws2.sinaimg.cn/large/006tNc79gy1fz48675dazj30f9049mz0.jpg"></p>
<h3 id="关闭模糊视图">关闭模糊视图</h3>
<p>目前，菜单弹出，模糊视图显示后，还没有回到原来视图的操作，下面添加这个操作。</p>
<p>在<code>finishPreview()</code>中添加以下代码,以准备交互式模糊：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>blurView.isUserInteractionEnabled = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>blurView.addGestureRecognizer(UITapGestureRecognizer(target: <span style="color:#007020;font-weight:bold">self</span>, action: <span style="color:#007020;font-weight:bold">#selector</span>(dismissMenu)))
</span></span></code></pre></td></tr></table>
</div>
</div><p>先确保将模糊效果设置为<code>.dark</code>，然后模糊视图本身上启用用户交互，并未模糊视图添加点击手势操作，允许用户点击图标周围的任何位置用来关闭菜单。</p>
<p><code>dismissMenu()</code>代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">@objc</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">dismissMenu</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">reset</span> = AnimatorFactory.reset(frame: startFrame!, view: previewEffectView, blurView: blurView)
</span></span><span style="display:flex;"><span>    reset.addCompletion { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#007020;font-weight:bold">self</span>.previewEffectView.removeFromSuperview()
</span></span><span style="display:flex;"><span>                         <span style="color:#007020;font-weight:bold">self</span>.previewView?.removeFromSuperview()
</span></span><span style="display:flex;"><span>                         <span style="color:#007020;font-weight:bold">self</span>.blurView.isUserInteractionEnabled = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>    reset.startAnimation()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="交互式关键帧动画">交互式关键帧动画</h3>
<p>在<a href="/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/#基础关键帧动画">20-UIViewPropertyAnimator入门</a>学习了 用<code>UIViewPropertyAnimator</code>制作关键帧动画，现在再给关键帧动画添加交互式操作。</p>
<p>为了尝试一下，你将为成长动画添加一个额外的元素 - 在用户按下图标时以交互方式擦洗的元素。</p>
<p>删除<code>AnimatorFactory</code>的<code>grow()</code>方法中的代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addAnimations {
</span></span><span style="display:flex;"><span>  blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>  view.transform = CGAffineTransform(scaleX: <span style="color:#40a070">1.5</span>, y: <span style="color:#40a070">1.5</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addAnimations {
</span></span><span style="display:flex;"><span>    UIView.animateKeyframes(withDuration: <span style="color:#40a070">0.5</span>, delay: <span style="color:#40a070">0.0</span>, animations: {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        UIView.addKeyframe(withRelativeStartTime: <span style="color:#40a070">0.0</span>, relativeDuration: <span style="color:#40a070">1.0</span>, animations: {
</span></span><span style="display:flex;"><span>            blurView.effect = UIBlurEffect(style: .dark)
</span></span><span style="display:flex;"><span>            view.transform = CGAffineTransform(scaleX: <span style="color:#40a070">1.5</span>, y: <span style="color:#40a070">1.5</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        UIView.addKeyframe(withRelativeStartTime: <span style="color:#40a070">0.5</span>, relativeDuration: <span style="color:#40a070">0.5</span>, animations: {
</span></span><span style="display:flex;"><span>            view.transform = view.transform.rotated(by: <span style="color:#666">-</span>.pi<span style="color:#666">/</span><span style="color:#40a070">8</span>)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一个关键帧运行您之前的相同动画。
第二个关键帧是简单旋转，效果：</p>
<p><img alt="ScreenRecording_01-04-2019 23-29-27.2019-01-04 23_32_31" src="https://ws1.sinaimg.cn/large/006tNc79gy1fz486eupoyg309b08njzk.gif"></p>
<h2 id="23-用uiviewpropertyanimator自定义视图控制器转场">23-用UIViewPropertyAnimator自定义视图控制器转场</h2>
<p>在<a href="http://andyron.com/2018/iOS-Animation-4-View-Controller-Transition-Animations">系统学习iOS动画之四：视图控制器的转场动画</a>中，学习了如何创建自定义视图控制器转场。这个章节学习使用<code>UIViewPropertyAnimator</code>来自定义视图控制器转场。</p>
<blockquote>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> 使用上一章节完成的项目。</p>
</blockquote>
<h3 id="静态视图控制器转场">静态视图控制器转场</h3>
<p>现在，点击**”Edit“**按钮时，体验非常糟糕😰。</p>
<p>首先创建一个新文件<code>PresentTransition.swift</code>，从名字也能看出这个类是用来转场的。 将其默认内容替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">UIKit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">PresentTransition</span>: NSObject, UIViewControllerAnimatedTransitioning {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">transitionDuration</span>(using transitionContext: UIViewControllerContextTransitioning?) -&gt; TimeInterval {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> <span style="color:#40a070">0.75</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animateTransition</span>(using transitionContext: UIViewControllerContextTransitioning) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>UIViewControllerAnimatedTransitioning</code>协议已经在<a href="http://andyron.com/2018/iOS-Animation-4-View-Controller-Transition-Animations">系统学习iOS动画之四：视图控制器的转场动画</a>中学过。</p>
<p>我将创建一个转场动画：原视图逐渐模糊图，新视图慢慢移动出来。</p>
<p>在<code>PresentTransition</code>中添加一个新方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">transitionAnimator</span>(using transitionContext: UIViewControllerContextTransitioning) -&gt; UIViewImplicitlyAnimating {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">duration</span> = transitionDuration(using: transitionContext)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">container</span> = transitionContext.containerView
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">to</span> = transitionContext.view(forKey: .to)<span style="color:#666">!</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    container.addSubview(to)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的代码中，为视图控制器转场做了一些必要的准备工作。 首先获取动画持续时间，然后获取目标视图控制器的视图，最后将此视图添加到过渡容器中。</p>
<p>接下来，可以设置动画并运行它。 将下面代码添加到上面的方法<code>transitionAnimator(using:)</code>中：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>to.transform = CGAffineTransform(scaleX: <span style="color:#40a070">1.33</span>, y: <span style="color:#40a070">1.33</span>).concatenating(CGAffineTransform(translationX: <span style="color:#40a070">0.0</span>, y: <span style="color:#40a070">200</span>))
</span></span><span style="display:flex;"><span>to.alpha = <span style="color:#40a070">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这会向上伸展，然后向下移动目标视图控制器的视图，最后将其淡出。</p>
<p>在<code>to.alpha = 0</code>之后添加动画师来运行转换：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">animator</span> = UIViewPropertyAnimator(duration: duration, curve: .easeOut)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>animator.addAnimations({
</span></span><span style="display:flex;"><span>    to.transform = CGAffineTransform(translationX: <span style="color:#40a070">0.0</span>, y: <span style="color:#40a070">100</span>)
</span></span><span style="display:flex;"><span>}, delayFactor: <span style="color:#40a070">0.15</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>animator.addAnimations({
</span></span><span style="display:flex;"><span>    to.alpha = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>}, delayFactor: <span style="color:#40a070">0.5</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>动画师中有两个动画：将目标视图控制器的视图移动到最终位置和淡入。</p>
<p>最后添加完成闭包：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addCompletion { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>                           
</span></span><span style="display:flex;"><span>  transitionContext.completeTransition(<span style="color:#666">!</span>transitionContext.transitionWasCancelled)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">return</span> animator
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>animateTransition(using:)</code>中调用上面的方法<code>transitionAnimator(using:)</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>transitionAnimator(using: transitionContext).startAnimation()
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>LockScreenViewController</code>中定义常量属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">presentTransition</span> = PresentTransition()
</span></span></code></pre></td></tr></table>
</div>
</div><p>让<code>LockScreenViewController</code>遵守<code>UIViewControllerTransitioningDelegate</code>协议：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// </span><span style="color:#60a0b0;background-color:#fff0f0">MARK:</span><span style="color:#60a0b0;font-style:italic"> - UIViewControllerTransitioningDelegate</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">extension</span> <span style="color:#0e84b5;font-weight:bold">LockScreenViewController</span>: UIViewControllerTransitioningDelegate {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animationController</span>(forPresented presented: UIViewController, presenting: UIViewController, source: UIViewController) -&gt; UIViewControllerAnimatedTransitioning? {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> presentTransition
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>UIViewControllerTransitioningDelegate</code>协议在 <a href="http://andyron.com/2018/iOS-Animation-4-View-Controller-Transition-Animations">系统学习iOS动画之四：视图控制器的转场动画</a> 中学习过。</p>
<p><code>animationController(forPresented:presents:source:)</code>方法是告诉UIKit，我想自定义视图控制器转场。</p>
<p>在<code>LockScreenViewController</code>中，找到点击<strong>Edit</strong>按钮的Action<code>presentSettings(_:)</code>，添加代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>settingsController = storyboard?.instantiateViewController(withIdentifier: <span style="color:#4070a0">&#34;SettingsViewController&#34;</span>) <span style="color:#007020;font-weight:bold">as</span>! SettingsViewController
</span></span><span style="display:flex;"><span>settingsController.transitioningDelegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span><span style="display:flex;"><span>present(settingsController, animated: <span style="color:#007020;font-weight:bold">true</span>, completion: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，点击<strong>Edit</strong>按钮，<code>SettingsViewController</code>有点问题：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fyc6z0vsfjj309q07cwfz.jpg"></p>
<p>在<code>Main.storyboard</code>中将视图的背景更改为<strong>Clear Color</strong>。</p>
<p>运行，变成：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fyc7232ygoj309q09z78p.jpg"></p>
<p>下面向动画师添加新属性，为了可以将任何自定义动画注入转场动画， 使用相同的转场类来生成略有不同的动画。</p>
<p>在<code>PresentTransition</code>中添加两个新属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">auxAnimations</span>: (() -&gt; <span style="color:#007020">Void</span>)?
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">auxAnimationsCancel</span>: (() -&gt; <span style="color:#007020">Void</span>)?
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>transitionAnimator(using:)</code>方法中动画师返回之前添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-65-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-65-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-65-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">auxAnimations</span> = auxAnimations {
</span></span><span style="display:flex;"><span>    animator.addAnimations(auxAnimations)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样可以根据具体情况在转换中添加自定义动画。 例如，要为当前转场添加模糊动画。</p>
<p>打开<code>LockScreenViewController</code>并在<code>presentSettings()</code>的开始处插入：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>presentTransition.auxAnimations = blurAnimations(<span style="color:#007020;font-weight:bold">true</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>再试一次过渡，看看这一行如何改变它：</p>
<p><img alt="image-20190111123452428" src="https://ws4.sinaimg.cn/large/006tNc79gy1fz486tm602j309505zgm8.jpg"></p>
<p>模糊动画重复使用了。</p>
<p>另外，当用户解除控制器时，还需要隐藏模糊视图。</p>
<p>在<code>presentSettings(_:)</code>中的<code>present(_:animated:completion:)</code>前添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    settingsController.didDismiss = { [<span style="color:#007020;font-weight:bold">unowned</span> <span style="color:#007020;font-weight:bold">self</span>] <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">self</span>.toggleBlur(<span style="color:#007020;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在，运行，点击<code>SettingsViewController</code>视图中的<strong>Cancel</strong>或其他选项，先有的模糊视图，然后恢复到第一个视图控制器：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fyc7kqfivvg309q0ha45w.gif"></p>
<h3 id="交互视图控制器转场">交互视图控制器转场</h3>
<p>这个部分通过下拉的手势来时学习实现交互视图控制器转场。</p>
<p>首先，让我们使用强大的<code>UIPercentDrivenInteractionTransition</code>类来启用视图控制器转场的交互性。</p>
<p>打开<code>PresentTransition.swift</code>把下面：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">PresentTransition</span>: NSObject, UIViewControllerAnimatedTransitioning
</span></span></code></pre></td></tr></table>
</div>
</div><p>替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">PresentTransition</span>: UIPercentDrivenInteractiveTransition, UIViewControllerAnimatedTransitioning {
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>UIPercentDrivenInteractiveTransition</code>是一个定义基于“百分比”的转场方法的类，例如有三个方法：</p>
<ul>
<li><code>update(_:)</code>  回退转场。</li>
<li><code>cancel() </code> 取消视图控制器转场。</li>
<li><code>finish()</code>  播放转场直到完成。</li>
</ul>
<p>之前学习的<a href="http://andyron.com/2018/iOS-Animation-4-View-Controller-Transition-Animations#19-%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AF%BC%E8%88%AA%E6%8E%A7%E5%88%B6%E5%99%A8%E8%BD%AC%E5%9C%BA">19-交互式导航控制器转场</a>中也提到相关内容。</p>
<p><code>UIPercentDrivenInteractiveTransition</code>的一些属性：</p>
<ul>
<li>
<p><code>timingCurve</code>：如果以交互方式驱动转场，并且是播放转场时直到结束，就可以通过设置此属性为动画提供自定义时序曲线。</p>
</li>
<li>
<p><code>wantsInteractiveStart</code>：默认是<code>true</code>，是否使用交互式转场。</p>
</li>
<li>
<p><code>pause()</code> ：调用此方法暂停非交互式转场并切换到交互模式。</p>
</li>
</ul>
<p>向<code>PresentTransition</code>添加一个新方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">interruptibleAnimator</span>(using transitionContext: UIViewControllerContextTransitioning) -&gt; UIViewImplicitlyAnimating {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> transitionAnimator(using: transitionContext)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是<code>UIViewControllerAnimatedTransitioning</code>协议的一个方法。 它允许我们UIKit提供可中断的动画师。</p>
<p>转场动画师类现在有两种不同的行为：</p>
<ol>
<li>如果以非交互方式使用它（当用户按下编辑按钮时），UIKit将调用<code>animateTransition(using:)</code>来设置转场动画。</li>
<li>如果以交互方式使用它，UIKit将调用<code>interruptibleAnimator(using:)</code>，获取动画师，并使用它来推动这种转场。</li>
</ol>
<p><img alt="image-20190111124837379" src="https://ws3.sinaimg.cn/large/006tNc79gy1fz48719aayj30ek0a3wfo.jpg"></p>
<p>切换到<code>LockScreenViewController.swift</code>， 在<code>UIViewControllerTransitioningDelegate</code>扩展中添新方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">interactionControllerForPresentation</span>(using animator: UIViewControllerAnimatedTransitioning) -&gt; UIViewControllerInteractiveTransitioning? {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> presentTransition
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，在<code>LockScreenViewController</code>中添加两个新属性，用来跟踪用户的手势：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">isDragging</span> = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">isPresentingSettings</span> = <span style="color:#007020;font-weight:bold">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当用户向下拉时，将<code>isDragging</code>标志设置为<code>true</code>，当拉得足够远，也将将<code>isPresentingSettings</code>设置为<code>true</code>。</p>
<p>实现<code>UISearchBarDelegate</code>的一个方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-73-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-73-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-73-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-73-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-73-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-73-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">scrollViewWillBeginDragging</span>(<span style="color:#007020;font-weight:bold">_</span> scrollView: UIScrollView) {
</span></span><span style="display:flex;"><span>    isDragging = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这可能看起来有点多余，因为<code>UITableView</code>已经有一个属性来跟踪它当前是否被拖动，但现在要自己做一些自定义跟踪。</p>
<p>接下来继续实现<code>UISearchBarDelegate</code>协议的另一个方法，用来跟踪用户的进度：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">scrollViewDidScroll</span>(<span style="color:#007020;font-weight:bold">_</span> scrollView: UIScrollView) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">guard</span> isDragging <span style="color:#007020;font-weight:bold">else</span> { <span style="color:#007020;font-weight:bold">return</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">!</span>isPresentingSettings <span style="color:#666">&amp;&amp;</span> scrollView.contentOffset.y <span style="color:#666">&lt;</span> <span style="color:#666">-</span><span style="color:#40a070">30</span> {
</span></span><span style="display:flex;"><span>        isPresentingSettings = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        presentTransition.wantsInteractiveStart = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        presentSettings()
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，需要添加代码以交互方式更新。 将以下内容追加到上面方法的末尾：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span> isPresentingSettings {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">progess</span> = max(<span style="color:#40a070">0.0</span>, min(<span style="color:#40a070">1.0</span>, ((<span style="color:#666">-</span>scrollView.contentOffset.y) <span style="color:#666">-</span> <span style="color:#40a070">30</span>) <span style="color:#666">/</span> <span style="color:#40a070">90.0</span>))
</span></span><span style="display:flex;"><span>    presentTransition.update(progess)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据拉出TableView的距离计算0.0到1.0范围内的进度，并在转场动画师上调用<code>update(_:)</code>以将动画定位到当前进度。
运行，当向下拖动时，将看到表格视图逐渐模糊。</p>
<p><img alt="2019-01-11 13-16-13.2019-01-11 13_22_39" src="https://ws1.sinaimg.cn/large/006tNc79gy1fz4876589cg308o0fh1f2.gif"></p>
<p>还需要注意完成取消转场，实现<code>UISearchBarDelegate</code>协议的另一个方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">scrollViewWillEndDragging</span>(<span style="color:#007020;font-weight:bold">_</span> scrollView: UIScrollView, withVelocity velocity: CGPoint, targetContentOffset: <span style="color:#007020">UnsafeMutablePointer</span>&lt;CGPoint&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">progress</span> = max(<span style="color:#40a070">0.0</span>, min(<span style="color:#40a070">1.0</span>, ((<span style="color:#666">-</span>scrollView.contentOffset.y) <span style="color:#666">-</span> <span style="color:#40a070">30</span>) <span style="color:#666">/</span> <span style="color:#40a070">90.0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> progress <span style="color:#666">&gt;</span> <span style="color:#40a070">0.5</span> {
</span></span><span style="display:flex;"><span>        presentTransition.finish()
</span></span><span style="display:flex;"><span>    } <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        presentTransition.cancel()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    isPresentingSettings = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    isDragging = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码看起来与<a href="http://andyron.com/2018/iOS-Animation-4-View-Controller-Transition-Animations#19-%E4%BA%A4%E4%BA%92%E5%BC%8F%E5%AF%BC%E8%88%AA%E6%8E%A7%E5%88%B6%E5%99%A8%E8%BD%AC%E5%9C%BA">19-交互式导航控制器转场</a>中相似。如果用户下拉已经超过距离的一半，则认为转场成功；如果用户未下拉超过一半，则取消转场。</p>
<p>把<code>transitionAnimator(using:)</code>方法中的<code>addCompletion</code>代码块替换为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    animator.addCompletion { (position) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">switch</span> position {
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">case</span> .end:
</span></span><span style="display:flex;"><span>        transitionContext.completeTransition(<span style="color:#666">!</span>transitionContext.transitionWasCancelled)
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">default</span>:
</span></span><span style="display:flex;"><span>        transitionContext.completeTransition(<span style="color:#007020;font-weight:bold">false</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，上下拉动，可能会出现下面这种像素化问题情况（iOS10可能会出现，iOS11之后应该修复了）：</p>
<p><img alt="image-20190111133132818" src="https://ws4.sinaimg.cn/large/006tNc79gy1fz487groy8j3095094q7d.jpg"></p>
<p>使用之前在<code>PresentTransition</code>中添加的<code>auxAnimationsCancel</code>属性。
在<code>transitionAnimator(using:)</code>中找到<code>animator.addCompletion</code>的调用，并在<code>default:</code>添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.auxAnimationsCancel?()
</span></span></code></pre></td></tr></table>
</div>
</div><p>到<code>LockScreenViewController</code>的<code>presentSettings(_:)</code>方法。在设置<code>auxAnimations</code>属性后，添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>presentTransition.auxAnimationsCancel = blurAnimations(<span style="color:#007020;font-weight:bold">false</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，像素化问题应该已经消失。</p>
<p>但是还有另一个问题。点击<strong>Edit</strong>按钮的非交互式转场没反应了！😱</p>
<p>只要用户点击<strong>Edit</strong>按钮，就需要更改代码以将视图控制器转场设置为非交互式。</p>
<p>到<code>LockScreenViewController</code>的<code>tableView(_:cellForRowAt:)</code>，在<code>self.presentSettings()</code>之前插入：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-80-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-80-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.presentTransition.wantsInteractiveStart = <span style="color:#007020;font-weight:bold">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，效果:</p>
<p><img alt="2019-01-11 13-40-54.2019-01-11 13_41_51" src="https://ws2.sinaimg.cn/large/006tNc79gy1fz487orsyng308o0dj4qp.gif"></p>
<h3 id="可中断的转场动画">可中断的转场动画</h3>
<p>接下来，要考虑转场期间在非交互模式和交互模式之间切换。</p>
<p>在这一部分，将实现点击<strong>Edit</strong>按钮后开始执行显示设置控制器的动画，但如果用户在动画期间再次点击屏幕，则暂停转场。</p>
<p>切换到<code>PresentTranstion.swift</code>。需要稍微改变动画师，不仅要分别处理交互式和非交互式模式，还要同时处理相同的过渡。
在<code>PresentTranstion</code>中再添加两个属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">context</span>: UIViewControllerContextTransitioning?
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">animator</span>: UIViewPropertyAnimator?
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用这两个属性来跟踪动画的上下文以及动画师。
在<code>transitionAnimator(using:)</code>方法的<code>return animator</code>前插入：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.animator = animator
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.context = transitionContext
</span></span></code></pre></td></tr></table>
</div>
</div><p>每次为转场创建新的动画师时，也会存储对它的引用。</p>
<p>转场完成后释放这些资源也很重要。 继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-83-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-83-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-83-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-83-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-83-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-83-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-83-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-83-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.addCompletion { [<span style="color:#007020;font-weight:bold">unowned</span> <span style="color:#007020;font-weight:bold">self</span>] <span style="color:#007020;font-weight:bold">_</span>  <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">self</span>.animator = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">self</span>.context = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>PresentTranstion</code>中再添加一个方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">interruptTransition</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">guard</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">context</span> = context <span style="color:#007020;font-weight:bold">else</span> { <span style="color:#007020;font-weight:bold">return</span> }
</span></span><span style="display:flex;"><span>    context.pauseInteractiveTransition()
</span></span><span style="display:flex;"><span>    pause()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>transitionAnimator(using:)</code>方法的<code>return animator</code>前插入：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animator.isUserInteractionEnabled = <span style="color:#007020;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>确保转场动画是交互式的，这样用户可以在暂停后继续与屏幕进行交互。</p>
<p>允许用户向上或向下滚动以分别完成或取消转场。 为此，在<code>LockScreenViewController</code>中添加一个新属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">touchesStartPointY</span>: CGFloat? 
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果用户在转场期间触摸屏幕，可以将其暂停并存储第一次触摸的位置：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">touchesBegan</span>(<span style="color:#007020;font-weight:bold">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">guard</span> presentTransition.wantsInteractiveStart == <span style="color:#007020;font-weight:bold">false</span>, presentTransition.animator <span style="color:#666">!=</span> <span style="color:#007020;font-weight:bold">nil</span> <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    touchesStartPointY = touches.first!.location(<span style="color:#007020;font-weight:bold">in</span>: view).y
</span></span><span style="display:flex;"><span>    presentTransition.interruptTransition()
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p>跟踪用户触摸并查看用户是向上还是向下平移，添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span> <span style="color:#007020;font-weight:bold">override</span> <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">touchesMoved</span>(<span style="color:#007020;font-weight:bold">_</span> touches: Set&lt;UITouch&gt;, with event: UIEvent?) {
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">guard</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">startY</span> = touchesStartPointY <span style="color:#007020;font-weight:bold">else</span> { <span style="color:#007020;font-weight:bold">return</span> }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">currentPoint</span> = touches.first!.location(<span style="color:#007020;font-weight:bold">in</span>: view).y
</span></span><span style="display:flex;"><span>  <span style="color:#007020;font-weight:bold">if</span> currentPoint <span style="color:#666">&lt;</span> startY <span style="color:#666">-</span> <span style="color:#40a070">40</span> {
</span></span><span style="display:flex;"><span>    touchesStartPointY = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    presentTransition.animator?.addCompletion({ (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#007020;font-weight:bold">self</span>.blurView.effect = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    presentTransition.cancel()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  } <span style="color:#007020;font-weight:bold">else</span> <span style="color:#007020;font-weight:bold">if</span> currentPoint <span style="color:#666">&gt;</span> startY <span style="color:#666">+</span> <span style="color:#40a070">40</span> {
</span></span><span style="display:flex;"><span>    touchesStartPointY = <span style="color:#007020;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    presentTransition.finish()
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，点击<strong>Edit</strong>按钮后，立即点击屏幕，这个时候转场会暂停，此时向下滑动会完成转场，向上滑动会取消转场，效果如下：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fz4qlv71nqg308o0erwqa.gif"></p>

        </div>

        
        
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">andyron</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2024-07-16
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>



        
        
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    
  </div>
</div>


        <footer class="post-footer">
          <div class="post-tags">
              <a href="http://localhost:1313/tags/ios%E5%8A%A8%E7%94%BB/">iOS动画</a>
                <a href="http://localhost:1313/tags/uiviewpropertyanimator/">UIViewPropertyAnimator</a>
                
            </div>


          
          <nav class="post-nav">
            
              <a class="prev" href="/blog/2019/01/swift%E7%AE%97%E6%B3%95%E4%BF%B1%E4%B9%90%E9%83%A8-%E5%A0%86%E6%8E%92%E5%BA%8F.html/">
                
                <i class="iconfont">
                  <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

                </i>
                <span class="prev-text nav-default">【译】Swift算法俱乐部-堆排序</span>
                <span class="prev-text nav-mobile">上一篇</span>
              </a>
            
              <a class="next" href="/blog/2019/01/swift%E7%AE%97%E6%B3%95%E4%BF%B1%E4%B9%90%E9%83%A8-%E5%A0%86.html/">
                <span class="next-text nav-default">【译】Swift算法俱乐部-堆</span>
                <span class="prev-text nav-mobile">下一篇</span>
                
                <i class="iconfont">
                  <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

                </i>
              </a>
          </nav>
        </footer>
      </article>

      
      


      
      

  

  
  
    <div class="post">
  <script
    src="https://giscus.app/client.js"
    data-repo="xianmin/comments---xianmin.org"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxNDAyNTY2MDI="
    data-category="Announcements"
    data-category-id="DIC_kwDOCFwlWs4CRRxW"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    
    crossorigin="anonymous"
    async
  ></script>
</div>

  

  
  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "http://localhost:1313/blog/2019/01/ios-animation-5-uiviewpropertyanimator.html/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'xianmin12';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript
    >Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
</div>


    

  

  


    </div>

    
    <nav class="toc" id="toc">
    <div class="toc-title">文章目录</div>
    <div class="toc-content custom-scrollbar">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#20-uiviewpropertyanimator入门">20-UIViewPropertyAnimator入门</a>
      <ul>
        <li><a href="#基础动画">基础动画</a></li>
        <li><a href="#提取动画">提取动画</a></li>
        <li><a href="#运行动画师">运行动画师</a></li>
        <li><a href="#基础关键帧动画">基础关键帧动画</a></li>
        <li><a href="#提取模糊动画">提取模糊动画</a></li>
        <li><a href="#防止动画重叠">防止动画重叠</a></li>
      </ul>
    </li>
    <li><a href="#21-深入uiviewpropertyanimator">21-深入UIViewPropertyAnimator</a>
      <ul>
        <li><a href="#自定义动画计时">自定义动画计时</a></li>
        <li><a href="#自动布局动画">自动布局动画</a></li>
        <li><a href="#视图过渡">视图过渡</a></li>
      </ul>
    </li>
    <li><a href="#22-用uiviewpropertyanimator进行交互式动画">22-用UIViewPropertyAnimator进行交互式动画</a>
      <ul>
        <li><a href="#动画状态机">动画状态机</a></li>
        <li><a href="#交互式3d-touch动画">交互式3D touch动画</a></li>
        <li><a href="#关闭模糊视图">关闭模糊视图</a></li>
        <li><a href="#交互式关键帧动画">交互式关键帧动画</a></li>
      </ul>
    </li>
    <li><a href="#23-用uiviewpropertyanimator自定义视图控制器转场">23-用UIViewPropertyAnimator自定义视图控制器转场</a>
      <ul>
        <li><a href="#静态视图控制器转场">静态视图控制器转场</a></li>
        <li><a href="#交互视图控制器转场">交互视图控制器转场</a></li>
        <li><a href="#可中断的转场动画">可中断的转场动画</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </nav>


  </div>

      </main>

      <footer id="footer" class="footer">
        <div class="icon-links">
  
  
    <a href="mailto:rongming.2008@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/3133839/andyron" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://github.com/andyron" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://localhost:1313/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2025
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        andyron
        
      </span></span>

  
  

  
</div>

      </footer>

      <div class="button__back-to-top">
        <a href="#back-to-top">
          <i class="iconfont">
            
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

          </i>
        </a>
      </div>
    </div>
    
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.25d4b4ffb2db9a42760854fb017fe0cbe4413e299a94b43b52a058abedbf5ace.js" integrity="sha256-JdS0/7LbmkJ2CFT7AX/gy&#43;RBPimalLQ7UqBYq&#43;2/Ws4=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>




  <script src="/js/custom.js"></script>


  </body>
</html>
