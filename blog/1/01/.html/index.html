<!DOCTYPE html>
<html
  lang="zh-cn"
  itemscope
  itemtype="http://schema.org/WebPage"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
           - 欣欣向戎
        </title>
    

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="andyron" />
  <meta name="description" content="title: &amp;lsquo;Java编程的逻辑2&amp;rsquo; date: 2024-07-25 draft: false slug: java-program-logic2 description: categories: [Java] tags: keywords: 示例 代码 四、文件 13 文件基本技术 13.1 文件概述 基本概念和常识 1 二进制思维 所" />

  <meta name="keywords" content="linux, Go, Java, PHP, program, journal, andyron, 博客, 笔记" />






<meta name="generator" content="Hugo 0.128.2" />


<link rel="canonical" href="http://localhost:1313/blog/1/01/.html/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.d8d87b982993a745e5e7b6a6cbf257be8c3e82aab5e485f0908ad7e6c3501ab2.css" integrity="sha256-2Nh7mCmTp0Xl57amy/JXvow&#43;gqq15IXwkIrX5sNQGrI=" media="screen" crossorigin="anonymous">






<link rel="stylesheet" href="/css/custom.css">


<meta property="og:url" content="http://localhost:1313/blog/1/01/.html/">
  <meta property="og:site_name" content="欣欣向戎">
  <meta property="og:title" content="欣欣向戎">
  <meta property="og:description" content="title: ‘Java编程的逻辑2’ date: 2024-07-25 draft: false slug: java-program-logic2 description: categories: [Java] tags: keywords: 示例 代码 四、文件 13 文件基本技术 13.1 文件概述 基本概念和常识 1 二进制思维 所">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:modified_time" content="2023-12-30T02:45:21+08:00">

  <meta itemprop="name" content="欣欣向戎">
  <meta itemprop="description" content="title: ‘Java编程的逻辑2’ date: 2024-07-25 draft: false slug: java-program-logic2 description: categories: [Java] tags: keywords: 示例 代码 四、文件 13 文件基本技术 13.1 文件概述 基本概念和常识 1 二进制思维 所">
  <meta itemprop="dateModified" content="2023-12-30T02:45:21+08:00">
  <meta itemprop="wordCount" content="74191">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="欣欣向戎">
  <meta name="twitter:description" content="title: ‘Java编程的逻辑2’ date: 2024-07-25 draft: false slug: java-program-logic2 description: categories: [Java] tags: keywords: 示例 代码 四、文件 13 文件基本技术 13.1 文件概述 基本概念和常识 1 二进制思维 所">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  </head>
  <body>
    <div id="back-to-top"></div>

    <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">欣欣向戎</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/blog/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/index.xml">订阅</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


    
      






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    

    
      
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '002186711602136249422:q1gkomof_em';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

    

    


    <header id="header" class="header">
      <div class="logo-wrapper">
  <a href="/" class="logo">
    
      欣欣向戎
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/blog/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/index.xml">订阅</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

    </header>

    <div id="mobile-panel">
      <main id="main" class="main bg-llight wallpaper">
        <div class="content-wrapper">
    <div id="content" class="content">
      <article class="post">
        
        <header class="post-header">
          <h1 class="post-title"></h1>
          

          <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          andyron
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="0001-01-01">
      0001-01-01
    </time>
  </div>

  
    <div class="post-meta-lastmod">
      (上次更新:
      2023-12-30)
    </div>
  


  <div class="post-meta__right">
    

    


    
    


    
    
  </div>
</div>

        </header>

        
        <div class="post-content">
          <hr>
<h2 id="keywords">title: &lsquo;Java编程的逻辑2&rsquo;
date: 2024-07-25
draft: false
slug: java-program-logic2
description:
categories: [Java]
tags:
keywords:</h2>
<p><a href="https://github.com/swiftma/program-logic/blob/master/the_logic_of_java_programming.md">示例  代码</a></p>
<h1 id="四文件">四、文件</h1>
<h2 id="13-文件基本技术">13 文件基本技术</h2>
<h3 id="131-文件概述">13.1 文件概述</h3>
<h4 id="基本概念和常识">基本概念和常识</h4>
<h5 id="1-二进制思维">1 二进制思维</h5>
<p>所有文件（不可执行文件、图片文件、视频文件、Word文件、压缩文件、txt文件等等）都是以0和1的二进制形式保存的。我们所看到的图片、视频、文本，都是<strong>应用程序对这些二进制的解析结果</strong>。</p>
<h5 id="2-文件类型">2 文件类型</h5>
<p>每种文件类型都有一定的格式，代表着**==文件含义和二进制之间的映射关系==**。</p>
<p>文件类型粗略分为两类：<strong>文本文件和二进制文件</strong>。前者如文本文件（.txt）、程序源代码文件（.java等）、HTML文件（.html）等，后者如压缩文件（.zip）、PDF文件、MP3文件、Excel文件等。</p>
<p>文本文件里的每个二进制字节都是某个可打印字符的一部分，都可以用最基本的文本编辑器进行查看和编辑；二进制文件中，每个字节就不一定表示字符，可能表示颜色、字体、声音大小等，如果用基本的文本编辑器打开，一般都是满屏的乱码，需要专门的应用程序进行查看和编辑。</p>
<h5 id="3-文本文件的编码">3 文本文件的编码</h5>
<p><strong>==编码==</strong>：字符到二进制的映射。</p>
<p>一个文本文件有自己的编码方式。应用程序用什么编码方式进行解读？一般使用某种默认的编码方式，<!-- raw HTML omitted -->可能是应用程序默认的，也可能是操作系统默认的，当然也可能采用一些比较智能的算法自动推断编码方式。<!-- raw HTML omitted --></p>
<p>🔖三个特殊字节（0xEF 0xBB 0xBF）</p>
<p>BOM头，Byte Order Mark（即字节序标记）</p>
<h5 id="4-文件系统">4 文件系统</h5>
<p>不同的文件系统有不同的文件组织方式、结构和特点，但编程时不需要关心其细节，编程语言和类库为我们提供统一的API。</p>
<p><code>File.separator</code>，路径分隔符</p>
<p><code>System.getProperty(&quot;user.dir&quot;)</code>，运行Java程序的当前目录</p>
<p>文件都具有<strong>元数据信息</strong>，如文件名、创建时间、修改时间、文件大小等。</p>
<p><strong>是否隐藏</strong></p>
<p><strong>访问权限</strong></p>
<p><strong>文件名大小写是否敏感</strong></p>
<p>临时文件，Windows 7 是 <code>C:\Users\用户名\AppData\Local\Temp</code>，Linux是<code>/tmp</code>。</p>
<h5 id="5-文件读写">5 文件读写</h5>
<p>Java封装了操作系统的功能，提供了统一的API。</p>
<p>基本常识：<strong>硬盘的访问延时，相比内存，是很慢的。</strong></p>
<p>操作系统和硬盘一般是<strong>按==块==批量传输</strong>，而不是按字节，以摊销延时开销，块大小一般至少为<strong>512字节</strong>，即使应用程序只需要文件的一个字节，操作系统也会至少将一个块读进来。一般而言，应<!-- raw HTML omitted -->尽量减少接触硬盘<!-- raw HTML omitted -->，接触一次，就一次多做一些事情。对于网络请求和其他输入输出设备，原则都是类似的。</p>
<p>基本常识：一般读写文件需要<strong>两==次数据复制==</strong>，比如读文件，<!-- raw HTML omitted -->需要先从硬盘复制到操作系统内核，再从内核复制到应用程序分配的内存中。<!-- raw HTML omitted --></p>
<p>操作系统所在的环境是**==内核态==<strong>，应用程序是</strong>==用户态==**，应用程序调用操作系统的功能，需要两次环境的切换，<!-- raw HTML omitted -->先从用户态切到内核态，再从内核态切到用户态<!-- raw HTML omitted -->。<strong>这种用户态/内核态的切换是有开销的，应尽量减少这种切换。</strong></p>
<p><strong>缓冲区</strong></p>
<p><strong>打开</strong>，<strong>关闭</strong>。打开文件操作系统会建立一个有关该文件的内存结构，这个结构通过一个整数索引来引用，这个索引叫做**==文件描述符==**。<strong>关闭文件</strong>一般会同步缓冲区内容到硬盘，并释放占据的内存。</p>
<p><strong>内存映射文件</strong>，高效的随机读写大文件的方法，将文件直接映射到内存，操作内存就是操作文件。</p>
<h4 id="java文件概述">Java文件概述</h4>
<h5 id="1-流">1 流</h5>
<p>在Java中（很多其他语言也类似），文件一般不是单独处理的，而是视为==输入输出（Input/Output, IO）设备==的一种。Java使用基本统一的概念（<strong>==流==</strong>）处理所有的IO，包括<!-- raw HTML omitted -->文件、键盘、显示终端、网络<!-- raw HTML omitted -->等。</p>
<blockquote>
<p>输入流就是可以从中获取数据到内存，输出流就是内存可以向其中写入数据。</p>
</blockquote>
<p>Java IO的基本类大多位于java.io。类<code>InputStream</code>表示<strong>输入流</strong>，<code>OutputStream</code>表示<strong>输出流</strong>，而<code>FileInputStream</code>表示<strong>文件输入流</strong>，<code>FileOutputStream</code>表示<strong>文件输出流</strong>。</p>
<p>有了流的概念，就有了很多<strong>面向流的代码</strong>，比如对流做<!-- raw HTML omitted -->加密、压缩、计算信息摘要、计算检验和<!-- raw HTML omitted -->等，这些代码接受的参数和返回结果都是**==抽象的流==<strong>，它们构成了一个</strong>协作体系**，<strong>这类似于之前介绍的接口概念、面向接口的编程，以及容器类协作体系</strong>。一些实际上不是IO的数据源和目的地也转换为了流，以方便参与这种协作，比如字节数组，也包装为了流<code>ByteArrayInputStream</code>和<code>ByteArrayOutputStream</code>。</p>
<h5 id="2-装饰器设计模式">2 装饰器设计模式</h5>
<p>基本的流按字节读写，<!-- raw HTML omitted -->没有缓冲区<!-- raw HTML omitted -->，这不方便使用。Java解决这个问题的方法是使用装饰器设计模式。</p>
<p>很多装饰类，其中两个基类：过滤器输入流<code>FilterInputStream</code>和过滤器输出流<code>FilterOutputStream</code>。</p>
<p>过滤类似于自来水管道，流入的是水，流出的也是水，功能不变，或者只是增加功能。子类如：</p>
<ul>
<li>对流起缓冲装饰的子类是<code>BufferedInputStream</code>和<code>BufferedOutputStream</code>。</li>
<li>可以按8种基本类型和字符串对流进行读写的子类是<code>DataInputStream</code>和<code>DataOutputStream</code>。</li>
<li>可以对流进行压缩和解压缩的子类有<code>GZIPInputStream</code>、<code>ZipInputStream</code>、<code>GZIPOutputStream</code>和<code>ZipOutputStream</code>。</li>
<li>可以将基本类型、对象输出为其字符串表示的子类有<code>PrintStream</code>。</li>
</ul>
<h5 id="3-readerwriter">3 Reader/Writer</h5>
<p>以InputStream/OutputStream为基类的流基本都是<!-- raw HTML omitted -->以二进制形式处理数据的<!-- raw HTML omitted -->，不能够方便地处理文本文件，没有<strong>编码</strong>的概念，能够方便地==按字符处理文本数据==的基类是<code>Reader</code>和<code>Writer</code>。子类：</p>
<ul>
<li>读写文件的子类是<code>FileReader</code>和<code>FileWriter</code>。</li>
<li>起缓冲装饰的子类是<code>BufferedReader</code>和<code>BufferedWriter</code>。</li>
<li>将字符数组包装为Reader/Writer的子类是<code>CharArrayReader</code>和<code>CharArrayWriter</code>。</li>
<li>将字符串包装为Reader/Writer的子类是<code>StringReader</code>和<code>StringWriter</code>。</li>
<li>将InputStream/OutputStream转换为Reader/Writer的子类是<code>InputStreamReader</code>和<code>OutputStreamWriter</code>。</li>
<li>将基本类型、对象输出为其字符串表示的子类是<code>PrintWriter</code>。</li>
</ul>
<h5 id="4-随机读写文件">4 随机读写文件</h5>
<p><code>RandomAccessFile</code></p>
<h5 id="5-file">5 File</h5>
<p>文件路径、文件元数据、文件目录、临时文件、访问权限管理等</p>
<h5 id="6-nio">6 NIO</h5>
<p>以上介绍的类基本都位于包java.io下。</p>
<p>java.nio，表示<strong>New IO</strong>。</p>
<p>NIO代表一种不同的看待IO的方式，它有**==缓冲区==<strong>和</strong>==通道==**的概念。更接近操作系统的概念，某些操作的性能也更高，比如，复制文件到网络。</p>
<p>通道可以利用操作系统和硬件提供的**==DMA机制==**（Direct Memory Access，直接内存存取），不用CPU和应用程序参与，直接将数据从硬盘复制到网卡。</p>
<p>NIO还支持一些比较底层的功能，如<strong>内存映射文件、文件加锁、自定义文件系统、非阻塞式IO、异步IO</strong>等。</p>
<h5 id="7-序列化和反序列化">7 序列化和反序列化</h5>
<p><strong>序列化就是将内存中的Java对象持久保存到一个流中，反序列化就是从流中恢复Java对象到内存。</strong></p>
<p>它们的作用：一是==对象状态持久化==；二是==网络远程调用==，用于传递和返回对象。</p>
<p>Java主要通过接口<code>Serializable</code>和类<code>ObjectInputStream</code>/<code>ObjectOutputStream</code>提供对序列化的支持。</p>
<p>Java的默认序列化的缺点：<strong>序列化后的形式比较大、浪费空间，序列化/反序列化的性能也比较低；Java特有技术，不能与其他语言交互。</strong></p>
<p>Java对象也可以序列化为ⅩML和JSON，它们都是文本格式，人容易阅读，但<strong>占用的空间相对大</strong>一些。</p>
<p>在只用于网络远程调用的情况下，有很多流行的、跨语言的、精简且高效的对象序列化机制，如ProtoBuf、Thrift、MessagePack等。其中，<!-- raw HTML omitted -->MessagePack是二进制形式的JSON，更小更快<!-- raw HTML omitted -->。</p>
<h3 id="132-二进制文件和字节流">13.2 二进制文件和字节流</h3>
<h4 id="inputstreamoutputstream">InputStream/OutputStream</h4>
<p>抽象基类</p>
<h5 id="inputstream的基本方法">InputStream的基本方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">abstract</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>read方法从流中读取下一个字节，返回类型为int，但取值为0～255，当读到流结尾的时候，返回值为-1，如果流中没有数据，read方法会==阻塞==直到数据到来、流关闭或异常出现。异常出现时，read方法抛出异常，类型为<code>IOException</code>，这是一个受检异常，调用者必须进行处理。</p>
<p>read方法是个抽象方法，子类FileInputStream中实现会调用本地方法。</p>
<p>其它方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 一次读取多个字节</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>read(b,<span style="color:#bbb"> </span>0,<span style="color:#bbb"> </span>b.<span style="color:#4070a0">length</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>off,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>len)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">close</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>close方法通常应该放在finally语句内</p>
<h5 id="inputstream的高级方法">InputStream的高级方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">skip</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>n)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">available</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">mark</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>readlimit)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">markSupported</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">reset</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>skip跳过输入流中n个字节。</p>
<p>available返回下一次不需要阻塞就能读取到的大概字节个数。</p>
<p>mark、reset、markSupported，用于支持从读过的流中<strong>重复读取</strong>。</p>
<p>不是所有流都支持mark、reset方法，是否支持可以通过markSupported的返回值进行判断。InpuStream的默认实现是不支持，FileInputStream也不直接支持，但BufferedInputStream和ByteArrayInputStream可以支持。</p>
<h5 id="outputstream">OutputStream</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">abstract</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>b)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>需要子类实现，，FileOutputStream的实现会调用本地方法。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 批量写入</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>off,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>len)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">flush</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">close</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>flush将缓冲而未实际写的数据进行实际写入，如在BufferedOutputStream中，调用flush方法会将其缓冲区的内容写到其装饰的流中，并调用该流的flush方法。基类OutputStream没有缓冲，flush方法代码为空。</p>
<p>close方法一般会<strong>首先调用flush方法，然后再释放流占用的系统资源</strong>。同InputStream一样，close方法一般应该放在finally语句内。</p>
<h4 id="fileinputstreamfileoutputstream">FileInputStream/FileOutputStream</h4>
<p>输入源和输出目标是文件的流。</p>
<h5 id="1-fileoutputstream">1 FileOutputStream</h5>
<p>FileOutputStream的构造方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">FileOutputStream</span>(File<span style="color:#bbb"> </span>file,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>append)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">FileOutputStream</span>(String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-7-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>FileOutputStream<span style="color:#bbb"> </span>output<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileOutputStream(<span style="color:#4070a0">&#34;hello.txt&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#bbb"> </span>data<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;hello, world! I&#39;m coming.&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>bytes<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>data.<span style="color:#4070a0">getBytes</span>(StandardCharsets.<span style="color:#4070a0">UTF_8</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>output.<span style="color:#4070a0">write</span>(bytes);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>output.<span style="color:#4070a0">close</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>OutputStream只能以byte或byte数组写文件。</p>
<p>FileOutputStream两个额外的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-8-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>FileChannel<span style="color:#bbb"> </span><span style="color:#06287e">getChannel</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>FileDescriptor<span style="color:#bbb"> </span><span style="color:#06287e">getFD</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>FileChannel</code>定义在java.nio中，表示文件通道概念;</p>
<p><code>FileDescriptor</code>表示文件描述符，它与操作系统的一些文件内存结构相连，它有一个本地方法==sync==，它会确保将操作系统缓冲的数据写到硬盘上。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sync</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>SyncFailedException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>sync与OutputStream的flush方法相区别，<strong>flush方法只能将应用程序缓冲的数据写到操作系统，sync方法则确保数据写到硬盘</strong>。（一般不需要手动调用它）</p>
<h5 id="2-fileinputstream">2 FileInputStream</h5>
<p>FileInputStream的主要构造方法:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">FileInputStream</span>(String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">FileInputStream</span>(File<span style="color:#bbb"> </span>file)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>参数是文件路径或File对象，必须是一个已经存在的文件，不能是目录。如果不存在，抛出<code>FileNotFoundException</code>，如果用户没有读的权限，抛出<code>SecurityException</code>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>FileInputStream<span style="color:#bbb"> </span>input<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileInputStream(<span style="color:#4070a0">&#34;hello.txt&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>buf<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span><span style="color:#902000">byte</span><span style="color:#666">[</span>1024<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>bytesRead<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>input.<span style="color:#4070a0">read</span>(buf);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#bbb"> </span>data<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>String(buf,<span style="color:#bbb"> </span>0,<span style="color:#bbb"> </span>bytesRead,<span style="color:#bbb"> </span>StandardCharsets.<span style="color:#4070a0">UTF_8</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(data);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>input.<span style="color:#4070a0">close</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="bytearrayinputstreambytearrayoutputstream">ByteArrayInputStream/ByteArrayOutputStream</h4>
<p>输入源和输出目标是<strong>字节数组</strong>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ByteArrayOutputStream</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ByteArrayOutputStream</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>size)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">toByteArray</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">toString</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">toString</span>(String<span style="color:#bbb"> </span>charsetName)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 把ByteArrayOutputStream中的数据写到另一个OutputStream</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">writeTo</span>(OutputStream<span style="color:#bbb"> </span>out)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">size</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">reset</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-14-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-14-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ByteArrayInputStream</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>buf<span style="color:#666">[]</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ByteArrayInputStream</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>buf<span style="color:#666">[]</span>,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>offset,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>length)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="datainputstreamdataoutputstream">DataInputStream/DataOutputStream🔖</h4>
<p>装饰类，按基本类型和字符串而非只是字节读写流。</p>
<p>DataOutputStream -&gt; FilterOutputStream  -&gt; OutputStream</p>
<p>DataInputStream -&gt; FilterInputStream -&gt; InputStream</p>
<h4 id="bufferedinputstreambufferedoutputstream">BufferedInputStream/BufferedOutputStream🔖</h4>
<p>装饰类，对输入输出流提供缓冲功能。</p>
<p><strong>将文件流包装到缓冲流中</strong>。BufferedInputStream内部有个字节数组作为缓冲区，读取时，先从这个缓冲区读，缓冲区读完了再调用包装的流，它的构造方法有两个：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">BufferedInputStream</span>(InputStream<span style="color:#bbb"> </span>in)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">BufferedInputStream</span>(InputStream<span style="color:#bbb"> </span>in,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>size)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="实用方法">实用方法</h4>
<p>实际开发中需要将一些常用功能进行封装。</p>
<p>复制输入流的内容到输出流：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">copy</span>(InputStream<span style="color:#bbb"> </span>input,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>OutputStream<span style="color:#bbb"> </span>output)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>buf<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span><span style="color:#902000">byte</span><span style="color:#666">[</span>4096<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>bytesRead<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">while</span>((bytesRead<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>input.<span style="color:#4070a0">read</span>(buf))<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span><span style="color:#666">-</span>1){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>output.<span style="color:#4070a0">write</span>(buf,<span style="color:#bbb"> </span>0,<span style="color:#bbb"> </span>bytesRead);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Java9中，InputStream类增加了一个方法transferTo，可以实现相同功能：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">transferTo</span>(OutputStream<span style="color:#bbb"> </span>out)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Objects.<span style="color:#4070a0">requireNonNull</span>(out,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;out&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>transferred<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>buffer<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span><span style="color:#902000">byte</span><span style="color:#666">[</span>DEFAULT_BUFFER_SIZE<span style="color:#666">]</span>;<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//buf大小是8192</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>read;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">while</span>((read<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">read</span>(buffer,<span style="color:#bbb"> </span>0,<span style="color:#bbb"> </span>DEFAULT_BUFFER_SIZE))<span style="color:#bbb"> </span><span style="color:#666">&gt;=</span><span style="color:#bbb"> </span>0)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>out.<span style="color:#4070a0">write</span>(buffer,<span style="color:#bbb"> </span>0,<span style="color:#bbb"> </span>read);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>transferred<span style="color:#bbb"> </span><span style="color:#666">+=</span><span style="color:#bbb"> </span>read;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>transferred;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>将文件读入字节数组，调用了上面的复制方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">readFileToByteArray</span>(String<span style="color:#bbb"> </span>fileName)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>InputStream<span style="color:#bbb"> </span>input<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileInputStream(fileName);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>ByteArrayOutputStream<span style="color:#bbb"> </span>output<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ByteArrayOutputStream();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">try</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>copy(input,<span style="color:#bbb"> </span>output);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>output.<span style="color:#4070a0">toByteArray</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#007020;font-weight:bold">finally</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>input.<span style="color:#4070a0">close</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>将字节数组写到文件：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">writeByteArrayToFile</span>(String<span style="color:#bbb"> </span>fileName,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                        </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>data)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>OutputStream<span style="color:#bbb"> </span>output<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileOutputStream(fileName);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">try</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>output.<span style="color:#4070a0">write</span>(data);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#007020;font-weight:bold">finally</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>output.<span style="color:#4070a0">close</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><a href="http://commons.apache.org/proper/commons-io/">Apache Commons IO</a> 提供了很多简单易用的方法。</p>
<p><img src="images/image-20220530153214772.png"></p>
<h3 id="133-文本文件和字符流">13.3 文本文件和字符流</h3>
<p><img src="images/image-20220530155220740.png"></p>
<h4 id="基本概论">基本概论</h4>
<h5 id="1文本文件">1.文本文件</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>DataOutputStream<span style="color:#bbb"> </span>output<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>DataOutputStream(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileOutputStream(<span style="color:#4070a0">&#34;test.data&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>output.<span style="color:#4070a0">writeInt</span>(123);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>output.<span style="color:#4070a0">close</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="images/image-20230320172729616.png"></p>
<p>在文件中存储的实际有4个字节，最低位字节7B对应的十进制数是123，也就是说，对int类型，二进制文件保存的直接就是int的二进制形式。这个二进制形式，如果当成字符来解释，显示成什么字符则与编码有关，如果当成UTF-32BE编码，解释成的就是一个字符，即{。</p>
<p>如果要使用文本文件保存整数123，需将整数123转换为字符串，然后将它的UTF-8编码输出到了文件中：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>OutputStream<span style="color:#bbb"> </span>output<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileOutputStream(<span style="color:#4070a0">&#34;test.txt&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#bbb"> </span>data<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Integer.<span style="color:#4070a0">toString</span>(123);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>output.<span style="color:#4070a0">write</span>(data.<span style="color:#4070a0">getBytes</span>(<span style="color:#4070a0">&#34;UTF-8&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>output.<span style="color:#4070a0">close</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="images/image-20230320173315242.png"></p>
<h5 id="2编码">2.编码</h5>
<p>在文本文件中，同一个字符不同编码方式对应的二进制形式可能是不一样的。</p>
<h5 id="3字符流">3.字符流</h5>
<p>字节流是按字节读取的，而<strong>字符流则是按char读取的</strong>，一个char在文件中保存的是几个字节与编码有关。但字符流封装了这种细节，我们操作的对象就是char。</p>
<p>注意：<strong>一个char不完全等同于一个字符</strong>，对于绝大部分字符，一个字符就是一个char，但之前介绍过，对于增补字符集中的字符，需要两个char表示，对于这种字符，Java中的字符流是按char而不是一个完整字符处理的。</p>
<h4 id="readerwriter">Reader/Writer</h4>
<p>Reader/Writer类似字节流的InputStream/OutputStream，都是抽象类。</p>
<p>Reader与字节流的InputStream类似，主要方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>(<span style="color:#902000">char</span><span style="color:#bbb"> </span>cbuf<span style="color:#666">[]</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">abstract</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">close</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">skip</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>n)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">ready</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>方法的名称和含义与InputStream中的对应方法基本类似，但Reader中处理的单位是char，比如read读取的是一个char，取值范围为0～65 535。Reader没有available方法，对应的方法是ready()。</p>
<p>Writer与字节流的OutputStream类似，主要方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>c)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(<span style="color:#902000">char</span><span style="color:#bbb"> </span>cbuf<span style="color:#666">[]</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(String<span style="color:#bbb"> </span>str)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">abstract</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">close</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">abstract</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">flush</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="inputstreamreaderoutputstreamwriter">InputStreamReader/OutputStreamWriter</h4>
<p>==适配器类==，<strong>将字节流转换为字符流</strong>（将InputStream/OutputStream转换为Reader/Writer）；</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">OutputStreamWriter</span>(OutputStream<span style="color:#bbb"> </span>out)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">OutputStreamWriter</span>(OutputStream<span style="color:#bbb"> </span>out,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>charsetName)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">InputStreamReader</span>(InputStream<span style="color:#bbb"> </span>in)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">InputStreamReader</span>(InputStream<span style="color:#bbb"> </span>in,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>charsetName)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="filereaderfilewriter">FileReader/FileWriter</h4>
<p>输入源和输出目标是文件的字符流；</p>
<p>FileReader/FileWriter不能指定编码类型，只能使用默认编码，如果需要指定编码类型，可以使用InputStreamReader/OutputStreamWriter。</p>
<h4 id="chararrayreaderchararraywriter">CharArrayReader/CharArrayWriter</h4>
<p>输入源和输出目标是char数组的字符流，这个数组的长度可以根据数据内容动态扩展。</p>
<p>CharArrayWriter与ByteArrayOutputStream类似。</p>
<p>CharArrayWriter可以方便地将数据转换为char数组或字符串：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">toCharArray</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">toString</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>CharArrayReader与ByteArrayInputStream类似，它将char数组包装为一个Reader，是一种适配器模式。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">CharArrayReader</span>(<span style="color:#902000">char</span><span style="color:#bbb"> </span>buf<span style="color:#666">[]</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">CharArrayReader</span>(<span style="color:#902000">char</span><span style="color:#bbb"> </span>buf<span style="color:#666">[]</span>,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>offset,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>length)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="stringreaderstringwriter">StringReader/StringWriter</h4>
<p>StringReader/StringWriter与CharArrayReader/CharArrayWriter类似，只是输入源为<code>String</code>，输出目标为<code>StringBuffer</code>，而且，String/StringBuffer内部是由char数组组成的，所以它们本质上是一样的。</p>
<h4 id="bufferedreaderbufferedwriter">BufferedReader/BufferedWriter</h4>
<p>装饰类，对输入/输出流提供缓冲，以及==按行读写==功能；</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">BufferedWriter</span>(Writer<span style="color:#bbb"> </span>out)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">BufferedWriter</span>(Writer<span style="color:#bbb"> </span>out,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>sz)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">newLine</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">BufferedReader</span>(Reader<span style="color:#bbb"> </span>in)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">BufferedReader</span>(Reader<span style="color:#bbb"> </span>in,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>sz)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 字符&#39;\r&#39;或&#39;\n&#39;或&#39;\r\n&#39;被视为换行符，readLine返回一行内容，但不会包含换行符，当读到流结尾时，返回null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">readLine</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="printwriter">PrintWriter</h4>
<p>装饰类，可将基本类型和对象转换为其字符串形式输出的类。</p>
<p>有很多print方法，这些方法都是先调用String.valueOf()，把参数转为字符串，然后再调用write：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">print</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">print</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">print</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>write(String.<span style="color:#4070a0">valueOf</span>(i));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>println多添加一个换行符。</p>
<p>printf是格式化输出：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-31-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>PrintWriter<span style="color:#bbb"> </span><span style="color:#06287e">printf</span>(String<span style="color:#bbb"> </span>format,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>...<span style="color:#bbb"> </span>args)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>PrintWriter的方便之处在于，它有很多构造方法，可以接受文件路径名、文件对象、OutputStream、Writer等，对于文件路径名和File对象，还可以接受编码类型作为参数。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-32-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">PrintWriter</span>(File<span style="color:#bbb"> </span>file)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">PrintWriter</span>(String<span style="color:#bbb"> </span>fileName,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>csn)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">PrintWriter</span>(OutputStream<span style="color:#bbb"> </span>out,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>autoFlush)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">PrintWriter</span>(Writer<span style="color:#bbb"> </span>out)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>🔖</p>
<h4 id="scanner">Scanner</h4>
<p>类似于一个Reader，但不是Reader的子类，可以读取基本类型的字符串形式，类似于PrintWriter的逆操作。</p>
<p>🔖</p>
<h4 id="标准流">标准流</h4>
<p>之前一直在使用System.out向屏幕上输出，它是一个PrintStream对象，输出目标就是所谓的“标准”输出，经常是屏幕。除了System.out, Java中还有两个标准流：System.in和System.err。</p>
<p>System.in表示标准输入，它是一个InputStream对象，输入源经常是键盘。</p>
<p>System.err表示标准错误流，一般异常和错误信息输出到这个流。</p>
<p>🔖</p>
<h4 id="实用方法-1">实用方法</h4>
<p>🔖</p>
<blockquote>
<p>小结：</p>
<p>写文件时，可以优先考虑PrintWriter，因为它使用方便，支持自动缓冲、指定编码类型、类型转换等。</p>
<p>读文件时，如果需要指定编码类型，需要使用InputStreamReader；如果不需要指定编码类型，可使用FileReader，但都应该考虑在外面包上缓冲类BufferedReader。</p>
</blockquote>
<h3 id="134-文件和目录操作">13.4 文件和目录操作</h3>
<p>文件和目录操作最终是与操作系统和文件系统相关的，不同系统的实现是不一样的，但Java中的<strong>java.io.File</strong>类提供了统一的接口，底层会通过本地方法调用操作系统和文件系统的具体实现。</p>
<h4 id="构造方法">构造方法</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//pathname表示完整路径，该路径可以是相对路径，也可以是绝对路径</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">File</span>(String<span style="color:#bbb"> </span>pathname)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//parent表示父目录，child表示孩子</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">File</span>(String<span style="color:#bbb"> </span>parent,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>child)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">File</span>(File<span style="color:#bbb"> </span>parent,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>child)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="文件元数据">文件元数据</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getName</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//返回文件或目录名称，不含路径名</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAbsolute</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//判断File中的路径是否是绝对路径</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getPath</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//返回构造File对象时的完整路径名，包括路径和文件名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getAbsolutePath</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//返回完整的绝对路径名</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回标准的完整路径名，它会去掉路径中的冗余名称如&#34;.&#34;, &#34;..&#34;，跟踪软链接(Unix系统概念)等</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getCanonicalPath</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getParent</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//返回父目录路径</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#bbb"> </span><span style="color:#06287e">getParentFile</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//返回父目录的File对象</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回一个新的File对象，新的File对象使用getAbsolutePath()的返回值作为参数构造</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#bbb"> </span><span style="color:#06287e">getAbsoluteFile</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回一个新的File对象，新的File对象使用getCanonicalPath()的返回值作为参数构造</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#bbb"> </span><span style="color:#06287e">getCanonicalFile</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>File有4个静态变量：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>separator<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>separatorChar<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>pathSeparator<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>pathSeparatorChar<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>前两个表示文件路径分隔符，Windows和Linux系统分别为：<code>\</code>， <code>/</code>；</p>
<p>后两个表示多个文件路径中的分隔符，比如，环境变量PATH中的分隔符，Java类路径变量classpath中的分隔符，Windows和Linux系统分别为：<code>;</code>， <code>:</code>。</p>
<p>获取文件或目录的基本信息：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">exists</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//文件或目录是否存在</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isDirectory</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//是否为目录</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isFile</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//是否为文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">length</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//文件长度，字节数，对目录没有意义</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">lastModified</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//最后修改时间，从纪元时开始的毫秒数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setLastModified</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>time)<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//设置最后修改时间，返回是否修改成功</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><!-- raw HTML omitted -->注：<!-- raw HTML omitted -->File对象没有返回创建时间的方法，因为创建时间不是一个公共概念， Linux/Unix就没有创建时间的概念。</p>
</blockquote>
<p>File类中与安全和权限相关的主要方法有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isHidden</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//是否为隐藏文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">canExecute</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//是否可执行</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">canRead</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//是否可读</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">canWrite</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//是否可写</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setReadOnly</span>()<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">//设置文件为只读文件</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//修改文件读权限</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setReadable</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>readable,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>ownerOnly)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setReadable</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>readable)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//修改文件写权限</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setWritable</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>writable,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>ownerOnly)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setWritable</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>writable)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//修改文件可执行权限</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setExecutable</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>executable,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>ownerOnly)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">setExecutable</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>executable)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="文件操作">文件操作</h4>
<p>新建一个File对象不会实际创建文件，但如下方法可以：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">createNewFile</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建临时文件：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>File<span style="color:#bbb"> </span><span style="color:#06287e">createTempFile</span>(String<span style="color:#bbb"> </span>prefix,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>suffix)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>File<span style="color:#bbb"> </span><span style="color:#06287e">createTempFile</span>(String<span style="color:#bbb"> </span>prefix,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>suffix,<span style="color:#bbb"> </span>File<span style="color:#bbb"> </span>directory)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>删除方法为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">delete</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">deleteOnExit</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>重命名：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-41-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">renameTo</span>(File<span style="color:#bbb"> </span>dest)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="目录操作">目录操作</h4>
<p>创建：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-42-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-42-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">mkdir</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>bollean<span style="color:#bbb"> </span><span style="color:#06287e">mkdirs</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>访问一个目录下的子目录和文件：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">list</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">list</span>(FilenameFilter<span style="color:#bbb"> </span>filter)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">listFiles</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">listFiles</span>(FileFilter<span style="color:#bbb"> </span>filter)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">listFiles</span>(FilenameFilter<span style="color:#bbb"> </span>filter)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>FilenameFilter和FileFilter都是接口，用于过滤。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">FileFilter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">accept</span>(File<span style="color:#bbb"> </span>pathname);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">FilenameFilter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">accept</span>(File<span style="color:#bbb"> </span>dir,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在遍历子目录和文件时，针对每个文件，会调用FilenameFilter或FileFilter的accept方法，只有accept方法返回true时，才将该子目录或文件包含到返回结果中。</p>
<p>FilenameFilter和FileFilter的区别在于：<!-- raw HTML omitted -->FileFilter的accept方法参数只有一个File对象，而File-nameFilter的accept方法参数有两个，dir表示父目录，name表示子目录或文件名。<!-- raw HTML omitted --></p>
<p>File类封装了操作系统和文件系统的差异，提供了统一的文件和目录API。</p>
<h2 id="14-文件高级技术">14 文件高级技术</h2>
<p>上一章中的字符流和字节流，都是以流的方式读写文件，它们有局限性：</p>
<ol>
<li>要么读、要么写，不能同时读和写。</li>
<li>不能随机读写，只能从头读到尾，且不能重复读，虽然通过缓冲可以实现部分重读，但是有限制。</li>
</ol>
<p><code>RandomAccessFile</code>，它没有这两个限制，<strong>既可以读，也可以写</strong>，还可以<strong>随机</strong>读写，是一个更接近于操作系统API的封装类。</p>
<p>访问文件还有一种方式：==内存映射文件==，它可以高效处理非常大的文件，而且可以被多个不同的应用程序共享，特别适合用于<strong>不同应用程序之间的通信</strong>。</p>
<p>使用<code>DataOutputStream</code>、<code>DataInputStream</code>需要逐个处理对象中的每个字段，比较麻烦，一种更为简单的机制就是==序列化==。</p>
<p>Java的标准序列化机制有一些重要的<strong>限制</strong>，而且<strong>不能跨语言</strong>，实践中经常使用一些替代方案，比如ⅩML/JSON/MessagePack。Java SDK中对这些格式的支持有限，有很多第三方的类库提供了更为方便的支持，Jackson是其中一种，它支持多种格式。</p>
<h3 id="141-常见文件类型处理">14.1 常见文件类型处理</h3>
<h4 id="属性文件">属性文件</h4>
<p>属性文件是常见的配置文件，用于<strong>在不改变代码的情况下改变程序的行为</strong>。</p>
<p><code>java.util.Properties</code></p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 从流中加载属性</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">load</span>(InputStream<span style="color:#bbb"> </span>inStream)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 获取属性值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getProperty</span>(String<span style="color:#bbb"> </span>key)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getProperty</span>(String<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>defaultValue)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Properties<span style="color:#bbb"> </span>properties<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Properties();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>properties.<span style="color:#4070a0">load</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileInputStream(<span style="color:#4070a0">&#34;data/config.properties&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>String<span style="color:#bbb"> </span>host<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>properties.<span style="color:#4070a0">getProperty</span>(<span style="color:#4070a0">&#34;db.host&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">int</span><span style="color:#bbb"> </span>port<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Integer.<span style="color:#4070a0">valueOf</span>(properties.<span style="color:#4070a0">getProperty</span>(<span style="color:#4070a0">&#34;db.port&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;3306&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(host);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用类Properties处理属性文件的好处是：</p>
<ul>
<li>可以自动处理空格，分隔符=前后的空格会被自动忽略。</li>
<li>可以自动忽略空行。</li>
<li>可以添加注释，以字符#或！开头的行会被视为注释，进行忽略。</li>
</ul>
<p>使用Properties也有限制：<strong>不能直接处理中文，在配置文件中，所有非ASCII字符需要使用Unicode编码</strong>。比如：能在配置文件中直接这么写<code>name=老马</code>，要写成<code>name=\u8001\u9A6C</code>。</p>
<blockquote>
<p>在Java IDE（如Eclipse）中使用属性文件编辑器，会地总替换中文为Unicode编码；</p>
<p>也可以用jdk命令<code>native2ascii</code>可用来转换为Unicode编码。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>native2ascii<span style="color:#bbb"> </span><span style="color:#666">-</span>encoding<span style="color:#bbb"> </span>UTF<span style="color:#666">-</span>8<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span>.<span style="color:#4070a0">properties</span><span style="color:#bbb"> </span>ascii.<span style="color:#4070a0">properties</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="csv文件">CSV文件</h4>
<p>CSV是Comma-Separated Values的缩写，表示逗号分隔值。</p>
<p>一般，一行表示一条<strong>记录</strong>，一条记录包含多个<strong>字段</strong>，字段之间用逗号（也可以是tab符<code>\t</code>、冒号<code>:</code>、分号<code>; </code>等）分隔。</p>
<p>各种日志文件通常是CSV文件。CSV也经常用于交换表格类型的数据。</p>
<p>CSV看上去很简单，但处理的复杂性经常被低估。</p>
<ul>
<li>字段内容中包含分隔符怎么办？</li>
<li>字段内容中包含换行符怎么办？</li>
</ul>
<p>两种处理方式：</p>
<ol>
<li>使用引用符号比如&quot;，在字段内容两边加上&quot;，如果内容中包含&quot;本身，则使用两个&quot;</li>
<li>使用转义字符，常用的是\，如果内容中包含\，则使用两个\。</li>
</ol>
<p>其它问题：</p>
<ul>
<li>怎么表示null值</li>
<li>空行和字段之间的空格怎么处理</li>
<li>怎么表示注释</li>
</ul>
<p>这些问题使用简单的字符流就难以处理了，需要第三方库<a href="http://commons.apache.org/proper/commons-csv/index.html">Apache Commons CSV</a>，<code>CSVFormat</code>表示CSV的格式，它有很多方法以定义具体的CSV格式：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//定义分隔符</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVFormat<span style="color:#bbb"> </span><span style="color:#06287e">withDelimiter</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>delimiter)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//定义引号符</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVFormat<span style="color:#bbb"> </span><span style="color:#06287e">withQuote</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>quoteChar)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//定义转义符</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVFormat<span style="color:#bbb"> </span><span style="color:#06287e">withEscape</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>escape)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//定义值为null的对象对应的字符串值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVFormat<span style="color:#bbb"> </span><span style="color:#06287e">withNullString</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>nullString)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//定义记录之间的分隔符</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVFormat<span style="color:#bbb"> </span><span style="color:#06287e">withRecordSeparator</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>recordSeparator)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//定义是否忽略字段之间的空白</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVFormat<span style="color:#bbb"> </span><span style="color:#06287e">withIgnoreSurroundingSpaces</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>ignoreSurroundingSpaces)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>分析字符流：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>CSVParser<span style="color:#bbb"> </span><span style="color:#06287e">parse</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Reader<span style="color:#bbb"> </span>in)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>CSVParser</code>的方法获取记录信息：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-50-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-50-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-50-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Iterator<span style="color:#666">&lt;</span>CSVRecord<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">iterator</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>CSVRecord<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">getRecords</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">getRecordNumber</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>CSVRecord</code>表示一条记录，它有获取每个字段的信息方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#60a0b0;font-style:italic">//根据字段列索引获取值，索引从0开始</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">get</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>i)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//根据列名获取值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">get</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//字段个数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">size</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//字段的迭代器</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Iterator<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">iterator</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>CSVPrinter</code>用来写CSV文件。</p>
<h4 id="excel">Excel</h4>
<p>Excel主要有两种格式：<code>.xls</code>和<code>.xlsx</code>（Office 2007以后）。</p>
<p>Java中处理Excel文件及其他微软文档广泛使用<a href="http://poi.apache.org/">POI类库</a>，主要类：</p>
<ul>
<li><code>Workbook</code>：表示一个Excel文件对象，它是一个接口，有两个主要类<code>HSSFWorkbook</code>和<code>ⅩSSFWorkbook</code>，前者对应.xls格式，后者对应.xlsx格式。</li>
<li><code>Sheet</code>：表示一个工作表。</li>
<li><code>Row</code>：表示一行。</li>
<li><code>Cell</code>：表示一个单元格。</li>
</ul>
<p>更加复杂的使用，如配置单元格的格式、颜色、字体： <a href="http://poi.apache.org/spreadsheet/quick-guide.html">http://poi.apache.org/spreadsheet/quick-guide.html</a></p>
<h4 id="html">HTML</h4>
<p>HTML分析器:<a href="https://jsoup.org/">jsoup</a></p>
<h4 id="压缩文件">压缩文件</h4>
<p>java SDK支持两种压缩文件格式：gzip（一个文件）和zip（多个文件）。</p>
<p>gzip两个主要类：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>java.<span style="color:#4070a0">util</span>.<span style="color:#4070a0">zip</span>.<span style="color:#4070a0">GZIPOutputStream</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java.<span style="color:#4070a0">util</span>.<span style="color:#4070a0">zip</span>.<span style="color:#4070a0">GZIPInputStream</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>zip的主要类：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>java.<span style="color:#4070a0">util</span>.<span style="color:#4070a0">zip</span>.<span style="color:#4070a0">ZipOutputStream</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java.<span style="color:#4070a0">util</span>.<span style="color:#4070a0">zip</span>.<span style="color:#4070a0">ZipInputStream</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ZipOutputStream可以写入多个文件，它有一个重要方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">putNextEntry</span>(ZipEntry<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>压缩条目<code>ZipEntry</code></p>
<p>🔖</p>
<p>如果需要更多格式，可以使用<a href="http://commons.apache.org/proper/commons-compress/">Apache Commons Compress</a>。</p>
<h3 id="142-随机读写文件">14.2 随机读写文件</h3>
<p>RandomAccessFile</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">RandomAccessFile</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>DataOutput,<span style="color:#bbb"> </span>DataInput,<span style="color:#bbb"> </span>Closeable<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="用法">用法</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">RandomAccessFile</span>(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>mode)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">RandomAccessFile</span>(File<span style="color:#bbb"> </span>file,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>mode)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>FileNotFoundException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>mode的四个值：</p>
<ol>
<li>&ldquo;r&rdquo;：只用于读。</li>
<li>&ldquo;rw&rdquo;：用于读和写。</li>
<li>&ldquo;rws&rdquo;：和&quot;rw&quot;一样，另外，它要求文件<strong>内容和元数据</strong>的任何更新都同步到设备上。</li>
<li>&ldquo;rwd&rdquo;：和&quot;rw&quot;一样，另外，它要求文件内容的任何更新都同步到设备上，和&quot;rws&quot;的区别是，元数据的更新不要求同步。</li>
</ol>
<p>RandomAccessFile有类似InputStream/OutputStream的读写字节流的方法。还实现了DataInput/DataOutput接口。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#60a0b0;font-style:italic">//读一个字节，取最低8位，0～255</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">read</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">readInt</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">writeInt</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>v)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">write</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>另外两个特殊的read方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">readFully</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">readFully</span>(<span style="color:#902000">byte</span><span style="color:#bbb"> </span>b<span style="color:#666">[]</span>,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>off,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>len)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它们可以确保读够期望的长度，如果到了文件结尾也没读够，它们会抛出<strong>EOFException</strong>异常。</p>
<p>RandomAccessFile内部有一个<strong>文件指针</strong>，指向当前读写的位置，各种read/write操作都会自动更新该指针（本地方法）。与流不同的是，RandomAccessFile可以获取该指针，也可以更改该指针，相关方法是：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#60a0b0;font-style:italic">//获取当前文件指针</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">getFilePointer</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//更改当前文件指针到pos</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">seek</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>pos)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>RandomAccessFile是<strong>通过本地方法，最终调用操作系统的API来实现文件指针调整的</strong>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 跳过输入流中n个字节。类似InputStream的skip方法（通过实际读取n个字节实现的），但skipBytes通过更改文件指针实现</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">skipBytes</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>n)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 直接获取文件长度，返回文件字节数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">length</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 修改文件长度（当前文件会根据情况扩展或截取）</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setLength</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>newLength)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>避免使用下面两个方法，它们没有编码概念，都假定一个字节代表一个字符，对中文显然不成立：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">writeBytes</span>(String<span style="color:#bbb"> </span>s)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">readLine</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="设计一个键值数据库basicdb">设计一个键值数据库BasicDB❤️</h4>
<p>在日常的一般文件读写中，使用流就可以了，但在一些系统程序中，流是不适合的， RandomAccessFile因为更接近操作系统，更为方便和高效。</p>
<h3 id="143-内存映射文件">14.3 内存映射文件🔖</h3>
<blockquote>
<p>内存映射文件不是Java引入的概念，而是操作系统提供的一种功能，大部分操作系统都支持。</p>
</blockquote>
<h4 id="基本概念">基本概念</h4>
<p>==内存映射文件==，就是<strong>将文件映射到内存，文件对应于内存中的一个字节数组，对文件的操作变为对这个字节数组的操作，而字节数组的操作直接映射到文件上</strong>。这种映射可以是映射文件全部区域，也可以是只映射一部分区域。</p>
<p>不过，这种映射是操作系统提供的一种==假象==，文件一般不会马上加载到内存，操作系统只是记录下了这回事，当实际发生读写时，才会按需加载。操作系统一般是按页加载的，页可以理解为就是一块，页的大小与操作系统和硬件相关，典型的配置可能是4K、8K等，当操作系统发现读写区域不在内存时，就会加载该区域对应的一个页到内存。</p>
<p>这种按需加载的方式，使得内存映射文件可以==方便高效地处理非常大的文件==，内存放不下整个文件也不要紧，操作系统会自动进行处理，将需要的内容读到内存，将修改的内容保存到硬盘，将不再使用的内存释放。</p>
<p>在应用程序写的时候，它写的是内存中的字节数组，这个内容什么时候同步到文件上呢？这个时机是不确定的，由操作系统决定，不过，<!-- raw HTML omitted -->只要操作系统不崩溃，操作系统会保证同步到文件上，即使映射这个文件的应用程序已经退出了。<!-- raw HTML omitted --></p>
<p>在一般的文件读写中，会有两次数据复制，一次是从硬盘复制到操作系统内核，另一次是从操作系统内核复制到用户态的应用程序。而在内存映射文件中，一般情况下，==只有一次复制==，且内存分配在操作系统内核，应用程序访问的就是操作系统的内核内存空间，这显然要<strong>比普通的读写效率更高</strong>。</p>
<p>内存映射文件的另一个重要特点是：它可以被多个不同的应用程序==共享==，多个程序可以映射同一个文件，映射到同一块内存区域，一个程序对内存的修改，可以让其他程序也看到，这使得它特别适合用于==不同应用程序之间的通信==。</p>
<p>操作系统自身在加载可执行文件的时候，一般都利用了内存映射文件，比如：</p>
<ul>
<li>按需加载代码，只有当前运行的代码在内存，其他暂时用不到的代码还在硬盘。</li>
<li>同时启动多次同一个可执行文件，文件代码在内存也只有一份。</li>
<li>不同应用程序共享的动态链接库代码在内存也只有一份。</li>
</ul>
<p>内存映射文件也有==局限性==。比如，<!-- raw HTML omitted -->它不太适合处理小文件，它是按页分配内存的，对于小文件，会浪费空间；另外，映射文件要消耗一定的操作系统资源，初始化比较慢<!-- raw HTML omitted -->。</p>
<blockquote>
<p>总结，对于一般的文件读写不需要使用内存映射文件，但如果处理的是大文件，要求极高的读写效率，比如数据库系统，或者需要在不同程序间进行共享和通信，那就可以考虑内存映射文件。</p>
</blockquote>
<h4 id="用法-1">用法</h4>
<h4 id="设计一个消息队列basicqueue">设计一个消息队列BasicQueue</h4>
<h4 id="实现消息队列">实现消息队列</h4>
<p>内存映射文件在日常普通的文件读写中，用到得比较少，但在<strong>一些系统程序中，它却是经常被用到的一把利器</strong>，可以高效地读写大文件，且能实现不同程序间的共享和通信。</p>
<h3 id="144-标准序列化机制">14.4 标准序列化机制🔖</h3>
<p>之前在将对象保存到文件时，使用的是DataOutputStream，从文件读入对象时，使用的是DataInputStream，使用它们，需要逐个处理对象中的每个字段，这种方式比较啰嗦，Java中有一种更为简单的机制，那就是序列化。</p>
<p>简单来说，==序列化就是将对象转化为字节流，反序列化就是将字节流转化为对象==。</p>
<h4 id="基本用法">基本用法</h4>
<p><code>java.io.Serializable</code></p>
<p>声明实现了Serializable接口后，保存/读取Student对象就可以使用<code>ObjectOutputStream</code>/<code>ObjectInputStream</code>流了。</p>
<p>将对象obj转化为字节，写到流中：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">writeObject</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>从流中读取字节，转化为一个对象：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">readObject</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ClassNotFoundException,<span style="color:#bbb"> </span>IOException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="复杂对象">复杂对象</h4>
<p>Java序列化机制能自动处理引用同一个对象的情况，也能自动处理循环引用的情况。</p>
<h4 id="定制序列化">定制序列化</h4>
<p>Java提供了多种定制序列化的机制，主要的有两种：</p>
<ol>
<li>transient关键字，</li>
<li>实现writeObject和readObject方法。</li>
</ol>
<h4 id="序列化的基本原理">序列化的基本原理</h4>
<h4 id="版本问题">版本问题</h4>
<h4 id="序列化特点分析">序列化特点分析</h4>
<p>序列化的主要用途有两个：</p>
<ul>
<li>对象持久化；</li>
<li>跨网络的数据交换、远程过程调用。</li>
</ul>
<p>Java标准的序列化机制有很多优点：</p>
<ul>
<li>使用简单</li>
<li>可自动处理对象引用和循环引用</li>
<li>也可以方便地进行定制，处理版本问题</li>
</ul>
<p>局限性：</p>
<ul>
<li>Java序列化格式是一种私有格式，是一种Java特有的技术，不能被其他语言识别，不能实现跨语言的数据交换。</li>
<li>Java在序列化字节中保存了很多描述信息，使得序列化格式比较大。</li>
<li>Java的默认序列化使用反射分析遍历对象结构，性能比较低。</li>
<li>Java的序列化格式是二进制的，不方便查看和修改。</li>
</ul>
<p>在跨语言的数据交换格式中，ⅩML/JSON是被广泛采用的文本格式，各种语言都有对它们的支持，文件格式清晰易读。有很多查看和编辑工具，它们的不足之处是<strong>性能和序列化大小</strong>，在性能和大小敏感的领域，往往会采用更为精简高效的二进制方式，如<strong>ProtoBuf、Thrift、MessagePack</strong>等。</p>
<h3 id="145-使用jackson序列化为jsonxmlmessagepack">14.5 使用Jackson序列化为JSON/XML/MessagePack❤️</h3>
<p>Java的标准序列化机制有一些重要的限制，而且不能跨语言，实践中经常使用一些替代方案，比如ⅩML/JSON/MessagePack。Java SDK中对这些格式的支持有限，有很多第三方的类库提供了更为方便的支持，Jackson是其中一种，它支持多种格式。</p>
<p>Jackson起初主要是用来支持JSON格式的，现在也支持很多其他格式，它的各种方式的使用方式是类似的。</p>
<h4 id="基本用法-1">基本用法</h4>
<h5 id="1json">1.Json</h5>
<p><code>ObjectMapper</code></p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;张三&#34;</span>,<span style="color:#bbb"> </span>21,<span style="color:#bbb"> </span>80.<span style="color:#4070a0">9d</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>ObjectMapper<span style="color:#bbb"> </span>mapper<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ObjectMapper();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>mapper.<span style="color:#4070a0">enable</span>(SerializationFeature.<span style="color:#4070a0">INDENT_OUTPUT</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>String<span style="color:#bbb"> </span>str<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>mapper.<span style="color:#4070a0">writeValueAsString</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(str);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>反序列化：</p>
<pre tabindex="0"><code class="language-jav" data-lang="jav">ObjectMapper mapper = new ObjectMapper();
Student s = mapper.readValue(new File(&#34;student.json&#34;), Student.class);
System.out.println(s.toString());
</code></pre><h5 id="2xml">2.xml</h5>
<p>只需要替换ObjectMapper为<code>ⅩmlMapper</code>🔖。<code>ⅩmlMapper</code>是ObjectMapepr的子类。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;张三&#34;</span>,<span style="color:#bbb"> </span>18,<span style="color:#bbb"> </span>80.<span style="color:#4070a0">9d</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>ObjectMapper<span style="color:#bbb"> </span>mapper<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>XmlMapper();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>mapper.<span style="color:#4070a0">enable</span>(SerializationFeature.<span style="color:#4070a0">INDENT_OUTPUT</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>String<span style="color:#bbb"> </span>str<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>mapper.<span style="color:#4070a0">writeValueAsString</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>mapper.<span style="color:#4070a0">writeValue</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#4070a0">&#34;student.xml&#34;</span>),<span style="color:#bbb"> </span>student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(str);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>反序列化：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ObjectMapper<span style="color:#bbb"> </span>mapper<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>XmlMapper();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Student<span style="color:#bbb"> </span>s<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>mapper.<span style="color:#4070a0">readValue</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#4070a0">&#34;student.xml&#34;</span>),<span style="color:#bbb"> </span>Student.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(s.<span style="color:#4070a0">toString</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="3messagepack">3.MessagePack</h5>
<blockquote>
<p>MessagePack是一种计算机数据交换格式。它是一种二进制形式，用于表示简单的数据结构，如数组和关系数组。MessagePack 旨在尽可能紧凑和简单。</p>
</blockquote>
<p><a href="https://msgpack.org/">https://msgpack.org/</a></p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#062873;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#062873;font-weight:bold">&lt;groupId&gt;</span>org.msgpack<span style="color:#062873;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#062873;font-weight:bold">&lt;artifactId&gt;</span>jackson-dataformat-msgpack<span style="color:#062873;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#062873;font-weight:bold">&lt;version&gt;</span>0.8.11<span style="color:#062873;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#062873;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">messagePack</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;李三&#34;</span>,<span style="color:#bbb"> </span>28,<span style="color:#bbb"> </span>81.<span style="color:#4070a0">9d</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>ObjectMapper<span style="color:#bbb"> </span>mapper<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ObjectMapper(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>MessagePackFactory());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>bytes<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>mapper.<span style="color:#4070a0">writeValueAsBytes</span>(student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>mapper.<span style="color:#4070a0">writeValue</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#4070a0">&#34;student.bson&#34;</span>),<span style="color:#bbb"> </span>student);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">messagePack2</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>IOException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>ObjectMapper<span style="color:#bbb"> </span>mapper<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ObjectMapper(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>MessagePackFactory());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Student<span style="color:#bbb"> </span>s<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>mapper.<span style="color:#4070a0">readValue</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#4070a0">&#34;student.bson&#34;</span>),<span style="color:#bbb"> </span>Student.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(s.<span style="color:#4070a0">toString</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="images/image-20231109111642770.png"></p>
<h4 id="容器对象">容器对象</h4>
<h5 id="1list">1.List</h5>
<h5 id="2map">2.Map</h5>
<h4 id="复杂对象-1">复杂对象</h4>
<h4 id="定制序列化-1">定制序列化</h4>
<p>Jackson两种配置方法：</p>
<ol>
<li>注解</li>
<li>配置ObjectMapper对象，ObjectMapper支持对序列化和反序列化过程做一些配置</li>
</ol>
<h4 id="jackson对xml支持的局限性">Jackson对XML支持的局限性</h4>
<p>对于ⅩML格式，Jackson的支持不是太全面。比如，对于一个<code>Map&lt;String, List&lt;String&gt;&gt;</code>对象，Jackson可以序列化，但不能反序列化</p>
<p>Jackson还支持很多其他格式，如YAML、AVRO、Protobuf、Smile等。</p>
<h1 id="五并发">五、并发</h1>
<h2 id="15-并发基础知识">15 并发基础知识</h2>
<h3 id="151-线程的基本概念">15.1 线程的基本概念</h3>
<h4 id="创建线程">创建线程</h4>
<p>线程表示一条单独的<strong>执行流</strong>，它有自己的程序<strong>执行计数器</strong>，有自己的<strong>栈</strong>。</p>
<p>Java中创建线程有两种方式：</p>
<h5 id="1继承thread">1.继承Thread</h5>
<p>继承Thread并重写其run方法来实现一个线程。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">HelloThread</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>HelloThread<span style="color:#bbb"> </span>thread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>HelloThread();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>thread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>run方法的方法<strong>签名是固定的</strong>， public，没有参数，没有返回值，不能抛出受检异常。</p>
<p>run方法类似于单线程程序中的main方法，线程<!-- raw HTML omitted -->从run方法的第一条语句开始执行<!-- raw HTML omitted -->直到结束。</p>
<p>start方法表示<strong>启动</strong>该线程，使其成为一条<strong>单独的执行流</strong>，操作系统会分配线程相关的资源，每个线程会有单独的程序执行计数器和栈，操作系统会把这个线程作为一个独立的个体进行调度，分配时间片让它执行，执行的起点就是run方法。</p>
<blockquote>
<p>如果不调用start，而直接调用run方法呢？</p>
<p>屏幕的输出并不会发生变化，但并不会启动一条单独的执行流，run方法的代码依然是在main线程中执行的，run方法只是main方法调用的一个普通方法。</p>
</blockquote>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span><span style="color:#06287e">currentThread</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">getId</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getName</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>操作系统负责调度，<!-- raw HTML omitted -->在单CPU的机器上，同一时刻只能有一个线程在执行，在多CPU的机器上，同一时刻可以有多个线程同时执行<!-- raw HTML omitted -->，但操作系统给我们屏蔽了这种差异，给程序员的感觉就是多个线程并发执行。</p>
<h5 id="2实现runnable接口">2.实现Runnable接口</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">HelloRunnable</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>Runnable<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>Thread<span style="color:#bbb"> </span>helloThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>HelloRunnable());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>helloThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="线程的基本属性和方法">线程的基本属性和方法</h4>
<h5 id="1id和name">1.id和name</h5>
<h5 id="2优先级">2.优先级</h5>
<p>在Java中，优先级从1到10，默认为5。</p>
<p>优先级对操作系统而言主要是一种<strong>建议和提示，而非强制</strong>。</p>
<h5 id="3状态">3.状态</h5>
<p><code>Thread.State</code></p>
<ol>
<li><code>NEW</code>：没有调用start的线程状态为NEW。</li>
<li><code>TERMINATED</code>：线程运行结束后状态为TERMINATED。</li>
<li><code>RUNNABLE</code>：调用start后线程在执行run方法且没有阻塞时状态为RUNNABLE，不过，RUNNABLE不代表CPU一定在执行该线程的代码，可能正在执行也可能在等待操作系统分配时间片，只是它没有在等待其他条件。</li>
<li><code>BLOCKED</code>、<code>WAITING</code>、<code>TIMED_WAITING</code>：都表示线程被阻塞了，在等待一些条件。</li>
</ol>
<p>另外isAlive方法，线程被启动后，run方法运行结束前，返回值都是true。</p>
<h5 id="4是否daemon线程">4.是否daemon线程</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-73-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-73-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-73-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-73-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setDaemon</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>on)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isDaemon</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>启动线程会启动一条单独的执行流，整个程序只有在所有线程都结束的时候才退出，但daemon线程是例外，当<strong>整个程序中剩下的都是daemon线程的时候，程序就会退出</strong>。</p>
<p>daemon线程一般是其他线程的<strong>辅助线程</strong>（如垃圾回收），在它辅助的主线程退出的时候，它就没有存在的意义了。</p>
<h5 id="5sleep方法">5.sleep方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sleep</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>millis)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>睡眠期间，该线程会<strong>让出CPU</strong>，但睡眠的时间不一定是确切的给定毫秒数，可能有一定的偏差，<strong>偏差与系统定时器和操作系统调度器的准确度和精度有关</strong>。</p>
<p>睡眠期间，线程可以被中断，如果被中断，sleep会抛出<code>InterruptedException</code>。</p>
<h5 id="6yield方法">6.yield方法</h5>
<p>让出CPU（只是建议）:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">yield</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="7join方法">7.join方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">join</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>join方法，可以<strong>让调用join的线程等待该线程结束，再执行其它线程</strong>。在等待线程结束的过程中，这个等待可能被中断，如果被中断，会抛出<code>InterruptedException</code>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">HelloRunnable</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>Runnable<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>helloThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>HelloRunnable());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>helloThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;world&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果可能为(HelloThread没执行完，main线程可能就执行完了)：</p>
<pre tabindex="0"><code>world
hello
</code></pre><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">HelloRunnable</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>Runnable<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>helloThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>HelloRunnable());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>helloThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>helloThread.<span style="color:#4070a0">join</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;world&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>一直为：</p>
<pre tabindex="0"><code>hello
world
</code></pre><h5 id="8过时方法">8.过时方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">stop</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">suspend</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">resume</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="共享内存及可能存在的问题">共享内存及可能存在的问题</h4>
<p>每个线程表示一条单独的执行流，有自己的程序计数器，有自己的栈，但<strong>线程之间可以共享内存，它们可以访问和操作相同的对象</strong>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-28">28</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ShareMemoryDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>shared<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incrShared</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>shared<span style="color:#bbb"> </span><span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ChildThread</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ChildThread</span>(List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">list</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>list;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>incrShared();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>list.<span style="color:#4070a0">add</span>(Thread.<span style="color:#4070a0">currentThread</span>().<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>t1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ChildThread(list);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>t2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ChildThread(list);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>t1.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>t2.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>t1.<span style="color:#4070a0">join</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>t2.<span style="color:#4070a0">join</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(shared);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(list);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>定义了一个静态变量shared和静态内部类ChildThread，在main方法中，创建并启动了两个ChildThread对象，传递了相同的list对象，ChildThread的run方法访问了共享的变量shared和list,main方法最后输出了共享的shared和list的值，大部分情况会输出：</p>
<pre tabindex="0"><code>2
[Thread-0, Thread-1]
</code></pre><p>通过此例子说明<strong>执行流、内存和程序代码</strong>之间的关系：</p>
<ul>
<li>该例中有三条执行流，一条执行main方法，另外两条执行ChildThread的run方法。</li>
<li>不同执行流可以访问和操作相同的变量。</li>
<li>不同执行流可以执行相同的程序代码，如本例中incrShared方法，ChildThread的run方法，被两条ChildThread执行流执行，incrShared方法是在外部定义的，但被ChildThread的执行流执行。<strong>==在分析代码执行过程时，理解代码在被哪个线程执行是很重要的==</strong>。</li>
<li>当多条执行流执行相同的程序代码时，<strong>每条执行流都有单独的栈</strong>，方法中的参数和局部变量都有自己的一份。</li>
</ul>
<p>当多条执行流可以操作相同的变量时，可能会出现一些意料之外的结果：</p>
<h5 id="1竟态条件">1.竟态条件</h5>
<p>==竞态条件（race condition）==是指，当多个线程访问和操作同一个对象时，最终执行结果与==执行时序==有关，可能正确也可能不正确。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-21">21</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">CounterThread</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>counter<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>1000;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>counter<span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>num<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>1000;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#666">[]</span><span style="color:#bbb"> </span>threads<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread<span style="color:#666">[</span>num<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>num;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>CounterThread();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span>.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>num;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span>.<span style="color:#4070a0">join</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(counter);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>期望结果值为1000000，但一般都是不是。因为counter++这个操作不是==原子操作==，它分为三个步骤：</p>
<ol>
<li>取counter的当前值；</li>
<li>在当前值基础上加1；</li>
<li>将新值重新赋值给counter。</li>
</ol>
<p>两个线程可能同时执行第一步，取到了相同的counter值，比如都取到了100，第一个线程执行完后counter变为101，而第二个线程执行完后还是101，最终的结果就与期望不符。</p>
<p>解决办法：</p>
<ul>
<li>使用<code>synchronized</code>关键字；</li>
<li>使用显式锁；</li>
<li>使用原子变量。</li>
</ul>
<h5 id="2内存可见性">2.内存可见性</h5>
<p>多个线程可以共享访问和操作相同的变量，但<!-- raw HTML omitted -->一个线程对一个共享变量的修改，另一个线程不一定马上就能看到，甚至永远也看不到<!-- raw HTML omitted -->。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-19">19</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">VisibilityDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>shutdown<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">HelloThread</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>shutdown)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;exit hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>HelloThread().<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread.<span style="color:#4070a0">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>shutdown<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;exit main&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>期望的结果是两个线程都退出，但实际执行时，很可能会发现HelloThread永远都不会退出。也就是说，在HelloThread执行流看来，shutdown永远为false，即使main线程已经更改为了true。</p>
<p><strong>内存可见性问题</strong>。在计算机系统中，==除了内存，数据还会被缓存在CPU的寄存器以及各级缓存中，当访问一个变量时，可能直接从寄存器或CPU缓存中获取，而不一定到内存中去取，当修改一个变量时，也可能是先写到缓存中，稍后才会同步更新到内存中。==</p>
<p>在单线程的程序中，这一般不是问题，但在多线程的程序中，尤其是在有多CPU的情况下，这就是严重的问题。<strong>一个线程对内存的修改，另一个线程看不到，一是修改没有及时同步到内存，二是另一个线程根本就没从内存读。</strong></p>
<p>解决办法：</p>
<ul>
<li>使用<code>volatile</code>关键字。</li>
<li>使用<code>synchronized</code>关键字或显式锁同步。</li>
</ul>
<h4 id="线程的优点及成本">线程的优点及成本</h4>
<p>优点：</p>
<ol>
<li>充分利用<strong>多CPU的计算能力</strong>，单线程只能利用一个CPU，使用多线程可以利用多CPU的计算能力。</li>
<li>充分利用<strong>硬件资源</strong>，CPU和硬盘、网络是可以同时工作的，一个线程在等待网络IO的同时，另一个线程完全可以利用CPU，对于多个独立的网络请求，完全可以使用多个线程同时请求。</li>
<li>在用户界面（GUI）应用程序中，<!-- raw HTML omitted -->保持程序的响应性，界面和后台任务通常是不同的线程<!-- raw HTML omitted -->，否则，如果所有事情都是一个线程来执行，当执行一个很慢的任务时，整个界面将停止响应，也无法取消该任务。</li>
<li>简化建模及IO处理，比如，在服务器应用程序中，对每个用户请求使用一个单独的线程进行处理，相比使用一个线程，处理来自各种用户的各种请求，以及各种网络和文件IO事件，建模和编写程序要容易得多。</li>
</ol>
<p>成本：</p>
<ol>
<li>操作系统会为每个线程创建必要的数据结构、栈、程序计数器等，创建也需要一定的时间。</li>
<li>线程调度和切换也是有成本的。<strong>==上下文切换==</strong></li>
</ol>
<p>如果执行的任务都是CPU密集型的，即主要消耗的都是CPU，那创建超过CPU数量的线程就是没有必要的，并不会加快程序的执行。</p>
<h3 id="152-理解synchronized">15.2 理解synchronized</h3>
<p>共享内存的两种问题都可以通过synchronized解决。</p>
<h4 id="用法和基本原理">用法和基本原理</h4>
<p><code>synchronized</code>可以用于修饰类的<!-- raw HTML omitted --><strong>实例方法、静态方法和代码块</strong><!-- raw HTML omitted -->。</p>
<h5 id="1实例方法">1.实例方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-38">38</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Counter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incr</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>count<span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">CounterThread</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Counter<span style="color:#bbb"> </span>counter;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">CounterThread</span>(Counter<span style="color:#bbb"> </span>counter)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">counter</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>counter;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>1000;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>counter.<span style="color:#4070a0">incr</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>num<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>1000;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Counter<span style="color:#bbb"> </span>counter<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Counter();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#666">[]</span><span style="color:#bbb"> </span>threads<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread<span style="color:#666">[</span>num<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>num;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>CounterThread(counter);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span>.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>num;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span>.<span style="color:#4070a0">join</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(counter.<span style="color:#4070a0">getCount</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建了1000个线程，传递了相同的counter对象，每个线程主要就是调用Counter的incr方法1000次，main线程等待子线程结束后输出counter的值，不论运行多少次结果都是100万。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Counter<span style="color:#bbb"> </span>counter1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Counter();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Counter<span style="color:#bbb"> </span>counter2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Counter();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Thread<span style="color:#bbb"> </span>t1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>CounterThread(counter1);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Thread<span style="color:#bbb"> </span>t2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>CounterThread(counter2);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>t1.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>t2.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>t1和t2两个线程是可以同时执行Counter的incr方法的，因为它们访问的是不同的Counter对象，一个是counter1，另一个是counter2。</p>
<p><strong>synchronized实例方法实际保护的是同一个==对象==的方法调用</strong>（同时只能有一个线程执行同一对象的实例方法）。</p>
<p>synchronized实例方法保护的是当前实例对象，即this, this对象有<strong>一个锁和一个等待队列</strong>，锁只能被一个线程持有，其他试图获得同样锁的线程需要等待。执行synchronized实例方法的过程大致如下：</p>
<ol>
<li>尝试获得锁，如果能够获得锁，继续下一步，否则加入等待队列，阻塞并等待唤醒。</li>
<li>执行实例方法体代码。</li>
<li>释放锁，如果等待队列上有等待的线程，从中取一个并唤醒，如果有多个等待的线程，唤醒哪一个是不一定的，<strong>不保证公平性</strong>。</li>
</ol>
<p>当前线程不能获得锁的时候，它会加入等待队列等待，线程的状态会变为**==BLOCKED==**。</p>
<p>**==synchronized保护的是对象而非代码，只要访问的是同一个对象的synchronized方法，即使是不同的代码，也会被同步顺序访问。==**比如，对于Counter中的两个实例方法getCount和incr，对同一个Counter对象，一个线程执行getCount，另一个执行incr，它们是不能同时执行的，会被synchronized同步顺序执行。</p>
<p>synchronized方法不能防止非synchronized方法被同时执行。比如，如果给Counter类增加一个非synchronized方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">decr</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>count<span style="color:#666">--</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>则该方法可以和synchronized的incr方法同时执行，这通常会出现非期望的结果，所以，<strong>==一般在保护变量时，需要在所有访问该变量的方法上加上synchronized==</strong>。</p>
<h5 id="2静态方法">2.静态方法</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">StaticCounter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>count<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incr</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>count<span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对于静态方法，synchronized保护的是==类对象==，也就是<code>StaticCounter.class</code>。实际上，每个对象都有一个锁和一个等待队列，类对象也不例外。</p>
<h5 id="3代码块">3.代码块</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Counter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incr</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span>(<span style="color:#007020;font-weight:bold">this</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>count<span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span>(<span style="color:#007020;font-weight:bold">this</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">StaticCounter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>count<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incr</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span>(StaticCounter.<span style="color:#4070a0">class</span>){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>count<span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span>(StaticCounter.<span style="color:#4070a0">class</span>){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>synchronized括号里面的就是保护的对象，对于实例方法，就是<code>this</code>，对于静态方法，就是类对象， <code>{}</code>里面是同步执行的代码。</p>
<p>synchronized同步的对象可以是任意对象，<strong>==任意对象都有一个锁和等待队列==</strong>，或者说，任何对象都可以作为锁对象。比如，Counter类的等价代码还可以是：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Counter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>lock<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Object();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incr</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span>(lock){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>count<span style="color:#bbb"> </span><span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span>(lock){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="进一步了解synchronized">进一步了解synchronized</h4>
<h5 id="1可重入性">1.可重入性</h5>
<p><strong>对同一个执行线程，它在获得了锁之后，在调用其他需要同样锁的代码时，可以直接调用</strong>。比如，在一个synchronized实例方法内，可以直接调用其他synchronized实例方法。</p>
<p><strong>可重入是通过记录锁的==持有线程和持有数量==来实现的</strong>，当调用被synchronized保护的代码时，检查对象是否已被锁，如果是，再检查是否被当前线程锁定，如果是，增加持有数量，如果不是被当前线程锁定，才加入等待队列，当释放锁时，减少持有数量，当数量变为0时才释放整个锁。</p>
<h5 id="2内存可见性-1">2.内存可见性</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Switcher</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>on;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isOn</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>on;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setOn</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>on)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">on</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>on;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>synchronized除了==保证原子操作==外，它还有一个重要的作用，就是==保证内存可见性==，在释放锁时，所有写入都会写回内存，而获得锁后，都会从内存中读最新数据。</p>
<p>不过，如果只是为了保证内存可见性，使用synchronized的成本有点高，有一个更轻量级的方式，那就是给变量加修饰符<code>volatile</code>。</p>
<p>加了volatile之后，Java会在操作对应变量时插入特殊的指令，保证读写到内存最新值，而非缓存的值。</p>
<h5 id="3死锁">3.死锁🔖</h5>
<blockquote>
<p>有a、b两个线程，a持有锁A，在等待锁B，而b持有锁B，在等待锁A, a和b陷入了互相等待，最后谁都执行不下去</p>
</blockquote>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-46">46</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">DeadLockDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>lockA<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Object();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>lockB<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Object();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">startThreadA</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>aThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(lockA)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>Thread.<span style="color:#4070a0">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(InterruptedException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(lockB)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>aThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">startThreadB</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>bThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(lockB)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>Thread.<span style="color:#4070a0">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(InterruptedException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(lockA)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>bThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>startThreadA();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>startThreadB();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>应该尽量避免在持有一个锁的同时去申请另一个锁，如果确实需要多个锁，所有代码都应该按照相同的顺序去申请锁。</strong></p>
<p>显式锁接口<code>Lock</code>，它支持<!-- raw HTML omitted -->尝试获取锁（tryLock）和带时间限制的获取锁方法<!-- raw HTML omitted -->。🔖</p>
<p><code>jstack</code>会报告发现的死锁。</p>
<h4 id="同步容器及其注意事项">同步容器及其注意事项</h4>
<p>类Collections中有一些方法，可以返回<strong>线程安全的同步容器</strong>，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Collection<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">synchronizedCollection</span>(Collection<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">synchronizedList</span>(List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Map<span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">synchronizedMap</span>(Map<span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>m)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它们是给所有容器方法都加上synchronized来实现安全的，比如<code>SynchronizedCollection</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-20">20</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SynchronizedCollection</span><span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>Collection<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Collection<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c;<span style="color:#bbb">   </span><span style="color:#60a0b0;font-style:italic">//Backing Collection</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>mutex;<span style="color:#bbb">      </span><span style="color:#60a0b0;font-style:italic">//Object on which to synchronize</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>SynchronizedCollection(Collection<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(c<span style="color:#666">==</span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>NullPointerException();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">c</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>c;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>mutex<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">this</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">size</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(mutex)<span style="color:#bbb"> </span>{<span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>c.<span style="color:#4070a0">size</span>();<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">add</span>(E<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(mutex)<span style="color:#bbb"> </span>{<span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>c.<span style="color:#4070a0">add</span>(e);<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">remove</span>(Object<span style="color:#bbb"> </span>o)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(mutex)<span style="color:#bbb"> </span>{<span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>c.<span style="color:#4070a0">remove</span>(o);<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//…</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里线程安全针对的是<strong>容器对象</strong>，指的是当多个线程并发访问同一个容器对象时，不需要额外的同步操作，也不会出现错误的结果。🔖</p>
<p>加了synchronized，所有方法调用变成了原子操作，客户端在调用时，是不是就绝对安全了呢？不是的，至少有以下情况需要注意：1️⃣ 复合操作，比如先检查再更新。2️⃣ 伪同步。3️⃣ 迭代。</p>
<h5 id="1复合操作">1.复合操作</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-25">25</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">package</span><span style="color:#bbb"> </span><span style="color:#0e84b5;font-weight:bold">com.andyron.bcdlj.c15.c152</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">import</span><span style="color:#bbb"> </span><span style="color:#0e84b5;font-weight:bold">java.util.Collections</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">import</span><span style="color:#bbb"> </span><span style="color:#0e84b5;font-weight:bold">java.util.Map</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * @author andyron
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> **/</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">EnhancedMap</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Map<span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>map;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">EnhancedMap</span>(Map<span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>map)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">map</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Collections.<span style="color:#4070a0">synchronizedMap</span>(map);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>V<span style="color:#bbb"> </span><span style="color:#06287e">putIfAbsent</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>V<span style="color:#bbb"> </span>old<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">get</span>(key);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(old<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>old;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">put</span>(key,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>V<span style="color:#bbb"> </span><span style="color:#06287e">put</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">put</span>(key,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">// ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>map的每个方法都是安全的，但这个复合方法putIfAbsent是安全的吗？显然是否定的，这是一个检查然后再更新的复合操作，在多线程的情况下，可能有多个线程都执行完了检查这一步，都发现Map中没有对应的键，然后就会都调用put，这就破坏了putIfAbsent方法期望保持的语义。</p>
<h5 id="2伪同步">2.伪同步</h5>
<p>那给该方法加上synchronized就能实现安全吗？</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>V<span style="color:#bbb"> </span><span style="color:#06287e">putIfAbsent</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>value){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>V<span style="color:#bbb"> </span>old<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">get</span>(key);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span>(old<span style="color:#666">!</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#007020;font-weight:bold">null</span>){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>old;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">put</span>(key,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>答案是否定的！为什么呢？同步错对象了。putIfAbsent同步使用的是EnhancedMap对象，而其他方法（如代码中的put方法）使用的是Collections.synchronizedMap返回的对象map，两者是不同的对象。要解决这个问题，所有方法必须使用相同的锁，可以使用EnhancedMap的对象锁，也可以使用map。使用EnhancedMap对象作为锁，则EnhancedMap中的所有方法都需要加上synchronized。</p>
<p>使用map作为锁，putIfAbsent方法可以改为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>V<span style="color:#bbb"> </span><span style="color:#06287e">putIfAbsent</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>value){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">synchronized</span>(map){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>V<span style="color:#bbb"> </span>old<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">get</span>(key);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(old<span style="color:#666">!</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#007020;font-weight:bold">null</span>){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>old;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>map.<span style="color:#4070a0">put</span>(key,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="3迭代">3.迭代</h5>
<p>对于同步容器对象，虽然单个操作是安全的，但迭代并不是。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-35">35</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">IterationTest</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">startModifyThread</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>modifyThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Runnable()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>100;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>list.<span style="color:#4070a0">add</span>(<span style="color:#4070a0">&#34;item &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>i);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>Thread.<span style="color:#4070a0">sleep</span>((<span style="color:#902000">int</span>)<span style="color:#bbb"> </span>(Math.<span style="color:#4070a0">random</span>()<span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span>10));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(InterruptedException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>e.<span style="color:#4070a0">printStackTrace</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>modifyThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">startIteratorThread</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>Thread<span style="color:#bbb"> </span>iteratorThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Runnable()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">               </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(<span style="color:#007020;font-weight:bold">true</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                   </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(String<span style="color:#bbb"> </span>s<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                   </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">               </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>iteratorThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Collections.<span style="color:#4070a0">synchronizedList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>startIteratorThread(list);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>startModifyThread(list);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>抛出异常：</p>
<pre tabindex="0"><code>Exception in thread &#34;Thread-0&#34; java.util.ConcurrentModificationException
	at java.util.ArrayList$Itr.checkForComodification(ArrayList.java:911)
	at java.util.ArrayList$Itr.next(ArrayList.java:861)
	at com.andyron.bcdlj.c15.c152.IterationTest$2.run(IterationTest.java:37)
	at java.lang.Thread.run(Thread.java:750)
</code></pre><p>如果在遍历的同时容器发生了结构性变化，就会抛出该异常<code>ConcurrentModificationException</code>。</p>
<p>同步容器并没有解决这个问题，如果要避免这个异常，需要在遍历的时候给整个容器对象加锁。比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">startIteratorThread</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Thread<span style="color:#bbb"> </span>iteratorThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Runnable()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">while</span>(<span style="color:#007020;font-weight:bold">true</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#007020;font-weight:bold">synchronized</span>(list){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span><span style="color:#007020;font-weight:bold">for</span>(String<span style="color:#bbb"> </span>str<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>iteratorThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="4并发容器">4.并发容器</h5>
<p>除了以上这些注意事项，同步容器的性能也是比较低的，当并发访问量比较大的时候性能比较差。所幸的是，Java中还有很多专为并发设计的容器类，比如：</p>
<ul>
<li><code>CopyOnWriteArrayList</code>。</li>
<li><code>ConcurrentHashMap</code>。</li>
<li><code>ConcurrentLinkedQueue</code>。</li>
<li><code>ConcurrentSkipListSet</code>。</li>
</ul>
<p>这些容器类都是线程安全的，但都没有使用<code>synchronized</code>，没有迭代问题，直接支持一些复合操作，性能也高得多。</p>
<h3 id="153-线程的基本协作机制">15.3 线程的基本协作机制🔖</h3>
<p>多线程之间除了==竞争访问同一个资源==外，也经常需要==相互协作==。协作的基本机制是==wait/notify==。</p>
<h4 id="协作场景">协作场景</h4>
<ol>
<li>
<p>生产者/消费者协作模式</p>
<p>常见的协作模式，生产者线程和消费者线程通过<strong>共享队列</strong>进行协作，生产者将数据或任务放到队列上，而消费者从队列上取数据或任务，如果队列长度有限，在队列满的时候，生产者需要等待，而在队列为空的时候，消费者需要等待。</p>
</li>
<li>
<p>同时开始</p>
<p>类似运动员比赛，在听到比赛开始枪响后同时开始，在一些程序，尤其是<strong>模拟仿真程序</strong>中，要求多个线程能同时开始。</p>
</li>
<li>
<p>等待结束</p>
<p><strong>主从协作模式</strong>也是一种常见的协作模式，主线程将任务分解为若干子任务，为每个子任务创建一个线程，主线程在继续执行其他任务之前需要等待每个子任务执行完毕。</p>
</li>
<li>
<p>异步结果</p>
<p>在主从协作模式中，主线程手工创建子线程的写法往往比较麻烦，一种常见的模式是将子线程的管理封装为<strong>异步调用</strong>，异步调用马上返回，但返回的不是最终的结果，而是一个一般称为**<code>Future</code>**的对象，通过它可以在随后获得最终的结果。</p>
</li>
<li>
<p>集合点</p>
<p>类似于学校或公司组团旅游，在旅游过程中有若干集合点，比如出发集合点，每个人从不同地方来到集合点，所有人到齐后进行下一项活动，在一些程序，比如<!-- raw HTML omitted -->并行迭代计算<!-- raw HTML omitted -->中，每个线程负责一部分计算，然后在集合点等待其他线程完成，所有线程到齐后，<!-- raw HTML omitted -->交换数据和计算结果<!-- raw HTML omitted -->，再进行下一次迭代。</p>
</li>
</ol>
<h4 id="waitnotify">wait/notify</h4>
<p>线程协作的基本方法定义在根父类Object里，是每个对象都可以调用这些方法。</p>
<p>wait方法有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-103-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-103-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-103-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-103-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-103-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-103-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">wait</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">wait</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>timeout)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">wait</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>timeout,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>nanos)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>带时间参数的表示最多等待这么长时间，参数为0表示无限期等待；不带时间参数的就表示无限期等待。</p>
<p><strong>除了用于锁的等待队列，每个对象还有另一个等待队列，表示==条件队列==，该队列用于线程间的协作。</strong></p>
<p>调用wait就会把当前线程<!-- raw HTML omitted -->放到条件队列上并阻塞<!-- raw HTML omitted -->，表示当前线程执行不下去了，它需要等待一个条件，这个条件它自己改变不了，需要其他线程改变。</p>
<p>当其他线程改变了条件后，应该调用Object的notify方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">notify</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">notifyAll</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>notify做的事情就是<strong>从条件队列中选一个线程，将其从队列中移除并唤醒</strong>，notifyAll和notify的区别是，它会<strong>移除条件队列中所有的线程并全部唤醒</strong>。</p>
<p>一个线程启动后，在执行一项操作前，它需要等待主线程给它指令，收到指令后才执行：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-30">30</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">WaitThread</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">volatile</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>fire<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(<span style="color:#007020;font-weight:bold">this</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>fire)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>wait();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;fired&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(InterruptedException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">fire</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">fire</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>notify();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>WaitThread<span style="color:#bbb"> </span>waitThread<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>WaitThread();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>waitThread.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread.<span style="color:#4070a0">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;fire&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>waitThread.<span style="color:#4070a0">fire</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>两个线程，一个是主线程，一个是WaitThread，协作的条件变量是fire, WaitThread等待该变量变为true，在不为true的时候调用wait，主线程设置该变量并调用notify。</p>
<p>实际上，<strong>==wait/notify方法只能在synchronized代码块内被调用==</strong>，如果调用wait/notify方法时，当前线程没有持有对象锁，会抛出异常<code>java.lang.IllegalMonitorStateException</code>。</p>
<p><strong>虽然是在synchronized方法内，但调用wait时，线程会释放对象锁</strong>。wait的具体过程是：</p>
<ol>
<li>把当前线程放入条件等待队列，释放对象锁，阻塞等待，线程状态变为<strong>WAITING</strong>或<strong>TIMED_WAITING</strong>。</li>
<li>等待时间到或被其他线程调用notify/notifyAll从条件队列中移除，这时，要重新竞争对象锁：
<ul>
<li>如果能够获得锁，线程状态变为<strong>RUNNABLE</strong>，并从wait调用中返回。</li>
<li>否则，该线程加入对象锁等待队列，线程状态变为<strong>BLOCKED</strong>，只有在获得锁后才会从wait调用中返回。</li>
</ul>
</li>
</ol>
<blockquote>
<p>wait等的到底是什么？ 而notify通知的又是什么?</p>
</blockquote>
<p>它们被不同的线程调用，但共享相同的锁和条件等待队列（相同对象的synchronized代码块内），它们围绕一个<!-- raw HTML omitted -->共享的条件变量<!-- raw HTML omitted -->进行协作，这个条件变量是程序自己维护的，当条件不成立时，线程调用wait进入条件等待队列，另一个线程修改了条件变量后调用notify，调用wait的线程唤醒后需要重新检查条件变量。从多线程的角度看，它们围绕共享变量进行协作，从调用wait的线程角度看，它阻塞等待一个条件的成立。</p>
<p>设计多线程协作时，需要**==想清楚协作的共享变量和条件是什么==**，这是协作的核心。</p>
<h4 id="生产者消费者模式">生产者/消费者模式</h4>
<p>在生产者/消费者模式中，协作的共享变量是<strong>队列</strong>，生产者往队列上放数据，如果满了就wait，而消费者从队列上取数据，如果队列为空也wait。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-29">29</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 生产者/消费者协作队列
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * @author andyron
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> **/</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">MyBlockingQueue</span><span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Queue<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>queue<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>limit;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">MyBlockingQueue</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>limit)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">limit</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>limit;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>queue<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayDeque<span style="color:#666">&lt;&gt;</span>(limit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">put</span>(E<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(queue.<span style="color:#4070a0">size</span>()<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>limit)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>wait();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>queue.<span style="color:#4070a0">add</span>(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>notifyAll();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>E<span style="color:#bbb"> </span><span style="color:#06287e">take</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(queue.<span style="color:#4070a0">isEmpty</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>wait();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>E<span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>queue.<span style="color:#4070a0">poll</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>notifyAll();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>e;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>put是给生产者使用的，往队列上放数据，满了就wait，放完之后调用notifyAll，通知可能的消费者。</p>
<p>take是给消费者使用的，从队列中取数据，如果为空就wait，取完之后调用notifyAll，通知可能的生产者。</p>
<p><!-- raw HTML omitted -->put等待的是队列不为满，而take等待的是队列不为空<!-- raw HTML omitted -->，但它们都会加入相同的条件等待队列。由于条件不同但又使用相同的等待队列，所以要调用notifyAll而不能调用notify，因为notify只能唤醒一个线程，如果唤醒的是同类线程就起不到协调的作用。</p>
<p>==只能有一个条件等待队列==，这是Java wait/notify机制的局限性，这使得对于等待条件的分析变得复杂，后续章节我们会介绍<strong>显式的锁和条件</strong>，它可以解决该问题。</p>
<p>Java提供了专门的阻塞队列实现：</p>
<ul>
<li>接口<code>BlockingQueue</code>和<code>BlockingDeque</code>。</li>
<li>基于数组的实现类ArrayBlockingQueue。</li>
<li>基于链表的实现类LinkedBlockingQueue和LinkedBlockingDeque。</li>
<li>基于堆的实现类PriorityBlockingQueue。</li>
</ul>
<h4 id="同时开始">同时开始</h4>
<p>同时开始，类似于运动员比赛，在听到比赛开始枪响后同时开始。</p>
<h4 id="等待结束">等待结束</h4>
<p>join实际上就是调用了wait。</p>
<p><code>CountDownLatch</code></p>
<h4 id="异步结果">异步结果</h4>
<p>在主从模式中，手工创建线程往往比较麻烦，一种常见的模式是异步调用，异步调用返回一个一般称为<code>Future</code>的对象，通过它可以获得最终的结果。在Java中，表示子任务的接口是<code>Callable</code>，声明为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-107-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-107-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-107-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-107-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-107-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-107-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Callable</span><span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>V<span style="color:#bbb"> </span><span style="color:#06287e">call</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Java一套完善的框架<code>Executors</code>，相关的部分接口和类有：</p>
<ul>
<li>表示异步结果的接口<code>Future</code>和实现类<code>FutureTask</code>。</li>
<li>用于执行异步任务的接口<code>Executor</code>，以及有更多功能的子接口<code>ExecutorService</code>。</li>
<li>用于创建<code>Executor</code>和<code>ExecutorService</code>的工厂方法类<code>Executors</code>。</li>
</ul>
<h4 id="集合点">集合点</h4>
<p>协作的共享变量依然是一个数，这个数表示未到集合点的线程个数，初始值为子线程个数，每个线程到达集合点后将该值减一，如果不为0，表示还有别的线程未到，进行等待，如果变为0，表示自己是最后一个到的，调用notifyAll唤醒所有线程。</p>
<h3 id="154-线程的中断">15.4 线程的中断</h3>
<blockquote>
<p>如何在Java中取消或关闭一个线程？</p>
</blockquote>
<h4 id="取消关闭的场景">取消/关闭的场景</h4>
<p>线程的start方法启动一个线程后，线程开始执行run方法，run方法运行结束后线程退出，那为什么还需要结束一个线程呢？</p>
<ol>
<li>很多线程的运行模式是死循环。比如在生产者/消费者模式中，消费者主体就是一个死循环，它不停地从队列中接受任务，执行任务，在停止程序时，我们需要一种“优雅”的方法以关闭该线程。</li>
<li>在一些图形用户界面程序中，线程是用户启动的，完成一些任务，比如从远程服务器上下载一个文件，在下载过程中，用户可能会希望取消该任务。</li>
<li>在一些场景中，比如从第三方服务器查询一个结果，我们希望在限定的时间内得到结果，如果得不到，我们会希望取消该任务。</li>
<li>有时，我们会启动<strong>多个线程做同一件事</strong>，比如类似抢火车票，我们可能会让多个好友帮忙从多个渠道买火车票，只要有一个渠道买到了，我们会通知取消其他渠道。</li>
</ol>
<h4 id="取消关闭的机制">取消/关闭的机制</h4>
<p>在Java中，停止一个线程的主要机制是**==中断==**，<strong>中断并不是强迫终止一个线程，它是一种协作机制，是给线程传递一个取消信号，但是由线程来决定如何以及何时退出</strong>。</p>
<p>Thread类关于中断的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isInterrupted</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">interrupt</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">interrupted</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>isInterrupted：返回对应线程的中断标志位是否为true。</li>
<li>interrupt：表示中断对应的线程。</li>
<li>interrupted：返回当前线程的中断标志位是否为true（会调用Thread.currentThread()），但它还有一个重要的副作用，就是清空中断标志位，也就是说，连续两次调用interrupted()，第一次返回的结果为true，第二次一般就是false（除非同时又发生了一次中断）。</li>
</ul>
<h4 id="线程对中断的反应">线程对中断的反应🔖</h4>
<p><code>interrupt()</code>对线程的影响与==线程的状态==和在进行的==IO操作==有关。</p>
<p>线程状态有：</p>
<h5 id="1runnable">1.RUNNABLE</h5>
<p>线程在运行或具备运行条件只是在等待操作系统调度。</p>
<h5 id="2waitingtimed_waiting">2.WAITING/TIMED_WAITING</h5>
<p>线程在等待某个条件或超时。</p>
<p>线程调用join/wait/sleep方法会进入WAITING或TIMED_WAITING状态，在这些状态时，对线程对象调用interrupt()会使得该线程抛出<code>InterruptedException</code>。需要注意的是，抛出异常后，中断标志位会被清空，而不是被设置。</p>
<h5 id="3blocked">3.BLOCKED</h5>
<p>线程在等待锁，试图进入同步块。</p>
<p>如果线程在等待锁，对线程对象调用interrupt()只是会设置线程的中断标志位，线程依然会处于BLOCKED状态，也就是说，<!-- raw HTML omitted -->interrupt()并不能使一个在等待锁的线程真正“中断”<!-- raw HTML omitted -->。</p>
<h5 id="4newterminated">4.NEW/TERMINATED</h5>
<p>线程还未启动或已结束。</p>
<p>如果线程尚未启动（NEW），或者已经结束（TERMINATED），则调用interrupt()对它没有任何效果，中断标志位也不会被设置。</p>
<h4 id="如何正确地取消关闭线程">如何正确地取消/关闭线程</h4>
<p>interrupt方法不一定会真正“中断”线程，它只是一种<strong>协作机制</strong>，如果不明白线程在做什么，不应该贸然地调用线程的interrupt方法，以为这样就能取消线程。</p>
<p>对于以线程提供服务的程序模块而言，它应该<strong>封装取消/关闭操作</strong>，提供单独的取消/关闭方法给调用者，外部调用者应该调用这些方法而不是直接调用interrupt。Java并发库的一些代码就提供了单独的取消/关闭方法，比如，Future接口提供了如下方法以取消任务：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">cancel</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>mayInterruptIfRunning);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ExecutorService提供了如下两个关闭方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">shutdown</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>List<span style="color:#666">&lt;</span>Runnable<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">shutdownNow</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="16-并发包的基石">16 并发包的基石</h2>
<p><code>java.util.concurrent</code>，包括很多易用且高性能的并发开发工具。</p>
<h3 id="161-原子变量和cas">16.1 原子变量和CAS</h3>
<p>对于count++这种操作来说，使用synchronized<strong>成本太高</strong>了，需要<!-- raw HTML omitted -->先获取锁，最后需要释放锁，获取不到锁的情况下需要等待，还会有线程的上下文切换<!-- raw HTML omitted -->，这些都需要成本。</p>
<p>可使用原子变量替代，Java并发包中的基本**==原子变量==**类型有很多种。</p>
<ul>
<li><code>AtomicBoolean</code>：原子Boolean类型，常用来在程序中表示一个标志位。</li>
<li><code>AtomicInteger</code>：原子Integer类型。</li>
<li><code>AtomicLong</code>：原子Long类型，常用来在程序中生成唯一序列号。</li>
<li><code>AtomicReference</code>：原子引用类型，用来以原子方式更新复杂类型。</li>
</ul>
<p>另外还又针对数组的类：<code>AtomicLongArray</code>、<code>AtomicReferenceArray</code>，以及用于以原子方式更新对象中的字段的类，如<code>AtomicIntegerFieldUpdater</code>、<code>AtomicReferenceFieldUpdater</code>等。</p>
<p>Java 8之后增加了几个类，在高并发统计汇总的场景中更为适合，包括<code>LongAdder</code>、<code>LongAccumulator</code>、<code>DoubleAdder</code>和<code>DoubleAccumulator</code>。</p>
<h4 id="atomicinteger">AtomicInteger</h4>
<h5 id="1基本用法">1.基本用法</h5>
<p>之所以称为原子变量，是因为它包含一些<strong>以原子方式实现组合操作的方法</strong>。如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//以原子方式获取旧值并设置新值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getAndSet</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>newValue)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以原子方式获取旧值并给当前值加1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getAndIncrement</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以原子方式获取旧值并给当前值减1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getAndDecrement</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以原子方式获取旧值并给当前值加delta</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getAndAdd</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>delta)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以原子方式给当前值加1并获取新值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">incrementAndGet</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以原子方式给当前值减1并获取新值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">decrementAndGet</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以原子方式给当前值加delta并获取新值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">addAndGet</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>delta)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这些方法的实现都依赖：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">compareAndSet</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>expect,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>update)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>compareAndSet是一个非常重要的方法，==比较并设置==，我们以后将简称为**==CAS==**。该方法有两个参数expect和update，以原子方式实现了如下功能：<!-- raw HTML omitted -->如果当前值等于expect，则更新为update，否则不更新，如果更新成功，返回true，否则返回false。<!-- raw HTML omitted --></p>
<p>AtomicInteger可以在程序中用作一个计数器，多个线程并发更新，也总能实现正确性。</p>
<h5 id="2基本原理和思维">2.基本原理和思维</h5>
<p>AtomicInteger的主要内部成员：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-113-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-113-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">volatile</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>value;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>volatile是必需的，以保证**==内存可见性==**。</p>
<p>与synchronized锁相比，<strong>这种原子更新方式代表一种不同的思维方式</strong>。synchronized是**==悲观==<strong>的，它假定更新很可能冲突，所以先获取锁，得到锁后才更新。原子变量的更新逻辑是</strong>==乐观==**的，它假定冲突比较少，但使用CAS更新，也就是进行冲突检测，如果确实冲突了，那也没关系，继续尝试就好了。</p>
<p>synchronized代表一种<strong>阻塞式</strong>算法，得不到锁的时候，进入<!-- raw HTML omitted -->锁等待队列<!-- raw HTML omitted -->，等待其他线程唤醒，有上下文切换开销。原子变量的更新逻辑是<strong>非阻塞式</strong>的，更新冲突的时候，它就重试，不会阻塞，不会有上下文切换开销。对于大部分比较简单的操作，无论是在低并发还是高并发情况下，这种<!-- raw HTML omitted -->==乐观非阻塞方式==<!-- raw HTML omitted -->的<strong>性能都远高于</strong><!-- raw HTML omitted -->==悲观阻塞式方式==<!-- raw HTML omitted -->。</p>
<p>原子变量相对比较简单，但对于复杂一些的数据结构和算法，非阻塞方式往往难于实现和理解，幸运的是，Java并发包中已经提供了一些==非阻塞容器==，我们只需要会使用就可以了，比如：</p>
<ul>
<li>
<p><code>ConcurrentLinkedQueue</code>和<code>ConcurrentLinkedDeque</code>：非阻塞并发队列。</p>
</li>
<li>
<p><code>ConcurrentSkipListMap</code>和<code>ConcurrentSkipListSet</code>：非阻塞并发Map和Set。</p>
</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-114-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-114-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-114-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-114-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-114-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-114-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">compareAndSet</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>expect,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>update)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>unsafe.<span style="color:#4070a0">compareAndSwapInt</span>(<span style="color:#007020;font-weight:bold">this</span>,<span style="color:#bbb"> </span>valueOffset,<span style="color:#bbb"> </span>expect,<span style="color:#bbb"> </span>update);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>sun.misc.Unsafe</code>是Sun的私有实现，名字的意思是是“不安全”，一般应用程序不应该直接使用。原理上，<strong>一般的计算机系统都==在硬件层次上直接支持CAS指令==</strong>，而Java的实现都会利用这些特殊指令。从程序的角度看，可以将compareAndSet视为计算机的基本操作，直接接纳就好。</p>
<h5 id="3实现锁">3.实现锁</h5>
<p>基于CAS，除了可以实现==乐观非阻塞算法==之外，还可以实现==悲观阻塞式算法==，比如锁。</p>
<p>实际上，<!-- raw HTML omitted -->Java并发包中的所有阻塞式工具、容器、算法也都是基于CAS的<!-- raw HTML omitted -->（不过，也需要一些别的支持）。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-15">15</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 使用AtomicInteger实现锁
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * status表示锁的状态，0表示未锁定，1表示锁定，lock()、unlock()使用CAS方法更新，lock()只有在更新成功后才退出，实现了阻塞的效果
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Mylock</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>AtomicInteger<span style="color:#bbb"> </span>status<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>AtomicInteger(0);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">lock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>status.<span style="color:#4070a0">compareAndSet</span>(0,<span style="color:#bbb"> </span>1))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Thread.<span style="color:#4070a0">yield</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">unlock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>status.<span style="color:#4070a0">compareAndSet</span>(1,<span style="color:#bbb"> </span>0);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>MyLock只是用于演示基本概念，实际开发中应该使用Java并发包中的类，如<code>ReentrantLock</code>。</p>
<h4 id="aba问题">ABA问题</h4>
<p>使用CAS方式更新有一个ABA问题：<!-- raw HTML omitted -->假设当前值为A，如果另一个线程先将A修改成B，再修改回成A，当前线程的CAS操作无法分辨当前值发生过变化<!-- raw HTML omitted -->。</p>
<p>ABA是不是一个问题与程序的逻辑有关，一般不是问题。而如果确实有问题，解决方法是使用<code>AtomicStampedReference</code>，<strong>在修改值的同时附加一个时间戳，只有值和时间戳都相同才进行修改</strong>，其CAS方法声明为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-116-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-116-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">compareAndSet</span>(V<span style="color:#bbb"> </span>expectedReference,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>newReference,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>expectedStamp,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>newStamp)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>例子：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Pair<span style="color:#bbb"> </span>pair<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Pair(100,<span style="color:#bbb"> </span>200);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">int</span><span style="color:#bbb"> </span>stamp<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>1;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>AtomicStampedReference<span style="color:#666">&lt;</span>Pair<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>pairRef<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>AtomicStampedReference<span style="color:#666">&lt;&gt;</span>(pair,<span style="color:#bbb"> </span>stamp);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">int</span><span style="color:#bbb"> </span>newStamp<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>2;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>pairRef.<span style="color:#4070a0">compareAndSet</span>(pair,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Pair(200,<span style="color:#bbb"> </span>200),<span style="color:#bbb"> </span>stamp,<span style="color:#bbb"> </span>newStamp);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(pair);<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// Pair{item=100, weight=200}</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>AtomicStampedReference在compareAndSet中要同时修改两个值：一个是引用，另一个是时间戳。它怎么实现原子性呢？实际上，内部AtomicStampedReference会将两个值组合为一个对象，修改的是一个值，我们看代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">compareAndSet</span>(V<span style="color:#bbb">   </span>expectedReference,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                             </span>V<span style="color:#bbb">   </span>newReference,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                             </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>expectedStamp,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                             </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>newStamp)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Pair<span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>current<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>pair;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>expectedReference<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>current.<span style="color:#4070a0">reference</span><span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>expectedStamp<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>current.<span style="color:#4070a0">stamp</span><span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>((newReference<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>current.<span style="color:#4070a0">reference</span><span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>newStamp<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>current.<span style="color:#4070a0">stamp</span>)<span style="color:#bbb"> </span><span style="color:#666">||</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span>casPair(current,<span style="color:#bbb"> </span>Pair.<span style="color:#4070a0">of</span>(newReference,<span style="color:#bbb"> </span>newStamp)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个Pair是AtomicStampedReference的一个内部类，成员包括引用和时间戳，具体定义为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Pair</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span>reference;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>stamp;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#06287e">Pair</span>(T<span style="color:#bbb"> </span>reference,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>stamp)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">reference</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>reference;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">stamp</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>stamp;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Pair<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">of</span>(T<span style="color:#bbb"> </span>reference,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>stamp)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Pair<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span>(reference,<span style="color:#bbb"> </span>stamp);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>AtomicStampedReference将对引用值和时间戳的组合比较和修改转换为了对这个内部类Pair单个值的比较和修改。</p>
<blockquote>
<p>CAS是Java并发包的基础，基于它可以实现高效的、乐观、非阻塞式数据结构和算法，它也是并发包中锁、同步工具和各种容器的基础。</p>
</blockquote>
<h3 id="162-显式锁">16.2 显式锁</h3>
<p>Java并发包中的显式锁可以解决synchronized的一些局限性。</p>
<p>Java并发包中的显式锁接口和类位于包<code>java.util.concurrent.locks</code>下，主要接口和类有：</p>
<ul>
<li>锁接口<code>Lock</code>，主要实现类是<code>ReentrantLock</code>；</li>
<li>读写锁接口<code>ReadWriteLock</code>，主要实现类是<code>ReentrantReadWriteLock</code>。</li>
</ul>
<h4 id="接口lock">接口Lock</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Lock</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">lock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">lockInterruptibly</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryLock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryLock</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>time,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Condition<span style="color:#bbb"> </span><span style="color:#06287e">newCondition</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>lock()</code>：普通的获取锁，会阻塞直到成功；<code>unlock()</code>：释放锁方法。</li>
<li><code>lockInterruptibly()</code>：与lock()的不同是，它可以响应中断，如果被其他线程中断了，则抛出<code>InterruptedException</code>。</li>
<li><code>tryLock()</code>：只是尝试获取锁，立即返回，不阻塞，如果获取成功，返回true，否则返回false。</li>
<li><code>tryLock(long time, TimeUnit unit)</code>：先尝试获取锁，如果能成功则立即返回true，否则阻塞等待，但等待的最长时间由指定的参数设置，在等待的同时响应中断，如果发生了中断，抛出InterruptedException，如果在等待的时间内获得了锁，返回true，否则返回false。</li>
<li><code>newCondition()</code>：新建一个条件，一个Lock可以关联多个条件。</li>
</ul>
<p>相比synchronized，<strong>显式锁支持以非阻塞方式获取锁、可以响应中断、可以限时</strong>。</p>
<h4 id="可重入锁reentrantlock">可重入锁ReentrantLock</h4>
<h5 id="1基本用法-1">1.基本用法</h5>
<p>Lock接口的主要实现类是<code>ReentrantLock</code>，它的基本用法lock/unlock实现了与synchronized一样的语义，包括：</p>
<ul>
<li>可重入，一个线程在持有一个锁的前提下，可以继续获得该锁；</li>
<li>可以解决竞态条件问题；</li>
<li>可以保证内存可见性。</li>
</ul>
<p>构造方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-121-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-121-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-121-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-121-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ReentrantLock</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ReentrantLock</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>fair)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>参数fair，默认是false，表示不公平。所谓公平指，<strong>等待时间最长的线程优先获得锁</strong>。</p>
<p><strong>保证公平会影响性能</strong>，一般也不需要，所以默认不保证，synchronized锁也是不保证公平的。</p>
<p>==使用显式锁，一定要记得调用unlock==。一般而言，应该将lock之后的代码包装到try语句内，在finally语句内释放锁。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Counter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Lock<span style="color:#bbb"> </span>lock<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ReentrantLock();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">volatile</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">incr</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>lock.<span style="color:#4070a0">lock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>count<span style="color:#666">++</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>lock.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getCount</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>count;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="2使用trylock避免死锁">2.使用tryLock避免死锁</h5>
<p>使用tryLock()，可以避免死锁。在持有一个锁获取另一个锁而获取不到的时候，可以释放已持有的锁，给其他线程获取锁的机会，然后重试获取所有锁。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-1">  1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-2">  2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-3">  3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-4">  4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-5">  5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-6">  6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-7">  7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-8">  8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-9">  9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-10"> 10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-11"> 11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-12"> 12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-13"> 13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-14"> 14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-15"> 15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-16"> 16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-17"> 17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-18"> 18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-19"> 19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-20"> 20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-21"> 21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-22"> 22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-23"> 23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-24"> 24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-25"> 25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-26"> 26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-27"> 27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-28"> 28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-29"> 29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-30"> 30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-31"> 31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-32"> 32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-33"> 33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-34"> 34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-35"> 35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-36"> 36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-37"> 37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-38"> 38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-39"> 39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-40"> 40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-41"> 41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-42"> 42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-43"> 43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-44"> 44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-45"> 45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-46"> 46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-47"> 47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-48"> 48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-49"> 49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-50"> 50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-51"> 51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-52"> 52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-53"> 53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-54"> 54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-55"> 55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-56"> 56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-57"> 57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-58"> 58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-59"> 59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-60"> 60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-61"> 61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-62"> 62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-63"> 63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-64"> 64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-65"> 65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-66"> 66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-67"> 67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-68"> 68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-69"> 69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-70"> 70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-71"> 71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-72"> 72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-73"> 73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-74"> 74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-75"> 75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-76"> 76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-77"> 77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-78"> 78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-79"> 79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-80"> 80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-81"> 81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-82"> 82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-83"> 83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-84"> 84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-85"> 85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-86"> 86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-87"> 87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-88"> 88</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-89"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-89"> 89</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-90"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-90"> 90</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-91"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-91"> 91</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-92"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-92"> 92</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-93"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-93"> 93</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-94"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-94"> 94</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-95"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-95"> 95</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-96"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-96"> 96</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-97"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-97"> 97</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-98"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-98"> 98</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-99"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-99"> 99</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-100"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-100">100</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-101"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-101">101</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-102"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-102">102</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-103"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-103">103</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-104"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-104">104</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-105"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-105">105</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-106"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-106">106</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-107"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-107">107</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-108"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-108">108</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-109"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-109">109</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-110"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-110">110</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">AccountMgr</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>NoEnoughMoneyException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>simulateDeadLock();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">NoEnoughMoneyException</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 转账的错误写法
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 如果两个账户都同时给对方转账，都先获取了第一个锁，则会发生死锁。
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param from
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param to
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param money
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @throws NoEnoughMoneyException
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">transfer</span>(Account<span style="color:#bbb"> </span>from,<span style="color:#bbb"> </span>Account<span style="color:#bbb"> </span>to,<span style="color:#bbb"> </span><span style="color:#902000">double</span><span style="color:#bbb"> </span>money)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>NoEnoughMoneyException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>from.<span style="color:#4070a0">lock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>to.<span style="color:#4070a0">lock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(from.<span style="color:#4070a0">getMoney</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;=</span><span style="color:#bbb"> </span>money)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>from.<span style="color:#4070a0">reduce</span>(money);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>to.<span style="color:#4070a0">add</span>(money);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>NoEnoughMoneyException();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>to.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>from.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 模拟账户转账的死锁过程&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 创建了10个账户，100个线程，每个线程执行100次循环，在每次循环中，随机挑选两个账户进行转账
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">simulateDeadLock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>accountNum<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>10;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Account<span style="color:#666">[]</span><span style="color:#bbb"> </span>accounts<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Account<span style="color:#666">[</span>accountNum<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Random<span style="color:#bbb"> </span>rnd<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Random();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>accountNum;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>accounts<span style="color:#666">[</span>i<span style="color:#666">]</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Account(rnd.<span style="color:#4070a0">nextInt</span>(10000));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>threadNum<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>100;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#666">[]</span><span style="color:#bbb"> </span>threads<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread<span style="color:#666">[</span>threadNum<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>threadNum;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>loopNum<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>100;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>k<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>k<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>loopNum;<span style="color:#bbb"> </span>k<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>rnd.<span style="color:#4070a0">nextInt</span>(accountNum);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>j<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>rnd.<span style="color:#4070a0">nextInt</span>(accountNum);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>money<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>rnd.<span style="color:#4070a0">nextInt</span>(10);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(i<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span>j)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//                                transfer(accounts[i], accounts[j], money);</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                </span>transfer_(accounts<span style="color:#666">[</span>i<span style="color:#666">]</span>,<span style="color:#bbb"> </span>accounts<span style="color:#666">[</span>j<span style="color:#666">]</span>,<span style="color:#bbb"> </span>money);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(NoEnoughMoneyException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>threads<span style="color:#666">[</span>i<span style="color:#666">]</span>.<span style="color:#4070a0">start</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 使用tryLock尝试转账
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 如果两个锁都能够获得，且转账成功，则返回true，否则返回false。
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryTransfer</span>(Account<span style="color:#bbb"> </span>from,<span style="color:#bbb"> </span>Account<span style="color:#bbb"> </span>to,<span style="color:#bbb"> </span><span style="color:#902000">double</span><span style="color:#bbb"> </span>money)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>NoEnoughMoneyException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(from.<span style="color:#4070a0">tryLock</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(to.<span style="color:#4070a0">tryLock</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(from.<span style="color:#4070a0">getMoney</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;=</span><span style="color:#bbb"> </span>money)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span>from.<span style="color:#4070a0">reduce</span>(money);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span>to.<span style="color:#4070a0">add</span>(money);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>NoEnoughMoneyException();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>to.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>from.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * transfer方法改进版：循环调用tryTransfer以避免死锁
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">transfer_</span>(Account<span style="color:#bbb"> </span>from,<span style="color:#bbb"> </span>Account<span style="color:#bbb"> </span>to,<span style="color:#bbb"> </span><span style="color:#902000">double</span><span style="color:#bbb"> </span>money)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>NoEnoughMoneyException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>success<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">do</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>success<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>tryTransfer(from,<span style="color:#bbb"> </span>to,<span style="color:#bbb"> </span>money);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>success)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>Thread.<span style="color:#4070a0">yield</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>success);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="reentrantlock的实现原理">ReentrantLock的实现原理</h4>
<p>ReentrantLock在最底层，它依赖于16.1节介绍的CAS方法。另外还依赖于类LockSupport中的一些方法。</p>
<h5 id="1locksupport">1.LockSupport</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-124-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-124-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-124-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-124-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-124-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-124-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-124-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-124-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">park</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">parkNanos</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>nanos)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">parkUntil</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>deadline)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">unpark</span>(Thread<span style="color:#bbb"> </span>thread)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>park使得当前线程放弃CPU，进入等待状态（WAITING）；当有其他线程对它调用了unpark, unpark使参数指定的线程恢复可运行状态，操作系统对其进行再调度。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-125-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-125-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Thread()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>LockSupport.<span style="color:#4070a0">park</span>();<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">// 放弃CPU</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;exit&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>t.<span style="color:#4070a0">start</span>();<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// 启动子线程</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Thread.<span style="color:#4070a0">sleep</span>(1000);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>LockSupport.<span style="color:#4070a0">unpark</span>(t);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>主线程启动子线程t，线程t启动后调用park，放弃CPU，主线程睡眠1秒以确保子线程已执行LockSupport.park()，调用unpark，线程t恢复运行，输出exit。</p>
<blockquote>
<p>park不同于Thread.yield(), yield只是告诉操作系统可以先让其他线程运行，但自己依然是可运行状态，而park会放弃调度资格，使线程进入WAITING状态。</p>
</blockquote>
<p>park的两个变体：</p>
<ul>
<li>parkNanos：可以指定等待的最长时间，参数是相对于当前时间的纳秒数；</li>
<li>parkUntil：可以指定最长等到什么时候，参数是绝对时间，是相对于纪元时的毫秒数。</li>
</ul>
<h5 id="2aqs">2.AQS</h5>
<p>利用CAS和LockSupport提供的基本方法，就可以用来实现ReentrantLock了。但Java中还有很多其他并发工具，如ReentrantReadWriteLock、Semaphore、CountDownLatch，它们的实现有很多类似的地方，为了复用代码，Java提供了一个抽象类<code>AbstractQueuedSynchronizer</code>，简称AQS，它简化了并发工具的实现。</p>
<p>AQS封装了一个状态，给子类提供了查询和设置状态的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-126-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-126-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-126-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-126-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-126-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-126-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-126-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-126-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">volatile</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>state;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getState</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setState</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>newState)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">compareAndSetState</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>expect,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>update)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>用于实现锁时，AQS可以保存锁的当前持有线程，提供了方法进行查询和设置：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-127-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-127-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-127-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-127-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-127-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-127-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">transient</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>exclusiveOwnerThread;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setExclusiveOwnerThread</span>(Thread<span style="color:#bbb"> </span>t)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span><span style="color:#06287e">getExclusiveOwnerThread</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>AQS内部维护了一个等待队列，借助CAS方法实现了无阻塞算法进行更新。</p>
<p>下面以ReentrantLock的使用为例简要介绍AQS的原理。</p>
<h5 id="3reentrantlock">3.ReentrantLock</h5>
<p>ReentrantLock内部使用AQS，有三个内部类：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-128-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-128-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-128-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-128-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-128-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-128-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">abstract</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Sync</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>AbstractQueuedSynchronizer<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">NonfairSync</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Sync<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">FairSync</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Sync<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Sync是抽象类，NonfairSync是fair为false时使用的类，FairSync是fire为true时使用的类。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-129-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-129-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-129-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-129-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-129-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-129-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-129-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-129-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-129-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-129-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Sync<span style="color:#bbb"> </span>sync;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ReentrantLock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>sync<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>NonfairSync();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ReentrantLock中的基本方法lock/unlock的实现：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-130-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-130-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">lock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>sync.<span style="color:#4070a0">lock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// sync默认类型是NonfairSync中lock实现</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">lock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span>(compareAndSetState(0,<span style="color:#bbb"> </span>1))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>setExclusiveOwnerThread(Thread.<span style="color:#4070a0">currentThread</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>acquire(1);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ReentrantLock使用state表示==是否被锁和持有数量==，如果当前未被锁定，则立即获得锁，否则调用acquire(1)获得锁。acquire是AQS中的方法，代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-131-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-131-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-131-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-131-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-131-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-131-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-131-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-131-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-131-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-131-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">acquire</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>arg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span>(<span style="color:#666">!</span><span style="color:#bbb"> </span>tryAcquire(arg)<span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">     </span>acquireQueued(addWaiter(Node.<span style="color:#4070a0">EXCLUSIVE</span>),<span style="color:#bbb"> </span>arg))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>selfInterrupt();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>调用tryAcquire获取锁，tryAcquire必须被子类重写。NonfairSync的实现为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-132-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-132-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-132-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-132-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-132-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-132-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryAcquire</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>acquires)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>nonfairTryAcquire(acquires);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>nonfairTryAcquire是sync中实现的：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-133-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-133-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">nonfairTryAcquire</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>acquires)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>current<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Thread.<span style="color:#4070a0">currentThread</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>c<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>getState();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(c<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>0)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(compareAndSetState(0,<span style="color:#bbb"> </span>acquires))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>setExclusiveOwnerThread(current);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(current<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>getExclusiveOwnerThread())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>nextc<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>c<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>acquires;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(nextc<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>0)<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">// overflow</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Error(<span style="color:#4070a0">&#34;Maximum lock count exceeded&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>setState(nextc);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果未被锁定，则使用CAS进行锁定；如果已被当前线程锁定，则增加锁定次数。</p>
<p>如果tryAcquire返回false，则AQS会调用<code>acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</code>。</p>
<p>其中，addWaiter会新建一个节点Node，代表当前线程，然后加入内部的等待队列中。放入等待队列后，调用acquireQueued尝试获得锁，代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-134-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-134-21">21</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">acquireQueued</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Node<span style="color:#bbb"> </span>node,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>arg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>failed<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>interrupted<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">for</span>(;<span style="color:#bbb"> </span>;<span style="color:#bbb"> </span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Node<span style="color:#bbb"> </span>p<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>node.<span style="color:#4070a0">predecessor</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">if</span>(p<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>head<span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb"> </span>tryAcquire(arg))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>setHead(node);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>p.<span style="color:#4070a0">next</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>;<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">// help GC</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>failed<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>interrupted;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">if</span>(shouldParkAfterFailedAcquire(p,<span style="color:#bbb"> </span>node)<span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">         </span>parkAndCheckInterrupt())<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>interrupted<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(failed)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>cancelAcquire(node);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>主体是一个死循环，在每次循环中，首先检查当前节点是不是第一个等待的节点，如果是且能获得到锁，则将当前节点从等待队列中移除并返回，否则最终调用LockSupport. park放弃CPU，进入等待，被唤醒后，检查是否发生了中断，记录中断标志，在最终方法返回时返回中断标志。如果发生过中断，acquire方法最终会调用selfInterrupt方法设置中断标志位，其代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-135-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-135-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-135-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-135-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-135-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-135-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">selfInterrupt</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Thread.<span style="color:#4070a0">currentThread</span>().<span style="color:#4070a0">interrupt</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>以上就是lock方法的基本过程，能获得锁就立即获得，否则加入等待队列，被唤醒后检查自己是否是第一个等待的线程，如果是且能获得锁，则返回，否则继续等待。这个过程中如果发生了中断，lock会记录中断标志位，但不会提前返回或抛出异常。</p>
<p>ReentrantLock的unlock方法的代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-136-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-136-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-136-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-136-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-136-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-136-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">unlock</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>sync.<span style="color:#4070a0">release</span>(1);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>release是AQS中定义的方法，代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-137-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-137-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">release</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>arg)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span>(tryRelease(arg))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Node<span style="color:#bbb"> </span>h<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>head;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(h<span style="color:#bbb"> </span><span style="color:#666">!</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span><span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb"> </span>h.<span style="color:#4070a0">waitStatus</span><span style="color:#bbb"> </span><span style="color:#666">!</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>unparkSuccessor(h);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>tryRelease方法会修改状态释放锁，unparkSuccessor会调用LockSupport.unpark将第一个等待的线程唤醒，具体代码就不列举了。</p>
<p>FairSync和NonfairSync的主要区别是：在获取锁时，即在tryAcquire方法中，如果当前未被锁定，即c==0, FairSync多了一个检查，如下：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-138-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-138-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryAcquire</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>acquires)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Thread<span style="color:#bbb"> </span>current<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Thread.<span style="color:#4070a0">currentThread</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>c<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>getState();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span>(c<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>0)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(<span style="color:#666">!</span><span style="color:#bbb"> </span>hasQueuedPredecessors()<span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>compareAndSetState(0,<span style="color:#bbb"> </span>acquires))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>setExclusiveOwnerThread(current);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>..<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个检查是指，只有不存在其他等待时间更长的线程，它才会尝试获取锁。</p>
<p>这样保证公平不是很好吗？为什么默认不保证公平呢？保证公平整体性能比较低，低的原因不是这个检查慢，而是会让活跃线程得不到锁，进入等待状态，引起频繁上下文切换，降低了整体的效率，通常情况下，谁先运行关系不大，而且长时间运行，从统计角度而言，虽然不保证公平，也基本是公平的。需要说明是，即使fair参数为true， ReentrantLock中不带参数的tryLock方法也是不保证公平的，它不会检查是否有其他等待时间更长的线程。</p>
<h4 id="对比reentrantlock和synchronized">对比ReentrantLock和synchronized</h4>
<p>相比synchronized, ReentrantLock可以实现与synchronized相同的语义，而且支持<strong>以非阻塞方式获取锁，可以响应中断，可以限时，更为灵活</strong>。不过，synchronized的使用<strong>更为简单，写的代码更少，也更不容易出错</strong>。</p>
<p>synchronized代表一种<strong>声明式编程思维</strong>，程序员更多的是表达一种同步声明，由Java系统负责具体实现，程序员不知道其实现细节；显式锁代表一种<strong>命令式编程思维</strong>，程序员实现所有细节。</p>
<p>声明式编程的好处除了简单，还在于性能，在较新版本的JVM上，ReentrantLock和synchronized的性能是接近的，但Java编译器和虚拟机可以不断优化synchronized的实现，比如自动分析synchronized的使用，对于没有锁竞争的场景，自动省略对锁获取/释放的调用。</p>
<blockquote>
<p>总结：<strong>能用synchronized就用synchronized</strong>，不满足要求时再考虑ReentrantLock。</p>
</blockquote>
<h3 id="163-显式条件">16.3 显式条件</h3>
<p>显式条件在不同上下文中也可以被称为<strong>条件变量、条件队列、或条件</strong>。</p>
<h4 id="用法-2">用法</h4>
<p>==锁用于解决竞态条件问题，条件是线程间的协作机制。==</p>
<p>显式锁与<code>synchronized</code>相对应，而显式条件与<code>wait/notify</code>相对应。wait/notify与synchronized配合使用，显式条件与显式锁配合使用。</p>
<p>Lock接口定义了创建方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-139-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-139-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Condition<span style="color:#bbb"> </span><span style="color:#06287e">newCondition</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-140-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-140-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Condition</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">await</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">awaitUninterruptibly</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">awaitNanos</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>nanosTimeout)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">await</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>time,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">awaitUntil</span>(Date<span style="color:#bbb"> </span>deadline)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">signal</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">signalAll</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>await对应于Object的wait, signal对应于notify, signalAll对应于notifyAll，语义也是一样的。</p>
<p>与Object的wait方法类似，await也有几个限定等待时间的方法，但功能更多一些：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-141-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-141-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-141-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-141-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-141-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-141-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-141-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-141-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-141-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-141-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-141-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-141-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//等待时间是相对时间，如果由于等待超时返回，返回值为false，否则为true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">await</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>time,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//等待时间也是相对时间，但参数单位是纳秒，返回值是nanosTimeout减去实际等待的时间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">awaitNanos</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>nanosTimeout)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//等待时间是绝对时间，如果由于等待超时返回，返回值为false，否则为true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">awaitUntil</span>(Date<span style="color:#bbb"> </span>deadline)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这些await方法都是响应中断的，如果发生了中断，会抛出InterruptedException，但中断标志位会被清空。<code>Condition</code>还定义了一个不响应中断的等待方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-142-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-142-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">awaitUninterruptibly</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>该方法不会由于中断结束，但当它返回时，如果等待过程中发生了中断，中断标志位会被设置。</p>
<p>一般而言，与Object的wait方法一样，调用await方法前需要先获取锁，如果没有锁，会抛出异常<code>IllegalMonitorStateException</code>。</p>
<p>await在进入等待队列后，会释放锁，释放CPU，当其他线程将它唤醒后，或等待超时后，或发生中断异常后，它都需要重新获取锁，获取锁后，才会从await方法中退出。</p>
<p>另外，与Object的wait方法一样，await返回后，不代表其等待的条件就一定满足了，通常要将await的调用放到一个循环内，只有条件满足后才退出。</p>
<p>一般而言，signal/signalAll与notify/notifyAll一样，调用它们需要先获取锁，如果没有锁，会抛出异常IllegalMonitorStateException。signal与notify一样，挑选一个线程进行唤醒，signalAll与notifyAll一样，唤醒所有等待的线程，但这些线程被唤醒后都需要重新竞争锁，获取锁后才会从await调用中返回。</p>
<p>🔖</p>
<h4 id="生产者消费者模式-1">生产者/消费者模式</h4>
<p>用wait/notify可以实现生产者/消费者模式，但有一个局限，它只能有一个条件等待队列，分析等待条件也很复杂。在生产者/消费者模式中，其实有两个条件，一个与队列满有关，一个与队列空有关。使用显式锁，可以创建多个条件等待队列。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-143-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-143-43">43</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 使用显式锁/条件实现的阻塞队列
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * @author andyron
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> **/</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">MyBlockingQueue</span><span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Queue<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>queue<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>limit;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Lock<span style="color:#bbb"> </span>lock<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ReentrantLock();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Condition<span style="color:#bbb"> </span>notFull<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>lock.<span style="color:#4070a0">newCondition</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Condition<span style="color:#bbb"> </span>notEmpty<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>lock.<span style="color:#4070a0">newCondition</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">MyBlockingQueue</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>limit)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">limit</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>limit;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>queue<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayDeque<span style="color:#666">&lt;&gt;</span>(limit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">put</span>(E<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>lock.<span style="color:#4070a0">lockInterruptibly</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(queue.<span style="color:#4070a0">size</span>()<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>limit)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>notFull.<span style="color:#4070a0">await</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>queue.<span style="color:#4070a0">add</span>(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>notEmpty.<span style="color:#4070a0">signal</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>lock.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>E<span style="color:#bbb"> </span><span style="color:#06287e">take</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>lock.<span style="color:#4070a0">lockInterruptibly</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(queue.<span style="color:#4070a0">isEmpty</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>notEmpty.<span style="color:#4070a0">await</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>E<span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>queue.<span style="color:#4070a0">poll</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>notFull.<span style="color:#4070a0">signal</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>e;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">finally</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>lock.<span style="color:#4070a0">unlock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>代码定义了两个等待条件：不满（notFull）、不空（notEmpty）。在put方法中，如果队列满，则在notFull上等待；在take方法中，如果队列空，则在notEmpty上等待。put操作后通知notEmpty, take操作后通知notFull。这样，代码更为清晰易读，同时避免了不必要的唤醒和检查，提高了效率。Java并发包中的类<code>ArrayBlockingQueue</code>就采用了类似的方式实现。</p>
<h4 id="实现原理">实现原理</h4>
<p>🔖</p>
<p>显式条件与显式锁配合使用，与wait/notify相比，可以支持多个条件队列，代码更为易读，效率更高，使用时注意不要将signal/signalAll误写为notify/notifyAll。</p>
<h2 id="17-并发容器">17 并发容器</h2>
<h3 id="171-写时复制的list和set">17.1 写时复制的List和Set</h3>
<p>Copy-On-Write即写时复制，或称写时拷贝，是解决并发问题的一种重要思路。</p>
<h4 id="copyonwritearraylist">CopyOnWriteArrayList</h4>
<p><code>CopyOnWriteArrayList</code>的用法与其他List（如ArrayList）<!-- raw HTML omitted -->基本是一样的<!-- raw HTML omitted -->。它的特点如下：</p>
<ul>
<li>线程安全</li>
<li>迭代器不支持修改操作，但也不会抛出<code>ConcurrentModificationException</code></li>
<li>以原子方式支持一些复合操作</li>
</ul>
<p>基于synchronized的同步容器的问题：</p>
<ul>
<li>迭代时，需要对整个列表对象加锁，否则会抛出ConcurrentModificationException；CopyOnWriteArrayList迭代时不需要加锁。</li>
<li>复合操作，比如先检查再更新，也需要调用方加锁，而CopyOnWriteArrayList直接支持两个原子方法：</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-144-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-144-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-144-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-144-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-144-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-144-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-144-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-144-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//不存在才添加，如果添加了，返回true，否则返回false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">addIfAbsent</span>(E<span style="color:#bbb"> </span>e)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//批量添加c中的非重复元素，不存在才添加，返回实际添加的个数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">addAllAbsent</span>(Collection<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>CopyOnWriteArrayList的内部也是一个数组，但这个数组是以原子方式被整体更新的。每次修改操作，都会新建一个数组，复制原数组的内容到新数组，在新数组上进行需要的修改，然后以原子方式设置内部的数组引用，这就是**==写时复制==**。</p>
<p>🔖</p>
<blockquote>
<p>**写时复制是一种重要的思维，用于各种计算机程序中，比如操作系统内部的进程管理和内存管理。**在进程管理中，子进程经常共享父进程的资源，只有在写时才复制。在内存管理中，当多个程序同时访问同一个文件时，操作系统在内存中可能只会加载一份，只有程序要写时才会复制，分配自己的内存，复制可能也不会全部复制，只会复制写的位置所在的。</p>
</blockquote>
<h4 id="copyonwritearrayset">CopyOnWriteArraySet</h4>
<p><code>CopyOnWriteArraySet</code>实现了Set接口，不包含重复元素，使用比较简单，其内部是通过CopyOnWriteArrayList实现的。</p>
<h3 id="172-concurrenthashmap">17.2 ConcurrentHashMap</h3>
<p>HashMap的并发版本，与HashMap相比，它有如下特点：</p>
<h4 id="并发安全">并发安全</h4>
<p>HashMap不是并发安全的，在并发更新的情况下，HashMap可能出现死循环，占满CPU。</p>
<p>🔖</p>
<h4 id="原子复合操作">原子复合操作</h4>
<p>除了Map接口，还实现了<code>ConcurrentMap</code>接口，java7具体定义：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-145-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-145-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">ConcurrentMap</span><span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Map<span style="color:#666">&lt;</span>K,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//条件更新，如果Map中没有key，设置key为value，返回原来key对应的值，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//如果没有，返回null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>V<span style="color:#bbb"> </span><span style="color:#06287e">putIfAbsent</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//条件删除，如果Map中有key，且对应的值为value，则删除，如果删除了，返回true，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//否则返回false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">remove</span>(Object<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//条件替换，如果Map中有key，且对应的值为oldValue，则替换为newValue，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//如果替换了，返回ture，否则false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">replace</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>oldValue,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>newValue);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//条件替换，如果Map中有key，则替换值为value，返回原来key对应的值，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//如果原来没有，返回null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>V<span style="color:#bbb"> </span><span style="color:#06287e">replace</span>(K<span style="color:#bbb"> </span>key,<span style="color:#bbb"> </span>V<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Java 8增加了几个默认方法，包括getOrDefault、forEach、computeIfAbsent、merge等。</p>
<p>如果使用同步容器，调用方必须加锁，而Concurrent-HashMap将它们实现为了原子操作。实际上，使用ConcurrentHashMap，调用方也没有办法进行加锁，它没有暴露锁接口，也不使用synchronized。</p>
<h4 id="高并发的基本机制">高并发的基本机制</h4>
<p>ConcurrentHashMap实现高并发的思路：</p>
<ul>
<li>分段锁</li>
<li>读不需要锁</li>
</ul>
<p>同步容器使用synchronized，所有方法竞争同一个锁；而ConcurrentHashMap<strong>采用分段锁技术，将数据分为多个段，而每个段有一个独立的锁</strong>，每一个段相当于一个独立的哈希表，分段的依据也是哈希值，无论是保存键值对还是根据键查找，都先根据键的哈希值映射到段，再在段对应的哈希表上进行操作。</p>
<p>采用分段锁，可以大大提高并发度，多个段之间可以并行读写。默认情况下，段是16个，不过，这个数字可以通过构造方法进行设置，如下所示：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-146-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-146-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ConcurrentHashMap</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>initialCapacity,<span style="color:#bbb"> </span><span style="color:#902000">float</span><span style="color:#bbb"> </span>loadFactor,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>concurrencyLevel)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>concurrencyLevel表示估计的并行更新的线程个数，ConcurrentHashMap会将该数转换为2的整数次幂，比如14转换为16,25转换为32。</p>
<p>在对每个段的数据进行读写时，ConcurrentHashMap也不是简单地使用锁进行同步，内部使用了CAS。对一些写采用原子方式的方法，实现比较复杂，我们就不介绍了。实现的效果是，对于写操作，需要获取锁，不能并行，但是读操作可以，多个读可以并行，写的同时也可以读，这使得ConcurrentHashMap的并行度远高于同步容器。</p>
<p>Java 8对ConcurrentHashMap的实现进一步做了优化。首先，与HashMap的改进类似，在哈希冲突比较严重的时候，会将单向链表转化为平衡的排序二叉树，提高查找的效率；其次，锁的粒度进一步细化了，以提高并行性，哈希表数组中的每个位置（指向一个单链表或树）都有一个单独的锁，具体比较复杂。</p>
<h4 id="迭代安全">迭代安全</h4>
<p>ConcurrentHashMap在迭代器创建后，在迭代过程中，如果另一个线程对容器进行了修改，迭代会继续，不会抛出异常。</p>
<p>🔖</p>
<h4 id="弱一致性">弱一致性</h4>
<p>ConcurrentHashMap的迭代器创建后，就会按照哈希表结构遍历每个元素，但在遍历过程中，内部元素可能会发生变化，如果变化发生在已遍历过的部分，迭代器就不会反映出来，而如果变化发生在未遍历过的部分，迭代器就会发现并反映出来，这就是==弱一致性==。</p>
<p>类似的情况还会出现在ConcurrentHashMap的另一个方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-147-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-147-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-147-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-147-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//批量添加m中的键值对到当前Map</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">putAll</span>(Map<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>K,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>m)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>该方法并非原子操作，而是调用put方法逐个元素进行添加的，在该方法没有结束的时候，部分修改效果就会体现出来。</p>
<h4 id="小结">小结</h4>
<p>ConcurrentHashMap是并发版的HashMap，通过降低锁的粒度和CAS等实现了高并发，支持原子条件更新操作，不会抛出ConcurrentModificationException，实现了弱一致性。</p>
<p>Java中没有并发版的HashSet，但可以通过Collections.newSetFromMap方法基于ConcurrentHashMap构建一个。</p>
<h3 id="173-基于跳表的map和set">17.3 基于跳表的Map和Set🔖</h3>
<p>Java并发包中与TreeMap/TreeSet对应的并发版本是<code>ConcurrentSkipListMap</code>和<code>ConcurrentSkipListSet</code>。</p>
<h4 id="基本概念-1">基本概念</h4>
<p>ConcurrentSkipListSet也是基于ConcurrentSkipListMap实现的。</p>
<p>ConcurrentSkipListMap是基于SkipList实现的，<code>SkipList</code>称为跳跃表或==跳表==。</p>
<blockquote>
<p>并发版本为什么采用跳表而不是树呢？</p>
<p>原因也很简单，因为跳表更易于实现高效并发算法。</p>
</blockquote>
<p><code>ConcurrentSkipListMap</code>的下特点：</p>
<ol>
<li>没有使用锁，所有操作都是无阻塞的，所有操作都可以并行，包括写，多线程可以同时写。</li>
<li>与ConcurrentHashMap类似，迭代器不会抛出ConcurrentModificationException，是弱一致的，迭代可能反映最新修改也可能不反映，一些方法如putAll、clear不是原子的。</li>
<li>与ConcurrentHashMap类似，同样实现了ConcurrentMap接口，支持一些原子复合操作。</li>
<li>与TreeMap一样，可排序，默认按键的自然顺序，也可以传递比较器自定义排序，实现了SortedMap和NavigableMap接口。</li>
</ol>
<h4 id="基本实现原理">基本实现原理🔖</h4>
<p>跳表是基于链表的，在链表的基础上加了多层索引结构。</p>
<p>ConcurrentSkipListMap会构造类似图17-1所示的跳表结构：</p>
<p><img src="images/image-20230503215341436.png"></p>
<p><img src="images/image-20230503215423599.png"></p>
<p><img src="images/image-20230503215452736.png"></p>
<h3 id="174-并发队列">17.4 并发队列🔖</h3>
<p>==无锁非阻塞==是指，这些队列不使用锁，所有操作总是可以立即执行，主要通过循环CAS实现并发安全。</p>
<p>==阻塞队列==是指，这些队列使用锁和条件，很多操作都需要先获取锁或满足特定条件，获取不到锁或等待条件时，会等待（即阻塞），获取到锁或条件满足再返回。</p>
<p>这些队列迭代都不会抛出<code>ConcurrentModificationException</code>，都是弱一致的。</p>
<h4 id="无锁非阻塞并发队列">无锁非阻塞并发队列</h4>
<p><code>ConcurrentLinkedQueue</code>、<code>ConcurrentLinkedDeque</code></p>
<h4 id="普通阻塞队列">普通阻塞队列</h4>
<p>基于数组的<code>ArrayBlockingQueue</code>，基于链表的<code>LinkedBlockingQueue</code>和<code>LinkedBlockingDeque</code>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-148-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-148-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//入队，如果队列满，等待直到队列有空间</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">put</span>(E<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//出队，如果队列空，等待直到队列不为空，返回头部元素</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>E<span style="color:#bbb"> </span><span style="color:#06287e">take</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//入队，如果队列满，最多等待指定的时间，如果超时还是满，返回false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">offer</span>(E<span style="color:#bbb"> </span>e,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>timeout,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//出队，如果队列空，最多等待指定的时间，如果超时还是空，返回null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>E<span style="color:#bbb"> </span><span style="color:#06287e">poll</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>timeout,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="优先级阻塞队列">优先级阻塞队列</h4>
<p><code>PriorityBlockingQueue</code></p>
<h4 id="延时阻塞队列">延时阻塞队列</h4>
<p><code>DelayQueue</code></p>
<h4 id="其它阻塞队列">其它阻塞队列</h4>
<p><code>SynchronousQueue</code>和<code>LinkedTransferQueue</code>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-149-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-149-15">15</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">TransferQueue</span><span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>BlockingQueue<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//如果有消费者在等待(执行take或限时的poll)，直接转给消费者，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//返回true，否则返回false，不入队</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryTransfer</span>(E<span style="color:#bbb"> </span>e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//如果有消费者在等待，直接转给消费者，否则入队，阻塞等待直到被消费者接收后再返回</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">transfer</span>(E<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//如果有消费者在等待，直接转给消费者，返回true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//否则入队，阻塞等待限定的时间，如果最后被消费者接收，返回true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryTransfer</span>(E<span style="color:#bbb"> </span>e,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>timeout,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否有消费者在等待</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">hasWaitingConsumer</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//等待的消费者个数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getWaitingConsumerCount</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="18-异步任务执行服务">18 异步任务执行服务🔖</h2>
<p><strong>执行服务</strong>，将“<strong>任务的提交</strong>”和“<strong>任务的执行</strong>”相分离。</p>
<p>“执行服务”封装了任务执行的细节，对于任务提交者而言，它可以关注于任务本身，如<strong>提交任务、获取结果、取消任务</strong>，而不需要关注任务执行的细节，如<strong>线程创建、任务调度、线程关闭</strong>等。</p>
<h3 id="181-基本概念和原理">18.1 基本概念和原理</h3>
<h4 id="基本接口">基本接口</h4>
<p>任务执行服务涉及的基本接口：</p>
<ul>
<li><code>Runnable</code>和<code>Callable</code>：表示要执行的异步任务。</li>
<li><code>Executor</code>和<code>ExecutorService</code>：表示执行服务。</li>
<li><code>Future</code>：表示异步任务的结果。</li>
</ul>
<h4 id="基本用法-2">基本用法</h4>
<h4 id="基本实现原理-1">基本实现原理</h4>
<h3 id="182-线程池">18.2 线程池</h3>
<p>线程池，就是一个线程的池子，里面有若干线程，它们的目的就是执行提交给线程池的任务，<strong>执行完一个任务后不会退出，而是继续等待或执行新任务</strong>。</p>
<p>线程池两个概念：<strong>==任务队列==</strong>，<strong>==工作者线程==</strong>。</p>
<p>线程池优点：</p>
<ul>
<li>它可以重用线程，避免线程创建的开销。</li>
<li>任务过多时，通过排队避免创建过多线程，减少系统资源消耗和竞争，确保任务有序完成。</li>
</ul>
<p>Java并发包中线程池的实现类是<code>ThreadPoolExecutor</code>，它继承自<code>AbstractExecutorService</code>，实现了<code>ExecutorService</code>。</p>
<h4 id="理解线程池">理解线程池</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-150-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-150-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-150-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-150-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-150-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-150-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ThreadPoolExecutor</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>corePoolSize,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>maximumPoolSize,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>keepAliveTime,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit,<span style="color:#bbb"> </span>BlockingQueue<span style="color:#666">&lt;</span>Runnable<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>workQueue)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">ThreadPoolExecutor</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>corePoolSize,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>maximumPoolSize,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>keepAliveTime,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit,<span style="color:#bbb"> </span>BlockingQueue<span style="color:#666">&lt;</span>Runnable<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>workQueue,<span style="color:#bbb"> </span>ThreadFactory<span style="color:#bbb"> </span>threadFactory,<span style="color:#bbb"> </span>RejectedExecutionHandler<span style="color:#bbb"> </span>handler)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="1线程池大小">1.线程池大小</h5>
<p>主要与4个参数有关：</p>
<ul>
<li><code>corePoolSize</code>：核心线程个数。</li>
<li><code>maximumPoolSize</code>：最大线程个数。</li>
<li><code>keepAliveTime</code>和<code>unit</code>：空闲线程存活时间。</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-151-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-151-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#60a0b0;font-style:italic">//返回当前线程个数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getPoolSize</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//返回线程池曾经达到过的最大线程个数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getLargestPoolSize</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//返回线程池自创建以来所有已完成的任务数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">getCompletedTaskCount</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//返回所有任务数，包括所有已完成的加上所有排队待执行的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span><span style="color:#06287e">getTaskCount</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="2队列">2.队列</h5>
<p>ThreadPoolExecutor要求的队列类型是阻塞队列BlockingQueue。</p>
<h5 id="3任务拒绝策略">3.任务拒绝策略</h5>
<p><code>RejectedExecutionException</code></p>
<p>拒绝策略是可以自定义的，ThreadPoolExecutor实现了4种处理方式:</p>
<ol>
<li>hreadPoolExecutor.AbortPolicy：这就是默认的方式，抛出异常。</li>
<li>ThreadPoolExecutor.DiscardPolicy：静默处理，忽略新任务，不抛出异常，也不执行。</li>
<li>ThreadPoolExecutor.DiscardOldestPolicy：将等待时间最长的任务扔掉，然后自己排队。</li>
<li>ThreadPoolExecutor.CallerRunsPolicy：在任务提交者线程中执行任务，而不是交给线程池中的线程执行。</li>
</ol>
<h5 id="4线程工厂">4.线程工厂</h5>
<h5 id="5关于核心线程的特殊配置">5.关于核心线程的特殊配置</h5>
<h4 id="工厂类executors">工厂类Executors</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-152-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-152-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-152-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-152-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-152-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-152-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>ExecutorService<span style="color:#bbb"> </span><span style="color:#06287e">newSingleThreadExecutor</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>ExecutorService<span style="color:#bbb"> </span><span style="color:#06287e">newFixedThreadPool</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>nThreads)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>ExecutorService<span style="color:#bbb"> </span><span style="color:#06287e">newCachedThreadPool</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="线程池的死锁">线程池的死锁</h4>
<h4 id="小结-1">小结</h4>
<p>ThreadPoolExecutor实现了生产者/消费者模式，工作者线程就是消费者，任务提交者就是生产者，线程池自己维护任务队列。当我们碰到类似生产者/消费者问题时，应该优先考虑直接使用线程池，而非“重新发明轮子”，应自己管理和维护消费者线程及任务队列。</p>
<h3 id="183-定时任务的陷阱">18.3 定时任务的陷阱</h3>
<p>定时任务的应用场景很多，比如：</p>
<ul>
<li>闹钟程序或任务提醒，指定时间叫床或在指定日期提醒还信用卡。</li>
<li>监控系统，每隔一段时间采集下系统数据，对异常事件报警。</li>
<li>统计系统，一般凌晨一定时间统计昨日的各种数据指标。</li>
</ul>
<p>在Java中，主要有两种方式实现定时任务：</p>
<ul>
<li>使用java.util包中的<code>Timer</code>和<code>TimerTask</code>。</li>
<li>使用Java并发包中的<code>ScheduledExecutorService</code>。</li>
</ul>
<h4 id="timer和timertask">Timer和TimerTask</h4>
<h5 id="基本用法-3">基本用法</h5>
<p>TimerTask表示一个定时任务，它是一个抽象类，实现了Runnable，具体的定时任务需要继承该类，实现run方法。</p>
<p>Timer是一个具体类，它负责定时任务的调度和执行，主要方法有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-153-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-153-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#60a0b0;font-style:italic">//在指定绝对时间time运行任务task</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">schedule</span>(TimerTask<span style="color:#bbb"> </span>task,<span style="color:#bbb"> </span>Date<span style="color:#bbb"> </span>time)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//在当前时间延时delay毫秒后运行任务task</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">schedule</span>(TimerTask<span style="color:#bbb"> </span>task,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>delay)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//固定延时重复执行，第一次计划执行时间为firstTime，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//后一次的计划执行时间为前一次&#34;实际&#34;执行时间加上period</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">schedule</span>(TimerTask<span style="color:#bbb"> </span>task,<span style="color:#bbb"> </span>Date<span style="color:#bbb"> </span>firstTime,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>period)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//同样是固定延时重复执行，第一次执行时间为当前时间加上delay</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">schedule</span>(TimerTask<span style="color:#bbb"> </span>task,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>delay,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>period)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//固定频率重复执行，第一次计划执行时间为firstTime，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//后一次的计划执行时间为前一次&#34;计划&#34;执行时间加上period</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">scheduleAtFixedRate</span>(TimerTask<span style="color:#bbb"> </span>task,<span style="color:#bbb"> </span>Date<span style="color:#bbb"> </span>firstTime,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>period)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//同样是固定频率重复执行，第一次计划执行时间为当前时间加上delay</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">scheduleAtFixedRate</span>(TimerTask<span style="color:#bbb"> </span>task,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>delay,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>period)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="小节">小节</h5>
<p>注意：</p>
<ul>
<li>后台只有一个线程在运行；</li>
<li>固定频率的任务被延迟后，可能会立即执行多次，将次数补够；</li>
<li>固定延时任务的延时相对的是任务执行前的时间；</li>
<li>不要在定时任务中使用无限循环；</li>
<li>一个定时任务的未处理异常会导致所有定时任务被取消。</li>
</ul>
<h4 id="scheduledexecutorservice">ScheduledExecutorService</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-154-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-154-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">ScheduledExecutorService</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>ExecutorService<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//单次执行，在指定延时delay后运行command</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>ScheduledFuture<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>schedule(Runnable<span style="color:#bbb"> </span>command,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>delay,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                      </span>TimeUnit<span style="color:#bbb"> </span>unit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//单次执行，在指定延时delay后运行callable</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>ScheduledFuture<span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">schedule</span>(Callable<span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>callable,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>delay,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                         </span>TimeUnit<span style="color:#bbb"> </span>unit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//固定频率重复执行</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>ScheduledFuture<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>scheduleAtFixedRate(Runnable<span style="color:#bbb"> </span>command,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                                 </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>initialDelay,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>period,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//固定延时重复执行</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>ScheduledFuture<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>scheduleWithFixedDelay(Runnable<span style="color:#bbb"> </span>command,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                                    </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>initialDelay,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>delay,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ScheduledThreadPoolExecutor与Timer主要不同：</p>
<ul>
<li>它的背后是线程池，可以有多个线程执行任务。</li>
<li>它在任务执行后再设置下次执行的时间，对于固定延时的任务更为合理。</li>
<li>任务执行线程会捕获任务执行过程中的所有异常，一个定时任务的异常不会影响其他定时任务，不过，发生异常的任务（即使是一个重复任务）不会再被调度。</li>
</ul>
<h4 id="小节-1">小节</h4>
<p>Timer和ScheduledExecutorService，实践中建议使用ScheduledExecutorService。</p>
<p>它们的共同局限是<strong>不太胜任复杂的定时任务调度</strong>。此时可使用[日期和时间处理方法](#7.5 剖析日期和时间)，后者第三方类库如<a href="http://www.quartz-scheduler.org/">Quartz</a>。</p>
<p>在并发应用程序中，一般我们应该尽量利用高层次的服务，比如各种并发容器、任务执行服务和线程池等，避免自己管理线程和它们之间的同步。</p>
<h2 id="19-同步和协作工具类">19 同步和协作工具类🔖</h2>
<h3 id="191-读写锁reentrantreadwritelock">19.1 读写锁ReentrantReadWriteLock</h3>
<p>synchronized和显式锁ReentrantLock这两种锁对于同一受保护对象的访问，无论是读还是写，它们都要求获得相同的锁。在一些场景中，这是没有必要的，多个线程的读操作完全可以并行，在读多写少的场景中，<strong>让读操作并行可以明显提高性能</strong>。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-155-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-155-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-155-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-155-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-155-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-155-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-155-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-155-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">ReadWriteLock</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Lock<span style="color:#bbb"> </span><span style="color:#06287e">readLock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Lock<span style="color:#bbb"> </span><span style="color:#06287e">writeLock</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>只有“读-读”操作是可以并行的，“读-写”和“写-写”都不可以。</p>
<h3 id="192-信号量semaphore">19.2 信号量Semaphore</h3>
<p>之前介绍的锁都是<strong>限制只有一个线程可以同时访问一个资源</strong>。</p>
<p>现实中，资源往往有多个，但每个同时只能被一个线程访问，比如，饭店的饭桌、火车上的卫生间。有的单个资源即使可以被并发访问，但并发访问数多了可能影响性能，所以希望<strong>限制并发访问的线程数</strong>。还有的情况，与软件的授权和计费有关，对不同等级的账户，限制不同的最大并发访问数。</p>
<p>信号量类Semaphore就是用来解决这类问题。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-156-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-156-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-156-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-156-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">Semaphore</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>permits)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">Semaphore</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>permits,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>fair)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>fire表示公平，permits表示许可数量。
Semaphore的方法与锁是类似的，主要的方法有两类，获取许可和释放许可：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-157-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-157-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//阻塞获取许可</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">acquire</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//阻塞获取许可，不响应中断</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">acquireUninterruptibly</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//批量获取多个许可</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">acquire</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>permits)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">acquireUninterruptibly</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>permits)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//尝试获取</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryAcquire</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//限定等待时间获取</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">tryAcquire</span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>permits,<span style="color:#bbb"> </span><span style="color:#902000">long</span><span style="color:#bbb"> </span>timeout,<span style="color:#bbb"> </span>TimeUnit<span style="color:#bbb"> </span>unit)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//释放许可</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">release</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="193-倒计时门栓countdownlatch">19.3 倒计时门栓CountDownLatch</h3>
<p>CountDownLatch相当于是一个门栓，一开始是关闭的，所有希望通过该门的线程都需要等待，然后开始倒计时，倒计时变为0后，门栓打开，等待的所有线程都可以通过，它是一次性的，打开后就不能再关上了。</p>
<h3 id="194-循环栅栏cyclicbarrier">19.4 循环栅栏CyclicBarrier</h3>
<p>CyclicBarrier相当于是一个栅栏，所有线程在到达该栅栏后都需要等待其他线程，等所有线程都到达后再一起通过，它是循环的，可以用作重复的同步。</p>
<p>CyclicBarrier与CountDownLatch的区别。</p>
<ol>
<li>CountDownLatch的参与线程是有不同角色的，有的负责倒计时，有的在等待倒计时变为0，负责倒计时和等待倒计时的线程都可以有多个，用于不同角色线程间的同步。</li>
<li>CyclicBarrier的参与线程角色是一样的，用于同一角色线程间的协调一致。</li>
<li>CountDownLatch是一次性的，而CyclicBarrier是可以重复利用的。</li>
</ol>
<h3 id="195-理解threadlocal">19.5 理解ThreadLocal</h3>
<p>实现线程安全的特殊概念：==线程本地变量==</p>
<h4 id="基本概念和用法">基本概念和用法</h4>
<p>线程本地变量是说，<strong>==每个线程都有同一个变量的独有拷贝==</strong>。</p>
<h4 id="使用场景">使用场景</h4>
<h5 id="1日期处理">1.日期处理</h5>
<h5 id="2随机数">2.随机数</h5>
<h5 id="3上下文信息">3.上下文信息</h5>
<h3 id="小结-2">小结</h3>
<ul>
<li>在读多写少的场景中使用ReentrantReadWriteLock替代ReentrantLock，以提高性能。</li>
<li>使用Semaphore限制对资源的并发访问数。</li>
<li>使用CountDownLatch实现不同角色线程间的同步。</li>
<li>使用CyclicBarrier实现同一角色线程间的协调一致。</li>
<li>ThreadLocal使得每个线程对同一个变量有自己的独立副本，是实现线程安全、减少竞争的一种方案。</li>
<li>ThreadLocal经常用于存储上下文信息，避免在不同代码间来回传递，简化代码。</li>
<li>每个线程都有一个Map，调用ThreadLocal对象的get/set实际就是以ThreadLocal对象为键读写当前线程的该Map。</li>
</ul>
<h2 id="20-并发总结">20 并发总结</h2>
<p>多线程开发有两个核心问题：一个是**==竞争==<strong>，另一个是</strong>==协作==**。</p>
<p>竞争会出现线程安全问题。</p>
<h3 id="201-线程安全的机制">20.1 线程安全的机制</h3>
<ul>
<li>使用synchronized；</li>
<li>使用显式锁；</li>
<li>使用volatile；</li>
<li>使用原子变量和CAS；</li>
<li>写时复制；</li>
<li>使用ThreadLocal。</li>
</ul>
<h3 id="202-线程的协作机制">20.2 线程的协作机制</h3>
<ul>
<li>
<p>wait/notify；</p>
</li>
<li>
<p>显式条件；</p>
</li>
<li>
<p>线程的中断；</p>
</li>
<li>
<p>协作工具类；</p>
</li>
<li>
<p>阻塞队列；</p>
</li>
<li>
<p>Future/FutureTask。</p>
</li>
</ul>
<h3 id="203-容器类">20.3 容器类</h3>
<h4 id="同步容器">同步容器</h4>
<h4 id="并发容器">并发容器</h4>
<ul>
<li>写时复制的List和Set。</li>
<li>ConcurrentHashMap。</li>
<li>基于SkipList的Map和Set。</li>
<li>各种队列。</li>
</ul>
<h3 id="204-任务执行服务">20.4 任务执行服务</h3>
<h1 id="六动态与函数式编程">六、动态与函数式编程</h1>
<h2 id="21-反射">21 反射</h2>
<p>Java的动态特性：反射、注解、动态代理、类加载器等。</p>
<p>利用这些特性，可以优雅地实现一些灵活通用的功能，它们经常用于各种框架、库和系统程序中，比如：</p>
<ol>
<li>Jackson利用反射和注解实现了<strong>通用的序列化机制</strong>。</li>
<li>有多种库（如Spring MVC、Jersey）用于处理Web请求，利用反射和注解，能方便地==将用户的请求参数和内容转换为Java对象，将Java对象转变为响应内容==。</li>
<li>有多种库（如Spring、Guice）利用这些特性实现了==对象管理容器==，方便程序员管理对象的生命周期以及其中复杂的依赖关系。</li>
<li>应用服务器（如Tomcat）利用类加载器实现不同应用之间的隔离，JSP技术利用类加载器实现修改代码不用重启就能生效的特性。</li>
<li>面向方面的编程==AOP==（Aspect Oriented Programming）将编程中通用的关注点（如日志记录、安全检查等）与业务的主体逻辑相==分离==，减少冗余代码，提高程序的可维护性， AOP需要依赖上面的这些特性来实现。</li>
</ol>
<p>在一般操作数据的时候，我们都是知道并且依赖于<strong>数据类型</strong>的，比如：</p>
<ol>
<li>根据类型使用new创建对象。</li>
<li>根据类型定义变量，类型可能是基本类型、类、接口或数组。</li>
<li>将特定类型的对象传递给方法。</li>
<li>根据类型访问对象的属性，调用对象的方法。</li>
</ol>
<p>编译器也是根据类型进行代码的检查编译的。</p>
<p>反射不一样，它是<strong>在运行时，而非编译时</strong>，动态获取类型的信息，比如<strong>接口信息、成员信息、方法信息、构造方法信息</strong>等，根据这些动态获取到的信息创建对象、访问/修改成员、调用方法等。</p>
<h3 id="211-class类">21.1 Class类</h3>
<p>每个已加载的类在内存都有一份<strong>类信息</strong>，每个对象都有指向它所属类信息的引用。</p>
<ul>
<li>所有类的根父类Object有一个方法<code>getClass</code>，用于获取对象的Class对象：</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-158-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-158-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>getClass()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Class是一个泛型类，有一个类型参数，getClass()并不知道具体的类型，所以返回<code>Class&lt;?&gt;</code>。</p>
<ul>
<li>
<p>获取Class对象不一定需要实例对象，如果在写程序时就知道类名，可以使用<code>&lt;类名&gt;.class</code>获取Class对象。</p>
</li>
<li>
<p>Class有一个静态方法<code>forName</code>（可能抛出<code>ClassNotFoundException</code>），可以根据类名直接加载Class，获取Class对象。</p>
</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-159-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-159-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-159-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-159-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-159-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-159-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#666">&lt;</span>Date<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Date.<span style="color:#4070a0">class</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>aClass<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#4070a0">&#34;java.util.Date&#34;</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>接口也有Class对象：</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-160-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-160-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#666">&lt;</span>Comparable<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Comparable.<span style="color:#4070a0">class</span>;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>基本类型也有对应的Class对象，类型参数为对应的包装类型：</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-161-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-161-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#666">&lt;</span>Integer<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>intCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#902000">int</span>.<span style="color:#4070a0">class</span>;<span style="color:#bbb"> 
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>对于数组，每种类型都有对应数组类型的Class对象，每个维度都有一个，即一维数组有一个，二维数组有一个不同的类型：</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-162-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-162-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-162-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-162-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-162-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-162-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-162-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-162-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-162-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-162-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-162-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-162-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span>strArr<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>String<span style="color:#666">[</span>10<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">int</span><span style="color:#666">[][]</span><span style="color:#bbb"> </span>twoDimArr<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#666">[</span>3<span style="color:#666">][</span>2<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#902000">int</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>oneDimArr<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#666">[</span>10<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>String<span style="color:#666">[]&gt;</span><span style="color:#bbb"> </span>strArrCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>strArr.<span style="color:#4070a0">getClass</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#666">[][]&gt;</span><span style="color:#bbb"> </span>twoDimArrCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>twoDimArr.<span style="color:#4070a0">getClass</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#666">[]&gt;</span><span style="color:#bbb"> </span>oneDimArrCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>oneDimArr.<span style="color:#4070a0">getClass</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>枚举类型也有对应的Class：</li>
</ul>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-163-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-163-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-163-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-163-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-163-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-163-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-163-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-163-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">enum</span><span style="color:#bbb"> </span>Size<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>SMALL,<span style="color:#bbb"> </span>MEDIUM,<span style="color:#bbb"> </span>BIG<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">		</span>Class<span style="color:#666">&lt;</span>Size<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>sCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Size.<span style="color:#4070a0">class</span>;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过Class对象可以获得很多信息：</p>
<h4 id="1名称信息">1.名称信息</h4>
<p>Class有四种与名称相关的方法。</p>
<p>不同Class对象的各种名称方法的返回值：</p>
<p><img src="images/image-20220325115839644.png"></p>
<ul>
<li>
<p><code>getSimpleName</code>：名称不带包信息；</p>
</li>
<li>
<p><code>getName</code>：Java内部使用的真正的名称；</p>
</li>
<li>
<p><code>getCanonicalName</code>：名称更为友好；</p>
</li>
<li>
<p><code>getPackage</code>返回的是包信息。</p>
</li>
</ul>
<blockquote>
<p>数组类型的getName，<code>[</code>表示数组，几个就表示几维数组；比如上面的二位数组就是<code>[[I</code></p>
<p>数组的类型用一个大写字符表示，<code>L</code>表示类或接口，<code>I</code>表示int，其它基本类型：boolean(<code>Z</code>)、byte(<code>B</code>)、char(<code>C</code>)、double(<code>D</code>)、float(<code>F</code>)、long(<code>J</code>)、short(<code>S</code>)；</p>
<p>对于<strong>引用类型的数组</strong>，注意最后有一个分号<code>;</code>。</p>
</blockquote>
<h4 id="2字段信息">2.字段信息</h4>
<p>类中定义的静态和实例变量都被称为<strong>字段</strong>，用类**<code>Field</code>**表示，位于包<!-- raw HTML omitted -->java.lang.reflect<!-- raw HTML omitted -->下，后文涉及的反射相关的类都位于该包下。Class有4个获取字段信息的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-164-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-164-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//返回所有的public字段，包括其父类的，如果没有字段，返回空数组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Field<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getFields</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回本类声明的所有字段，包括非public的，但不包括父类的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Field<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredFields</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回本类或父类中指定名称的public字段，找不到抛出异常NoSuchFieldException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Field<span style="color:#bbb"> </span><span style="color:#06287e">getField</span>(String<span style="color:#bbb"> </span>name)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回本类中声明的指定名称的字段，找不到抛出异常NoSuchFieldException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Field<span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredField</span>(String<span style="color:#bbb"> </span>name)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Field也有很多方法，可以获取字段的信息，也可以通过Field访问和操作<!-- raw HTML omitted -->指定对象中该字段的值<!-- raw HTML omitted -->：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-165-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-165-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//获取字段的名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getName</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//判断当前程序是否有该字段的访问权限</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAccessible</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//flag设为true表示忽略Java的访问检查机制，以允许读写非public的字段</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setAccessible</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>flag)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取指定对象obj中该字段的值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">get</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//将指定对象obj中该字段的值设为value</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">set</span>(Object<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>value)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在get/set方法中，对于静态变量，obj被忽略，可以为null，如果字段值为基本类型， <!-- raw HTML omitted -->get/set会自动在基本类型与对应的包装类型间进行转换<!-- raw HTML omitted -->；对于private字段，直接调用get/set会抛出非法访问异常IllegalAccessException，应该先调用<code>setAccessible(true)</code>以关闭Java的检查机制：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-166-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-166-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>obj<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">asList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span>{<span style="color:#4070a0">&#34;Andy&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;编程&#34;</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>lcls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>obj.<span style="color:#4070a0">getClass</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(lcls.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">for</span>(Field<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>lcls.<span style="color:#4070a0">getDeclaredFields</span>()){<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// 返回的是Arrays静态内部类ArrayList中的两个字段</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>f.<span style="color:#4070a0">setAccessible</span>(<span style="color:#007020;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(f.<span style="color:#4070a0">getName</span>()<span style="color:#666">+</span><span style="color:#4070a0">&#34; - &#34;</span><span style="color:#666">+</span>f.<span style="color:#4070a0">get</span>(obj)<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34; - &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>Modifier.<span style="color:#4070a0">toString</span>(f.<span style="color:#4070a0">getModifiers</span>()));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-167-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-167-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-167-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-167-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-167-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-167-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>java.<span style="color:#4070a0">util</span>.<span style="color:#4070a0">Arrays$ArrayList</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>serialVersionUID<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#666">-</span>2764017481108945198<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>a<span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#666">[</span>Ljava.<span style="color:#4070a0">lang</span>.<span style="color:#4070a0">String</span>;<span style="color:#555;font-weight:bold">@20fa23c1</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Field的其它方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-168-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-168-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//返回字段的修饰符，结果int通过Modifier类的静态方法toString解读</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getModifiers</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回字段的类型</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>getType()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//以基本类型操作字段</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setBoolean</span>(Object<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>z)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">getBoolean</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setDouble</span>(Object<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span><span style="color:#902000">double</span><span style="color:#bbb"> </span>d)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">double</span><span style="color:#bbb"> </span><span style="color:#06287e">getDouble</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//查询字段的注解信息，下一章介绍注解</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">getAnnotation</span>(Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>annotationClass)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredAnnotations</span>()<span style="color:#bbb">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>Modifier</code> 类提供静态方法和常量来解码类和成员访问修饰符。修饰符集合用整数表示，不同的位位置表示不同的修饰符。</p>
</blockquote>
<h4 id="3方法信息">3.方法信息</h4>
<p>类中定义的静态和实例方法都被称为<strong>方法</strong>，用类**<code>Method</code>**表示。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-169-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-169-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//返回所有的public方法，包括其父类的，如果没有方法，返回空数组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Method<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getMethods</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回本类声明的所有方法，包括非public的，但不包括父类的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Method<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredMethods</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回本类或父类中指定名称和参数类型的public方法，</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//找不到抛出异常NoSuchMethodException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span><span style="color:#06287e">getMethod</span>(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span>...<span style="color:#bbb"> </span>parameterTypes)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回本类中声明的指定名称和参数类型的方法，找不到抛出异常NoSuchMethodException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredMethod</span>(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span>...<span style="color:#bbb"> </span>parameterTypes)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注：<code>Class&lt;? &gt;... parameterTypes</code>表示方法参数的Class的数组。</p>
</blockquote>
<p>Method的基本方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-170-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-170-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//获取方法的名称</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">getName</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//flag设为true表示忽略Java的访问检查机制，以允许调用非public的方法</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setAccessible</span>(<span style="color:#902000">boolean</span><span style="color:#bbb"> </span>flag)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//在指定对象obj上调用Method代表的方法，传递的参数列表为args</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">invoke</span>(Object<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span>Object...<span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>IllegalAccessException,<span style="color:#bbb"> </span>IllegalArgumentException,<span style="color:#bbb"> </span>InvocationTargetException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对<code>invoke</code>方法，如果Method为静态方法，obj被忽略，可以为null, args可以为null，也可以为一个空的数组，方法调用的返回值被包装为Object返回，如果实际方法调用抛出异常，异常被包装为<code>InvocationTargetException</code>重新抛出，可以通过getCause方法得到原异常。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-171-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-171-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#666">&lt;</span>Integer<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>icls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Integer.<span style="color:#4070a0">class</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Method<span style="color:#bbb"> </span>method<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>icls.<span style="color:#4070a0">getMethod</span>(<span style="color:#4070a0">&#34;parseInt&#34;</span>,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[]</span>{String.<span style="color:#4070a0">class</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(method.<span style="color:#4070a0">invoke</span>(<span style="color:#007020;font-weight:bold">null</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;123&#34;</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(NoSuchMethodException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>e.<span style="color:#4070a0">printStackTrace</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(InvocationTargetException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>e.<span style="color:#4070a0">printStackTrace</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Method还有很多方法，可以获取其修饰符、参数、返回值、注解等信息。</p>
<h4 id="4创建对象和构造方法">4.创建对象和构造方法</h4>
<p>Class有一个用来创建对象的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-172-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-172-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">newInstance</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InstantiationException,<span style="color:#bbb"> </span>IllegalAccessException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它会调用类的默认构造方法（即无参public构造方法），如果类没有该构造方法，会抛出异常<code>InstantiationException</code>。</p>
<p>Class中获取所有构造方法的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-173-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-173-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//获取所有的public构造方法，返回值可能为长度为0的空数组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Constructor<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span><span style="color:#bbb"> </span>getConstructors()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取所有的构造方法，包括非public的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Constructor<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span><span style="color:#bbb"> </span>getDeclaredConstructors()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取指定参数类型的public构造方法，没找到抛出异常NoSuchMethodException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Constructor<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">getConstructor</span>(Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span>...<span style="color:#bbb"> </span>parameterTypes)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取指定参数类型的构造方法，包括非public的，没找到抛出异常NoSuchMethodException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Constructor<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredConstructor</span>(Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span>...<span style="color:#bbb"> </span>parameterTypes)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>Constructor</code>表示构造方法，它也有newInstance方法来创建对象：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-174-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-174-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-174-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-174-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">newInstance</span>(Object<span style="color:#bbb"> </span>...<span style="color:#bbb"> </span>initargs)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>InstantiationException,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IllegalAccessException,<span style="color:#bbb"> </span>IllegalArgumentException,<span style="color:#bbb"> </span>InvocationTargetException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>例子：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-175-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-175-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-175-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-175-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-175-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-175-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 通过指定参数类型，获取到特定构造方法</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Constructor<span style="color:#666">&lt;</span>StringBuilder<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>constructor<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>StringBuilder.<span style="color:#4070a0">class</span>.<span style="color:#4070a0">getConstructor</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[]</span>{<span style="color:#902000">int</span>.<span style="color:#4070a0">class</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>StringBuilder<span style="color:#bbb"> </span>sb<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>constructor.<span style="color:#4070a0">newInstance</span>(100);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Constructor还有很多获取关于构造方法信息（参数、修饰符、注解等）的方法。</p>
<h4 id="5类型检查和转换">5.类型检查和转换</h4>
<p><code>instanceof</code>关键字可以用来判断<strong>变量指向的实际对象类型</strong>。</p>
<p>instanceof后面的类型是在代码中确定的，如果要检查的类型是动态的，可以使用Class类的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-176-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-176-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isInstance</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-177-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-177-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-177-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-177-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-177-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-177-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(list<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>ArrayList)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;array list&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>等价于：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-178-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-178-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-178-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-178-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-178-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-178-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-178-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-178-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#4070a0">&#34;java.util.ArrayList&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(cls.<span style="color:#4070a0">isIntance</span>(list))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;array list&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Class中强制转换类型的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-179-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-179-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">cast</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>正常转换：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-180-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-180-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-180-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-180-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-180-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-180-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-180-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-180-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span>List<span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>..<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span>(list<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>ArrayList){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>ArrayList<span style="color:#bbb"> </span>arrList<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(ArrayList)list;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>强制转换到的类型ArrayList，在写代码时就知道了。</p>
<p>使用cast方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-181-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-181-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-181-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-181-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-181-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-181-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-181-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-181-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 把对象obj强制转换成T</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">toType</span>(Object<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span>Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">cast</span>(obj);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>判断Class之间的关系：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-182-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-182-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-182-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-182-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-182-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-182-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-182-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-182-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 检查参数类型cls能否赋给当前Class类型的变量</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAssignableFrom</span>(Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Object.<span style="color:#4070a0">class</span>.<span style="color:#4070a0">isAssignableFrom</span>(String.<span style="color:#4070a0">class</span>)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6class的类型信息">6.Class的类型信息</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-183-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-183-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isArray</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是数组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isPrimitive</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是基本类型</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isInterface</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是接口</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isEnum</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是枚举</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAnnotation</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是注解</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAnonymousClass</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是匿名内部类</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isMemberClass</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是成员类，成员类定义在方法外，不是匿名类</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isLocalClass</span>()<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//是否是本地类，本地类定义在方法内，不是匿名类</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="7类的声明信息">7.类的声明信息</h4>
<p>类的声明信息，如修饰符、父类、接口、注解等：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-184-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-184-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//获取修饰符，返回值可通过Modifier类进行解读</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getModifiers</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取父类，如果为Object，父类为null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">getSuperclass</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//对于类，为自己声明实现的所有接口，对于接口，为直接扩展的接口，不包括通过父类继承的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span><span style="color:#bbb"> </span>getInterfaces();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//自己声明的注解</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredAnnotations</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//所有的注解，包括继承得到的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getAnnotations</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取或检查指定类型的注解，包括继承得到的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>A<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>A<span style="color:#bbb"> </span><span style="color:#06287e">getAnnotation</span>(Class<span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>annotationClass)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAnnotationPresent</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>annotationClass)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="8类的加载">8.类的加载</h4>
<p>Class有两个静态方法，可以根据类名加载类：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-185-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-185-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-185-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-185-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>forName(String<span style="color:#bbb"> </span>className)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>forName(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>initialize,<span style="color:#bbb">  </span>ClassLoader<span style="color:#bbb"> </span>loader)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ClassLoader表示类加载器；initialize表示加载后，<!-- raw HTML omitted -->是否执行类的初始化代码<!-- raw HTML omitted -->（如static语句块）。第一个方法中没有传这些参数，相当于：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-186-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-186-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class.<span style="color:#4070a0">forName</span>(className,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>,<span style="color:#bbb"> </span>currentLoader)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>className与Class.getName的返回值是一致的，是Java内部使用的名称。如对于String数组：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-187-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-187-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-187-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-187-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-187-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-187-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;[Ljava.lang.String; &#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Class<span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(name);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(cls<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span>.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>java9的添加的forName方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-188-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-188-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>forName(Module<span style="color:#bbb"> </span>module,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="9反射与数组">9.反射与数组</h4>
<p>对于数组类型，有一个专门的方法，可以获取它的<strong>元素类型</strong>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-189-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-189-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>getComponentType()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-190-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-190-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-190-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-190-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span>arr<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span>{};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(arr.<span style="color:#4070a0">getClass</span>().<span style="color:#4070a0">getComponentType</span>());<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">// class java.lang.String</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>java.lang.reflect包中有一个针对数组的专门的类<code>Array</code>（注意不是java.util中的<code>Arrays</code>)，提供了对于数组的一些反射支持，以便于统一处理多种类型的数组，主要方法有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-191-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-191-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//创建指定元素类型、指定长度的数组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">newInstance</span>(Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>componentType,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>length)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//创建多维数组</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">newInstance</span>(Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>componentType,<span style="color:#bbb"> </span><span style="color:#902000">int</span>...<span style="color:#bbb"> </span>dimensions)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取数组array指定的索引位置index处的值</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">get</span>(Object<span style="color:#bbb"> </span>array,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>index)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//修改数组array指定的索引位置index处的值为value</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">set</span>(Object<span style="color:#bbb"> </span>array,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>index,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>value)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//返回数组的长度</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">native</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">getLength</span>(Object<span style="color:#bbb"> </span>array)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在Array类中，数组是用Object而非Object[]表示的。</p>
<h4 id="10反射与枚举">10.反射与枚举</h4>
<p>获取所有的枚举常量:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-192-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-192-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>T<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getEnumConstants</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="212-应用示例实现简单的通用序列化反序列化">21.2 应用示例：实现简单的通用序列化/反序列化</h3>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-53">53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-54">54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-55">55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-56">56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-57">57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-58">58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-59">59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-60">60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-61">61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-62">62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-63">63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-64">64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-65">65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-66">66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-67">67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-68">68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-69">69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-70">70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-71">71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-72">72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-73">73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-74">74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-75">75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-76">76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-77">77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-78">78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-79">79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-80">80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-81">81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-82">82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-193-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-193-83">83</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 利用反射实现一个简单的通用序列化/反序列化类SimpleMapper
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 只支持最简单的类，即有默认构造方法，成员类型只有基本类型、包装类或String。
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleMapper</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">toString</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>obj.<span style="color:#4070a0">getClass</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>StringBuilder<span style="color:#bbb"> </span>sb<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>StringBuilder();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>sb.<span style="color:#4070a0">append</span>(cls.<span style="color:#4070a0">getName</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;\n&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(Field<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>cls.<span style="color:#4070a0">getDeclaredFields</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">isAccessible</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>f.<span style="color:#4070a0">setAccessible</span>(<span style="color:#007020;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>sb.<span style="color:#4070a0">append</span>(f.<span style="color:#4070a0">getName</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;=&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">get</span>(obj).<span style="color:#4070a0">toString</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;\n&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>sb.<span style="color:#4070a0">toString</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(IllegalAccessException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">fromString</span>(String<span style="color:#bbb"> </span>str)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span>lines<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>str.<span style="color:#4070a0">split</span>(<span style="color:#4070a0">&#34;\n&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(lines.<span style="color:#4070a0">length</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>1)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>IllegalArgumentException(str);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(lines<span style="color:#666">[</span>0<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Object<span style="color:#bbb"> </span>obj<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">newInstance</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(lines.<span style="color:#4070a0">length</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>1)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>1;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>lines.<span style="color:#4070a0">length</span>;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span>fv<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>lines<span style="color:#666">[</span>i<span style="color:#666">]</span>.<span style="color:#4070a0">split</span>(<span style="color:#4070a0">&#34;=&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(fv.<span style="color:#4070a0">length</span><span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span>2)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>IllegalArgumentException(lines<span style="color:#666">[</span>i<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>Field<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">getDeclaredField</span>(fv<span style="color:#666">[</span>0<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">isAccessible</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                        </span>f.<span style="color:#4070a0">setAccessible</span>(<span style="color:#007020;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>setFieldValue(f,<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span>fv<span style="color:#666">[</span>1<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>obj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Exception<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 根据字段的类型，将字符串形式的值转换为了对应类型的值。
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 对于基本类型和String以外的类型，它假定该类型有一个以String类型为参数的构造方法。
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param f 字段
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param obj 对象
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param value 字段的值
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @throws Exception
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">setFieldValue</span>(Field<span style="color:#bbb"> </span>f,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>obj,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>type<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">getType</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">int</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setInt</span>(obj,<span style="color:#bbb"> </span>Integer.<span style="color:#4070a0">parseInt</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">byte</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setByte</span>(obj,<span style="color:#bbb"> </span>Byte.<span style="color:#4070a0">parseByte</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">long</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setLong</span>(obj,<span style="color:#bbb"> </span>Long.<span style="color:#4070a0">parseLong</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">short</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setShort</span>(obj,<span style="color:#bbb"> </span>Short.<span style="color:#4070a0">parseShort</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">float</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setFloat</span>(obj,<span style="color:#bbb"> </span>Float.<span style="color:#4070a0">parseFloat</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">double</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setDouble</span>(obj,<span style="color:#bbb"> </span>Double.<span style="color:#4070a0">parseDouble</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">char</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setChar</span>(obj,<span style="color:#bbb"> </span>value.<span style="color:#4070a0">charAt</span>(0));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span>.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">setBoolean</span>(obj,<span style="color:#bbb"> </span>Boolean.<span style="color:#4070a0">parseBoolean</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(type<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>String.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">set</span>(obj,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Constructor<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>constructor<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>type.<span style="color:#4070a0">getConstructor</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[]</span>{String.<span style="color:#4070a0">class</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>f.<span style="color:#4070a0">set</span>(obj,<span style="color:#bbb"> </span>constructor.<span style="color:#4070a0">newInstance</span>(value));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="213-反射与泛型">21.3 反射与泛型</h3>
<p>泛型参数在运行时会被==擦除==，在类信息Class中依然有关于泛型的一些信息，可以通过反射得到。</p>
<p>Class有如下方法，可以获取类的泛型参数信息：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-194-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-194-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>TypeVariable<span style="color:#666">&lt;</span>Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getTypeParameters</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Field有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-195-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-195-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Type<span style="color:#bbb"> </span><span style="color:#06287e">getGenericType</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Method有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-196-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-196-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-196-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-196-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-196-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-196-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Type<span style="color:#bbb"> </span><span style="color:#06287e">getGenericReturnType</span>()<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Type<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getGenericParameterTypes</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Type<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getGenericExceptionTypes</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Constructor有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-197-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-197-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Type<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getGenericParameterTypes</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>Type</code>是一个接口，Class实现了Type, Type的其他子接口还有：</p>
<ul>
<li><code>TypeVariable</code>：类型参数，可以有上界，比如<code>T extends Number</code>；</li>
<li><code>ParameterizedType</code>：参数化的类型，有原始类型和具体的类型参数，比如<code>List&lt;String&gt;</code>；</li>
<li><code>WildcardType</code>：通配符类型，比如<code>?</code>、<code>? extends Number</code>、<code>? super Integer</code>。</li>
</ul>
<p>**如果能用接口实现同样的灵活性，就不要使用反射。**原因：</p>
<ol>
<li>反射更容易出现运行时错误，使用显式的类和接口，编译器能帮我们做类型检查，减少错误，但使用反射，类型是运行时才知道的，编译器无能为力。</li>
<li>反射的性能要低一些，在访问字段、调用方法前，反射先要查找对应的Field/Method，要慢一些。</li>
</ol>
<h2 id="22-注解">22 注解</h2>
<p>在Java中，注解就是给程序添加一些信息，用字符<code>@</code>开头，这些信息用于修饰它后面紧挨着的其他代码元素，比如<!-- raw HTML omitted -->类、接口、字段、方法、方法中的参数、构造方法<!-- raw HTML omitted -->等。注解可以被编译器、程序运行时和其他工具使用，用于<strong>增强或修改</strong>程序行为等。</p>
<h3 id="221-内置注解">22.1 内置注解</h3>
<h4 id="override">@Override</h4>
<p>修饰方法，表示该方法不是当前类首先声明的（而是在父类或接口中）。不写，也改变不了”==重写==“的本质，但还是加上，让编译器帮助减少编程的错误。</p>
<h4 id="deprecated">@Deprecated</h4>
<p>修饰范围很广，可以是类、方法、字段、参数等，表示代码过时，是一种警告，不是强制性的。</p>
<p>在声明元素为@Deprecated时，应该用Java文档注释的方式同时说明替代方案，优先使用替代方案。</p>
<p>从Java 9开始，@Deprecated多了两个属性：since和forRemoval。since是一个字符串，表示是从哪个版本开始过时的；forRemoval是一个boolean值，表示将来是否会删除。</p>
<h4 id="suppresswarnings">@SuppressWarnings</h4>
<p>表示压制Java的编译警告，它有一个<strong>必填参数</strong>，表示压制哪种类型的警告，它也可以修饰大部分代码元素，在更大范围的修饰也会对内部元素起效，比如，在类上的注解会影响到方法，在方法上的注解会影响到代码行。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-198-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-198-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-198-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-198-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-198-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-198-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-198-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-198-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-198-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-198-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@SuppressWarnings</span>({<span style="color:#4070a0">&#34;deprecation&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;unused&#34;</span>})<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Date<span style="color:#bbb"> </span>date<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Date(2017,<span style="color:#bbb"> </span>4,<span style="color:#bbb"> </span>12);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>year<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>date.<span style="color:#4070a0">getYear</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="222-框架和库的注解">22.2 框架和库的注解</h3>
<h4 id="1jackson">1.Jackson</h4>
<p>Jackson是一个通用的序列化库，其中一些注解可以对序列化进行定制：</p>
<ul>
<li>使用@JsonIgnore和@JsonIgnoreProperties配置忽略字段。</li>
<li>使用@JsonManagedReference和@JsonBackReference配置互相引用关系。</li>
<li>使用@JsonProperty和@JsonFormat配置字段的名称和格式等。</li>
</ul>
<p>注解出现之前，同样的配置功能使用配置文件也同样能实现，但<strong>配置项和要配置的程序元素不在一个地方，难易管理和维护</strong>。</p>
<h4 id="2依赖注入容器">2.依赖注入容器</h4>
<p>现代Java开发经常利用某种框架<strong>管理对象的生命周期及其依赖关系</strong>。</p>
<p>这个框架一般称为DI（Dependency Injection）容器。DI是指==依赖注入==，流行的框架有Spring、<a href="https://github.com/google/guice">Guice</a>等。</p>
<p>在使用这些框架时，程序员一般<strong>不通过new创建对象，而是由容器管理对象的创建，对于依赖的服务，也不需要自己管理，而是使用注解表达依赖关系</strong>。</p>
<h4 id="3servlet-30">3.Servlet 3.0</h4>
<p>Servlet是Java为Web应用提供的技术框架，早期的Servlet只能在web.xml中进行配置，而Servlet 3.0则开始支持注解，可以使用@WebServlet配置一个类为Servlet，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-199-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-199-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-199-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-199-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-199-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-199-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-199-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-199-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@WebServlet</span>(urlPatterns<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;/async&#34;</span>,<span style="color:#bbb"> </span>asyncSupported<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">AsyncDemoServlet</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>HttpServlet<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4web应用框架">4.Web应用框架</h4>
<h4 id="5神奇的注解">5.神奇的注解</h4>
<p>注解通过简单的声明，就可以达到某种效果；</p>
<p>有点类似序列化机制中通过简单的<code>Serializable</code>接口，Java就能自动处理很多复杂的事情；</p>
<p>也类似<code>synchronized</code>关键字，通过它可以自动实现同步访问；</p>
<p>在这些**==声明式编程风格==**中，程序都由三个组件组成：</p>
<ul>
<li>声明的关键字和语法本身</li>
<li>系统/框架/库，它们==负责解释、执行声明式的语句==</li>
<li>应用程序，使用声明式风格写程序</li>
</ul>
<p><strong>在编程的世界里，访问数据库的SQL语言、编写网页样式的CSS，以及正则表达式、函数式编程都是这种风格，这种风格降低了编程的难度，为应用程序员提供了更为高级的语言，使得程序员可以在更高的抽象层次上思考和解决问题，而不是陷于底层的细节实现。</strong></p>
<blockquote>
<p>❤️</p>
<p>命令式编程（Imperative Programming）是一种以命令和指令为中心的编程范式。在命令式编程中，程序员通过编写一系列的指令来描述计算机执行的步骤。程序按照给定的顺序执行，通过使用变量、循环、条件语句等控制结构来改变程序的状态。</p>
<p>声明式编程（Declarative Programming）是一种更侧重于描述问题的解决方法，而不是详细指定解决方法的编程范式。在声明式编程中，程序员通过声明所需的结果来描述计算机应该完成的任务，而不是指定如何执行这些任务。常见的声明式编程语言包括SQL、HTML、CSS等。</p>
<p>函数式编程（Functional Programming）是一种以函数为基本构建块的编程范式。在函数式编程中，函数被看作是一等公民，可以像其他值一样作为参数传递、返回和存储。函数式编程强调纯函数的使用，避免副作用，并倡导不可变性和无状态的编程方式。</p>
<p>响应式编程（Reactive Programming）是一种关注数据流和变化的编程范式。在响应式编程中，程序通过对数据流进行观察和响应来处理异步事件。它使用观察者模式和可观察序列（Observable）来处理数据流和事件，使得程序可以以响应式的方式处理变化和异步操作。</p>
</blockquote>
<h3 id="223-创建注解">22.3 创建注解</h3>
<p><code>@Override</code>的定义：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-200-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-200-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-200-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-200-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-200-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-200-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-200-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-200-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">METHOD</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">SOURCE</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>Override<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted -->@Target和@Retention<!-- raw HTML omitted -->是**==元注解==**，专门用于定义注解本身。</p>
<p>@Target表示注解的目标。<code>ElementType</code>是一个枚举，主要可选值有：</p>
<ul>
<li>TYPE：表示类、接口（包括注解），或者枚举声明；</li>
<li>FIELD：字段，包括枚举常量；</li>
<li>METHOD：方法；</li>
<li>PARAMETER：方法中的参数；</li>
<li>CONSTRUCTOR：构造方法；</li>
<li>LOCAL_VARIABLE：本地变量；</li>
<li>MODULE：模块（Java 9引入的）。</li>
</ul>
<p>如果没有声明@Target，<strong>默认为适用于所有类型</strong>。</p>
<p>@Retention表示注解信息保留到什么时候，取值只能有一个，类型为<code>RetentionPolicy</code>，它是一个枚举，有三个取值。</p>
<ul>
<li>SOURCE：只在源代码中保留，编译器将代码编译为字节码文件后就会丢掉。</li>
<li>CLASS：保留到字节码文件中，但Java虚拟机将class文件加载到内存时不一定会在内存中保留。</li>
<li>RUNTIME：一直保留到运行时。</li>
</ul>
<p>没有声明@Retention，则默认为CLASS。</p>
<p>可以为注解定义一些参数，定义的方式是在注解内定义一些方法，返回值类型表示参数的类型，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-201-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-201-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 定义</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>SuppressWarings<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">value</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 使用</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@SuppressWarings</span>(value<span style="color:#666">=</span>{<span style="color:#4070a0">&#34;deprecation&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;unused&#34;</span>})<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当只有一个参数，且名称为value时，使用时可简写：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-202-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-202-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@SuppressWarings</span>({<span style="color:#4070a0">&#34;deprecation&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;unused&#34;</span>})<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注解内参数的类型，可以是<!-- raw HTML omitted -->基本类型、String、Class、枚举、注解，以及这些类型的数组<!-- raw HTML omitted -->。</p>
<p>参数定义时可以使用default指定一个默认值，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-203-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-203-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-203-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-203-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-203-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-203-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-203-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-203-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-203-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-203-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-203-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-203-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@Target</span>({<span style="color:#bbb"> </span>METHOD,<span style="color:#bbb"> </span>CONSTRUCTOR,<span style="color:#bbb"> </span>FIELD<span style="color:#bbb"> </span>})<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Retention</span>(RUNTIME)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Documented</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>Inject<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">optional</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果参数没有提供默认值，使用注解时必须提供具体的值，不能为null。</p>
<p>元注解<code>@Documented</code>，表示<strong>注解信息包含到生成的文档中</strong>。</p>
<p>注解不能继承。不过注解有一个与继承有关的元注解<code>@Inherited</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-204-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-204-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">InheritDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Inherited</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>Test<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Base</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Child</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Base<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(Child.<span style="color:#4070a0">class</span>.<span style="color:#4070a0">isAnnotationPresent</span>(Test.<span style="color:#4070a0">class</span>));<span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注解@Inherited会让Child继承了Base的注解。</p>
<h3 id="224-查看注解信息">22.4 查看注解信息</h3>
<p>注解要影响程序，先要能查看这些信息。</p>
<p>主要考虑<code>@Retention</code>为<code>RetentionPolicy.RUNTIME</code>的注解，利用反射机制在运行时进行查看和利用这些信息。</p>
<p>反射相关类中与注解相关的方法，Class、Field、Method、Constructor中都有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-205-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-205-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//获取所有的注解</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getAnnotations</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取所有本元素上直接声明的注解，忽略inherited来的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">getDeclaredAnnotations</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//获取指定类型的注解，没有返回null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>A<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>A<span style="color:#bbb"> </span><span style="color:#06287e">getAnnotation</span>(Class<span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>annotationClass)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//判断是否有指定类型的注解</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isAnnotationPresent</span>(Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>annotationClass)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Annotation是一个接口，表示注解，具体定义：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-206-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-206-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Annotation</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">equals</span>(Object<span style="color:#bbb"> </span>obj);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">hashCode</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#06287e">toString</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">//返回真正的注解类型</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">annotationType</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>内部实现时，==所有的注解类型都是扩展的Annotation==。</strong></p>
<p>对于Method和Contructor，它们都有方法参数，而参数也可以有注解，因而它们有另外的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-207-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-207-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Annotation<span style="color:#666">[][]</span><span style="color:#bbb"> </span><span style="color:#06287e">getParameterAnnotations</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>返回结果为一个二维数组，每个参数对应一个一维数组。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-208-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-208-33">33</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">MethodAnnotations</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">PARAMETER</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>QueryParam<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span><span style="color:#06287e">value</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">PARAMETER</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>DefaultValue<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span><span style="color:#06287e">value</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">hello</span>(<span style="color:#555;font-weight:bold">@QueryParam</span>(<span style="color:#4070a0">&#34;action&#34;</span>)<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>action,<span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@QueryParam</span>(<span style="color:#4070a0">&#34;sort&#34;</span>)<span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@DefaultValue</span>(<span style="color:#4070a0">&#34;asc&#34;</span>)<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>sort){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//…</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>MethodAnnotations.<span style="color:#4070a0">class</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Method<span style="color:#bbb"> </span>method<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">getMethod</span>(<span style="color:#4070a0">&#34;hello&#34;</span>,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[]</span>{String.<span style="color:#4070a0">class</span>,<span style="color:#bbb"> </span>String.<span style="color:#4070a0">class</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Annotation<span style="color:#666">[][]</span><span style="color:#bbb"> </span>annts<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getParameterAnnotations</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(<span style="color:#902000">int</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>0;<span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>annts.<span style="color:#4070a0">length</span>;<span style="color:#bbb"> </span>i<span style="color:#666">++</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;annotations for paramter &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>(i<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>1));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Annotation<span style="color:#666">[]</span><span style="color:#bbb"> </span>anntArr<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>annts<span style="color:#666">[</span>i<span style="color:#666">]</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">for</span>(Annotation<span style="color:#bbb"> </span>annt<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>anntArr)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span>(annt<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>QueryParam)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>QueryParam<span style="color:#bbb"> </span>qp<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(QueryParam)<span style="color:#bbb"> </span>annt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(qp.<span style="color:#4070a0">annotationType</span>().<span style="color:#4070a0">getSimpleName</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;:&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>qp.<span style="color:#4070a0">value</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">if</span>(annt<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>DefaultValue)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>DefaultValue<span style="color:#bbb"> </span>dv<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(DefaultValue)<span style="color:#bbb"> </span>annt;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(dv.<span style="color:#4070a0">annotationType</span>().<span style="color:#4070a0">getSimpleName</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;:&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>dv.<span style="color:#4070a0">value</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>定义了注解，通过反射获取到注解信息，但具体怎么利用这些信息呢？</p>
<h3 id="225-注解的应用定制序列化">22.5 注解的应用：定制序列化</h3>
<p>定义两个注解：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-209-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-209-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 定制输出字段的名称
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">FIELD</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>Label<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#06287e">value</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 定义日期类型的输出格式
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">FIELD</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>Format<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#06287e">pattern</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;yyyy-MM-dd HH:mm:ss&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#06287e">timezone</span>()<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;GMT+8&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用注解来修饰要序列化的类字段：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-210-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-210-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Student</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Label</span>(<span style="color:#4070a0">&#34;姓名&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#bbb"> </span>name;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Label</span>(<span style="color:#4070a0">&#34;出生日期&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Format</span>(pattern<span style="color:#666">=</span><span style="color:#4070a0">&#34;yyyy/MM/dd&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Date<span style="color:#bbb"> </span>born;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Label</span>(<span style="color:#4070a0">&#34;分数&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">double</span><span style="color:#bbb"> </span>score;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">// ... </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">  
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>获取处理注解：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-211-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-211-40">40</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleFormatter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">format</span>(Object<span style="color:#bbb"> </span>obj)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>obj.<span style="color:#4070a0">getClass</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>StringBuilder<span style="color:#bbb"> </span>sb<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>StringBuilder();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">for</span>(Field<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>cls.<span style="color:#4070a0">getDeclaredFields</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span>(<span style="color:#666">!</span>f.<span style="color:#4070a0">isAccessible</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>f.<span style="color:#4070a0">setAccessible</span>(<span style="color:#007020;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>Label<span style="color:#bbb"> </span>label<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">getAnnotation</span>(Label.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>String<span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>label<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span><span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span>label.<span style="color:#4070a0">value</span>()<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>f.<span style="color:#4070a0">getName</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>Object<span style="color:#bbb"> </span>value<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">get</span>(obj);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span>(value<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span><span style="color:#bbb"> </span><span style="color:#666">&amp;&amp;</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">getType</span>()<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span>Date.<span style="color:#4070a0">class</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>value<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>formatDate(f,<span style="color:#bbb"> </span>value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>sb.<span style="color:#4070a0">append</span>(name<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;: &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>value<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;\n&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>sb.<span style="color:#4070a0">toString</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(IllegalAccessException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">formatDate</span>(Field<span style="color:#bbb"> </span>f,<span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Format<span style="color:#bbb"> </span>format<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">getAnnotation</span>(Format.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">if</span>(format<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>SimpleDateFormat<span style="color:#bbb"> </span>sdf<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>SimpleDateFormat(format.<span style="color:#4070a0">pattern</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>sdf.<span style="color:#4070a0">setTimeZone</span>(TimeZone.<span style="color:#4070a0">getTimeZone</span>(format.<span style="color:#4070a0">timezone</span>()));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>sdf.<span style="color:#4070a0">format</span>(value);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>value;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ParseException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>SimpleDateFormat<span style="color:#bbb"> </span>sdf<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>SimpleDateFormat(<span style="color:#4070a0">&#34;yyyy-MM-dd&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Student<span style="color:#bbb"> </span>zs<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;张三&#34;</span>,<span style="color:#bbb"> </span>sdf.<span style="color:#4070a0">parse</span>(<span style="color:#4070a0">&#34;2002-5-31&#34;</span>),<span style="color:#bbb"> </span>89.<span style="color:#4070a0">2d</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(SimpleFormatter.<span style="color:#4070a0">format</span>(zs));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>结果为：</p>
<pre tabindex="0"><code>姓名: 张三
出生日期: 2002/05/31
分数: 89.2
</code></pre><h3 id="226-注解的应用di容器">22.6 注解的应用：DI容器</h3>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-213-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-213-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">TYPE</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>SimpleSingleton<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Retention</span>(RetentionPolicy.<span style="color:#4070a0">RUNTIME</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Target</span>(ElementType.<span style="color:#4070a0">FIELD</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#555;font-weight:bold">@interface</span><span style="color:#bbb"> </span>SimpleInject<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-214-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-214-15">15</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#555;font-weight:bold">@SimpleSingleton</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ServiceB</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">action</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;I&#39;m B&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ServiceA</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@SimpleInject</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>ServiceB<span style="color:#bbb"> </span>b;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">callB</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>b.<span style="color:#4070a0">action</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-50">50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-51">51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-52">52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-53">53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-54">54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-55">55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-56">56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-57">57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-58">58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-59">59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-60">60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-215-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-215-61">61</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * DI容器
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleContainer</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 缓存创建过的单例对象
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Map<span style="color:#666">&lt;</span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span>,<span style="color:#bbb"> </span>Object<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>instances<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ConcurrentHashMap<span style="color:#666">&lt;&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * 创建需要的对象，并配置依赖关系
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param cls
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     * @param &lt;T&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">     */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">getInstance</span>(Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic">// 如果非单列模式，直接常见实例</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>singleton<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">isAnnotationPresent</span>(SimpleSingleton.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>singleton)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>createInstance(cls);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic">// 单利模式，从缓冲获取</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Object<span style="color:#bbb"> </span>obj<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>instances.<span style="color:#4070a0">get</span>(cls);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(obj<span style="color:#bbb"> </span><span style="color:#666">!=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(T)<span style="color:#bbb"> </span>obj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic">// TODO</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(cls)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>obj<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>instances.<span style="color:#4070a0">get</span>(cls);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(obj<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>obj<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>createInstance(cls);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>instances.<span style="color:#4070a0">put</span>(cls,<span style="color:#bbb"> </span>obj);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(T)<span style="color:#bbb"> </span>obj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Exception<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">createInstance</span>(Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Exception<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>T<span style="color:#bbb"> </span>obj<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">newInstance</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Field<span style="color:#666">[]</span><span style="color:#bbb"> </span>fields<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">getDeclaredFields</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(Field<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>fields)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic">// 当前字段上如果有注解SimpleInject，就初始化</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(f.<span style="color:#4070a0">isAnnotationPresent</span>(SimpleInject.<span style="color:#4070a0">class</span>))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#666">!</span>f.<span style="color:#4070a0">isAccessible</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>f.<span style="color:#4070a0">setAccessible</span>(<span style="color:#007020;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>fieldCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">getType</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>f.<span style="color:#4070a0">set</span>(obj,<span style="color:#bbb"> </span>getInstance(fieldCls));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>obj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">// 使用getInstance方法获取对象实例，而不是自己new</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>ServiceA<span style="color:#bbb"> </span>a<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>SimpleContainer.<span style="color:#4070a0">getInstance</span>(ServiceA.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>a.<span style="color:#4070a0">callB</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>注解提升了Java语言的==表达能力==，有效地实现了==应用功能和底层功能的分离==，==框架/库的程序员==可以专注于底层实现，借助反射实现通用功能，提供注解给==应用程序员==使用，应用程序员可以专注于应用功能，通过简单的声明式注解与框架/库进行协作。</strong></p>
<blockquote>
<p>Java中一种更为动态灵活的机制：动态代理。</p>
</blockquote>
<h2 id="23-动态代理">23 动态代理</h2>
<p>在运行时动态创建一个类，实现一个或多个接口，可以<strong>在不修改原有类的基础上动态为通过该类获取的对象==添加方法、修改行为==</strong>。</p>
<p>动态代理是实现面向切面的编程<strong>AOP</strong>（Aspect OrientedProgramming）的基础。切面的例子有<strong>日志、性能监控、权限检查、数据库事务</strong>等，它们在程序的很多地方都会用到，代码都差不多，但与某个具体的业务逻辑关系也不太密切，如果在每个用到的地方都写，代码会很冗余，也难以维护，AOP将这些切面==与主体逻辑相分离==，代码简单优雅得多。</p>
<p>和注解类似，在大部分的应用编程中，我们不需要自己实现动态代理，而只需要按照框架和库的文档说明进行使用就可以了。不过，理解动态代理有助于我们更为深刻地理解这些框架和库，也能更好地应用它们，在自己的业务需要时，也能自己实现。</p>
<p>动态代理有两种实现方式：一种是Java SDK提供的；另外一种是第三方库（如cglib）提供的。</p>
<h3 id="231-静态代理">23.1 静态代理</h3>
<p>代理存在的价值：</p>
<ol>
<li>节省成本比较高的实际对象的创建开销，<strong>==按需延迟加载==</strong>，创建代理时并不真正创建实际对象，而只是保存实际对象的地址，在需要时再加载或创建。</li>
<li>执行**==权限检查==**，代理检查权限后，再调用实际对象。</li>
<li><strong>==屏蔽网络差异和复杂性==</strong>，代理在本地，而实际对象在其他服务器上，调用本地代理时，本地代理请求其他服务器。</li>
</ol>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-216-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-216-37">37</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> * 静态代理示例
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"> */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleStaticProxyDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">IService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">RealService</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>IService<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">TraceProxy</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>IService<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>IService<span style="color:#bbb"> </span>realService;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">TraceProxy</span>(IService<span style="color:#bbb"> </span>realService)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">realService</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>realService;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;entering sayHello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">realService</span>.<span style="color:#4070a0">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;leaving sayHello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IService<span style="color:#bbb"> </span>realService<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RealService();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IService<span style="color:#bbb"> </span>proxyService<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>TraceProxy(realService);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>proxyService.<span style="color:#4070a0">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>代理和实际对象一般有相同的接口</strong>，共同的接口是IService，实际对象是RealService，代理是TraceProxy。</p>
<p>TraceProxy内部有一个IService的<strong>成员变量，指向实际对象，在构造方法中被初始化</strong>，对于方法sayHello的调用，它转发给了实际对象，在调用前后输出了一些跟踪调试信息。</p>
<p><!-- raw HTML omitted -->代理模式与适配器和装饰器有点类似<!-- raw HTML omitted -->，它们的背后都有一个别的实际对象，都是通过==组合==的方式指向该对象，不同之处在于，<!-- raw HTML omitted -->适配器是提供了一个不一样的新接口，装饰器是对原接口起到了“装饰”作用，可能是增加了新接口、修改了原有的行为等，==代理一般不改变接口==。<!-- raw HTML omitted --></p>
<p>代理类TraceProxy的代码是在写程序时固定的，所以称为**==静态代理==**。</p>
<p>输出跟踪调试信息是一个通用需求。</p>
<h3 id="232-java-sdk动态代理">23.2 Java SDK动态代理</h3>
<p>在静态代理中，代理类是直接定义在代码中的；在动态代理中，代理类是动态生成的。</p>
<h4 id="用法-3">用法</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-217-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-217-33">33</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleJDKDynamicProxyDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">IService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">RealService</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>IService<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleInvocationHandler</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>InvocationHandler<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>realObj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">SimpleInvocationHandler</span>(Object<span style="color:#bbb"> </span>realObj)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">realObj</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>realObj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">invoke</span>(Object<span style="color:#bbb"> </span>proxy,<span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>method,<span style="color:#bbb"> </span>Object<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Throwable<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;entering &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Object<span style="color:#bbb"> </span>result<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">invoke</span>(realObj,<span style="color:#bbb"> </span>args);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;leaving &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>result;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IService<span style="color:#bbb"> </span>realService<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RealService();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IService<span style="color:#bbb"> </span>proxyService<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(IService)<span style="color:#bbb"> </span>Proxy.<span style="color:#4070a0">newProxyInstance</span>(IService.<span style="color:#4070a0">class</span>.<span style="color:#4070a0">getClassLoader</span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span>{<span style="color:#bbb"> </span>IService.<span style="color:#4070a0">class</span><span style="color:#bbb"> </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>SimpleInvocationHandler(realService));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>proxyService.<span style="color:#4070a0">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>IService和RealService的定义不变，程序的输出也没变，但<!-- raw HTML omitted -->代理对象proxyService的创建方式变了<!-- raw HTML omitted -->，它使用java.lang.reflect包中的<code>Proxy</code>类的静态方法<code>newProxyInstance</code>来创建代理对象，这个方法的声明：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-218-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-218-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">newProxyInstance</span>(ClassLoader<span style="color:#bbb"> </span>loader,<span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span><span style="color:#bbb"> </span>interfaces,<span style="color:#bbb"> </span>InvocationHandler<span style="color:#bbb"> </span>h)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>第一个参数loader表示类加载器。例子是使用与IService一样的类加载器；</li>
<li>interfaces表示<strong>代理类要实现的接口列表</strong>，是一个Class数组，元素的类型只能是接口，不能是普通的类；</li>
<li><code>InvocationHandler</code>是一个接口，也定义在java.lang.reflect包中，它只定义了一个方法<code>invoke</code>，<strong>对代理接口所有方法的调用都会转给该方法</strong>。</li>
</ul>
<p>newProxyInstance的返回值类型为Object，可以强制转换为<!-- raw HTML omitted -->interfaces数组中的某个接口类型<!-- raw HTML omitted -->。这里我们强制转换为了IService类型，需要注意的是，==它不能强制转换为某个类类型==，比如RealService，即使它实际代理的对象类型为RealService。</p>
<p>SimpleInvocationHandler实现了<code>InvocationHandler</code>，它的构造方法接受一个参数realObj表示被代理的对象，<code>invoke</code>方法处理所有的接口调用，它有三个参数：</p>
<ul>
<li>proxy表示代理对象本身，需要注意，它不是被代理的对象；</li>
<li>method表示正在被调用的方法；</li>
<li>args表示方法的参数。</li>
</ul>
<p>在SimpleInvocationHandler的invoke实现中，我们调用了method的invoke方法，传递了实际对象realObj作为参数，达到了调用实际对象对应方法的目的。注意，不能将proxy作为参数传递给method. invoke。</p>
<h4 id="基本原理">基本原理</h4>
<p>上面<code>Proxy.newProxyInstance</code>创建proxyService的代码可以用如下代码代替：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-219-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-219-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-219-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-219-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-219-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-219-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-219-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-219-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>proxyCls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Proxy.<span style="color:#4070a0">getProxyClass</span>(IService.<span style="color:#4070a0">class</span>.<span style="color:#4070a0">getClassLoader</span>(),<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>IService.<span style="color:#4070a0">class</span><span style="color:#bbb"> </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Constructor<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>ctor<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>proxyCls.<span style="color:#4070a0">getConstructor</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span>{<span style="color:#bbb"> </span>InvocationHandler.<span style="color:#4070a0">class</span><span style="color:#bbb"> </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>InvocationHandler<span style="color:#bbb"> </span>handler<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>SimpleInvocationHandler(realService);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>IService<span style="color:#bbb"> </span>proxyService<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(IService)<span style="color:#bbb"> </span>ctor.<span style="color:#4070a0">newInstance</span>(handler);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>分三步：</p>
<ol>
<li>通过Proxy.getProxyClass创建代理类定义，类定义会被缓存；</li>
<li>获取代理类的构造方法，构造方法有一个InvocationHandler类型的参数；</li>
<li>创建InvocationHandler对象，创建代理类对象</li>
</ol>
<p>Proxy.getProxyClass需要两个参数：一个是ClassLoader；另一个是==接口数组==。它会动态生成一个类，类名以<code>$Proxy</code>开头，后跟一个数字。</p>
<p>对于上面的的例子，动态生成的类定义如代码如下（忽略异常处理代码）：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-220-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-220-33">33</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">$Proxy0</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Proxy<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>SimpleJDKDynamicProxyDemo.<span style="color:#4070a0">IService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>m1;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>m3;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>m2;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>m0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">$Proxy0</span>(InvocationHandler<span style="color:#bbb"> </span>paramInvocationHandler)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">super</span>(paramInvocationHandler);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">equals</span>(Object<span style="color:#bbb"> </span>paramObject)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span>((Boolean)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">h</span>.<span style="color:#4070a0">invoke</span>(<span style="color:#007020;font-weight:bold">this</span>,<span style="color:#bbb"> </span>m1,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                   </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Object<span style="color:#666">[]</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>paramObject<span style="color:#bbb"> </span>})).<span style="color:#4070a0">booleanValue</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">h</span>.<span style="color:#4070a0">invoke</span>(<span style="color:#007020;font-weight:bold">this</span>,<span style="color:#bbb"> </span>m3,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">toString</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(String)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">h</span>.<span style="color:#4070a0">invoke</span>(<span style="color:#007020;font-weight:bold">this</span>,<span style="color:#bbb"> </span>m2,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">hashCode</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>((Integer)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">h</span>.<span style="color:#4070a0">invoke</span>(<span style="color:#007020;font-weight:bold">this</span>,<span style="color:#bbb"> </span>m0,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)).<span style="color:#4070a0">intValue</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>m1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#4070a0">&#34;java.lang.Object&#34;</span>).<span style="color:#4070a0">getMethod</span>(<span style="color:#4070a0">&#34;equals&#34;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                                     </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[]</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#4070a0">&#34;java.lang.Object&#34;</span>)<span style="color:#bbb"> </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>m3<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#4070a0">&#34;laoma.demo.proxy.SimpleJDKDynamicProxyDemo$IService&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>.<span style="color:#4070a0">getMethod</span>(<span style="color:#4070a0">&#34;sayHello&#34;</span>,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[</span>0<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>m2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#4070a0">&#34;java.lang.Object&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>.<span style="color:#4070a0">getMethod</span>(<span style="color:#4070a0">&#34;toString&#34;</span>,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[</span>0<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>m0<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(<span style="color:#4070a0">&#34;java.lang.Object&#34;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>.<span style="color:#4070a0">getMethod</span>(<span style="color:#4070a0">&#34;hashCode&#34;</span>,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">[</span>0<span style="color:#666">]</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>$Proxy0</code>的父类是Proxy，</p>
<p>Proxy有一个构造方法，接受一个InvocationHandler类型的参数，保存为了实例变量h, h定义在父类Proxy中，它实现了接口IService，对于每个方法，如sayHello；</p>
<p>Proxy调用InvocationHandler的invoke方法，对于Object中的方法，如<code>hashCode</code>、equals和toString, <code>$Proxy0</code>同样转发给了InvocationHandler。</p>
<p>Proxy这个类定义本身==与被代理的对象没有关系==，与InvocationHandler的==具体实现也没有关系==，而主要==与接口数组有关==，给定这个接口数组，它==动态创建每个接口的实现代码==，实现就是转发给InvocationHandler，与被代理对象的关系以及对它的调用由InvocationHandler的实现管理。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-221-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-221-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-221-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-221-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 在项目源目录下运行 -D是java命令下用来配置属性的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java<span style="color:#bbb">  </span><span style="color:#666">-</span>Dsun.<span style="color:#4070a0">misc</span>.<span style="color:#4070a0">ProxyGenerator</span>.<span style="color:#4070a0">saveGeneratedFiles</span><span style="color:#666">=</span><span style="color:#007020;font-weight:bold">true</span><span style="color:#bbb">  </span>com.<span style="color:#4070a0">andyron</span>.<span style="color:#4070a0">bcdlj</span>.<span style="color:#4070a0">c23</span>.<span style="color:#4070a0">c232</span>.<span style="color:#4070a0">SimpleJDKDynamicProxyDemo</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可得到动态生成的代理类$Proxy0.class。</p>
<h4 id="动态代理的优点">动态代理的优点</h4>
<p>使用动态代理，可以编写==通用的代理逻辑==，用于各种类型的被代理对象，而不需要为每个被代理的类型都创建一个静态代理类。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-37">37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-38">38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-39">39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-40">40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-41">41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-42">42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-43">43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-44">44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-45">45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-46">46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-47">47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-48">48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-49">49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-222-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-222-50">50</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">GeneralProxyDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IServiceA<span style="color:#bbb"> </span>a<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ServiceAImpl();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IServiceA<span style="color:#bbb"> </span>aProxy<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>getProxy(IServiceA.<span style="color:#4070a0">class</span>,<span style="color:#bbb"> </span>a);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>aProxy.<span style="color:#4070a0">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IServiceB<span style="color:#bbb"> </span>b<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ServiceBImpl();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IServiceB<span style="color:#bbb"> </span>bProxy<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>getProxy(IServiceB.<span style="color:#4070a0">class</span>,<span style="color:#bbb"> </span>b);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>bProxy.<span style="color:#4070a0">fly</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">IServiceA</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ServiceAImpl</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>IServiceA<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">IServiceB</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">fly</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ServiceBImpl</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>IServiceB<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">fly</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;flying&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleInvocationHandler</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>InvocationHandler<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>realObj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#06287e">SimpleInvocationHandler</span>(Object<span style="color:#bbb"> </span>realObj)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">realObj</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>realObj;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">invoke</span>(Object<span style="color:#bbb"> </span>proxy,<span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>method,<span style="color:#bbb"> </span>Object<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Throwable<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;entering &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>realObj.<span style="color:#4070a0">getClass</span>().<span style="color:#4070a0">getSimpleName</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;::&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Object<span style="color:#bbb"> </span>result<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">invoke</span>(realObj,<span style="color:#bbb"> </span>args);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;leaving &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>realObj.<span style="color:#4070a0">getClass</span>().<span style="color:#4070a0">getSimpleName</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;::&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>result;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">getProxy</span>(Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>intf,<span style="color:#bbb"> </span>T<span style="color:#bbb"> </span>realObj)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(T)<span style="color:#bbb"> </span>Proxy.<span style="color:#4070a0">newProxyInstance</span>(intf.<span style="color:#4070a0">getClassLoader</span>(),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;[]</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>intf<span style="color:#bbb"> </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>SimpleInvocationHandler(realObj));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在这个例子中，有两个接口IServiceA和IServiceB，它们对应的实现类是ServiceAImpl和ServiceBImpl，虽然它们的接口和实现不同，但利用动态代理，它们可以调用同样的方法getProxy获取代理对象，共享同样的代理逻辑SimpleInvocationHandler。</p>
<h3 id="233-cglib动态代理">23.3 cglib动态代理</h3>
<p>Java SDK动态代理的局限在于，它**==只能为接口创建代理==，返回的代理对象也只能转换到某个接口类型**，如果一个类没有接口，或者希望代理非接口中定义的方法，那就没有办法了。</p>
<p>第三方的类库<a href="https://github.com/cglib/cglib">cglib</a>，可以做到，Spring、Hibernate等都使用该类库。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-223-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-223-28">28</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleCGLibDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">RealService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sayHello</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">SimpleInterceptor</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>MethodInterceptor<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span><span style="color:#06287e">intercept</span>(Object<span style="color:#bbb"> </span>object,<span style="color:#bbb"> </span>Method<span style="color:#bbb"> </span>method,<span style="color:#bbb"> </span>Object<span style="color:#666">[]</span><span style="color:#bbb"> </span>args,<span style="color:#bbb"> </span>MethodProxy<span style="color:#bbb"> </span>proxy)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>Throwable<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;entering &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Object<span style="color:#bbb"> </span>result<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>proxy.<span style="color:#4070a0">invokeSuper</span>(object,<span style="color:#bbb"> </span>args);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;leaving &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>result;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">getProxy</span>(Class<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>cls)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Enhancer<span style="color:#bbb"> </span>enhancer<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Enhancer();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">// 设置被代理的类</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>enhancer.<span style="color:#4070a0">setSuperclass</span>(cls);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">// 设置被代理类的public非final方法被调用时的处理类</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>enhancer.<span style="color:#4070a0">setCallback</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>SimpleInterceptor());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(T)<span style="color:#bbb"> </span>enhancer.<span style="color:#4070a0">create</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>RealService<span style="color:#bbb"> </span>proxyService<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>getProxy(RealService.<span style="color:#4070a0">class</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>proxyService.<span style="color:#4070a0">sayHello</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>RealService表示被代理的类，它没有接口。getProxy()为一个类生成代理对象，这个代理对象可以安全地转换为被代理类的类型，它使用了cglib的Enhancer类。</p>
<p><code>Enhancer</code>类的setSuperclass==设置被代理的类==，setCallback==设置被代理类的public非final方法被调用时的处理类==。</p>
<p>Enhancer支持多种类型，这里使用的类实现了<code>MethodInterceptor</code>接口，它与Java SDK中的InvocationHandler有点类似，方法名称变成了intercept，多了一个MethodProxy类型的参数。</p>
<p>与前面的InvocationHandler不同，SimpleInterceptor中没有被代理的对象，它通过MethodProxy的invokeSuper方法调用被代理类的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-224-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-224-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object<span style="color:#bbb"> </span>result<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>proxy.<span style="color:#4070a0">invokeSuper</span>(object,<span style="color:#bbb"> </span>args);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注意，它不能这样调用被代理类的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-225-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-225-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object<span style="color:#bbb"> </span>result<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>method.<span style="color:#4070a0">invoke</span>(object,<span style="color:#bbb"> </span>args);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>object是代理对象，调用这个方法还会调用到SimpleInterceptor的intercept方法，造成死循环。</p>
<p>在main方法中，也没有创建被代理的对象，创建的对象直接就是代理对象。</p>
<p>==cglib的实现机制与Java SDK不同，它是通过继承实现的==，它也是动态创建了一个类，但这个类的父类是被代理的类，代理类重写了父类的所有public非final方法，改为调用Callback中的相关方法，在上例中，调用SimpleInterceptor的intercept方法。🔖</p>
<h3 id="234-java-sdk代理与cglib代理比较">23.4 Java SDK代理与cglib代理比较</h3>
<p>Java SDK代理<strong>面向的是==一组接口==</strong>，它为这些接口动态创建了一个实现类。接口的具体实现逻辑是通过自定义的InvocationHandler实现的，这个实现是自定义的，也就是说，<strong>其背后都不一定有真正被代理的对象，也可能有多个实际对象，根据情况动态选择。cglib代理面向的是==一个具体的类==</strong>，它动态创建了一个新类，继承了该类，重写了其方法。</p>
<p>从代理的角度看，Java SDK**==代理的是对象==**，需要先有一个实际对象，自定义的InvocationHandler引用该对象，然后创建一个代理类和代理对象，客户端访问的是代理对象，代理对象最后再调用实际对象的方法；cglib==代理的是类==，创建的对象只有一个。</p>
<p>如果目的都是为一个类的方法增强功能，Java SDK要求该类必须有接口，且只能处理接口中的方法，cglib没有这个限制。</p>
<h3 id="235-动态代理的应用aop">23.5 动态代理的应用：AOP</h3>
<h4 id="实现原理-1">实现原理</h4>
<p>CGLibContainer在初始化的时候，会分析带有@Aspect注解的类，分析出每个类的方法在调用前/调用后/出现异常时应该调用哪些方法，在创建该类的对象时，如果有需要被调用的方法，则创建一个动态代理对象。</p>
<h2 id="24-类加载机制">24 类加载机制</h2>
<p>类加载器<code>ClassLoader</code>就是加载其他类的类，它负责<strong>将字节码文件加载到内存</strong>，创建Class对象。</p>
<p>ClassLoader一般是系统提供的，不需要自己实现，不过，通过创建自定义的ClassLoader，可以实现一些强大灵活的功能，比如：</p>
<ol>
<li>
<p>==热部署==。在不重启Java程序的情况下，动态<strong>替换类的实现</strong>。</p>
</li>
<li>
<p>==应用的模块化和相互隔离==。不同的ClassLoader可以加载相同的类但互相隔离、互不影响。</p>
<p>Web应用服务器如Tomcat利用这一点在一个程序中管理多个Web应用程序，每个Web应用使用自己的ClassLoader，这些Web应用互不干扰。</p>
<p><strong>OSGI</strong>（Open Service Gateway Initiative，开放服务网关协议）和Java9利用这一点实现了一个<strong>动态模块化架构</strong>，每个模块有自己的ClassLoader，不同模块可以互不干扰。🔖</p>
</li>
<li>
<p>从不同地方灵活加载。</p>
<p>默认ClassLoader一般从本地的class文件或jar文件中加载字节码文件。</p>
<p>通过自定义的ClassLoader，也可以从<strong>共享的Web服务器、数据库、缓存服务器</strong>等其他地方加载字节码文件。</p>
</li>
</ol>
<h3 id="241-类加载的基本机制和过程">24.1 类加载的基本机制和过程</h3>
<p>运行Java程序，就是执行<code>java</code>命令，指定包含main方法的完整类名以及一个classpath（<strong>==类路径==</strong>）。</p>
<p>类路径可以有多个。对于直接的class文件，类路径就是class文件的根目录；对于jar包，类路径是jar包的完整路径（<strong>路径+jar包名</strong>）。</p>
<p>负责加载类的类就是类加载器，它的输入是**==完全限定的类名==<strong>，输出是</strong>==Class对象==**。类加载器不是只有一个，一般程序运行时，都会有三个（java9引入模块化，有些变化）：</p>
<ol>
<li><strong>启动类加载器</strong>（Bootstrap ClassLoader）：Java虚拟机实现的一部分，不是Java语言实现的，一般是C++实现的，它负责加载Java的基础类，主要是<code>&lt;JAVA_HOME&gt;/lib/rt.jar</code>，日常用的Java类库比如String、ArrayList等都位于该包内。</li>
<li><strong>扩展类加载器</strong>（Extension ClassLoader）：这个加载器的实现类是<code>sun.misc.Launcher$ExtClassLoader</code>，它负责加载Java的一些扩展类，一般是<code>&lt;JAVA_HOME&gt;/lib/ext</code>目录中的jar包。</li>
<li><strong>应用程序类加载器</strong>（Application ClassLoader）/<strong>系统类加载器</strong>（System ClassLoader）：这个加载器的实现类是<code>sun.misc.Launcher$AppClassLoader</code>，它负责加载应用程序的类，包括自己写的和引入的第三方法类库，即所有在类路径中指定的类。</li>
</ol>
<p>三个类加载器<!-- raw HTML omitted -->不是父子继承关系，而是父子委派关系<!-- raw HTML omitted -->（<strong>==双亲委派==</strong>）。子ClassLoader有一个变量parent指向父ClassLoader，在子ClassLoader加载类时，一般会首先通过父ClassLoader加载，过程：</p>
<ol>
<li>判断是否已经加载过了，加载过了，直接返回Class对象，<strong>一个类只会被一个ClassLoader加载一次</strong>。</li>
<li>如果没有被加载，先让父ClassLoader去加载，如果加载成功，返回得到的Class对象。</li>
<li>在父ClassLoader没有加载成功的前提下，自己尝试加载类。</li>
</ol>
<p>优先让父ClassLoader去加载，可以避免<strong>Java类库被覆盖</strong>的问题。</p>
<p>双亲委派的例外，如：</p>
<ol>
<li><strong>自定义的加载顺序</strong>：尽管不被建议，自定义的ClassLoader可以不遵从“双亲委派”这个约定，不过，即使不遵从，<!-- raw HTML omitted -->以java开头的类也不能被自定义类加载器加载，这是由Java的安全机制保证的，以避免混乱<!-- raw HTML omitted -->。</li>
<li><strong>网状加载顺序</strong>：在OSGI框架和Java 9模块化系统中，类加载器之间的关系是一个网，每个模块有一个类加载器，不同模块之间可能有依赖关系，在一个模块加载一个类时，可能是从自己模块加载，也可能是委派给其他模块的类加载器加载。</li>
<li><strong>父加载器委派给子加载器加载</strong>：典型的例子有==JNDI==服务（Java Naming and DirectoryInterface），它是Java企业级应用中的一项服务。</li>
</ol>
<h3 id="242-理解classloader">24.2 理解ClassLoader</h3>
<p>类<code>ClassLoader</code>是一个抽象类，扩展类加载器和应用程序类加载器都继承至它。</p>
<p>Application ClassLoader和Extension ClassLoader的具体实现类分别是<code>sun.misc.Launcher$AppClassLoader</code>和<code>sun.misc.Launcher$ExtClassLoader</code>, Bootstrap ClassLoader不是由Java实现的，没有对应的类。</p>
<p>每个<code>Class</code>对象都有一个<code>getClassLoader()</code>方法，可以获取实际加载它的<code>ClassLoader</code>。</p>
<p><code>ClassLoader</code>有一个获取父<code>ClassLoader</code>的方法(如果是启动类加载器返回null)：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-226-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-226-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>ClassLoader<span style="color:#bbb"> </span><span style="color:#06287e">getParent</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ClassLoader有一个静态方法，可以获取默认的系统类加载器：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-227-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-227-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>ClassLoader<span style="color:#bbb"> </span><span style="color:#06287e">getSystemClassLoader</span>()<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ClassLoader中加载类方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-228-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-228-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>loadClass(String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ClassNotFoundException<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-229-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-229-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ClassLoader<span style="color:#bbb"> </span>cl<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>ClassLoader.<span style="color:#4070a0">getSystemClassLoader</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(cl);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// java.util.ArrayList实际由BootStrap ClassLoader加载，所以返回值就是null。</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cl.<span style="color:#4070a0">loadClass</span>(<span style="color:#4070a0">&#34;java.util.ArrayList&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>ClassLoader<span style="color:#bbb"> </span>actualLoader<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>cls.<span style="color:#4070a0">getClassLoader</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(actualLoader);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(ClassNotFoundException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>e.<span style="color:#4070a0">printStackTrace</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>由于委派机制，Class的getClassLoader方法返回的不一定是调用loadClass的ClassLoader，比如，上面代码中，java.util.ArrayList实际由BootStrap ClassLoader加载而不是默认的系统类加载器，所以返回值就是null。</p>
<p><code>Class</code>有两个静态方法forName：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-230-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-230-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-230-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-230-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>forName(String<span style="color:#bbb"> </span>className)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>forName(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>initialize,<span style="color:#bbb"> </span>ClassLoader<span style="color:#bbb"> </span>loader)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第一个方法使用系统类加载器加载，第二个方法指定ClassLoader，参数initialize表示==加载后是否执行类的初始化代码（如static语句块）==，没有指定默认为true。</p>
<blockquote>
<p>ClassLoader的loadClass方法与Class的forName方法都可以加载类，它们有什么不同呢？</p>
<p>ClassLoader的<strong>loadClass不会执行类的初始化代码</strong>。❤️</p>
</blockquote>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-231-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-231-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">CLInitDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Hello</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>ClassLoader<span style="color:#bbb"> </span>cl<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>ClassLoader.<span style="color:#4070a0">getSystemClassLoader</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>className<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>CLInitDemo.<span style="color:#4070a0">class</span>.<span style="color:#4070a0">getName</span>()<span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;$Hello&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//            Class&lt;?&gt; cls = cl.loadClass(className);   // 没有输出</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(className);<span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">// 输出 hello</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(ClassNotFoundException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>e.<span style="color:#4070a0">printStackTrace</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ClassLoader的loadClass：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-232-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-232-32">32</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>loadClass(String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ClassNotFoundException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>loadClass(name,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>loadClass(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span>resolve)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ClassNotFoundException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">synchronized</span><span style="color:#bbb"> </span>(getClassLoadingLock(name))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">//首先，检查类是否已经被加载了</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Class<span style="color:#bbb"> </span>c<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>findLoadedClass(name);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(c<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#60a0b0;font-style:italic">//没被加载，先委派父ClassLoader或BootStrap ClassLoader去加载</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">if</span>(parent<span style="color:#bbb"> </span><span style="color:#666">!</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#60a0b0;font-style:italic">//委派父ClassLoader, resolve参数固定为false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>c<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>parent.<span style="color:#4070a0">loadClass</span>(name,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>c<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>findBootstrapClassOrNull(name);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(ClassNotFoundException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//没找到，捕获异常，以便尝试自己加载</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">if</span>(c<span style="color:#bbb"> </span><span style="color:#666">==</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">null</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//自己去加载，findClass才是当前ClassLoader的真正加载方法</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>c<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>findClass(name);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span>(resolve)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#60a0b0;font-style:italic">//链接，执行static语句块</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>resolveClass(c);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>c;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>参数resolve类似Class.forName中的参数initialize，其默认值为false。</p>
<h3 id="243-类加载的应用可配置的策略">24.3 类加载的应用：可配置的策略</h3>
<blockquote>
<p>可以通过ClassLoader的loadClass或Class.forName自己加载类。</p>
<p>什么情况需要自己加载类呢？</p>
</blockquote>
<p>很多应用使用面向接口的编程，接口具体的实现类可能有很多，适用于不同的场合，具体使用哪个实现类在配置文件中配置，<strong>通过更改配置，不用改变代码，就可以改变程序的行为</strong>，在设计模式中，这是一种**==策略模式==**。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-233-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-233-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-233-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-233-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-233-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-233-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">IService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">action</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-234-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-234-20">20</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ConfigurableStrategyDemo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>IService<span style="color:#bbb"> </span><span style="color:#06287e">createService</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Properties<span style="color:#bbb"> </span>prop<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Properties();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>String<span style="color:#bbb"> </span>filename<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;data/config.properties&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>prop.<span style="color:#4070a0">load</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FileInputStream(filename));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>String<span style="color:#bbb"> </span>className<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>prop.<span style="color:#4070a0">getProperty</span>(<span style="color:#4070a0">&#34;service&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>cls<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Class.<span style="color:#4070a0">forName</span>(className);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(IService)<span style="color:#bbb"> </span>cls.<span style="color:#4070a0">newInstance</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(Exception<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>RuntimeException();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>IService<span style="color:#bbb"> </span>service<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>createService();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>service.<span style="color:#4070a0">action</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-235-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-235-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-235-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-235-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-235-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-235-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-235-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-235-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-235-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-235-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-235-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-235-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ServiceB</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>IService<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">action</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;service B action&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>config.properties内容：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-236-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-236-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-properties" data-lang="properties"><span style="display:flex;"><span><span style="color:#4070a0">service</span><span style="color:#666">=</span><span style="color:#4070a0">com.andyron.bcdlj.c24.c243.ServiceB</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>客户端通过接口<code>IService</code>访问其方法，具体使用哪个实例，自己通过配置文件配置。</p>
<h3 id="244-自定义classloader">24.4 自定义ClassLoader</h3>
<p>自定义ClassLoader是Tomcat实现应用隔离、支持JSP、OSGI实现动态模块化的基础。</p>
<p>一般是继承类ClassLoader，重写<code>findClass</code>方法，使用自己的逻辑寻找Class文件字节码的字节形式。再通过<code>defineClass</code>方法转换为Class对象：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-237-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-237-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>defineClass(String<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>b,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>off,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>len)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ClassFormatError<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>name表示类名，b是存放字节码数据的字节数组，有效数据从off开始，长度为len。看个例子：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-238-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-238-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">MyClassLoader</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>ClassLoader<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>BASE_DIR<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;data/&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span>Class<span style="color:#666">&lt;?&gt;</span><span style="color:#bbb"> </span>findClass(String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">throws</span><span style="color:#bbb"> </span>ClassNotFoundException<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>fileName<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>name.<span style="color:#4070a0">replace</span>(<span style="color:#4070a0">&#34;\\.&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;/&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>fileName<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>BASE_DIR<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>fileName<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;.class&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">try</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#902000">byte</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>bytes<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>BinaryFileUtils.<span style="color:#4070a0">readFileToByteArray</span>(fileName);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>defineClass(fileName,<span style="color:#bbb"> </span>bytes,<span style="color:#bbb"> </span>0,<span style="color:#bbb"> </span>bytes.<span style="color:#4070a0">length</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">catch</span><span style="color:#bbb"> </span>(IOException<span style="color:#bbb"> </span>e)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">throw</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ClassNotFoundException(<span style="color:#4070a0">&#34;failed to load class &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>父ClassLoader默认是系统类加载器，如果要指定可重写构造方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-239-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-239-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#06287e">ClassLoader</span>(ClassLoader<span style="color:#bbb"> </span>parent)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>🔖🔖  ？java.lang.NoClassDefFoundError: IllegalName:</p>
<h3 id="245-自定义classloader的应用热部署">24.5 自定义ClassLoader的应用：热部署🔖</h3>
<p>热部署：在不重启应用的情况下，当类的定义即字节码文件修改后，能够替换该Class创建的对象。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"></code></pre></td></tr></table>
</div>
</div><h2 id="25-正则表达式">25 正则表达式</h2>
<h3 id="251-语法">25.1 语法</h3>
<p>正则表达式是一串字符，它描述了一个文本模式，利用它可以方便地==处理文本==，包括文本的==查找、替换、验证、切分==等。</p>
<p>正则表达式中的字符分两类：</p>
<ul>
<li>==普通字符==：匹配字符本身；</li>
<li>==元字符==：有特殊含义。</li>
</ul>
<h4 id="1单个字符">1.单个字符</h4>
<p>大部分的单个字符就是用字符本身表示的，比如字符'0&rsquo;、&lsquo;3&rsquo;、&lsquo;a&rsquo;、&lsquo;马&rsquo;等，但有<strong>一些单个字符使用多个字符表示</strong>，这些字符都以斜杠&rsquo;<code>\</code>&lsquo;开头，比如：</p>
<ul>
<li>==特殊字符==，比如tab字符&rsquo;<code>\t</code>&rsquo;、换行符&rsquo;<code>\n</code>&rsquo;、回车符&rsquo;<code>\r</code>&lsquo;等。</li>
<li>==八进制表示的字符==，以<code>\0</code>开头，后跟1～3位数字，比如\0141，对应的是ASCII编码为97的字符，即字符&rsquo;a&rsquo;。</li>
<li>==十六进制表示的字符==，以<code>\x</code>开头，后跟两位字符，比如\x6A，对应的是ASCII编码为106的字符，即字符&rsquo;j&rsquo;。</li>
<li>==Unicode编号表示的字符==，以<code>\u</code>开头，后跟4位字符，比如\u9A6C，表示的是中文字符&rsquo;马&rsquo;，这只能表示编号在0xFFFF以下的字符，如果超出0ⅩFFFF，使用\x{&hellip;}形式，比如\x{1f48e}。</li>
<li>==斜杠\本身==，斜杠\是一个元字符，如果要匹配它自身，使用两个斜杠表示，即&rsquo;<code>\\</code>&rsquo;。</li>
<li>==元字符本身==，除了&rsquo;<code>\</code>&rsquo;，正则表达式中还有很多元字符，比如<code>．</code>、<code>*</code>、<code>?</code> 、<code>+</code>等，要匹配这些元字符自身，需要在前面加转义字符&rsquo;<code>\</code>&rsquo;，比如&rsquo;<code>\.</code>&rsquo;。</li>
</ul>
<p><img src="images/image-20220424175306573.png"></p>
<h4 id="2字符组">2.字符组</h4>
<p>字符组有多种，包括==任意字符、多个指定字符之一、字符区间、排除型字符组、预定义的字符==组等，具体：</p>
<ul>
<li>
<p><code>.</code></p>
<ul>
<li>默认模式下，它匹配==除了换行符以外的任意字符==。</li>
<li>单行匹配模式（或点号匹配模式）下，它匹配任意字符，包括换行符。有两种方式指定这种模式：1️⃣ 开头加上<code>(? s)</code>（s表示single line），如<code>(? s)a.f</code>；2️⃣ <code>Pattern.DOTALL</code>。</li>
</ul>
</li>
<li>
<p>在单个字符和任意字符之间，有一个字符组的概念，匹配组中的==任意一个字符==，用中括号<code>[]</code>表示。</p>
<ul>
<li>如 <code>[abcd]</code>，<code>[0123456789]</code>。</li>
<li>为方便表示连续的多个字符，字符组中可以使用连字符&rsquo;<code>-</code>&rsquo;，比如：<code>[a-z]</code>，<code>[0-9]</code>。</li>
<li>可以有多个连续空间，可以有其他普通字符，比如<code>[0-9a-zA-Z_]</code>。</li>
<li>在字符组中，&rsquo;-&lsquo;是一个元字符，如果要匹配它自身，可以使用转义，即&rsquo;<code>\-</code>&rsquo;，或者把它放在字符组的最前面，比如：<code>[-0-9]</code>。</li>
<li>字符组支持排除的概念，在<code>[</code>后紧跟一个字符<code>^</code>，比如： <code>[^abcd]</code>表示匹配除了a, b, c, d以外的任意一个字符。</li>
<li><code>^</code>只有在字符组的开头才是元字符，如果不在开头，就是普通字符，匹配它自身。</li>
<li>在字符组中，除了^、-、[ ]、\外，其他在字符组外的元字符不再具备特殊含义，变成了普通字符，比如字符&rsquo;.&lsquo;和&rsquo;＊&rsquo;, <code>[.*]</code>就是匹配&rsquo;.&lsquo;或者&rsquo;*&lsquo;本身。</li>
</ul>
</li>
<li>
<p>有一些特殊的以\开头的字符，表示一些==预定义的字符组==，比如：</p>
<ul>
<li><code>\d</code>:d表示digit，匹配一个数字字符，等同于<code>[0-9]</code>。</li>
<li><code>\w</code>:w表示word，匹配一个单词字符，等同于[a-zA-Z_0-9]。</li>
<li><code>\s</code>:s表示space，匹配一个空白字符，等同于<code>[\t\n\x0B\f\r]</code>。</li>
<li>它们都有对应的排除型字符组，用大写表示。</li>
</ul>
</li>
<li>
<p>还有一类字符组，称为==POSIⅩ字符组==，它们是POSIⅩ标准定义的一些字符组，在Java中，这些字符组的形式是<code>\p{...}</code>。</p>
</li>
</ul>
<p><img src="images/image-20220424175322266.png"></p>
<h4 id="3量词指定出现次数的元字符">3.量词：指定出现次数的元字符</h4>
<ul>
<li>
<p><code>+</code>：一次或多次</p>
</li>
<li>
<p><code>*</code>：零次或多次出现</p>
</li>
<li>
<p><code>?</code>：零次或一次</p>
</li>
<li>
<p>更为通用的表示出现次数的语法是<code>{m,n}</code>【逗号左右不能有空格】，出现次数从m到n，包括m和n，如果n没有限制，可以省略，如果m和n一样，可以写为<code>{m}</code>。</p>
</li>
<li>
<p><code>?</code>、<code>*</code>、<code>+</code>、<code>{</code>是元字符，如果要匹配这些字符本身，需要使用&rsquo;'转义。</p>
</li>
<li>
<p>这些量词出现在字符组中时，不是元字符，比如：<code>[? ＊+{]</code>就是匹配其中一个字符本身。</p>
</li>
<li>
<p>量词的默认匹配是**==贪婪==**的；在量词的后面加一个符号&rsquo;<code>?</code>&lsquo;就表示==懒惰量词==，只匹配第一个能匹配的。</p>
</li>
</ul>
<p><img src="images/image-20220424175339837.png"></p>
<h4 id="4分组">4.分组</h4>
<ul>
<li>
<p>用括号<code>()</code>括起来，表示一个分组</p>
</li>
<li>
<p>分组可以嵌套，比如<code>a(de(fg))</code>。</p>
</li>
<li>
<p>分组默认都有一个==编号==，按照括号的出现顺序，从1开始，从左到右依次递增，比如表达式：<code>a(bc)((de)(fg))</code>，字符串abcdefg匹配这个表达式，第1个分组为bc，第2个为defg，第3个为de，第4个为fg。分组0是一个特殊分组，内容是整个匹配的字符串，这里是abcdefg。</p>
</li>
<li>
<p>分组匹配的子字符串可以在后续访问，好像被捕获了一样，所以默认分组称为<strong>捕获分组</strong>。</p>
</li>
<li>
<p>可以对分组使用量词，表示分组的出现次数，比如<code>a(bc)+d</code>，表示bc出现一次或多次。</p>
</li>
<li>
<p>中括号[]表示匹配其中的一个字符，括号<code>()</code>和元字符&rsquo;<code>|</code>&lsquo;一起，可以表示匹配其中的一个子表达式，比如：<code>(http|ftp|file)</code>匹配http或ftp或file。</p>
</li>
<li>
<p>需要注意区分|和[], |用于[]中不再有特殊含义。</p>
</li>
<li>
<p>可以使用斜杠<code>\</code>加分组编号引用之前匹配的分组，这称为==回溯引用==，比如：<code>&lt;(\w+)&gt;(.＊)&lt;/\1&gt;</code>，<code>\1</code>匹配之前的第一个分组<code>(\w+)</code>，这个表达式可以匹配类似如下字符串：<code>&lt;title&gt;bc&lt;/title&gt;</code>这里，第一个分组是&quot;title&quot;。</p>
</li>
<li>
<p>使用数字引用分组，可能容易出现混乱，可以==对分组进行命名==，通过名字引用之前的分组，对分组命名的语法是<code>(? &lt;name&gt;Ⅹ)</code>，引用分组的语法是<code>\k&lt;name&gt;</code>，比如，上面的例子可以写为：<code>&lt;(? &lt;tag&gt;\w+)&gt;(.＊)&lt;/\k&lt;tag&gt;&gt;</code>。</p>
</li>
<li>
<p>默认分组都称为捕获分组，即分组匹配的内容被捕获了，可以在后续被引用。实现捕获分组有一定的成本，为了提高性能，如果分组后续不需要被引用，可以改为==非捕获分组==，语法是<code>(? :...)</code>，比如：<code>(? :abc|def)</code>。</p>
</li>
</ul>
<p><img src="images/image-20220424175351966.png"></p>
<h4 id="5特殊边界匹配">5.特殊边界匹配</h4>
<p>常用的表示特殊边界的元字符有</p>
<ul>
<li><code>^</code>，<code>^abc</code>表示整个字符串必须以abc开始。在字符组中它表示排除，但在字符组外，它匹配开始，比如表达式<code>^[^abc]</code>，表示以一个不是a、b、c的字符开始。</li>
<li><code>$</code>。如果整个字符串以换行符结束，<code>$</code>匹配的是换行符之前的边界，比如表达式<code>abc$</code>，表示整个表达式以abc结束，或者以<code>abc\r\n</code>或<code>abc\n</code>结束。</li>
</ul>
<blockquote>
<p>以上<code>^</code>和<code>$</code>的含义是默认模式下的，可以指定另外一种匹配模式：==多行匹配模式==，在此模式下，会以行为单位进行匹配，<code>^</code>匹配的是行开始，$匹配的是行结束，比如表达式是<code>^abc$</code>，字符串是&quot;<code>abc\nabc\r\n</code>&quot;，就会有两个匹配。</p>
<p>可以有两种方式指定匹配模式。</p>
<ul>
<li>一种是在正则表达式中，以<code>(? m)</code>开头，m表示multi-line，即多行匹配模式，上面的正则表达式可以写为：<code>(? m)^abc$</code>。</li>
<li>另外一种是在程序中指定，在Java中，对应的模式常量是<code>Pattern.MULTILINE</code>。</li>
</ul>
<p>需要说明的是，多行模式和之前介绍的单行模式容易混淆，其实，它们之间没有关系。<strong>单行模式影响的是字符&rsquo;.&lsquo;的匹配规则</strong>，使得&rsquo;.&lsquo;可以匹配换行符；<strong>多行模式影响的是^和$的匹配规则</strong>，使得它们可以匹配行的开始和结束，两个模式可以一起使用。</p>
</blockquote>
<ul>
<li>``\A<code>与</code>^`类似，但不管什么模式，它匹配的总是整个字符串的开始边界。</li>
<li><code>\Z</code>、<code>\z</code>与<code>$</code>类似，但不管什么模式，它们匹配的总是整个字符串的结束边界。\Z与\z的区别是：如果字符串以换行符结束，\Z与<code>$</code>一样，匹配的是换行符之前的边界，而\z匹配的总是结束边界。在进行输入验证的时候，为了确保输入最后没有多余的换行符，可以使用\z进行匹配。</li>
<li><code>\b</code>匹配的是单词边界，比如\bcat\b，匹配的是完整的单词cat，它不能匹配category。\b匹配的不是一个具体的字符，而是一种边界，这种边界满足一个要求，即一边是单词字符，另一边不是单词字符。在Java中，\b识别的单词字符除了\w，还包括中文字符。</li>
</ul>
<p>边界匹配不同于字符匹配，可以认为，在一个字符串中，每个字符的两边都是边界，而上面介绍的这些特殊字符，匹配的都不是字符，而是特定的边界，例子：</p>
<p><img src="images/image-20231216141539035.png"></p>
<p>上面的字符串是&quot;a cat\n&quot;，我们用粗线显示出了每个字符两边的边界，并且显示出了每个边界与哪些边界元字符匹配。</p>
<h4 id="6环视边界匹配-">6.环视边界匹配 🔖</h4>
<p><img src="images/image-20220424175402964.png"></p>
<h4 id="7转义与匹配模式">7.转义与匹配模式🔖</h4>
<p><img src="images/image-20220424175436526.png"></p>
<h3 id="252-java-api">25.2 Java API</h3>
<p><code>java.util.regex</code>，两个主要类：</p>
<ul>
<li><code>Pattern</code>：表示正则表达式对象，它与要处理的具体字符串无关。</li>
<li><code>Matcher</code>：表示一个匹配，它将正则表达式应用于一个具体字符串，通过它对字符串进行处理。</li>
</ul>
<p>字符串类String中很多方法都用到正则。</p>
<p>正则表达式在Java中是需要先以字符串形式表示的。</p>
<p>先来介绍如何<strong>表示正则表达式</strong>，然后探讨如何利用它实现一些常见的<strong>文本处理任务</strong>，包括切分、验证、查找和替换。</p>
<h4 id="1-表示正则表达式">1 表示正则表达式🔖</h4>
<h4 id="2-切分">2 切分</h4>
<p>文本处理的一个常见需求是根据分隔符切分字符串，比如在处理CSV文件时，按逗号分隔每个字段</p>
<h4 id="3-验证">3 验证</h4>
<p>验证就是检验输入文本是否完整匹配预定义的正则表达式，经常用于检验用户的输入是否合法。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-241-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-241-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-241-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-241-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-241-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-241-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String<span style="color:#bbb"> </span>regex<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;\\d{8}&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>String<span style="color:#bbb"> </span>str<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;12345678&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(str.<span style="color:#4070a0">matches</span>(regex));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-查找">4 查找</h4>
<p>查找就是在文本中寻找匹配正则表达式的子字符串。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-242-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-242-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">find</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>regex<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;\\d{4}-\\d{2}-\\d{2}&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Pattern<span style="color:#bbb"> </span>pattern<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Pattern.<span style="color:#4070a0">compile</span>(regex);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>str<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;today is 2017-06-02, yesterday is 2017-06-01&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Matcher<span style="color:#bbb"> </span>matcher<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>pattern.<span style="color:#4070a0">matcher</span>(str);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">while</span>(matcher.<span style="color:#4070a0">find</span>()){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;find &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>matcher.<span style="color:#4070a0">group</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34; position: &#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>matcher.<span style="color:#4070a0">start</span>()<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;-&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>matcher.<span style="color:#4070a0">end</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><pre tabindex="0"><code>find 2017-06-02 position: 9-19
find 2017-06-01 position: 34-44
</code></pre><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-244-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-244-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#555;font-weight:bold">@Test</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">findGroup</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>regex<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;(\\d{4})-(\\d{2})-(\\d{2})&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Pattern<span style="color:#bbb"> </span>pattern<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Pattern.<span style="color:#4070a0">compile</span>(regex);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>str<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;today is 2017-06-02, yesterday is 2017-06-01&#34;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Matcher<span style="color:#bbb"> </span>matcher<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>pattern.<span style="color:#4070a0">matcher</span>(str);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">while</span><span style="color:#bbb"> </span>(matcher.<span style="color:#4070a0">find</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;year:&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>matcher.<span style="color:#4070a0">group</span>(1)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;, month:&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>matcher.<span style="color:#4070a0">group</span>(2)<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span><span style="color:#4070a0">&#34;, day:&#34;</span><span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>matcher.<span style="color:#4070a0">group</span>(3));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><pre tabindex="0"><code>year:2017, month:06, day:02
year:2017, month:06, day:01
</code></pre><h4 id="5-替换-">5 替换 🔖</h4>
<p>String有多个替换方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-246-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-246-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-246-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-246-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-246-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-246-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-246-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-246-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">replace</span>(<span style="color:#902000">char</span><span style="color:#bbb"> </span>oldChar,<span style="color:#bbb"> </span><span style="color:#902000">char</span><span style="color:#bbb"> </span>newChar)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">replace</span>(CharSequence<span style="color:#bbb"> </span>target,<span style="color:#bbb"> </span>CharSequence<span style="color:#bbb"> </span>replacement)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">replaceAll</span>(String<span style="color:#bbb"> </span>regex,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>replacement)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#06287e">replaceFirst</span>(String<span style="color:#bbb"> </span>regex,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>replacement)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第一个replace方法操作的是单个字符，第二个是CharSequence，它们都是将参数看作普通字符。而replaceAll和replaceFirst则将参数regex看作正则表达式，它们的区别是， replaceAll替换所有找到的子字符串，而replaceFirst则只替换第一个找到的。</p>
<h3 id="253-模板引擎">25.3 模板引擎</h3>
<h3 id="254-剖析常见表达式">25.4 剖析常见表达式</h3>
<h4 id="1邮编">1.邮编</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-247-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-247-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">[</span>0<span style="color:#666">-</span>9<span style="color:#666">]</span>{6}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2手机号码">2.手机号码</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-248-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-248-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">[</span>0<span style="color:#666">-</span>9<span style="color:#666">]</span>{11}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3固定电话号码">3.固定电话号码</h4>
<p>不考虑分机，中国的固定电话一般由两部分组成：区号和市内号码，区号是3到4位，市内号码是7到8位。</p>
<p>区号以0开头，表达式：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-249-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-249-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>0<span style="color:#666">[</span>0<span style="color:#666">-</span>9<span style="color:#666">]</span>{2,3}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>市内号码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-250-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-250-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">[</span>0<span style="color:#666">-</span>9<span style="color:#666">]</span>{7,8}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>区号可能用括号包含，区号与市内号码之间可能有连字符，如010-63325678，(010)63325678。整个表达式：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-251-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-251-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>(<span style="">\</span>(<span style="color:#666">?</span>0<span style="color:#666">[</span>0<span style="color:#666">-</span>9<span style="color:#666">]</span>{2,3}<span style="">\</span>)<span style="color:#666">?-?</span>)<span style="color:#666">?[</span>0<span style="color:#666">-</span>9<span style="color:#666">]</span>{7,8}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4日期">4.日期</h4>
<p>日期有多种表示，看类似<code>2022-01-11</code>的形式：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-252-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-252-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="">\</span>d{4}<span style="color:#666">-</span>(0<span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#666">[</span>1<span style="color:#666">-</span>9<span style="color:#666">]|</span>1<span style="color:#666">[</span>0<span style="color:#666">-</span>2<span style="color:#666">]</span>)<span style="color:#666">-</span>(0<span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#666">[</span>1<span style="color:#666">-</span>9<span style="color:#666">]|[</span>1<span style="color:#666">-</span>2<span style="color:#666">][</span>0<span style="color:#666">-</span>9<span style="color:#666">]|</span>3<span style="color:#666">[</span>01<span style="color:#666">]</span>)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5时间">5.时间</h4>
<h4 id="6身份证号">6.身份证号</h4>
<h4 id="7ip地址">7.IP地址</h4>
<h4 id="8url">8.URL</h4>
<h4 id="9email地址">9.Email地址</h4>
<h4 id="10中文字符">10.中文字符</h4>
<h2 id="26-函数式编程">26 函数式编程</h2>
<p>Lambda表达式是一种紧凑的传递代码的方式。</p>
<p>基于Lambda表达式，针对常见的集合数据处理，Java 8引入了一套新的类库，位于包java.util.stream下，称为**==Stream API==**。</p>
<p>Stream API是对容器类的增强，它可以<strong>将对集合数据的==多个操作以流水线的方式组合==在一起</strong>。</p>
<p>Java 8新增的<code>CompletableFuture</code>是对并发编程的增强，可以方便地<strong>将多个有一定依赖关系的异步任务以流水线的方式组合在一起</strong>，大大简化多异步任务的开发。</p>
<p>利用Lambda表达式，Java 8还增强了日期和时间API。</p>
<h3 id="261-lambda表达式">26.1 Lambda表达式</h3>
<h4 id="通过接口传递代码">通过接口传递代码</h4>
<p>针对接口而非具体类型进行编程，可以降低程序的耦合性，提高灵活性，提高复用性。<strong>接口常被用于==传递代码==</strong>，比如：</p>
<ol>
<li>
<p><code>File</code>有方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-253-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-253-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">listFiles</span>(FilenameFilter<span style="color:#bbb"> </span>filter)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>listFiles需要的其实不是FilenameFilter对象，而是需要FilenameFilter对象中的方法<code>boolean accept(File dir, String name);</code>。</p>
<p>或者说，listFiles希望接受一段方法代码作为参数，但没有办法直接传递这个方法代码本身，只能传递一个接口。</p>
</li>
<li>
<p>类Collections中的很多方法都接受一个参数Comparator：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-254-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-254-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">sort</span>(List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list,<span style="color:#bbb"> </span>Comparator<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它们需要的也不是Comparator对象，而是需要它包含的方法<code>int compare(T o1, T o2);</code></p>
</li>
<li>
<p>异步任务执行服务<code>ExecutorService</code>，提交任务的方法有：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-255-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-255-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-255-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-255-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Future<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">submit</span>(Callable<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>task);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Future<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>submit(Runnable<span style="color:#bbb"> </span>task);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Callable和Runnable接口也用于传递任务代码。</p>
</li>
</ol>
<p>通过接口传递行为代码，就要<strong>传递一个==实现了该接口的实例对象==</strong>，之前最简洁的方式是使用匿名内部类：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-256-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-256-22">22</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#4070a0">&#34;.&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span>files<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">listFiles</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>FilenameFilter()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">accept</span>(File<span style="color:#bbb"> </span>dir,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(name.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 将files按照文件名排序</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Arrays.<span style="color:#4070a0">sort</span>(files,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Comparator<span style="color:#666">&lt;</span>File<span style="color:#666">&gt;</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span><span style="color:#06287e">compare</span>(File<span style="color:#bbb"> </span>o1,<span style="color:#bbb"> </span>File<span style="color:#bbb"> </span>o2)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>o1.<span style="color:#4070a0">getName</span>().<span style="color:#4070a0">compareTo</span>(o2.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(File<span style="color:#bbb"> </span>file<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>files)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(file.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-257-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-257-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ExecutorService<span style="color:#bbb"> </span>executor<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Executors.<span style="color:#4070a0">newFixedThreadPool</span>(100);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>executor.<span style="color:#4070a0">submit</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Runnable()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#555;font-weight:bold">@Override</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">run</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;Hello world.&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>});<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="lambda语法">Lambda语法</h4>
<p>java8提供了一个比匿名内部类更紧凑的传递代码的语法：Lambda表达式。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-258-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-258-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File<span style="color:#bbb"> </span>f<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>File(<span style="color:#4070a0">&#34;.&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span>files<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">listFiles</span>((File<span style="color:#bbb"> </span>dir,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(name.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>});<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>前面是方法的参数，后面{}内是方法的代码。</p>
</blockquote>
<p>简化：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-259-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-259-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-259-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-259-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-259-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-259-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span>files<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">listFiles</span>((File<span style="color:#bbb"> </span>dir,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>name.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>});<span style="color:#bbb">  
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当主体代码只有一条语句的时候，括号和return语句也可以省略：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-260-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-260-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span>files<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">listFiles</span>((File<span style="color:#bbb"> </span>dir,<span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>name.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>方法的参数类型声明也可以省略：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-261-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-261-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span>files<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">listFiles</span>((dir,<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>name.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当参数只有一个的时候，参数部分的括号可以省略，比如File还有另外一个listFiles方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-262-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-262-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">listFiles</span>(FileFilter<span style="color:#bbb"> </span>filter)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-263-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-263-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-263-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-263-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-263-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-263-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">FileFilter</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">accept</span>(File<span style="color:#bbb"> </span>pathname);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它的Lambda表达式为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-264-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-264-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>File<span style="color:#666">[]</span><span style="color:#bbb"> </span>files<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>f.<span style="color:#4070a0">listFiles</span>(path<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>path.<span style="color:#4070a0">getName</span>.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>异步任务执行服务ExecutorService的Lambda表达式为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-265-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-265-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Executors.<span style="color:#4070a0">newFixedThreadPool</span>(100).<span style="color:#4070a0">submit</span>(()<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(<span style="color:#4070a0">&#34;Hello world!&#34;</span>));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Java会为每个匿名内部类生成一个类，但Lambda表达式不会。</strong></p>
<p>Lambda表达式内部实现上，利用了Java 7引入的为支持动态类型语言引入的<code>invokedynamic</code>指令、方法句柄（method handle）等具体实现查看<a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-translation.html">Translation of Lambda Expressions</a>。🔖</p>
<h4 id="函数式接口">函数式接口</h4>
<p><strong>==函数式接口==也是接口，但==只能有一个抽象方法==</strong>（java8引入）。还是允许有静态方法和默认方法的。</p>
<p>Lambda表达式就是函数接口，可以赋值给函数接口：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-266-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-266-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-266-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-266-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>FileFilter<span style="color:#bbb"> </span>filter<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>path<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>path.<span style="color:#4070a0">getName</span>().<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>FilenameFilter<span style="color:#bbb"> </span>filenameFilter<span style="color:#666">=</span><span style="color:#bbb"> </span>((dir,<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>name.<span style="color:#4070a0">endsWith</span>(<span style="color:#4070a0">&#34;.txt&#34;</span>));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这些函数接口都有一个注解<code>@FunctionalInterface</code>，非必须。</p>
<blockquote>
<p>为什么Comparator接口有两个抽象方法compare和equals,却可以用作Lambda？</p>
<p>因为在调用用lambda表达式调用Comparator接口中都是实现了compare方法，并没有实现equals，而equals是Object中的方法，所用的类都继承Object类，所以equals继承了Object中是实现，所以函数式接口(Functional Interface)就是一个有且仅有一个(除和Object中方法有相同签名的外)抽象方法，但是可以有多个非抽象方法的接口。</p>
<p>根据Java语言规范的定义，一个使用了该注释的接口类型声明将被视为一个函数式接口。从概念上讲，一个函数式接口有且只有一个抽象方法。由于默认方法已经有了实现，所以它们不是抽象方法。如果一个接口中声明的抽象方法是重写了超类Object类中任意一个public方法，那么这些抽象方法并不会算入接口的抽象方法数量中。因为任何接口的实现都会从其父类Object或其它地方获得这些方法的实现。
注意：函数式接口的实现可以由Lambda表达式、方法引用、构造器引用等方式实现。</p>
<p>如果一个类型使用了该注释，那么编译器将会生成一个错误信息，除非这个类型是一个接口类型，而不是一个注释类型、枚举或类。同时使用该注释的接口满足函数式接口的要求，即一个函数式接口有且只有一个抽象方法。</p>
<p>但是编译器会将所有定义为函数式接口（满足函数式接口要求）的接口视为函数式接口，而不管这个接口声明中是否使用了函数式接口的注释（即@FunctionalInterface）。</p>
<p>也就是：</p>
<ol>
<li>一个函数式接口有且只有一个抽象方法。</li>
<li>默认方法不是抽象方法，因为它们已经实现了。</li>
<li>重写了超类Object类中任意一个public方法的方法并不算接口中的抽象方法</li>
</ol>
</blockquote>
<h4 id="预定义的函数接口">预定义的函数接口</h4>
<p>Java 8定义了大量的预定义函数式接口，用于常见类型的代码传递，在<code>java.util.function</code>包内。</p>
<p><img src="images/image-20220602152042189.png"></p>
<p>为避免装箱/拆箱，Java 8提供了一些专门的函数，类似：</p>
<p><img src="images/image-20230501145201567.png"></p>
<p>这些函数被大量用于Java 8的函数式数据处理Stream相关的类中，即使不使用Stream，也可以在自己的代码中直接使用这些预定义的函数。</p>
<h5 id="1-predicate示例">1 Predicate示例</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-267-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-267-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-267-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-267-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-267-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-267-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-267-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-267-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-267-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-267-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Student</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>String<span style="color:#bbb"> </span>name;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Double<span style="color:#bbb"> </span>score;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// ...</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-268-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-268-24">24</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">PredicateTest</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">asList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student<span style="color:#666">[]</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;zhangsan&#34;</span>,<span style="color:#bbb"> </span>87d),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;lisi&#34;</span>,<span style="color:#bbb"> </span>89d),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;wangwu&#34;</span>,<span style="color:#bbb"> </span>92d)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">// 过滤90分以上</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>students<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>filter(students,<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>90);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(Student<span style="color:#bbb"> </span>s<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>students)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(s);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">filter</span>(List<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list,<span style="color:#bbb"> </span>Predicate<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>pred)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>retList<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(E<span style="color:#bbb"> </span>e<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(pred.<span style="color:#4070a0">test</span>(e))<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>retList.<span style="color:#4070a0">add</span>(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>retList;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在日常开发中，列表处理的一个常见需求是**==过滤==**，<strong>列表的类型</strong>经常不一样，<strong>过滤的条件</strong>也经常变化，但主体逻辑都是类似的，可以借助Predicate写一个通用的方法。</p>
<h5 id="2-function示例">2 Function示例</h5>
<p>列表处理的另一个常见需求是==转换==。比如，给定一个学生列表，需要返回名称列表，或者将名称转换为大写返回，可以借助Function写一个通用的方法:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-269-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-269-24">24</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">FunctionTest</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">map</span>(List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span>list,<span style="color:#bbb"> </span>Function<span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>mapper)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>retList<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;&gt;</span>(list.<span style="color:#4070a0">size</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(T<span style="color:#bbb"> </span>e<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>retList.<span style="color:#4070a0">add</span>(mapper.<span style="color:#4070a0">apply</span>(e));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>retList;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">asList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student<span style="color:#666">[]</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;zhangsan&#34;</span>,<span style="color:#bbb"> </span>87d),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;lisi&#34;</span>,<span style="color:#bbb"> </span>89d),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;wangwu&#34;</span>,<span style="color:#bbb"> </span>92d)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>names<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map(students,<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(names);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>students<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map(students,<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(t.<span style="color:#4070a0">getName</span>().<span style="color:#4070a0">toUpperCase</span>(),<span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(Student<span style="color:#bbb"> </span>s<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>students)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(s);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="3-consumer示例">3 Consumer示例</h5>
<p>直接修改原对象</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-270-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-270-19">19</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ConsumerTest</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">foreach</span>(List<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list,<span style="color:#bbb"> </span>Consumer<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>consumer)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(E<span style="color:#bbb"> </span>e<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>list)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>consumer.<span style="color:#4070a0">accept</span>(e);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">main</span>(String<span style="color:#666">[]</span><span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>List<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>students<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">asList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student<span style="color:#666">[]</span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;zhangsan&#34;</span>,<span style="color:#bbb"> </span>87d),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;lisi&#34;</span>,<span style="color:#bbb"> </span>89d),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;wangwu&#34;</span>,<span style="color:#bbb"> </span>92d)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>foreach(students,<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">setName</span>(t.<span style="color:#4070a0">getName</span>().<span style="color:#4070a0">toUpperCase</span>()));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">for</span><span style="color:#bbb"> </span>(Student<span style="color:#bbb"> </span>s<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>students)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(s);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>以上这些示例主要用于演示函数式接口的基本概念，实际中可以直接使用流API。</p>
</blockquote>
<h4 id="方法引用">方法引用</h4>
<p>官方文档：https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.13</p>
<p>Lambda表达式经常用于调用对象的某个方法，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-271-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-271-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>names<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map(students,<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getName</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可简化为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-272-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-272-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>names<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>map(students,<span style="color:#bbb">  </span>Student::getName);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>Student::getName</code>这种写法是Java 8引入对Lambda表达式简写的一种新语法，称为**==方法引用==**。</p>
<p><code>::</code>前面是类名或变量名，后面是方法名。方法可以是实例方法，也可以是静态方法，但含义不同。</p>
<p>对于静态方法，方法引用是<code>Supplier</code>，下面是等价的：🔖如果静态方法名相同参数不同的呢？</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-273-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-273-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-273-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-273-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Supplier<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Student::getCollegeName;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Supplier<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>()<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>Student.<span style="color:#4070a0">getCollegeName</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对于实例方法，方法引用是<code>Function</code>，它的第一个参数就是该类型的实例，下面等价：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-274-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-274-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-274-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-274-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Function<span style="color:#666">&lt;</span>Student,<span style="color:#bbb"> </span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>f1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Student::getName;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Function<span style="color:#666">&lt;</span>Student,<span style="color:#bbb"> </span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>f2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(Student<span style="color:#bbb"> </span>t)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getName</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对于Student::setName，它是一个<code>BiConsumer</code>，即如下两条语句是等价的：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-275-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-275-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-275-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-275-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>BiConsumer<span style="color:#666">&lt;</span>Student,<span style="color:#bbb"> </span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c1<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Student::setName;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>BiConsumer<span style="color:#666">&lt;</span>Student,<span style="color:#bbb"> </span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c2<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(t,<span style="color:#bbb"> </span>name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">setName</span>(name);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对于方法引用前面是变量名时：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-276-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-276-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-276-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-276-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-276-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-276-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-276-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-276-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-276-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-276-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-276-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-276-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Student<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(<span style="color:#4070a0">&#34;andy&#34;</span>,<span style="color:#bbb"> </span>99.<span style="color:#4070a0">9d</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Supplier<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s3<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>t::getName;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Supplier<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s4<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>()<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getName</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Consumer<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c3<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>t::setName;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Consumer<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>c4<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(name)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">setName</span>(name);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对于构造方法，方法引用的语法是<code>&lt;类名&gt;::new</code>： 🔖构造方法参数多余2个的呢？</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-277-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-277-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-277-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-277-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>BiFunction<span style="color:#666">&lt;</span>String,<span style="color:#bbb"> </span>Double,<span style="color:#bbb"> </span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s5<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Student::<span style="color:#007020;font-weight:bold">new</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>BiFunction<span style="color:#666">&lt;</span>String,<span style="color:#bbb"> </span>Double,<span style="color:#bbb"> </span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s6<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>(name,<span style="color:#bbb"> </span>score)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>Student(name,<span style="color:#bbb"> </span>score);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-278-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-278-15">15</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Supplier</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>T<span style="color:#bbb"> </span><span style="color:#06287e">get</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Function</span><span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>R<span style="color:#bbb"> </span><span style="color:#06287e">apply</span>(T<span style="color:#bbb"> </span>t);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">BiConsumer</span><span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>U<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">accept</span>(T<span style="color:#bbb"> </span>t,<span style="color:#bbb"> </span>U<span style="color:#bbb"> </span>u);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Consumer</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#902000">void</span><span style="color:#bbb"> </span><span style="color:#06287e">accept</span>(T<span style="color:#bbb"> </span>t);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">BiFunction</span><span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>U,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>R<span style="color:#bbb"> </span><span style="color:#06287e">apply</span>(T<span style="color:#bbb"> </span>t,<span style="color:#bbb"> </span>U<span style="color:#bbb"> </span>u);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h4 id="函数的复合">函数的复合</h4>
<p>函数式接口和Lambda表达式还可用作方法的返回值，传递代码回调用者，将这两种用法结合起来，可以构造复合的函数，使程序简洁易读。</p>
<h5 id="comparator中的复合方法">Comparator中的复合方法</h5>
<p>Comparator接口中的静态方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-279-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-279-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>U<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Comparable<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>U<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>Comparator<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">comparing</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>U<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>keyExtractor)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Objects.<span style="color:#4070a0">requireNonNull</span>(keyExtractor);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(Comparator<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#666">&amp;</span><span style="color:#bbb"> </span>Serializable)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(c1,<span style="color:#bbb"> </span>c2)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>keyExtractor.<span style="color:#4070a0">apply</span>(c1).<span style="color:#4070a0">compareTo</span>(keyExtractor.<span style="color:#4070a0">apply</span>(c2));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-280-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-280-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Arrays.<span style="color:#4070a0">sort</span>(files,<span style="color:#bbb"> </span>(f1,<span style="color:#bbb"> </span>f2)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>f1.<span style="color:#4070a0">getName</span>().<span style="color:#4070a0">compareTo</span>(f2.<span style="color:#4070a0">getName</span>()));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>简化为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-281-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-281-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Arrays.<span style="color:#4070a0">sort</span>(files,<span style="color:#bbb"> </span>Comparator.<span style="color:#4070a0">comparing</span>(File::getName));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-282-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-282-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-282-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-282-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 将学生列表按照分数倒序排（高分在前），分数一样的按照名字进行排序</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>students.<span style="color:#4070a0">sort</span>(Comparator.<span style="color:#4070a0">comparing</span>(Student::getScore).<span style="color:#4070a0">reversed</span>().<span style="color:#4070a0">thenComparing</span>(Student::getName));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="function包中的复合方法">function包中的复合方法</h5>
<p>在java.util.function包的很多函数式接口里，都定义了一些复合方法。</p>
<p>Function接口：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-283-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-283-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-283-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-283-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-283-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-283-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-283-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-283-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Function<span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">andThen</span>(Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>R,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>after)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Objects.<span style="color:#4070a0">requireNonNull</span>(after);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(T<span style="color:#bbb"> </span>t)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>after.<span style="color:#4070a0">apply</span>(apply(t));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>先将T类型的参数转化为类型R，再调用after将R转换为V，最后返回类型V。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-284-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-284-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-284-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-284-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-284-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-284-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-284-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-284-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>V<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Function<span style="color:#666">&lt;</span>V,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">compose</span>(Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>V,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>before)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Objects.<span style="color:#4070a0">requireNonNull</span>(before);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>(V<span style="color:#bbb"> </span>v)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>apply(before.<span style="color:#4070a0">apply</span>(v));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>对V类型的参数，先调用before将V转换为T类型，再调用当前的apply方法转换为R类型返回。</p>
<h3 id="262-函数式数据处理基本用法">26.2 函数式数据处理：基本用法</h3>
<p>接口Stream类似于一个迭代器，但提供了更为丰富的操作。</p>
<p>Java 8给Collection接口增加了两个默认方法，它们可以返回一个Stream：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-285-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-285-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-285-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-285-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-285-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-285-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-285-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-285-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-285-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-285-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-285-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-285-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">stream</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>StreamSupport.<span style="color:#4070a0">stream</span>(spliterator(),<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>E<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">parallelStream</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>StreamSupport.<span style="color:#4070a0">stream</span>(spliterator(),<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>前者返回的是一个==顺序流==，后者是一个并行流；顺序流就是由==一个线程执行操作==。而并行流背后==可能有多个线程并行执行==，与之前介绍的并发技术不同，使用并行流不需要显式管理线程，使用方法与顺序流是一样的。</p>
<h4 id="基本示例">基本示例</h4>
<h5 id="1基本过滤">1．基本过滤</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-286-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-286-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-286-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-286-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>87).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>list.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">forEach</span>(e<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(e));<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>==函数式数据处理==。与传统代码相比，其特点是：</p>
<ul>
<li>没有显式的循环迭代，循环过程被Stream的方法隐藏了。</li>
<li>提供了声明式的处理函数，比如filter，它封装了数据过滤的功能，而传统代码是命令式的，需要一步步的操作指令。</li>
<li>流畅式接口，方法调用链接在一起，清晰易读。</li>
</ul>
<h5 id="2基本转换">2．基本转换</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-287-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-287-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>nameList<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">map</span>(Student::getName).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="3基本的过滤和转换组合">3．基本的过滤和转换组合</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-288-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-288-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>aboveName<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>87).<span style="color:#4070a0">map</span>(Student::getName).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>filter()和map()一起使用不会遍历两次，它们都不会执行任何实际的操作，只是在构建操作的流水线，调用collect才会触发实际的遍历执行，在一次遍历中完成过滤、转换以及收集结果的任务。</p>
<p>像filter和map这种不实际触发执行、用于构建流水线、返回Stream的操作称为==中间操作（intermediate operation）==，而像collect这种触发实际执行、返回具体结果的操作称为==终端操作（terminal operation）==。</p>
<h4 id="中间操作">中间操作</h4>
<p>除了filter和map，还有：</p>
<h5 id="1-distinct">1. distinct</h5>
<p>distinct返回一个新的Stream，过滤重复的元素，只留下唯一的元素，是否重复是根据equals方法来比较的，distinct可以与其他函数（如filter、map）结合使用。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-289-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-289-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-289-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-289-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">asList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span>{<span style="color:#4070a0">&#34;abc&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;def&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;hello&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;Abc&#34;</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>retList<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>list.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(s<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>s.<span style="color:#4070a0">length</span>()<span style="color:#bbb"> </span><span style="color:#666">&lt;=</span><span style="color:#bbb"> </span>3).<span style="color:#4070a0">map</span>(String::toLowerCase).<span style="color:#4070a0">distinct</span>().<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">      
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>filter和map都是无状态的，对于流中的每一个元素，处理都是独立的，处理后即交给流水线中的下一个操作；distinct不同，它是有状态的，在处理过程中，它需要在内部记录之前出现过的元素，如果已经出现过，即重复元素，它就会过滤掉，不传递给流水线中的下一个操作。对于顺序流，内部实现时，distinct操作会使用HashSet记录出现过的元素，如果流是有顺序的，需要保留顺序，会使用LinkedHashSet。</p>
<h5 id="2-sorted">2. sorted</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-290-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-290-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-290-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-290-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-290-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-290-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>90)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>.<span style="color:#4070a0">sorted</span>(Comparator.<span style="color:#4070a0">comparing</span>(Student::getScore).<span style="color:#4070a0">reversed</span>().<span style="color:#4070a0">thenComparing</span>(Student::getName))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>.<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>与distinct一样，sorted也是一个有状态的中间操作，在处理过程中，需要在内部记录出现过的元素。其不同是，每碰到流中的一个元素，distinct都能立即做出处理，要么过滤，要么马上传递给下一个操作；sorted需要先排序，为了排序，它需要先在内部数组中保存碰到的每一个元素，到流结尾时再对数组排序，然后再将排序后的元素逐个传递给流水线中的下一个操作。</p>
<h5 id="3-skiplimit">3. skip/limit</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-291-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-291-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-291-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-291-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">skip</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>n)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">limit</span>(<span style="color:#902000">long</span><span style="color:#bbb"> </span>maxSize)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-292-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-292-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-292-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-292-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-292-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-292-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 将学生列表按照分数排序，返回第3名到第5名</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">sorted</span>(Comparator.<span style="color:#4070a0">comparing</span>(Student::getScore).<span style="color:#4070a0">reversed</span>())<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>.<span style="color:#4070a0">skip</span>(2).<span style="color:#4070a0">limit</span>(3).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>skip和limit只能根据元素数目进行操作，Java 9增加了两个新方法，相当于更为通用的skip和limit：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-293-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-293-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-293-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-293-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-293-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-293-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-293-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-293-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//通用的skip，在谓词返回为true的情况下一直进行skip操作，直到某次返回false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">dropWhile</span>(Predicate<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>predicate)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//通用的limit，在谓词返回为true的情况下一直接受，直到某次返回false</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">takeWhile</span>(Predicate<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>predicate)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="4-peek">4. peek</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-294-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-294-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">        </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">peek</span>(Consumer<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>action)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它返回的流与之前的流是一样的，没有变化，但它提供了一个Consumer，会将流中的每一个元素传给该Consumer。这个方法的主要目的是==支持调试==，可以使用该方法观察在流水线中流转的元素：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-295-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-295-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-295-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-295-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>above90Name<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>90)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>.<span style="color:#4070a0">peek</span>(System.<span style="color:#4070a0">out</span>::println).<span style="color:#4070a0">map</span>(Student::getName).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="5-maptolongmaptointmaptodouble">5. mapToLong/mapToInt/mapToDouble</h5>
<p>map函数接受的参数是一个Function&lt;T, R&gt;，为避免装箱/拆箱，提高性能，Stream还有如下返回基本类型特定流的方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-296-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-296-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-296-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-296-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-296-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-296-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>DoubleStream<span style="color:#bbb"> </span><span style="color:#06287e">mapToDouble</span>(ToDoubleFunction<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>mapper)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>IntStream<span style="color:#bbb"> </span><span style="color:#06287e">mapToInt</span>(ToIntFunction<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>mapper)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>LongStream<span style="color:#bbb"> </span><span style="color:#06287e">mapToLong</span>(ToLongFunction<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>mapper)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>DoubleStream/IntStream/LongStream是基本类型特定的流，有一些专门的更为高效的方法。比如，求学生列表的分数总和，代码为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-297-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-297-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#902000">double</span><span style="color:#bbb"> </span>sum<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">mapToDouble</span>(Student::getScore).<span style="color:#4070a0">sum</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="6-flatmap">6. flatMap</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-298-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-298-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">&lt;</span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">flatMap</span>(Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>R<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>mapper);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它接受一个函数mapper，对流中的每一个元素，mapper会将该元素转换为一个流Stream，然后把新生成流的每一个元素传递给下一个操作。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-299-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-299-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-299-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-299-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-299-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-299-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>lines<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">asList</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>String<span style="color:#666">[]</span>{<span style="color:#4070a0">&#34;hello abc&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;老李 编程&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;my name is andy&#34;</span>});<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>words<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>lines.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">flatMap</span>(line<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>Arrays.<span style="color:#4070a0">stream</span>(line.<span style="color:#4070a0">split</span>(<span style="color:#4070a0">&#34;\\s+&#34;</span>))).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>System.<span style="color:#4070a0">out</span>.<span style="color:#4070a0">println</span>(words);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-300-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-300-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">[</span>hello,<span style="color:#bbb"> </span>abc,<span style="color:#bbb"> </span>老李,<span style="color:#bbb"> </span>编程,<span style="color:#bbb"> </span>my,<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>is,<span style="color:#bbb"> </span>andy<span style="color:#666">]</span><span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="终端操作">终端操作</h4>
<p>除了collect，还有：</p>
<h5 id="1-maxmin">1. max/min</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-301-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-301-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-301-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-301-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">        </span>Optional<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">max</span>(Comparator<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>comparator)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>Optional<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">min</span>(Comparator<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>comparator)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>java.util.Optional</code>是Java 8引入的一个新类，它是一个泛型容器类，内部只有一个类型为T的单一变量value，可能为null，也可能不为null。</p>
<p>Optional定义了一些方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-302-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-302-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//value不为null时返回true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#902000">boolean</span><span style="color:#bbb"> </span><span style="color:#06287e">isPresent</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//返回实际的值，如果为null，抛出异常NoSuchElementException</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">get</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//如果value不为null，返回value，否则返回other</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span><span style="color:#06287e">orElse</span>(T<span style="color:#bbb"> </span>other)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//构建一个空的Optional, value为null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Optional<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">empty</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//构建一个非空的Optional, 参数value不能为null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Optional<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">of</span>(T<span style="color:#bbb"> </span>value)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#60a0b0;font-style:italic">//构建一个Optional，参数value可以为null，也可以不为null</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Optional<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">ofNullable</span>(T<span style="color:#bbb"> </span>value)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-303-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-303-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-303-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-303-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 返回分数最高的学生</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Student<span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">max</span>(Comparator.<span style="color:#4070a0">comparing</span>(Student::getScore)).<span style="color:#4070a0">get</span>();<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="2-count">2. count</h5>
<h5 id="3-allmatchanymatchnonematch">3. allMatch/anyMatch/noneMatch</h5>
<p>这几个函数都接受一个谓词Predicate，返回一个boolean值，用于判定流中的元素是否满足一定的条件。它们的区别是：</p>
<ul>
<li>
<p>allMatch：只有在流中所有元素都满足条件的情况下才返回true。</p>
</li>
<li>
<p>anyMatch：只要流中有一个元素满足条件就返回true。</p>
</li>
<li>
<p>noneMatch：只有流中所有元素都不满足条件才返回true。</p>
</li>
</ul>
<h5 id="4-findfirstfindany">4. findFirst/findAny</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-304-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-304-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-304-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-304-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-304-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-304-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-304-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-304-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-304-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-304-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 随便找一个不及格的学生</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Optional<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>student<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&lt;</span><span style="color:#bbb"> </span>60).<span style="color:#4070a0">findAny</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">if</span><span style="color:#bbb"> </span>(student.<span style="color:#4070a0">isPresent</span>())<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">// 处理不及格的学生</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="5-foreach">5. forEach</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-305-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-305-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>90).<span style="color:#4070a0">forEach</span>(System.<span style="color:#4070a0">out</span>::println);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="6-toarray">6. toArray</h5>
<p>将流转换为数组，有两个方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-306-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-306-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-306-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-306-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">        </span>Object<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">toArray</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>A<span style="color:#666">[]</span><span style="color:#bbb"> </span><span style="color:#06287e">toArray</span>(IntFunction<span style="color:#666">&lt;</span>A<span style="color:#666">[]&gt;</span><span style="color:#bbb"> </span>generator)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>不带参数的toArray返回的数组类型为Object[]，这通常不是期望的结果，如果希望得到正确类型的数组，需要传递一个类型为IntFunction的generator。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-307-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-307-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Student<span style="color:#666">[]</span><span style="color:#bbb"> </span>above90Arr<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#bbb"> </span><span style="color:#666">&gt;</span><span style="color:#bbb"> </span>90).<span style="color:#4070a0">toArray</span>(Student<span style="color:#666">[]</span>::<span style="color:#007020;font-weight:bold">new</span>);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>Student[]::new</code>就是一个类型为IntFunction&lt;Student[]&gt;的generator。</p>
<h5 id="7-reduce">7. reduce</h5>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-308-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-308-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-308-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-308-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-308-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-308-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Optional<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">reduce</span>(BinaryOperator<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>accumulator);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>T<span style="color:#bbb"> </span><span style="color:#06287e">reduce</span>(T<span style="color:#bbb"> </span>identity,<span style="color:#bbb"> </span>BinaryOperator<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>accumulator);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#666">&lt;</span>U<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>U<span style="color:#bbb"> </span><span style="color:#06287e">reduce</span>(U<span style="color:#bbb"> </span>identity,<span style="color:#bbb"> </span>BiFunction<span style="color:#666">&lt;</span>U,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T,<span style="color:#bbb"> </span>U<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>accumulator,<span style="color:#bbb"> </span>BinaryOperator<span style="color:#666">&lt;</span>U<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>combiner);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="构建流">构建流</h4>
<p>换做parallelStream方法，就会使用并行流，<strong>接口方法都是通用的</strong>。但并行流内部会使用多线程，线程个数一般与系统的CPU核数一样，以充分利用CPU的计算能力。</p>
<p>流定义了很多数据处理的基本函数，对于一个具体的数据处理问题，解决的主要思路就是组合利用这些基本函数，以声明式的方式简洁地实现期望的功能，这种思路就是函数式数据处理思维，相比直接利用容器类API的命令式思维，思考的层次更高。</p>
<p>除了通过Collection接口的stream/parallelStream获取流，还有一些其他方式可以获取流。Arrays有一些stream方法，可以将数组或子数组转换为流，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-309-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-309-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-309-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-309-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-309-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-309-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-309-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-309-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>IntStream<span style="color:#bbb"> </span><span style="color:#06287e">stream</span>(<span style="color:#902000">int</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>array)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span>DoubleStream<span style="color:#bbb"> </span><span style="color:#06287e">stream</span>(<span style="color:#902000">double</span><span style="color:#666">[]</span><span style="color:#bbb"> </span>array,<span style="color:#bbb"> </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>startInclusive,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                    </span><span style="color:#902000">int</span><span style="color:#bbb"> </span>endExclusive)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">stream</span>(T<span style="color:#666">[]</span><span style="color:#bbb"> </span>array)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Stream也有一些静态方法，可以构建流，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-310-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-310-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#60a0b0;font-style:italic">//返回一个空流</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">empty</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//返回只包含一个元素t的流</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">of</span>(T<span style="color:#bbb"> </span>t)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//返回包含多个元素values的流</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">of</span>(T...<span style="color:#bbb"> </span>values)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//通过Supplier生成流，流的元素个数是无限的</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">generate</span>(Supplier<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>s)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">//同样生成无限流，第一个元素为seed，第二个为f(seed)，第三个为f(f(seed))，以此类推</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Stream<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">iterate</span>(<span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span>seed,<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>UnaryOperator<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>f)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-311-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-311-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-311-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-311-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-311-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-311-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-311-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-311-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-311-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-311-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 输出10个随机数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Stream.<span style="color:#4070a0">generate</span>(()<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>Math.<span style="color:#4070a0">random</span>()).<span style="color:#4070a0">limit</span>(10).<span style="color:#4070a0">forEach</span>(System.<span style="color:#4070a0">out</span>::println);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// 输出100个递增的奇数</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Stream.<span style="color:#4070a0">iterate</span>(1,<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>t<span style="color:#bbb"> </span><span style="color:#666">+</span><span style="color:#bbb"> </span>2).<span style="color:#4070a0">limit</span>(100).<span style="color:#4070a0">forEach</span>(System.<span style="color:#4070a0">out</span>::println);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="函数式数据处理思维">函数式数据处理思维</h4>
<p>使用Stream API处理数据集合，与直接使用容器类API处理数据的思路是完全不一样的。流定义了很多数据处理的==基本函数==，对于一个具体的数据处理问题，解决的主要思路就是==组合利用==这些基本函数，以==声明式==的方式简洁地实现期望的功能，这种思路就是函数式数据处理思维，相比直接利用容器类API的命令式思维，==思考的层次更高==。</p>
<p>Stream API的这种思路也不是新发明，它与数据库查询语言SQL是很像。</p>
<p>Stream API也与各种基于Unix系统的管道命令类似。</p>
<p>Unix有很多命令，大部分命令只是专注于完成一件事情，但可以通过管道的方式将多个命令链接起来，完成一些复杂的功能，比如：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-312-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-312-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> cat nginx_access.log | awk <span style="color:#4070a0">&#39;{print $1}&#39;</span> | sort | uniq -c | sort -rnk <span style="color:#40a070">1</span> | head -n <span style="color:#40a070">20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析nginx访问日志，统计出访问次数最多的前20个IP地址及其访问次数。cat命令输出nginx访问日志到流，一行为一个元素，awk输出行的第一列，这里为IP地址，sort按IP进行排序，&ldquo;uniq -c&quot;按IP统计计数，&ldquo;sort -rnk 1&quot;按计数从高到低排序，&ldquo;head -n 20&quot;输出前20行。</p>
<h3 id="263-函数式数据处理强大方便的收集器">26.3 函数式数据处理：强大方便的收集器</h3>
<h4 id="理解collect">理解collect</h4>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-313-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-313-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>Student<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>above90List<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>students.<span style="color:#4070a0">stream</span>().<span style="color:#4070a0">filter</span>(t<span style="color:#666">-&gt;</span>t.<span style="color:#4070a0">getScore</span>()<span style="color:#666">&gt;</span>90).<span style="color:#4070a0">collect</span>(Collectors.<span style="color:#4070a0">toList</span>());<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>collect()</code>是怎么把Stream转换为List<!-- raw HTML omitted -->的呢？</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-314-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-314-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#666">&lt;</span>R,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>R<span style="color:#bbb"> </span><span style="color:#06287e">collect</span>(Collector<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>T,<span style="color:#bbb"> </span>A,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>collector)<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>它接受一个收集器<code>Collector</code>作为参数</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-315-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-315-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Collector</span><span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span>A,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Supplier<span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">supplier</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>BiConsumer<span style="color:#666">&lt;</span>A,<span style="color:#bbb"> </span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">accumulator</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>BinaryOperator<span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">combiner</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Function<span style="color:#666">&lt;</span>A,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">finisher</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Set<span style="color:#666">&lt;</span>Characteristics<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">characteristics</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在顺序流中，collect方法与这些接口方法的交互大概是这样的：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-316-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-316-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//首先调用工厂方法supplier创建一个存放处理状态的容器container，类型为A</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>A<span style="color:#bbb"> </span>container<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>collector.<span style="color:#4070a0">supplier</span>().<span style="color:#4070a0">get</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//对流中的每一个元素t，调用累加器accumulator，参数为累计状态container和当前元素t</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">for</span>(T<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>data)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>collector.<span style="color:#4070a0">accumulator</span>().<span style="color:#4070a0">accept</span>(container,<span style="color:#bbb"> </span>t);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">//最后调用finisher对累计状态container进行可能的调整，类型转换(A转换为R)，返回结果</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>collector.<span style="color:#4070a0">finisher</span>().<span style="color:#4070a0">apply</span>(container);<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>combiner只在并行流中有用，用于合并部分结果。</p>
<p>characteristics用于标示收集器的特征，Collector接口的调用者可以利用这些特征进行一些优化。<code>Characteristics</code>是一个枚举，有三个值：CONCURRENT、UNORDERED和IDENTITY_FINISH。</p>
<p><code>Collectors.toList()</code>中的tolist:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-317-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-317-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-317-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-317-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-317-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-317-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-317-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-317-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-317-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-317-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-317-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-317-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Collector<span style="color:#666">&lt;</span>T,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span>,<span style="color:#bbb"> </span>List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">toList</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>CollectorImpl<span style="color:#666">&lt;&gt;</span>((Supplier<span style="color:#666">&lt;</span>List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span>)<span style="color:#bbb"> </span>ArrayList::<span style="color:#007020;font-weight:bold">new</span>,<span style="color:#bbb"> </span>List::add,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                             </span>(left,<span style="color:#bbb"> </span>right)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                             </span>{<span style="color:#bbb"> </span>left.<span style="color:#4070a0">addAll</span>(right);<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>left;<span style="color:#bbb"> </span>},<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                             </span>CH_ID);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>CollectorImpl是<code>Collector</code>的实现类，是Collectors内部的一个私有类，实现很简单，主要就是定义了两个构造方法，接受函数式参数并赋值给内部变量。对toList来说：</p>
<ul>
<li>supplier的实现是ArrayList::new，也就是创建一个ArrayList作为容器。</li>
<li>accumulator的实现是List::add，也就是将碰到的每一个元素加到列表中。</li>
<li>第三个参数是combiner，表示合并结果。</li>
<li>第四个参数CH_ID是一个静态变量，只有一个特征IDENTITY_FINISH，表示finisher没有什么事情可以做，就是把累计状态container直接返回。</li>
</ul>
<p>最终<code>collect(Collectors.toList())</code>可以用一段伪代码理解为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-318-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-318-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-318-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-318-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-318-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-318-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-318-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-318-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>container<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">for</span>(T<span style="color:#bbb"> </span>t<span style="color:#bbb"> </span>:<span style="color:#bbb"> </span>data)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>container.<span style="color:#4070a0">add</span>(t);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>container;<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="容器收集器">容器收集器</h4>
<p><code>Collectors</code>中与toList类似的容器收集器还有toSet、toCollection、toMap等。</p>
<h5 id="1-toset">1. toSet</h5>
<h5 id="2-tocollection">2. toCollection</h5>
<h5 id="3-tomap">3. toMap</h5>
<h4 id="字符串收集器">字符串收集器</h4>
<p>除了将元素流收集到容器中，另一个常见的操作是收集为一个字符串。</p>
<p><code>Collectors.joining</code></p>
<h4 id="分组">分组</h4>
<p>分组类似于数据库查询语言SQL中的group by语句，它将元素流中的每个元素分到一个组，可以针对分组再进行处理和收集。</p>
<h5 id="1-基本用法">1 基本用法</h5>
<h5 id="2-基本原理">2 基本原理</h5>
<h5 id="3-分组计数找最大最小元素">3 分组计数、找最大/最小元素</h5>
<h5 id="4-分组数值统计">4 分组数值统计</h5>
<h5 id="5-分组内的map">5 分组内的map</h5>
<h5 id="6-分组结果处理filtersortskiplimit">6 分组结果处理（filter/sort/skip/limit）</h5>
<h5 id="7-分区">7 分区</h5>
<h5 id="8-多级分组">8 多级分组</h5>
<h3 id="264-组合式异步编程-">26.4 组合式异步编程 🔖</h3>
<h4 id="异步任务管理">异步任务管理</h4>
<h4 id="与futurefutruetask对比">与Future/FutrueTask对比</h4>
<h4 id="构建依赖单一阶段的任务流">构建依赖单一阶段的任务流</h4>
<h4 id="构建依赖两个阶段的任务流">构建依赖两个阶段的任务流</h4>
<h4 id="构建依赖多个阶段的任务流">构建依赖多个阶段的任务流</h4>
<h3 id="265-java-8-的日期和时间api">26.5 Java 8 的日期和时间API🔖</h3>
<p>位于包<code>java.time</code>。</p>
<h4 id="表示日期和时间">表示日期和时间</h4>
<h5 id="1-instant">1. Instant</h5>
<h5 id="2-localdatetime">2. LocalDateTime</h5>
<h5 id="3-zoneidzoneoffset">3. ZoneId/ZoneOffset</h5>
<h5 id="4-localdatelocaltime">4. LocalDate/LocalTime</h5>
<h5 id="5-zoneddatetime">5. ZonedDateTime</h5>
<h4 id="格式化">格式化</h4>
<h4 id="设置和修改时间">设置和修改时间</h4>
<h4 id="时间段的计算">时间段的计算</h4>
<h4 id="与datecalendar对象的转换">与Date/Calendar对象的转换</h4>
<h1 id="七更多">七、更多</h1>
<h2 id="java集合的双大括号初始化">Java集合的双大括号初始化</h2>
<p>双大括号初始化（double brace initialization）或者匿名内部类初始化法</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-319-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-319-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span>()<span style="color:#bbb"> </span>{{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>add(<span style="color:#4070a0">&#34;Hello&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>add(<span style="color:#4070a0">&#34;World!&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}};<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Map<span style="color:#666">&lt;</span>String,<span style="color:#bbb"> </span>Object<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>map<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>HashMap<span style="color:#666">&lt;</span>String,<span style="color:#bbb"> </span>Object<span style="color:#666">&gt;</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>put(<span style="color:#4070a0">&#34;name&#34;</span>,<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;Tom&#34;</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>put(<span style="color:#4070a0">&#34;age&#34;</span>,<span style="color:#bbb"> </span>10);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">	</span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>};<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="原理">原理</h4>
<p>第一层花括号定义了一个<strong>继承于ArrayList的匿名内部类 (Anonymous Inner Class)</strong>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-320-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-320-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-320-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-320-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-320-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-320-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-320-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-320-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//定义了一个继承于ArrayList的匿名内部类</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>};<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第二层花括号是这个匿名内部类<strong>实例初始化块 (Instance Initializer Block)</strong>（或称为非静态初始化块）：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-321-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-321-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-321-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-321-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;</span>String<span style="color:#666">&gt;</span>(){<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>{<span style="color:#bbb">
</span></span></span></code></pre></td></tr></table>
</div>
</div>
        </div>

        
        
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">andyron</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2023-12-30
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>



        
        
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    
  </div>
</div>


        <footer class="post-footer">
          


          
          <nav class="post-nav">
            
              <a class="prev" href="/blog/2017/07/swift-1-the-basics.html/">
                
                <i class="iconfont">
                  <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

                </i>
                <span class="prev-text nav-default">以撸代码的形式学习Swift-1：基础(The Basics)</span>
                <span class="prev-text nav-mobile">上一篇</span>
              </a>
            
          </nav>
        </footer>
      </article>

      
      


      
      

  

  
  
    <div class="post">
  <script
    src="https://giscus.app/client.js"
    data-repo="xianmin/comments---xianmin.org"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxNDAyNTY2MDI="
    data-category="Announcements"
    data-category-id="DIC_kwDOCFwlWs4CRRxW"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    
    crossorigin="anonymous"
    async
  ></script>
</div>

  

  
  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "http://localhost:1313/blog/1/01/.html/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'xianmin12';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript
    >Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
</div>


    

  

  


    </div>

    
    <nav class="toc" id="toc">
    <div class="toc-title">文章目录</div>
    <div class="toc-content custom-scrollbar">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#keywords">title: &lsquo;Java编程的逻辑2&rsquo;
date: 2024-07-25
draft: false
slug: java-program-logic2
description:
categories: [Java]
tags:
keywords:</a></li>
  </ul>

  <ul>
    <li><a href="#13-文件基本技术">13 文件基本技术</a>
      <ul>
        <li><a href="#131-文件概述">13.1 文件概述</a></li>
        <li><a href="#132-二进制文件和字节流">13.2 二进制文件和字节流</a></li>
        <li><a href="#133-文本文件和字符流">13.3 文本文件和字符流</a></li>
        <li><a href="#134-文件和目录操作">13.4 文件和目录操作</a></li>
      </ul>
    </li>
    <li><a href="#14-文件高级技术">14 文件高级技术</a>
      <ul>
        <li><a href="#141-常见文件类型处理">14.1 常见文件类型处理</a></li>
        <li><a href="#142-随机读写文件">14.2 随机读写文件</a></li>
        <li><a href="#143-内存映射文件">14.3 内存映射文件🔖</a></li>
        <li><a href="#144-标准序列化机制">14.4 标准序列化机制🔖</a></li>
        <li><a href="#145-使用jackson序列化为jsonxmlmessagepack">14.5 使用Jackson序列化为JSON/XML/MessagePack❤️</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#15-并发基础知识">15 并发基础知识</a>
      <ul>
        <li><a href="#151-线程的基本概念">15.1 线程的基本概念</a></li>
        <li><a href="#152-理解synchronized">15.2 理解synchronized</a></li>
        <li><a href="#153-线程的基本协作机制">15.3 线程的基本协作机制🔖</a></li>
        <li><a href="#154-线程的中断">15.4 线程的中断</a></li>
      </ul>
    </li>
    <li><a href="#16-并发包的基石">16 并发包的基石</a>
      <ul>
        <li><a href="#161-原子变量和cas">16.1 原子变量和CAS</a></li>
        <li><a href="#162-显式锁">16.2 显式锁</a></li>
        <li><a href="#163-显式条件">16.3 显式条件</a></li>
      </ul>
    </li>
    <li><a href="#17-并发容器">17 并发容器</a>
      <ul>
        <li><a href="#171-写时复制的list和set">17.1 写时复制的List和Set</a></li>
        <li><a href="#172-concurrenthashmap">17.2 ConcurrentHashMap</a></li>
        <li><a href="#173-基于跳表的map和set">17.3 基于跳表的Map和Set🔖</a></li>
        <li><a href="#174-并发队列">17.4 并发队列🔖</a></li>
      </ul>
    </li>
    <li><a href="#18-异步任务执行服务">18 异步任务执行服务🔖</a>
      <ul>
        <li><a href="#181-基本概念和原理">18.1 基本概念和原理</a></li>
        <li><a href="#182-线程池">18.2 线程池</a></li>
        <li><a href="#183-定时任务的陷阱">18.3 定时任务的陷阱</a></li>
      </ul>
    </li>
    <li><a href="#19-同步和协作工具类">19 同步和协作工具类🔖</a>
      <ul>
        <li><a href="#191-读写锁reentrantreadwritelock">19.1 读写锁ReentrantReadWriteLock</a></li>
        <li><a href="#192-信号量semaphore">19.2 信号量Semaphore</a></li>
        <li><a href="#193-倒计时门栓countdownlatch">19.3 倒计时门栓CountDownLatch</a></li>
        <li><a href="#194-循环栅栏cyclicbarrier">19.4 循环栅栏CyclicBarrier</a></li>
        <li><a href="#195-理解threadlocal">19.5 理解ThreadLocal</a></li>
        <li><a href="#小结-2">小结</a></li>
      </ul>
    </li>
    <li><a href="#20-并发总结">20 并发总结</a>
      <ul>
        <li><a href="#201-线程安全的机制">20.1 线程安全的机制</a></li>
        <li><a href="#202-线程的协作机制">20.2 线程的协作机制</a></li>
        <li><a href="#203-容器类">20.3 容器类</a></li>
        <li><a href="#204-任务执行服务">20.4 任务执行服务</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#21-反射">21 反射</a>
      <ul>
        <li><a href="#211-class类">21.1 Class类</a></li>
        <li><a href="#212-应用示例实现简单的通用序列化反序列化">21.2 应用示例：实现简单的通用序列化/反序列化</a></li>
        <li><a href="#213-反射与泛型">21.3 反射与泛型</a></li>
      </ul>
    </li>
    <li><a href="#22-注解">22 注解</a>
      <ul>
        <li><a href="#221-内置注解">22.1 内置注解</a></li>
        <li><a href="#222-框架和库的注解">22.2 框架和库的注解</a></li>
        <li><a href="#223-创建注解">22.3 创建注解</a></li>
        <li><a href="#224-查看注解信息">22.4 查看注解信息</a></li>
        <li><a href="#225-注解的应用定制序列化">22.5 注解的应用：定制序列化</a></li>
        <li><a href="#226-注解的应用di容器">22.6 注解的应用：DI容器</a></li>
      </ul>
    </li>
    <li><a href="#23-动态代理">23 动态代理</a>
      <ul>
        <li><a href="#231-静态代理">23.1 静态代理</a></li>
        <li><a href="#232-java-sdk动态代理">23.2 Java SDK动态代理</a></li>
        <li><a href="#233-cglib动态代理">23.3 cglib动态代理</a></li>
        <li><a href="#234-java-sdk代理与cglib代理比较">23.4 Java SDK代理与cglib代理比较</a></li>
        <li><a href="#235-动态代理的应用aop">23.5 动态代理的应用：AOP</a></li>
      </ul>
    </li>
    <li><a href="#24-类加载机制">24 类加载机制</a>
      <ul>
        <li><a href="#241-类加载的基本机制和过程">24.1 类加载的基本机制和过程</a></li>
        <li><a href="#242-理解classloader">24.2 理解ClassLoader</a></li>
        <li><a href="#243-类加载的应用可配置的策略">24.3 类加载的应用：可配置的策略</a></li>
        <li><a href="#244-自定义classloader">24.4 自定义ClassLoader</a></li>
        <li><a href="#245-自定义classloader的应用热部署">24.5 自定义ClassLoader的应用：热部署🔖</a></li>
      </ul>
    </li>
    <li><a href="#25-正则表达式">25 正则表达式</a>
      <ul>
        <li><a href="#251-语法">25.1 语法</a></li>
        <li><a href="#252-java-api">25.2 Java API</a></li>
        <li><a href="#253-模板引擎">25.3 模板引擎</a></li>
        <li><a href="#254-剖析常见表达式">25.4 剖析常见表达式</a></li>
      </ul>
    </li>
    <li><a href="#26-函数式编程">26 函数式编程</a>
      <ul>
        <li><a href="#261-lambda表达式">26.1 Lambda表达式</a></li>
        <li><a href="#262-函数式数据处理基本用法">26.2 函数式数据处理：基本用法</a></li>
        <li><a href="#263-函数式数据处理强大方便的收集器">26.3 函数式数据处理：强大方便的收集器</a></li>
        <li><a href="#264-组合式异步编程-">26.4 组合式异步编程 🔖</a></li>
        <li><a href="#265-java-8-的日期和时间api">26.5 Java 8 的日期和时间API🔖</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#java集合的双大括号初始化">Java集合的双大括号初始化</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </nav>


  </div>

      </main>

      <footer id="footer" class="footer">
        <div class="icon-links">
  
  
    <a href="mailto:rongming.2008@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/3133839/andyron" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://github.com/andyron" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://localhost:1313/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2025
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        andyron
        
      </span></span>

  
  

  
</div>

      </footer>

      <div class="button__back-to-top">
        <a href="#back-to-top">
          <i class="iconfont">
            
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

          </i>
        </a>
      </div>
    </div>
    
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.25d4b4ffb2db9a42760854fb017fe0cbe4413e299a94b43b52a058abedbf5ace.js" integrity="sha256-JdS0/7LbmkJ2CFT7AX/gy&#43;RBPimalLQ7UqBYq&#43;2/Ws4=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>




  <script src="/js/custom.js"></script>


  </body>
</html>
