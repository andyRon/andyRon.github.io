<!DOCTYPE html>
<html
  lang="zh-cn"
  itemscope
  itemtype="http://schema.org/WebPage"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
          系统学习iOS动画之三：图层动画 - 欣欣向戎
        </title>
    

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="andyron" />
  <meta name="description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati" />

  <meta name="keywords" content="linux, Go, Java, PHP, program, journal, andyron, 博客, 笔记" />






<meta name="generator" content="Hugo 0.128.2" />


<link rel="canonical" href="http://localhost:1313/blog/2018/12/ios-animation-3-layer-animations.html/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.d8d87b982993a745e5e7b6a6cbf257be8c3e82aab5e485f0908ad7e6c3501ab2.css" integrity="sha256-2Nh7mCmTp0Xl57amy/JXvow&#43;gqq15IXwkIrX5sNQGrI=" media="screen" crossorigin="anonymous">






<link rel="stylesheet" href="/css/custom.css">


<meta property="og:url" content="http://localhost:1313/blog/2018/12/ios-animation-3-layer-animations.html/">
  <meta property="og:site_name" content="欣欣向戎">
  <meta property="og:title" content="系统学习iOS动画之三：图层动画">
  <meta property="og:description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2018-12-15T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-07-16T10:02:19+08:00">
    <meta property="article:tag" content="IOS动画">
    <meta property="article:tag" content="图层动画">
    <meta property="article:tag" content="Layer Animations">
    <meta property="article:tag" content="核心动画">

  <meta itemprop="name" content="系统学习iOS动画之三：图层动画">
  <meta itemprop="description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati">
  <meta itemprop="datePublished" content="2018-12-15T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-07-16T10:02:19+08:00">
  <meta itemprop="wordCount" content="21619">
  <meta itemprop="keywords" content="IOS动画,图层动画,Layer Animations,核心动画">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="系统学习iOS动画之三：图层动画">
  <meta name="twitter:description" content="本文是我学习《iOS Animations by Tutorials》 笔记中的一篇。 文中详细代码都放在我的Github上 andyRon/LearniOSAnimati">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  </head>
  <body>
    <div id="back-to-top"></div>

    <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">欣欣向戎</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/blog/">全部文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/index.xml">订阅</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


    
      






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    

    
      
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '002186711602136249422:q1gkomof_em';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

    

    


    <header id="header" class="header">
      <div class="logo-wrapper">
  <a href="/" class="logo">
    
      欣欣向戎
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/blog/">全部文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://localhost:1313/index.xml">订阅</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

    </header>

    <div id="mobile-panel">
      <main id="main" class="main bg-llight wallpaper">
        <div class="content-wrapper">
    <div id="content" class="content">
      <article class="post">
        
        <header class="post-header">
          <h1 class="post-title">系统学习iOS动画之三：图层动画</h1>
          

          <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          andyron
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2018-12-15">
      2018-12-15
    </time>
  </div>

  
    <div class="post-meta-lastmod">
      (上次更新:
      2024-07-16)
    </div>
  


  <div class="post-meta__right">
    

    <div class="post-meta-category">
        <a href="http://localhost:1313/categories/ios-animation/"> iOS-Animation </a>
          
      </div>


    
    


    
    
  </div>
</div>

        </header>

        
        <div class="post-content">
          <blockquote>
<p>本文是我学习<a href="https://store.raywenderlich.com/products/ios-animations-by-tutorials">《iOS Animations by Tutorials》</a> 笔记中的一篇。
文中详细代码都放在我的Github上 <a href="https://github.com/andyRon/LearniOSAnimations/tree/master/iOS_Animations_by_Tutorials">andyRon/LearniOSAnimations</a>。</p>
</blockquote>
<p><a href="http://andyron.com/2018/iOS-Animation-1-view-animation">系统学习iOS动画之一：视图动画</a> 学习了创建视图动画（View Animations），这一部分学习功能更强大、更偏底层的<strong>Core Animation(核心动画)</strong> APIs。核心动画的这个名字可能令人有点误解，暂时可以理解为本文的标题<strong>图层动画(Layer Animations)</strong>。</p>
<p>在本书的这一部分中，将学习动画层而不是视图以及如何使用特殊图层。</p>
<p>图层是一个简单的模型类，它公开了许多属性来表示一些基于图像的内容。 每个<code>UIView</code>都有一个图层支持(都有一个<code>layer</code>属性)。</p>
<p><strong>视图 vs 图层</strong></p>
<p>由于以下原因，图层(Layers)与视图(Views)（对于动画）不同：</p>
<ul>
<li>图层是一个模型对象 —— 它公开数据属性并且不实现任何逻辑。 它没有复杂的自动布局依赖关系，也不用处理用户交互。</li>
<li>图层具有预定义的可见特征 —— 这些特征是许多影响内容在屏幕上呈现的数据属性，例如边框线，边框颜色，位置和阴影。</li>
<li>最后，<strong>Core Animation</strong>优化了图层内容的缓存并直接在<strong>GPU</strong>上快速绘图。</li>
</ul>
<p>单个来说，两者的优点。</p>
<p>视图：</p>
<ul>
<li>复杂视图层次结构布局，自动布局等。</li>
<li>用户交互。</li>
<li>通常具有在CPU上的主线程上执行的自定义逻辑或自定义绘图代码。</li>
<li>非常灵活，功能强大，子类很多类。</li>
</ul>
<p>图层：</p>
<ul>
<li>更简单的层次结构，更快地解决布局，绘制速度更快。</li>
<li>没有响应者链开销。</li>
<li>默认情况下没有自定义逻辑 并直接在GPU上绘制。</li>
<li>不那么灵活，子类的类更少。</li>
</ul>
<p>视图和图层的选择技巧： <strong>任何时候都可以选择视图动画; 当需要更高的性能时，就需要使用图层动画。</strong></p>
<p>两者在架构中的位置：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxdhuq4gvcj30eo0aumxf.jpg"></p>
<!-- raw HTML omitted -->
<p><strong>预览：</strong></p>
<p>本文比较长，图片比较多，预警⚠️😀。</p>
<p><a href="/blog/2018/12/ios-animation-3-layer-animations.html/#8-图层动画入门">8-图层动画入门</a>   —— 从最简单的图层动画开始，了解调试动画错误的方法。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#9-动画的Keys和代理">9-动画的Keys和代理</a> —— 怎么更好地控制当前运行的动画，并使用代理方法对动画事件做出响应。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#10-动画组和时间控制">10-动画组和时间控制</a> —— 组合许多简单的动画，并将它们作为一个组一起运行。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#11-图层弹簧动画">11-图层弹簧动画</a> —— 学习如何使用<code>CASpringAnimation</code>创建强大而灵活的弹簧图层动画。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#12-图层关键帧动画和结构属性">12-图层关键帧动画和结构属性</a> —— 学习图层关键帧动画， 动画结构属性的一些特殊处理。</p>
<p>接下来，学习几个专门的图层：</p>
<p><a href="/blog/2018/12/ios-animation-3-layer-animations.html/#13-形状和蒙版">13-形状和蒙版</a> —— 通过<code>CAShapeLayer</code>在屏幕上绘制形状，并为其特殊路径属性设置动画。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#14-渐变动画">14-渐变动画</a>  —— 了解如何使用<code>CAGradientLayer</code>来绘制渐变和动画渐变。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#15-Stroke和路径动画">15-Stroke和路径动画</a> ——  以交互方式绘制形状，并使用关键帧动画的一些强大功能。<br>
<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#16-复制动画">16-复制动画</a> —— 学习如何创建图层内容的多个副本，然后利用副本制作动画。</p>
<h2 id="8-图层动画入门">8-图层动画入门</h2>
<p><strong>图层动画</strong>的工作方式与<strong>视图动画</strong>非常相似; 只需在定义的时间段内为起始值和结束值之间的属性设置动画，然后让<strong>Core Animation</strong>处理两者之间的渲染。</p>
<p>但是，<strong>图层动画</strong>具有比<strong>视图动画</strong>更多的<strong>可动画属性</strong>; 在设计效果时，这会提供了很多选择和灵活性; <strong>图层动画</strong>还有许多专门的CALayer子类（如<code>CATextLayer</code>、 <code>CAShapeLayer</code> 、 <code>CATransformLayer</code> 、<code>CAGradientLayer</code>、<code>CAReplicatorLayer</code>、<code>CAScrollLayer</code>、<code>CAEmitterLayer</code>、<code>AVPlayerLayer</code>等），这些子类有提供了许多其他属性。</p>
<p>本章介绍CALayer和Core Animation的基础知识。</p>
<h3 id="可动画属性">可动画属性</h3>
<p>可与视图动画的<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#%E5%8F%AF%E5%8A%A8%E7%94%BB%E5%B1%9E%E6%80%A7">可动画属性</a>对照着看。</p>
<h4 id="位置-和-大小">位置 和 大小</h4>
<p><code>bounds</code>、<code>position</code>、<code>transform</code></p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fw8y8bkr03j30do05qglq.jpg"></p>
<h4 id="边">边</h4>
<p><code>borderColor</code>、 <code>borderWidth</code>、<code>cornerRadius</code></p>
<p><img alt="image-20181015154228090" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fw8ybp1rc8j30dx05o754.jpg"></p>
<h4 id="阴影">阴影</h4>
<p><img alt="image-20181015154548338" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxde6lbbg1j30d004zjsm.jpg"></p>
<p><code>shadowOffset</code>： 使阴影看起来更接近或更远离图层。
<code>shadowOpacity</code>：使阴影淡入或淡出。
<code>shadowPath</code>： 更改图层阴影的形状。 可以创建不同的3D效果，使图层看起来像浮动在不同的阴影形状和位置上。
<code>shadowRadius</code>： 控制阴影的模糊; 当模拟视图朝向或远离投射阴影的表面移动时，这尤其有用。</p>
<h4 id="内容">内容</h4>
<p><code>contents</code> ：修改此项以将原始TIFF或PNG数据指定为图层内容。</p>
<p><code>mask</code> ：修改它将用于掩盖图层可见内容的形状或图像。 这个属性在<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#13-形状和蒙版">13-形状和蒙版</a>将详细介绍和使用。</p>
<p><code>opacity</code></p>
<h3 id="第一个图层动画">第一个图层动画</h3>
<p><strong>开始项目</strong>使用<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#3-%E8%BF%87%E6%B8%A1%E5%8A%A8%E7%94%BB"> 3-过渡动画</a>完成的项目。</p>
<p>把原本head的视图动画替换为图层动画。</p>
<p>分别删除<strong>ViewController</strong>的<code>viewWillAppear()</code>中：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>heading.center.x    <span style="color:#666">-=</span>  view.bounds.width
</span></span></code></pre></td></tr></table>
</div>
</div><p>和<code>viewDidAppear()</code>中:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>UIView.animate(withDuration: <span style="color:#40a070">0.5</span>) {
</span></span><span style="display:flex;"><span>     <span style="color:#007020;font-weight:bold">self</span>.heading.center.x <span style="color:#666">+=</span> <span style="color:#007020;font-weight:bold">self</span>.view.bounds.width
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>viewWillAppear()</code>的开始（<code>super</code>调用后）添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-2-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flyRight</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.x&#34;</span>)
</span></span><span style="display:flex;"><span>flyRight.fromValue = <span style="color:#666">-</span>view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>flyRight.toValue = view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>flyRight.duration = <span style="color:#40a070">0.5</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>核心动画中的动画对象只是<strong>简单的数据模型</strong>; 上面的代码创建了<code>CABasicAnimation</code>的实例，并设置了一些数据属性。
这个实例描述了一个<strong>潜在</strong>的图层动画：<em>可以选择立即运行，稍后运行，或者根本不运行</em>。</p>
<p>由于动画未绑定到特定图层，因此可以在其他图层上<strong>重复使用动画</strong>，每个图层将独立运行动画的副本。</p>
<p>在动画模型中，您可以将要设置为动画的属性指定为<code>keypath</code>参数(比如上面设置是<code>&quot;position.x&quot;</code>); 这很方便，因为动画总是在图层中设置。</p>
<p>接下来，为在<code>keypath</code>上指定的属性设置<code>fromValue</code>和<code>toValue</code>。需要动画对象（此处我要处理的是heading）从屏幕左侧到屏幕中央。动画持续时间的概念没有改变; <code>duration</code>设置为0.5秒。</p>
<p>动图已经设置完成，现在需要把它添加需要运行此动画的图层上。 在刚添加的代码下方添加，将动画添加到heading的图层：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>heading.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>add(_:forKey:)</code>会把动画做个一个<strong>拷贝</strong>给将要添加的图层。 如果之后需要更改或停止动画，可以添加<code>forKey</code>参数用于识别动画。</p>
<p>此时的动画看上去和之前视图动画没有什么区别。</p>
<h3 id="更多图层动画知识">更多图层动画知识</h3>
<p>同一样的方法应用在<strong>Username Filed</strong>上，删除<code>viewWillAppear()</code>和<code>viewDidAppear()</code>中对应代码。再把之前的动画添加的<strong>Username Filed</strong>的layer上：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>username.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时运行项目，看上去会有点别扭，因为<strong>heading Label</strong>，<strong>Username Filed</strong>的动画是相同的，<strong>Username Filed</strong>没有之前的延迟效果。</p>
<p>在添加动画到<strong>Username Filed</strong>的layer上之前，添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyRight.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>动画的<code>beginTime</code>属性设置动画应该开始的绝对时间; 在这种情况下，可以使用<code>CACurrentMediaTime()</code>获取当前时间(系统的一个绝对时间，机器开启时间，取自机器时间 <code>mach_absolute_time()</code>)，并以秒为单位添加所需的延迟。</p>
<p>此时，如果仔细观察会发现有个问题，<strong>Username Filed</strong>在开始动画之前已经出现了，这就涉及到另外一个图层动画属性 <code>fillMode</code>  了。</p>
<h4 id="关于-fillmode">关于 <code>fillMode</code></h4>
<p>以<strong>Username Field</strong>的移动动画来看看<code>fillMode</code>不同值的区别，为了方便观察，我把<code>beginTime</code>时间变大，代码类似于：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-6-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flyRight</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.x&#34;</span>)
</span></span><span style="display:flex;"><span>flyRight.fromValue = <span style="color:#666">-</span>view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>flyRight.toValue = view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>flyRight.duration = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>heading.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flyRight.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">2.3</span>
</span></span><span style="display:flex;"><span>flyRight.fillMode = kCAFillModeRemoved
</span></span><span style="display:flex;"><span>username.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>kCAFillModeRemoved</code>  是<code>fillMode</code>的默认值</p>
<p>在定义的<code>beginTime</code>处启动动画(如果未设置<code>beginTime</code>，也就是<code>beginTime</code>等于<code>CACurrentMediaTime()</code>，则立即启动动画)， 并在动画完成时删除动画期间所做的更改：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxk4aqik4wj30ee04bglh.jpg"></p>
<p>实际效果：
<img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxk4qcfn85g308q060ta9.gif"></p>
<p><em>now</em> 到 <em>begin</em> 这段时间动画没有开始，但<strong>Username Field</strong>直接显示了，然后到 <em>begin</em>时动画才开始，这就是之前遇到的情况。</p>
</li>
<li>
<p><code>kCAFillModeBackwards</code></p>
<p>无论动画的实际开始时间如何，<code>kCAFillModeBackwards</code>都会立即在屏幕上显示动画的第一帧，并在以后启动动画:</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxk4h0w3ncj30du03w3yf.jpg"></p>
<p>实际效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxk4klai6yg308q06075v.gif"></p>
<p>第一帧在<code>fromValue</code>处，也就是<code>&quot;position.x&quot;</code>是负的在屏幕外，因此开始时没有看见<strong>Username Field</strong>，等待2.3s后动画开始。</p>
</li>
<li>
<p><code>kCAFillModeForwards</code></p>
<p><code>kCAFillModeForwards</code>像往常一样播放动画，但在屏幕上保留动画的最后一帧，直到您删除动画：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxk53tocyvj30dw049a9z.jpg"></p>
<p>实际效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxk57t0yj4g308q060jsx.gif"></p>
<p>除了设置kCAFillModeForwards之外，还需要对图层进行一些其他更改以使最后一帧“粘贴”。 你将在本章后面稍后了解这一点。 和第一个有点类似，但还是有区别的。</p>
</li>
<li>
<p><code>kCAFillModeBoth</code></p>
<p><code>kCAFillModeBoth</code>是<code>kCAFillModeForwards</code>和<code>kCAFillModeBackwards</code>的组合; 这会使动画的第一帧立即出现在屏幕上，并在动画结束时在屏幕上保留最终帧：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxk5cg26eoj30ea048weg.jpg"></p>
<p>实际效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxk5bvgjmcg308q060wgg.gif"></p>
<p>要解决之前发现的问题，将使用<code>kCAFillModeBoth</code>。</p>
<p>同样对于<strong>Password Field</strong>，也删除其视图动画的代码，改换成类似<strong>Username Field</strong>的图层动画，不过<code>beginTime</code>要晚一点，具体代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>flyRight.beginTime = CACurrentMediaTime() + 0.3
flyRight.fillMode = kCAFillModeBoth
username.layer.add(flyRight, forKey: nil)</p>
<p>flyRight.beginTime = CACurrentMediaTime() + 0.4
password.layer.add(flyRight, forKey: nil)</p>
<pre tabindex="0"><code>
到目前为止，您的动画恰好在表单元素最初位于Interface Builder中的确切位置结束。 但是，很多时候情况并非如此。

### 调试动画

在上面的动画后继续添加：

```swift
username.layer.position.x -= view.bounds.width
password.layer.position.x -= view.bounds.width
</code></pre><p>这就是把两个文本框的图层移动到屏幕外，类似于<code>flyRight.fromValue = -view.bounds.size.width/2</code>（此时这段代码可以暂时注释掉），运行后发现问题，动画结束后两个文本框消失了，这是怎么回事呢？</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fw9uakzv3kg308s0fo0v1.gif"></p>
<p>继续在上面的代码后添加一个延迟函数：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-9-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>delay(seconds: <span style="color:#40a070">5.0</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#4070a0">&#34;where are the fields?&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>并打断点后运行：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy7n2onqjqj309s02ldfv.jpg"></p>
<p>进入<strong>UI hierarchy</strong> 窗口：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fw9v6cjqdmj30xa0meacn.jpg"></p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fw9v6q3kc4j30uq0iadj0.jpg"></p>
<p><strong>UI hierarchy</strong> 模式下可以查看当前运行时的UI层次结构，包括已经隐藏或透明视图以及在屏幕外的视图。还可以3D查看。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fw9vjxwr0dg31140oz1hp.gif"></p>
<p>当然还可以在右侧检测器中查看实时属性：</p>
<p><img alt="image-20181125124028215" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxk7g2vfjzj31ek0u0e81.jpg"></p>
<p>动画完成后，代码更改会导致字段跳回其初始位置。 但为什么？</p>
<h3 id="动画-vs-真实内容">动画 vs 真实内容</h3>
<p>当你为<strong>Text Field</strong>设置动画时，你实际上并没有看到<strong>Text Field</strong>本身是动画的; 相反，你会看到它的缓存版本，称为<strong>presentation layer</strong>（显示层）。动画完成后原始图层再次到原本位置，则从屏幕上移除<strong>presentation layer</strong>。
首先，请记住在<code>viewWillAppear(_:)</code>中将<strong>Text Field</strong>设置在屏幕外：</p>
<p><img alt="image-20181125145909389" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxkbgcncy0j30ea03874p.jpg"></p>
<p>动画开始时，<strong>Text Field</strong>暂时隐藏，预渲染的动画对象将替代它：</p>
<p><img alt="image-20181125145923978" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxkbgli16zj30do03f0t5.jpg"></p>
<p>现在无法点击动画对象，输入任何文本或使用任何其他特定文本字段功能，因为它不是真正的文本字段，只是可见的“幻像”。
动画一旦完成，它就会从屏幕上消失，原始<strong>Text Field</strong>将被取消隐藏。但它此时的位置还在屏幕左侧！</p>
<p><img alt="image-20181125150009137" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxkbhdich6j30dh03saah.jpg"></p>
<p>要解决这个难题，您需要使用另一个<code>CABasicAnimation</code>属性：<code>isRemovedOnCompletion</code>。</p>
<p>将<code>fillMode</code>设置为<code>kCAFillModeBoth</code>可让动画在完成后保留在屏幕上，并在动画开始之前显示动画的第一帧。要完成效果，您需要相应地设置<code>removedOnCompletion</code>，两者的组合将使动画在屏幕上可见。
在设置<code>fillMode</code>之后，将以下行添加到<code>viewWillAppear()</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyRight.isRemovedOnCompletion = <span style="color:#007020;font-weight:bold">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>isRemovedOnCompletion</code>默认为<code>true</code>，因此动画一完成就会消失。将其设置为<code>false</code>并将其与正确的<code>fillMode</code>组合可将动画保留在屏幕上 。</p>
<p>现在运行项目，应该能看到所有元素都按预期保留在屏幕上。</p>
<h4 id="更新图层模型">更新图层模型</h4>
<p>从屏幕上删除图层动画后，图层将回退到其当前位置和其他属性值。 这意味着您通常需要更新图层的属性以反映动画的最终值。</p>
<p>虽然前面已经说明过把<code>isRemovedOnCompletion</code>设置成<code>false</code>是如何工作的，但尽可能避免使用它。 在屏幕上保留动画会影响性能，因此需要自动删除它们并更新原始图层的位置。</p>
<p>需要把原始图层设置到屏幕中间，在<code>viewWillAppear</code>中天假：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>username.layer.position.x = view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>password.layer.position.x = view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当然此时要注意把之前注释掉的<code>flyRight.fromValue = -view.bounds.size.width/2</code>，去掉注释，也要把调试动画时的代码去掉。</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h3 id="使用图层动画实现的淡入">使用图层动画实现☁️的淡入</h3>
<p>删除<code>viewWillAppear()</code>中把四个☁️透明度设为0.0的代码，和<code>viewDidAppear()</code>的☁️的视图动画。</p>
<p>然后在<code>viewDidAppear()</code>加入：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-12-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">cloudFade</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;alpha&#34;</span>)
</span></span><span style="display:flex;"><span>cloudFade.duration = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>cloudFade.fromValue = <span style="color:#40a070">0.0</span>
</span></span><span style="display:flex;"><span>cloudFade.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>cloudFade.fillMode = kCAFillModeBackwards
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cloudFade.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>cloud1.layer.add(cloudFade, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cloudFade.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.7</span>
</span></span><span style="display:flex;"><span>cloud2.layer.add(cloudFade, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cloudFade.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.9</span>
</span></span><span style="display:flex;"><span>cloud3.layer.add(cloudFade, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cloudFade.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">1.1</span>
</span></span><span style="display:flex;"><span>cloud4.layer.add(cloudFade, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="登录按钮背景颜色变化的动画">登录按钮背景颜色变化的动画</h3>
<p>把原登录按钮背景颜色变化的动画修改成图层动画。</p>
<p>删除<code>logIn()</code>中的：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.loginButton.backgroundColor = UIColor(red: <span style="color:#40a070">0.85</span>, green: <span style="color:#40a070">0.83</span>, blue: <span style="color:#40a070">0.45</span>, alpha: <span style="color:#40a070">1.0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除<code>resetForm()</code>中的：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-14-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.loginButton.backgroundColor = UIColor(red: <span style="color:#40a070">0.63</span>, green: <span style="color:#40a070">0.84</span>, blue: <span style="color:#40a070">0.35</span>, alpha: <span style="color:#40a070">1.0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<strong>ViewController.swift</strong>文件中创建一个全局的背景颜色变化动画函数：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-15-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">tintBackgroundColor</span>(layer: CALayer, toColor: UIColor) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tint</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;backgroundColor&#34;</span>)
</span></span><span style="display:flex;"><span>    tint.fromValue = layer.backgroundColor
</span></span><span style="display:flex;"><span>    tint.toValue = toColor.cgColor
</span></span><span style="display:flex;"><span>    tint.duration = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>    layer.add(tint, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    layer.backgroundColor = toColor.cgColor
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>logIn()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-16-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tintColor</span> = UIColor(red: <span style="color:#40a070">0.85</span>, green: <span style="color:#40a070">0.83</span>, blue: <span style="color:#40a070">0.45</span>, alpha: <span style="color:#40a070">1.0</span>)
</span></span><span style="display:flex;"><span>tintBackgroundColor(layer: loginButton.layer, toColor: tintColor)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>resetForm()</code>中登录按钮动画方法的<code>completion</code>闭包中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-17-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>completion: { <span style="color:#007020;font-weight:bold">_</span> <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>     <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tintColor</span> = UIColor(red: <span style="color:#40a070">0.63</span>, green: <span style="color:#40a070">0.84</span>, blue: <span style="color:#40a070">0.35</span>, alpha: <span style="color:#40a070">1.0</span>)
</span></span><span style="display:flex;"><span>     tintBackgroundColor(layer: <span style="color:#007020;font-weight:bold">self</span>.loginButton.layer, toColor: tintColor)
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="登录按钮的圆角动画">登录按钮的圆角动画</h3>
<p>在<strong>ViewController.swift</strong>文件中创建一个全局的圆角变化动画函数：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-18-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">roundCorners</span>(layer: CALayer, toRadius: CGFloat) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">round</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;cornerRadius&#34;</span>)
</span></span><span style="display:flex;"><span>    round.fromValue = layer.cornerRadius
</span></span><span style="display:flex;"><span>    round.toValue = toRadius
</span></span><span style="display:flex;"><span>    round.duration = <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>    layer.add(round, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    layer.cornerRadius = toRadius
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>logIn()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-19-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>roundCorners(layer: loginButton.layer, toRadius: <span style="color:#40a070">25.0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>resetForm()</code>中登录按钮动画方法的<code>completion</code>闭包中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-20-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>roundCorners(layer: <span style="color:#007020;font-weight:bold">self</span>.loginButton.layer, toRadius: <span style="color:#40a070">10.0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>两种状态的变化：</p>
<p><img alt="image-20181125155719946" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxkd4voqrwj30pu05mmxk.jpg"></p>
<p>两个动画函数<code>tintBackgroundColor</code>和<code>roundCorners</code>最后都需要把动画最变化最终值赋值给动画的属性，这对应于前面的 [动画 vs 真实内容](#动画 vs 真实内容) 章节</p>
<p>本章节的最终效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxze3jk58xg308k0fq16j.gif"></p>
<h2 id="9-动画的keys和代理">9-动画的Keys和代理</h2>
<p>关于视图动画和相应的闭包语法的一个棘手问题是，一旦您创建并运行视图动画，您就无法暂停，停止或以任何方式访问它。</p>
<p>但是，使用核心动画，您可以轻松检查在图层上运行的动画，并在需要时停止它们。 此外，您甚至可以在动画上设置委托对象并对动画事件做出反应。</p>
<blockquote>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a>使用上一章完成的项目</p>
</blockquote>
<h3 id="动画代理介绍">动画代理介绍</h3>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx4io22vm1j30de06qjre.jpg"></p>
<p><code>CAAnimationDelegate</code>的两个代理方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-21-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animationDidStart</span>(<span style="color:#007020;font-weight:bold">_</span> anim: CAAnimation)
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animationDidStop</span>(<span style="color:#007020;font-weight:bold">_</span> anim: CAAnimation, finished flag: <span style="color:#007020">Bool</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>做个小测试，在<code>flyRight</code>初始化时，添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-22-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyRight.delegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对<code>ViewController</code>添加扩展，并实现一个代理方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-23-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">extension</span> <span style="color:#0e84b5;font-weight:bold">ViewController</span>: CAAnimationDelegate {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animationDidStop</span>(<span style="color:#007020;font-weight:bold">_</span> anim: CAAnimation, finished flag: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>        print(anim.description, <span style="color:#4070a0">&#34;动画完成&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，打印结果：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-24-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>&lt;CABasicAnimation: <span style="color:#40a070">0x6000032376e0</span>&gt; <span style="">动画完成</span>
</span></span><span style="display:flex;"><span>&lt;CABasicAnimation: <span style="color:#40a070">0x600003237460</span>&gt; <span style="">动画完成</span>
</span></span><span style="display:flex;"><span>&lt;CABasicAnimation: <span style="color:#40a070">0x600003237480</span>&gt; <span style="">动画完成</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>会发现<code>animationDidStop(_:finished:)</code>方法被调用三次，并且每次调用的动画都不同，这因为当每一次调用<code>layer.add(_:forKey:)</code>把动画添加给图层时，都会拷贝一份，这在前面的图层动画基础知识中说明过。</p>
<h3 id="kvo">KVO</h3>
<p><code>CAAnimation</code>类及其子类是用Objective-C编写的，并且符合键值编码(KVO)，这意味着您可以将它们视为字典，并在运行时向它们添加新属性。(关于KVO，可查看我的小结文章 <a href="http://andyron.com/2018/ios-oc-kvc-begin">OC中的键/值编码(KVC)</a>)</p>
<p>使用此机制为<code>flyRight</code>动画指定名称，以便之后可以从其他活动动画中识别它。</p>
<p>在<code>viewWillAppear()</code>中的<code>flyRight.delegate = self</code>后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-25-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyRight.setValue(<span style="color:#4070a0">&#34;form&#34;</span>, forKey: <span style="color:#4070a0">&#34;name&#34;</span>)
</span></span><span style="display:flex;"><span>flyRight.setValue(heading.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的代码中，在<code>flyRight</code>动画上创建键为<code>&quot;name&quot;</code>，值为<code>&quot;form&quot;</code>的键值对，可以从委托回调方法调用识别；</p>
<p>也创建了一个键为<code>&quot;layer&quot;</code>，值为<code>heading.layer</code>的键值对，以方便之后引用动画所属的图层。</p>
<p>同样的可以添加(之前已经说过每次动画都会拷贝一份，所以不会覆盖)：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-26-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyRight.setValue(username.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flyRight.setValue(password.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在代理回调方法中验证上面的代码，上面的移动动画结束后再添加一个简单的脉动动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-27-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animationDidStop</span>(<span style="color:#007020;font-weight:bold">_</span> anim: CAAnimation, finished flag: <span style="color:#007020">Bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#60a0b0;font-style:italic">// print(anim.description, &#34;动画完成&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">guard</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">name</span> = anim.value(forKey: <span style="color:#4070a0">&#34;name&#34;</span>) <span style="color:#007020;font-weight:bold">as</span>? <span style="color:#007020">String</span> <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> name == <span style="color:#4070a0">&#34;form&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#60a0b0;font-style:italic">// `value(forKey:)`的结果总是`Any`，因此需要转换为所需类型</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">layer</span> = anim.value(forKey: <span style="color:#4070a0">&#34;layer&#34;</span>) <span style="color:#007020;font-weight:bold">as</span>? CALayer
</span></span><span style="display:flex;"><span>        anim.setValue(<span style="color:#007020;font-weight:bold">nil</span>, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#60a0b0;font-style:italic">// 简单的脉动动画</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">pulse</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.scale&#34;</span>)
</span></span><span style="display:flex;"><span>        pulse.fromValue = <span style="color:#40a070">1.25</span>
</span></span><span style="display:flex;"><span>        pulse.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>        pulse.duration = <span style="color:#40a070">0.25</span>
</span></span><span style="display:flex;"><span>        layer?.add(pulse, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意: <code>layer?.add()</code>意味着如果动画中没有存储图层，则会跳过<code>add(_:forKey:)</code>的调用。 这是Swift中的<a href="https://docs.swift.org/swift-book/LanguageGuide/OptionalChaining.html"><strong>可选链式调用</strong></a>，可参考<a href="http://andyron.com/2017/swift-17-optional-chaining.html">以撸代码的形式学习Swift-17：可选链式调用(Optional Chaining)</a></p>
</blockquote>
<p>移动动画结束后有一个简单变大的脉动动画效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx4zbw6nt9g308q060q4l.gif"></p>
<h3 id="动画keys">动画Keys</h3>
<p><code>add(_:forKey:)</code>中的参数<code>forKey</code>(注意不要和<code>setValue(_:forKey:)</code>中的<code>forKey</code>混淆)，之前一直没使用。</p>
<p>在这部分中，将创建另一个图层动画，学习如何一次运行多个动画，并了解如何使用动画Keys控制正在运行的动画。</p>
<p>添加一个新标签，新标签将从右到左缓慢动画，用来提示用户输入。 一旦用户开始输入他们的用户名或密码（<strong>Text Field</strong>获得焦点），该标签将停止移动并直接跳到其最终位置（居中位置）。 一旦用户知道该怎么做就没有必要继续动画。</p>
<p>在<code>ViewController</code>中添加属性 <code>let info = UILabel()</code>，并在<code>viewDidLoad()</code>中配置：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-28-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>info.frame = CGRect(x: <span style="color:#40a070">0.0</span>, y: loginButton.center.y <span style="color:#666">+</span> <span style="color:#40a070">60.0</span>,  width: view.frame.size.width, height: <span style="color:#40a070">30</span>)
</span></span><span style="display:flex;"><span>info.backgroundColor = UIColor.clear
</span></span><span style="display:flex;"><span>info.font = UIFont(name: <span style="color:#4070a0">&#34;HelveticaNeue&#34;</span>, size: <span style="color:#40a070">12.0</span>)
</span></span><span style="display:flex;"><span>info.textAlignment = .center
</span></span><span style="display:flex;"><span>info.textColor = UIColor.white
</span></span><span style="display:flex;"><span>info.text = <span style="color:#4070a0">&#34;Tap on a field and enter username and password&#34;</span>
</span></span><span style="display:flex;"><span>view.insertSubview(info, belowSubview: loginButton)
</span></span></code></pre></td></tr></table>
</div>
</div><p>为<code>info</code>添加两个动画:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-29-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 提示信息Label的两个动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flyLeft</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.x&#34;</span>)
</span></span><span style="display:flex;"><span>flyLeft.fromValue = info.layer.position.x <span style="color:#666">+</span> view.frame.size.width
</span></span><span style="display:flex;"><span>flyLeft.toValue = info.layer.position.x
</span></span><span style="display:flex;"><span>flyLeft.duration = <span style="color:#40a070">5.0</span>
</span></span><span style="display:flex;"><span>info.layer.add(flyLeft, forKey: <span style="color:#4070a0">&#34;infoappear&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">fadeLabelIn</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;opacity&#34;</span>)
</span></span><span style="display:flex;"><span>fadeLabelIn.fromValue = <span style="color:#40a070">0.2</span>
</span></span><span style="display:flex;"><span>fadeLabelIn.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>fadeLabelIn.duration = <span style="color:#40a070">4.5</span>
</span></span><span style="display:flex;"><span>info.layer.add(fadeLabelIn, forKey: <span style="color:#4070a0">&#34;fadein&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>flyLeft</code>是从左到右移动的动画，<code>fadeLabelIn</code>是透明度渐渐变大的动画。</p>
<p>此时的动画效果如下：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx524dojubg308q0600vk.gif"></p>
<p>为<strong>Text Field</strong>添加代理。通过扩展，让<code>ViewController</code>遵循<code>UITextFieldDelegate</code>协议：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-30-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">extension</span> <span style="color:#0e84b5;font-weight:bold">ViewController</span>: UITextFieldDelegate {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">textFieldDidBeginEditing</span>(<span style="color:#007020;font-weight:bold">_</span> textField: UITextField) {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">guard</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">runningAnimations</span> = info.layer.animationKeys() <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        print(runningAnimations)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>viewDidAppear()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-31-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-31-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>username.delegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span><span style="display:flex;"><span>password.delegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此时运行，<code>info</code>动画还在进行时点击文本框，会打印动画key值：</p>
<pre tabindex="0"><code>[&#34;infoappear&#34;, &#34;fadein&#34;]
</code></pre><p>在 <code>textFieldDidBeginEditing(:)</code>里添加:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-33-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>info.layer.removeAnimation(forKey: <span style="color:#4070a0">&#34;infoappear&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>点击文本框后，删除从左向右移动的动画，<code>info</code>立即到达终点，也就是屏幕中央：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxkpgdflv2g308q07t0vk.gif"></p>
<p>当然也可以通过<code>removeAllAnimations()</code>方法删除<code>layer</code>上的所有动画。</p>
<blockquote>
<p>**注意：**动画进行完了，会默认被从<code>layer</code>上删除，也就是<code>animationKeys()</code>方法将获得不到动画keys了。</p>
</blockquote>
<h3 id="修改的动画">修改☁️的动画</h3>
<p>通过本章所学的动画代理和动画KVO修改☁️的动画</p>
<p>先在<code>ViewController</code>中添加动画方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-34-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">/// 云的图层动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animateCloud</span>(layer: CALayer) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">cloudSpeed</span> = <span style="color:#40a070">60.0</span> <span style="color:#666">/</span> <span style="color:#007020">Double</span>(view.layer.frame.size.width)
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">duration</span>: TimeInterval = <span style="color:#007020">Double</span>(view.layer.frame.size.width <span style="color:#666">-</span> layer.frame.origin.x) <span style="color:#666">*</span> cloudSpeed
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">cloudMove</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.x&#34;</span>)
</span></span><span style="display:flex;"><span>    cloudMove.duration = duration
</span></span><span style="display:flex;"><span>    cloudMove.toValue = <span style="color:#007020;font-weight:bold">self</span>.view.bounds.width <span style="color:#666">+</span> layer.bounds.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>    cloudMove.delegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span><span style="display:flex;"><span>    cloudMove.setValue(<span style="color:#4070a0">&#34;cloud&#34;</span>, forKey: <span style="color:#4070a0">&#34;name&#34;</span>)
</span></span><span style="display:flex;"><span>    cloudMove.setValue(layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>    layer.add(cloudMove, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>把<code>viewDidAppear()</code>中的四个<code>animateCloud</code>方法调用替代为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-35-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>animateCloud(layer: cloud1.layer)
</span></span><span style="display:flex;"><span>animateCloud(layer: cloud2.layer)
</span></span><span style="display:flex;"><span>animateCloud(layer: cloud3.layer)
</span></span><span style="display:flex;"><span>animateCloud(layer: cloud4.layer)
</span></span></code></pre></td></tr></table>
</div>
</div><p>让☁️不停的移动，在动画代理方法<code>animationDidStop</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-36-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span> name == <span style="color:#4070a0">&#34;cloud&#34;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">layer</span> = anim.value(forKey: <span style="color:#4070a0">&#34;layer&#34;</span>) <span style="color:#007020;font-weight:bold">as</span>? CALayer {
</span></span><span style="display:flex;"><span>        anim.setValue(<span style="color:#007020;font-weight:bold">nil</span>, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        layer.position.x = <span style="color:#666">-</span>layer.bounds.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>        delay(<span style="color:#40a070">0.5</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">self</span>.animateCloud(layer: layer)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>本章的效果：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxzelm0xktg308k0fq43t.gif"></p>
<h2 id="10-动画组和时间控制">10-动画组和时间控制</h2>
<p>在上一章中，学习了如何向单个图层添加多个独立动画。 但是，如果您希望您的动画同步工作并保持彼此一致，该怎么办？ 这就用到<strong>动画组(animation groups)</strong>。</p>
<p>本章介绍如何使用<code>CAAnimationGroup</code>对动画进行分组，可以向组中添加多个动画并同时调整持续时间，委托和<code>timingFunction</code>等属性。
对动画进行分组会产生简化的代码，并确保您的所有动画将作为一个实体单元同步。</p>
<blockquote>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a>使用上一章完成的项目</p>
</blockquote>
<h3 id="caanimationgroup">CAAnimationGroup</h3>
<p>删除<code>viewWillAppear()</code>中的:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-37-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>loginButton.center.y <span style="color:#666">+=</span> <span style="color:#40a070">30.0</span>
</span></span><span style="display:flex;"><span>loginButton.alpha = <span style="color:#40a070">0.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>删除<code>viewDidAppear()</code>中登录按钮的显示动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-38-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>UIView.animate(withDuration: <span style="color:#40a070">0.5</span>, delay: <span style="color:#40a070">0.5</span>, usingSpringWithDamping: <span style="color:#40a070">0.5</span>, initialSpringVelocity: <span style="color:#40a070">0.0</span>, options: [], animations: {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.loginButton.center.y <span style="color:#666">-=</span> <span style="color:#40a070">30.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.loginButton.alpha = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>}, completion: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>viewDidAppear()</code>中组动画添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-39-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">groupAnimation</span> = CAAnimationGroup()
</span></span><span style="display:flex;"><span>groupAnimation.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>groupAnimation.duration = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>groupAnimation.fillMode = kCAFillModeBackwards 
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>CAAnimationGroup</code>继承于<code>CAAnimation</code>，也有<code>beginTime</code>, <code>duration</code>, <code>fillMode</code>, <code>delegate</code>等属性。</p>
<p>继续三个动画，并把它们加入到上面的组动画中：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-40-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scaleDown</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.scale&#34;</span>)
</span></span><span style="display:flex;"><span>scaleDown.fromValue = <span style="color:#40a070">3.5</span>
</span></span><span style="display:flex;"><span>scaleDown.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">rotate</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.rotation&#34;</span>)
</span></span><span style="display:flex;"><span>rotate.fromValue = .pi <span style="color:#666">/</span> <span style="color:#40a070">4.0</span>
</span></span><span style="display:flex;"><span>rotate.toValue = <span style="color:#40a070">0.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">fade</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;opacity&#34;</span>)
</span></span><span style="display:flex;"><span>fade.fromValue = <span style="color:#40a070">0.0</span>
</span></span><span style="display:flex;"><span>fade.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>groupAnimation.animations = [scaleDown, rotate, fade]
</span></span><span style="display:flex;"><span>loginButton.layer.add(groupAnimation, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>登录按钮的效果为：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx5fkh3qgjg308q0bjjwx.gif"></p>
<h3 id="动画缓动">动画缓动</h3>
<p>图层动画中的动画缓动与<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#%E5%8A%A8%E7%94%BB%E7%BC%93%E5%8A%A8">1-视图动画入门</a>中介绍的视图动画的动画选项的，在概念上是相同的， 只是语法有所不同。</p>
<p>图层动画中的动画缓动通过类<code>CAMediaTimingFunction</code>来表示 。用法如下：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-41-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>groupAnimation.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseIn)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>name</code>参数有如下几种，和视图动画中的差不多：</p>
<p><code>kCAMediaTimingFunctionLinear</code>  速度不变化</p>
<p><code>kCAMediaTimingFunctionEaseIn</code>  开始时慢，结束时快</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy7n0pfn7cj30b104n74h.jpg"></p>
<p><code>kCAMediaTimingFunctionEaseOut</code>  开始时快，结束时慢</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7n0fb9hrj309004174h.jpg"></p>
<p><code>kCAMediaTimingFunctionEaseInEaseOut</code>  开始结束都慢，中间快</p>
<p><img alt="image-20181126112903447" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxlb038a98j30ba04n74l.jpg"></p>
<p>可以试一下不同的效果。</p>
<p>另外<code>CAMediaTimingFunction</code>有个初始化方法<code>init(controlPoints c1x: Float, _ c1y: Float, _ c2x: Float, _ c2y: Float)</code>，可以自定义缓动模式，具体可参考<a href="https://developer.apple.com/documentation/quartzcore/camediatimingfunction/1522235-init">官方文档</a></p>
<h3 id="更多动画时间控制的选项">更多动画时间控制的选项</h3>
<h4 id="重复动画">重复动画</h4>
<p><code>repeatCount</code> 可设置重复动画指定的次数。
为提示信息Label的动画添加重复次数，在<code>viewDidAppear()</code>中为<code>flyLeft</code>动画设置属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-42-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyLeft.repeatCount = <span style="color:#40a070">4</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>另外一个<code>repeatDuration</code>可用来设置总重复时间。</p>
<p>和视图动画一样，也要设置<code>autoreverses</code>，要不然不连贯：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-43-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyLeft.autoreverses = <span style="color:#007020;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在效果看着不错了，但是还有点问题，就是4次重复结束后，会直接跳到屏幕中心，如下（由于太长，gif已经省略了前几次滚动）：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxzo8m3ohig308j03raga.gif"></p>
<p>这也很好理解，最后一个循环以标签离开屏幕结束。解决办法就是半个动画周期：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-44-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyLeft.repeatCount = <span style="color:#40a070">2.5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="改变动画的速度">改变动画的速度</h4>
<p>可以通过设置速度属性来独立于持续时间来控制动画的速度。</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-45-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>flyLeft.speed = <span style="color:#40a070">2.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="把三个form的动画修改为动画组">把三个form的动画修改为动画组</h3>
<p>下面代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-46-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-20">20</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flyRight</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.x&#34;</span>)
</span></span><span style="display:flex;"><span>    flyRight.fromValue = <span style="color:#666">-</span>view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>    flyRight.toValue = view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>    flyRight.duration = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>    flyRight.fillMode = kCAFillModeBoth
</span></span><span style="display:flex;"><span>    flyRight.delegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span><span style="display:flex;"><span>    flyRight.setValue(<span style="color:#4070a0">&#34;form&#34;</span>, forKey: <span style="color:#4070a0">&#34;name&#34;</span>)
</span></span><span style="display:flex;"><span>    flyRight.setValue(heading.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    heading.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    flyRight.setValue(username.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    flyRight.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.3</span>
</span></span><span style="display:flex;"><span>    username.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    flyRight.setValue(password.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    flyRight.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.4</span>
</span></span><span style="display:flex;"><span>    password.layer.add(flyRight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-47-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-25">25</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">formGroup</span> = CAAnimationGroup()
</span></span><span style="display:flex;"><span>    formGroup.duration = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>    formGroup.fillMode = kCAFillModeBackwards
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flyRight</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.x&#34;</span>)
</span></span><span style="display:flex;"><span>    flyRight.fromValue = <span style="color:#666">-</span>view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>    flyRight.toValue = view.bounds.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">fadeFieldIn</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;opacity&#34;</span>)
</span></span><span style="display:flex;"><span>    fadeFieldIn.fromValue = <span style="color:#40a070">0.25</span>
</span></span><span style="display:flex;"><span>    fadeFieldIn.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    formGroup.animations = [flyRight, fadeFieldIn]
</span></span><span style="display:flex;"><span>    heading.layer.add(formGroup, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    formGroup.delegate = <span style="color:#007020;font-weight:bold">self</span>
</span></span><span style="display:flex;"><span>    formGroup.setValue(<span style="color:#4070a0">&#34;form&#34;</span>, forKey: <span style="color:#4070a0">&#34;name&#34;</span>)
</span></span><span style="display:flex;"><span>    formGroup.setValue(username.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    formGroup.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.3</span>
</span></span><span style="display:flex;"><span>    username.layer.add(formGroup, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    formGroup.setValue(password.layer, forKey: <span style="color:#4070a0">&#34;layer&#34;</span>)
</span></span><span style="display:flex;"><span>    formGroup.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.4</span>
</span></span><span style="display:flex;"><span>    password.layer.add(formGroup, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>本章节的最终效果：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxzn61qt1vg308k0fqdlz.gif"></p>
<h2 id="11-图层弹簧动画">11-图层弹簧动画</h2>
<p>前面视图动画中的<a href="http://andyron.com/2018/iOS-Animation-1-view-animation#2-%E5%BC%B9%E7%B0%A7%E5%8A%A8%E7%94%BB">2-弹簧动画</a>可以用于创建一些相对简单的弹簧式动画，而本章节学习的**图层弹簧动画(Layer Springs)**可以呈现一个看起来更自然的物理模拟。</p>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a>使用上一章完成的项目，添加一些新的图层弹簧动画，并说明两种弹簧动画之间的差异。</p>
<p>先说一些理论知识：</p>
<h3 id="阻尼谐振子">阻尼谐振子</h3>
<p><strong>阻尼谐振子</strong>，Damped harmonic oscillators（直译就是，逐渐衰弱的振荡器），可以理解为逐渐衰减的振动。</p>
<p>UIKit API简化了弹簧动画的制作，不需要了解它们的原理就可以很方便的使用。 但是，由于您现在是核心动画专家，因此您需要深入研究细节。</p>
<p><strong>钟摆</strong>，理想状况下钟摆是不停的摆动，像下面的一样：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx5ndd6e2wj308106kaa0.jpg"></p>
<p>对应的运动轨迹图就像：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx5ne165xmj30a5048wed.jpg"></p>
<p>但现实中由于能量的损耗，钟摆的摇摆的幅度会逐渐减小：</p>
<p><img alt="image-20181112222946546" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx5nf8yf71j30a206saap.jpg"></p>
<p>对应的运动轨迹：</p>
<p><img alt="image-20181112223028487" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx5nfxvbhij30c204kt8s.jpg"></p>
<p>这就是一个阻尼谐振子 。</p>
<p>钟摆停下来所需的时间长度，以及最终振荡器图形的方式取决于振荡系统的以下参数：</p>
<ul>
<li>
<p>阻尼(damping)：由于空气摩擦、机械摩擦和其他作用在系统上的外部减速力。</p>
</li>
<li>
<p>质量(mass)：摆锤越重，摆动的时间越长。</p>
</li>
<li>
<p>刚度(stiffness)：振荡器的“弹簧”越硬（钟摆的“弹簧”是指地球的引力），钟摆摆动越困难，系统停下来也越快。想象一下，如果在月球或木星上使用这个钟摆；在低重力和高重力情况下的运动将是完全不同的。</p>
</li>
<li>
<p>初始速度(initial velocity)：推一下钟摆。</p>
</li>
</ul>
<p><em>“这一切都非常有趣，但与弹簧动画有什么关系呢？”</em></p>
<p>阻尼谐振子系统是推动iOS中弹簧动画的动力。 下一节将更详细地讨论这个问题。</p>
<h3 id="视图弹簧动画-vs-图层弹簧动画">视图弹簧动画 vs 图层弹簧动画</h3>
<p>UIKit以动态方式调整所有其他变量，使系统在给定的持续时间内稳定下来。 这就是为什么UIKit弹簧动画有时有点<strong>被迫</strong> 停下来的感觉。 如果仔细观察会发现UIKit动画有点不太自然。</p>
<p>幸运的是，<strong>核心</strong>允许通过<code>CASpringAnimation</code>类为图层属性创建合适的弹簧动画。 <code>CASpringAnimation</code>在幕后为UIKit创建弹簧动画，但是当我们直接调用它时，可以设置系统的各种变量，让动画自己稳定下来。 这种方法的缺点是不能设置固定的持续时间（duration）；持续时间取决于提供的其它变量，然后系统计算所得。</p>
<p><code>CASpringAnimation</code>的一些属性（对应之前振荡系统的参数）：</p>
<p><code>damping</code>    阻尼系数，阻止弹簧伸缩的系数，阻尼系数越大，停止越快</p>
<p><code>mass</code>   质量，影响图层运动时的弹簧惯性，质量越大，弹簧拉伸和压缩的幅度越大</p>
<p><code>stiffness </code>    刚度系数(劲度系数/弹性系数)，刚度系数越大，形变产生的力就越大，运动越快</p>
<p><code>initialVelocity</code>   初始速率，动画视图的初始速度大小。速率为正数时，速度方向与运动方向一致，速率为负数时，速度方向与运动方向相反</p>
<h3 id="第一个图层弹簧动画">第一个图层弹簧动画</h3>
<p><strong>BahamaAirLoginScreen</strong>项目中两个文本框移动动画结束后有个脉动动画，让用户知道该字段处于活动状态并可以使用。 然而，动画结束时有些突然。 通过用<code>CASpringAnimation</code>来让脉动动画更加自然一点。</p>
<p>把<code>animationDidStop(_:finished:)</code>动画代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-48-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 简单的脉动动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">pulse</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.scale&#34;</span>)
</span></span><span style="display:flex;"><span>pulse.fromValue = <span style="color:#40a070">1.25</span>
</span></span><span style="display:flex;"><span>pulse.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>pulse.duration = <span style="color:#40a070">0.25</span>
</span></span><span style="display:flex;"><span>layer?.add(pulse, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>转变为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-49-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">pulse</span> = CASpringAnimation(keyPath: <span style="color:#4070a0">&#34;transform.scale&#34;</span>)
</span></span><span style="display:flex;"><span>pulse.damping = <span style="color:#40a070">2.0</span>
</span></span><span style="display:flex;"><span>pulse.fromValue = <span style="color:#40a070">1.25</span>
</span></span><span style="display:flex;"><span>pulse.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>pulse.duration = pulse.settlingDuration
</span></span><span style="display:flex;"><span>layer?.add(pulse, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果图前后对比：</p>
<p><img alt="CABasicAnimation" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx4zbw6nt9g308q060q4l.gif"></p>
<p><img alt="CASpringAnimation" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx647m132mg308o060464.gif"></p>
<p>这边要注意<code>duration</code>。要使用系统根据当前参数估算的弹簧动画从开始到结束的时间<code>pulse.settlingDuration</code>。</p>
<p>弹簧系统不能在0.25秒内稳定下来; 提供的变量意味着动画应该在它停止前再运行一段时间。
关于如何切断弹簧动画的视觉演示：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx64fgnaecj30bw03sq2u.jpg"></p>
<p>如果抖动时间太长，可以加大阻尼系数<code>damping</code>，比如：<code>pulse.damping = 7.5</code>。</p>
<h3 id="弹簧动画属性">弹簧动画属性</h3>
<p><code>CASpringAnimation</code>预定义的弹簧动画属性的默认值分别是：</p>
<pre tabindex="0"><code>damping: 10.0
mass: 1.0
stiffness: 100.0
initialVelocity: 0.0
</code></pre><p>实现文本框的一个代理方法：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-51-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-12">12</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">textFieldDidEndEditing</span>(<span style="color:#007020;font-weight:bold">_</span> textField: UITextField) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">guard</span> <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">text</span> = textField.text <span style="color:#007020;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">if</span> text.count <span style="color:#666">&lt;</span> <span style="color:#40a070">5</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">jump</span> = CASpringAnimation(keyPath: <span style="color:#4070a0">&#34;position.y&#34;</span>)
</span></span><span style="display:flex;"><span>        jump.fromValue = textField.layer.position.y <span style="color:#666">+</span> <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>        jump.toValue = textField.layer.position.y
</span></span><span style="display:flex;"><span>        jump.duration = jump.settlingDuration
</span></span><span style="display:flex;"><span>        textField.layer.add(jump, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码，表示当用户在文本中输入结束后，如果输入字符数小于5，出现一个小幅度的抖动动画，提醒用户太短了。</p>
<h4 id="initialvelocity"><code>initialVelocity</code></h4>
<p>起始速度，默认值0。</p>
<p>在设置持续时间前添加，也就是在<code>jump.duration = jump.settlingDuration</code>前添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-52-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>jump.initialVelocity = <span style="color:#40a070">100.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy59opvlxjg308e02rjrv.gif"></p>
<p>由于开始时的额外推动，文本框弹的更高了。</p>
<h4 id="mass"><code>mass</code></h4>
<p>增加初始速度会使动画持续时间更长，如果增加质量会怎么样？</p>
<p>在<code>jump.initialVelocity = 100.0</code>后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-53-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>jump.mass = <span style="color:#40a070">10.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy59uefd6bg308g02sgor.gif"></p>
<p>额外质量使文本框的跳跃的要高了，并且稳定下来的持续时间更久了。</p>
<h4 id="stiffness"><code>stiffness</code></h4>
<p>刚度，默认是100。越大弹簧更“硬”。</p>
<p>在<code>jump.mass = 10.0</code>后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-54-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>jump.stiffness = <span style="color:#40a070">1500.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果:</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy5a2hcl65g308902gn0k.gif"></p>
<p>现在跳跃的不是那么高了。</p>
<h4 id="damping"><code>damping</code></h4>
<p>动画看起来很棒，但似乎确实有点太长了。 增加系统阻尼以使动画更快地稳定下来。</p>
<p>在<code>jump.stiffness = 1500.0</code>后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-55-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>jump.damping = <span style="color:#40a070">50.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy5a998pblg308d02dwf8.gif"></p>
<h3 id="特殊图层属性">特殊图层属性</h3>
<p>在文本框抖动时，添加有颜色的边框。</p>
<p>在<code>textFieldDidEndEditing(_:)</code>中的<code>textField.layer.add(jump, forKey: nil)</code>后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-56-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>textField.layer.borderWidth = <span style="color:#40a070">3.0</span>
</span></span><span style="display:flex;"><span>textField.layer.borderColor = UIColor.clear.cgColor
</span></span></code></pre></td></tr></table>
</div>
</div><p>此代码给文本框周围添加了透明边框。
在上面代码后添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-57-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flash</span> = CASpringAnimation(keyPath: <span style="color:#4070a0">&#34;borderColor&#34;</span>)
</span></span><span style="display:flex;"><span>flash.damping = <span style="color:#40a070">7.0</span>
</span></span><span style="display:flex;"><span>flash.stiffness = <span style="color:#40a070">200.0</span>
</span></span><span style="display:flex;"><span>flash.fromValue = UIColor(red: <span style="color:#40a070">1.0</span>, green: <span style="color:#40a070">0.27</span>, blue: <span style="color:#40a070">0.0</span>, alpha: <span style="color:#40a070">1.0</span>).cgColor
</span></span><span style="display:flex;"><span>flash.toValue = UIColor.white.cgColor
</span></span><span style="display:flex;"><span>flash.duration = flash.settlingDuration
</span></span><span style="display:flex;"><span>textField.layer.add(flash, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，放慢效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy5auyp1iog308b029q5f.gif"></p>
<blockquote>
<p>注意：在某些iOS版本中，图层动画会删除文本字段的圆角。此情况可在最后一段代码之后添加此行：<code>textField.layer.cornerRadius = 5</code>.</p>
</blockquote>
<h3 id="把登录按钮的圆角和背景色变化动画转化为弹性动画">把登录按钮的圆角和背景色变化动画转化为弹性动画</h3>
<p>这个改变很方便，只要修改<code>ViewController.swift</code>中两个函数：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-17">17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-18">18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-19">19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-20">20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-21">21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-22">22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-23">23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-24">24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-25">25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-26">26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-27">27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-28">28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-29">29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-30">30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-31">31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-32">32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-33">33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-34">34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-35">35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-36">36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-58-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-37">37</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 背景颜色变化的图层动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">tintBackgroundColor</span>(layer: CALayer, toColor: UIColor) {
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    let tint = CABasicAnimation(keyPath: &#34;backgroundColor&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    tint.fromValue = layer.backgroundColor</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    tint.toValue = toColor.cgColor</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    tint.duration = 0.5</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    layer.add(tint, forKey: nil)</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    layer.backgroundColor = toColor.cgColor</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tint</span> = CASpringAnimation(keyPath: <span style="color:#4070a0">&#34;backgroundColor&#34;</span>)
</span></span><span style="display:flex;"><span>    tint.damping = <span style="color:#40a070">5.0</span>
</span></span><span style="display:flex;"><span>    tint.initialVelocity = <span style="color:#666">-</span><span style="color:#40a070">10.0</span>
</span></span><span style="display:flex;"><span>    tint.fromValue = layer.backgroundColor
</span></span><span style="display:flex;"><span>    tint.toValue = toColor.cgColor
</span></span><span style="display:flex;"><span>    tint.duration = tint.settlingDuration
</span></span><span style="display:flex;"><span>    layer.add(tint, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    layer.backgroundColor = toColor.cgColor
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 圆角动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">roundCorners</span>(layer: CALayer, toRadius: CGFloat) {
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    let round = CABasicAnimation(keyPath: &#34;cornerRadius&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    round.fromValue = layer.cornerRadius</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    round.toValue = toRadius</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    round.duration = 0.33</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    layer.add(round, forKey: nil)</span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">//    layer.cornerRadius = toRadius</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">round</span> = CASpringAnimation(keyPath: <span style="color:#4070a0">&#34;cornerRadius&#34;</span>)
</span></span><span style="display:flex;"><span>    round.damping = <span style="color:#40a070">5.0</span>
</span></span><span style="display:flex;"><span>    round.fromValue = layer.cornerRadius
</span></span><span style="display:flex;"><span>    round.toValue = toRadius
</span></span><span style="display:flex;"><span>    round.duration = round.settlingDuration
</span></span><span style="display:flex;"><span>    layer.add(round, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    layer.cornerRadius = toRadius
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-图层关键帧动画和结构属性">12-图层关键帧动画和结构属性</h2>
<p>图层上的关键帧动画(Layer Keyframe Animations，<code>CAKeyframeAnimation</code>)与<code>UIView</code>上的关键帧动画略有不同。 <a href="http://andyron.com/2018/iOS-Animation-1-view-animation#5-%E5%85%B3%E9%94%AE%E5%B8%A7%E5%8A%A8%E7%94%BB">视图关键帧动画</a>是将独立简单动画组合在一起,可以为不同的视图和属性设置动画，动画两者之间可以重叠或存在间隙。</p>
<p>相比之下，<code>CAKeyframeAnimation</code>允许我们为给定图层上的单个属性设置动画。可以定义动画的不同关键点，但动画中不能有任何间隙或重叠。 尽管听起来有些限制，但可以使用<code>CAKeyframeAnimation</code>创建一些非常引人注目的效果。</p>
<p>在本章中，将创建许多图层关键帧动画，从非常基本模拟真实世界碰撞到更高级的动画。 在<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#15-Stroke和路径动画">15-Stroke和路径动画</a>中，您将学习如何进一步获取图层动画，并沿给定路径为图层设置动画。</p>
<p>现在，您将在跑步之前走路，并为您的第一层关键帧动画创建一个时髦的摇摆效果。</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx690o3li9g308m060dho.gif"></p>
<h3 id="介绍图层关键帧动画">介绍图层关键帧动画</h3>
<p>想一想基本动画是如何运作的？ 使用<code>fromValue</code>和<code>toValue</code>，核心动画会在指定的持续时间内逐步修改这些值之间的特定图层属性。
例如，当在45°和-45°（或π/ 4和-π/ 4）之间旋转图层时，只需要指定这两个值，然后图层渲染所有中间值以完成动画：</p>
<p><img alt="image-20181127104828153" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxmfg5sraej30ds0703zm.jpg"></p>
<p><code>CAKeyframeAnimation</code>使用一组值来完成动画，而不是<code>fromValue</code>和<code>toValue</code>。 另外，还需要提供动画应达到每个值的关键点的时间。</p>
<p>在上面的动画中，图层从45°旋转到-45°，但这次它有两个独立的阶段：</p>
<p><img alt="image-20181127104845088" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxmfgenky3j30dp05ldgk.jpg"></p>
<p>首先，它在动画持续时间的前三分之二内从45°旋转到22°，然后它在剩余的时间内一直旋转到-45°。
实质上，使用关键帧设置动画，要求我们为设置动画的属性提供关键值，以及在0.0和1.0之间进行相应数量的相对关键时间。</p>
<blockquote>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a>使用上一章完成的项目</p>
</blockquote>
<h3 id="创建图层关键帧动画">创建图层关键帧动画</h3>
<p>在<code>resetForm()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-59-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">wobble</span> = CAKeyframeAnimation(keyPath: <span style="color:#4070a0">&#34;transform.rotation&#34;</span>)
</span></span><span style="display:flex;"><span>wobble.duration = <span style="color:#40a070">0.25</span>
</span></span><span style="display:flex;"><span>wobble.repeatCount = <span style="color:#40a070">4</span>
</span></span><span style="display:flex;"><span>wobble.values = [<span style="color:#40a070">0.0</span>, <span style="color:#666">-</span>.pi<span style="color:#666">/</span><span style="color:#40a070">4.0</span>, <span style="color:#40a070">0.0</span>, .pi<span style="color:#666">/</span><span style="color:#40a070">4.0</span>, <span style="color:#40a070">0.0</span>]
</span></span><span style="display:flex;"><span>wobble.keyTimes = [<span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.25</span>, <span style="color:#40a070">0.5</span>, <span style="color:#40a070">0.75</span>, <span style="color:#40a070">1.0</span>]
</span></span><span style="display:flex;"><span>heading.layer.add(wobble, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>keyTimes</code>是从<code>0.0</code>到<code>1.0</code>的一系列值，并且与<code>values</code>一一对应。在登录按钮恢复原状后，heading有一个摇摆的效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx690o3li9g308m060dho.gif"></p>
<p>眼睛敏锐的读者可能已经注意到我还没有介绍过结构属性的动画。 大多数情况下，你可以放弃动画结构的单个组件，例如CGPoint的x组件，或CATransformation3D的旋转组件，但是接下来你会发现动态结构值的动画比 你可能会先考虑一下。</p>
<h3 id="animating-struct-values">Animating struct values</h3>
<p>结构体是Swift中的一等公民。 实际上，在使用类和结构之间语法上几乎没有区别。（关于类和结构体可查<a href="http://andyron.com/2017/swift-9-structures-classes.html">以撸代码的形式学习Swift-9：类和结构体(Classes and Structures)</a>）
但是，<strong>核心动画</strong>是一个基于C构建的Objective-C框架，这意味着结构体的处理方式与Swift的结构体截然不同。 Objective-C API喜欢处理对象，因此结构体需要一些特殊的处理。
这就是为什么对图层属性（如颜色或数字）进行动画制作相对容易的原因，但是为<code>CGPoint</code>等结构体属性设置动画并不容易。
<code>CALayer</code>有许多可动画属性，它们包含struct值，包括<code>CGPoint</code>类型的位置，<code>CATransform3D</code>类型的转换和<code>CGRect</code>类型的边界。</p>
<p>为了解决这个问题，<strong>Cocoa</strong>使用<code>NSValue</code>类，它可将一个<code>struct</code>值“包装”为一个核心动画好处理的对象。</p>
<p><code>NSValue</code>附带了许多便利初始化程序：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-60-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">init</span>(cgPoint: CGPoint)
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">init</span>(cgSize: CGSize)
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">init</span>(cgRect rect: CGRect)
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">init</span>(caTransform3D: CATransform3D)
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用例子， 以下是使用CGPoint的示例位置动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-61-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">move</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position&#34;</span>)
</span></span><span style="display:flex;"><span>move.duration = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>move.fromValue = NSValue(cgPoint: CGPoint(x: <span style="color:#40a070">100.0</span>, y: <span style="color:#40a070">100.0</span>))
</span></span><span style="display:flex;"><span>move.toValue = NSValue(cgPoint: CGPoint(x: <span style="color:#40a070">200.0</span>, y: <span style="color:#40a070">200.0</span>))
</span></span></code></pre></td></tr></table>
</div>
</div><p>在把<code>CGPoint</code>赋值给<code>fromValue</code>或<code>toValue</code>之前，需要把<code>CGPoint</code>转化为<code>NSValue</code>，否则动画无法工作。关键帧动画同样如此。</p>
<h3 id="热气球的关键帧动画">热气球的关键帧动画</h3>
<p>在<code>logIn()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-62-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">balloon</span> = CALayer()
</span></span><span style="display:flex;"><span>balloon.contents = UIImage(named: <span style="color:#4070a0">&#34;balloon&#34;</span>)<span style="color:#666">!</span>.cgImage
</span></span><span style="display:flex;"><span>balloon.frame = CGRect(x: <span style="color:#666">-</span><span style="color:#40a070">50.0</span>, y: <span style="color:#40a070">0.0</span>, width: <span style="color:#40a070">50.0</span>, height: <span style="color:#40a070">65.0</span>)
</span></span><span style="display:flex;"><span>view.layer.insertSublayer(balloon, below: username.layer)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>insertSublayer(_:below)</code>方法创建了一个图片图层作为<code>view.layer</code>的子图层。</p>
<p>如果需要在屏幕上显示图像但不需要使用<code>UIView</code>的所有好处（例如自动布局约束，附加手势识别器等），可以简单地使用上面的代码示例中的<code>CALayer</code>。</p>
<p>在上面的代码后添加动画代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-63-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flight</span> = CAKeyframeAnimation(keyPath: <span style="color:#4070a0">&#34;position&#34;</span>)
</span></span><span style="display:flex;"><span>flight.duration = <span style="color:#40a070">12.0</span>
</span></span><span style="display:flex;"><span>flight.values = [
</span></span><span style="display:flex;"><span>  CGPoint(x: <span style="color:#666">-</span><span style="color:#40a070">50.0</span>, y: <span style="color:#40a070">0.0</span>),
</span></span><span style="display:flex;"><span>  CGPoint(x: view.frame.width <span style="color:#666">+</span> <span style="color:#40a070">50.0</span>, y: <span style="color:#40a070">160.0</span>),
</span></span><span style="display:flex;"><span>  CGPoint(x: <span style="color:#666">-</span><span style="color:#40a070">50.0</span>, y: loginButton.center.y)
</span></span><span style="display:flex;"><span>].map { NSValue(cgPoint: <span style="color:#bb60d5">$0</span>) }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flight.keyTimes = [<span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.5</span>, <span style="color:#40a070">1.0</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>values</code>的三个对应点如下：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx69jdo8zrj30d606zglk.jpg"></p>
<p>最后把动画添加到气球图层上，并且设置气球图层最终位置：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-64-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>balloon.add(flight, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>balloon.position = CGPoint(x: <span style="color:#666">-</span><span style="color:#40a070">50.0</span>, y: loginButton.center.y)
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行，效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx69ltw09dg308s0avwtn.gif"></p>
<h2 id="13-形状和蒙版">13-形状和蒙版</h2>
<p>本章学习<code>CALayer</code>的一个子类<code>CAShapeLayer</code>，它可以在屏幕上绘制各种形状，从非常简单到非常复杂都可以。</p>
<p>本章的<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> <strong>MultiplayerSearch</strong> 模拟了正在搜索在线对手的战斗游戏的起始屏幕。其中一个视图控制器显示一个漂亮的背景图像，一些标签，一个”Search Again“按钮(默认是透明的)，和两个头像图像，其中一个将是空的，直到应用程序”找到“一个对手。</p>
<p><img alt="image-20181214163442348" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy6czphh8ij30a608ngmp.jpg"></p>
<h3 id="头像视图">头像视图</h3>
<p>两个头像都是<code>AvatarView</code>类的一个实例。 下面开始完成一些头像视图的效果。
打开<code>AvatarView.swift</code>，会发现有几个已定义的属性，它们分别表示：</p>
<p><code>photoLayer</code>：头像的图片图层。
<code>circleLayer</code>：用于绘制圆的形状图层。
<code>maskLayer</code>：另一个用于绘制蒙版的形状图层。
<code>label</code>：显示玩家姓名的标签。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx6ami0kayj30e405r74e.jpg"></p>
<p>上面的组件已经存在于项目中，但尚未添加到视图中，第一个任务就是把它们添加动视图中。 将以下代码添加到<code>didMoveToWindow()</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-65-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>photoLayer.mask = maskLayer
</span></span></code></pre></td></tr></table>
</div>
</div><p>这简单地用<code>maskLayer</code>中的圆形掩盖方形图像。</p>
<p>还可以通过<code>@IBDesignable</code>(关于<code>@IBDesignable</code>，可查看<a href="http://andyron.com/2017/ios-tutorial-8-ibinspectable-ibdesignable.html">iOS tutorial 8：使用IBInspectable 和 IBDesignable定制UI</a>)在storyboard中看到设置属性。</p>
<p>运行效果：</p>
<p><img alt="image-20181214164234894" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy6d7t4ey3j309y03qaah.jpg"></p>
<p>现在将圆形边框图层添加到头像视图图层，在<code>didMoveToWindow()</code>中添加代码：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-66-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>layer.addSublayer(circleLayer)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这时的效果为：</p>
<p><img alt="image-20181214164408801" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy6d9gpkmdj309102y0t4.jpg"></p>
<p>添加名字标签：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-67-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>addSubview(label)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="反弹动画">反弹动画</h3>
<p>下面创建类似两个物体相撞，然后弹开的反弹(bounce-off)动画。</p>
<p>在<code>ViewController</code>中创建<code>searchForOpponent()</code>函数，并在<code>viewDidAppear</code>中调用：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-68-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">searchForOpponent</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">avatarSize</span> = myAvatar.frame.size
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">bounceXOffset</span>: CGFloat = avatarSize.width<span style="color:#666">/</span><span style="color:#40a070">1.9</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">morphSize</span> = CGSize(width: avatarSize.width <span style="color:#666">*</span> <span style="color:#40a070">0.85</span>, height: avatarSize.height <span style="color:#666">*</span> <span style="color:#40a070">1.1</span>) 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>bounceXOffset</code>是相互反弹时应移动的水平距离。</p>
<p><code>morphSize</code>是头像碰撞后的形变大小（宽度变小，长度变大）。</p>
<p>在<code>searchForOpponent()</code>里继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-69-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">rightBouncePoint</span> = CGPoint(x: view.frame.size.width<span style="color:#666">/</span><span style="color:#40a070">2.0</span> <span style="color:#666">+</span> bounceXOffset, y: myAvatar.center.y)
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">leftBouncePoint</span> = CGPoint(x: view.frame.size.width<span style="color:#666">/</span><span style="color:#40a070">2.0</span> <span style="color:#666">-</span> bounceXOffset, y: myAvatar.center.y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>myAvatar.bounceOff(point: rightBouncePoint, morphSize: morphSize)
</span></span><span style="display:flex;"><span>opponentAvatar.bounceOff(point: leftBouncePoint, morphSize: morphSize)
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的<code>bounceOff(point:morphSize:)</code>方法，两个参数分别代表头像移动的位置和变形的大小。在<code>AvatarView</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-70-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">bounceOff</span>(point: CGPoint, morphSize: CGSize) {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">originalCenter</span> = center
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    UIView.animate(withDuration: animationDuration, delay: <span style="color:#40a070">0.0</span>, usingSpringWithDamping: <span style="color:#40a070">0.8</span>, initialSpringVelocity: <span style="color:#40a070">0.0</span>, animations: {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.center = point
</span></span><span style="display:flex;"><span>    }, completion: {<span style="color:#007020;font-weight:bold">_</span> <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                   })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    UIView.animate(withDuration: animationDuration, delay: animationDuration, usingSpringWithDamping: <span style="color:#40a070">0.7</span>, initialSpringVelocity: <span style="color:#40a070">1.0</span>, animations: {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.center = originalCenter
</span></span><span style="display:flex;"><span>    }) { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>        delay(seconds: <span style="color:#40a070">0.1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">self</span>.bounceOff(point: point, morphSize: morphSize)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>       }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的两个动画分别是，<strong>使用弹簧动画将头像移动到指定位置</strong> 和 <strong>使用弹簧动画将头像移动到原来位置</strong>。此时效果如下：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx6g7btqrug308s08u77g.gif"></p>
<h3 id="图像变形">图像变形</h3>
<p>实际生活中，两个物体相撞时，有一个短时间暂停，并且物体变形（”压扁“的效果）。下面就实现这种效果。</p>
<p>在<code>bounceOff(point:morphSize:)</code>添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-71-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">morphedFrame</span> = (originalCenter.x <span style="color:#666">&gt;</span> point.x) ?
</span></span><span style="display:flex;"><span>        CGRect(x: <span style="color:#40a070">0.0</span>, y: bounds.height <span style="color:#666">-</span> morphSize.height, width: morphSize.width, height: morphSize.height) :
</span></span><span style="display:flex;"><span>        CGRect(x: bounds.width <span style="color:#666">-</span> bounds.width, y: bounds.height <span style="color:#666">-</span> morphSize.height, width: morphSize.width, height: morphSize.height)
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>originalCenter.x &gt; point.x</code>来判断是左边头像还是右边头像。</p>
<p>在<code>bounceOff(point:morphSize:)</code>继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-72-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">morphAnimation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;path&#34;</span>)
</span></span><span style="display:flex;"><span>morphAnimation.duration = animationDuration
</span></span><span style="display:flex;"><span>morphAnimation.toValue = UIBezierPath(ovalIn: morphedFrame).cgPath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>morphAnimation.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseOut)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>circleLayer.add(morphAnimation, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>UIBezierPath</code>创建椭圆。</p>
<p>运行后，效果有点问题：</p>
<p><img alt="image-20181127144558179" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxmmb90qrcj309z0443z1.jpg"></p>
<p>只有边框图层发生了变形，图片图层没有变化。</p>
<p>把<code>morphAnimation</code>动画添加到蒙版图层：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-73-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-73-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>maskLayer.add(morphAnimation, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样的效果就好很多：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fxmmdra4j2g308m0760vk.gif"></p>
<h3 id="搜索对手">搜索对手</h3>
<p>在<code>searchForOppoent()</code>里最后添加<code>delay(seconds: 4.0, completion: foundOppoent)</code>，然后在<code>ViewController</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-74-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-74-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">foundOpponent</span>() {
</span></span><span style="display:flex;"><span>    status.text = <span style="color:#4070a0">&#34;Connecting...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    opponentAvatar.image = UIImage(named: <span style="color:#4070a0">&#34;avatar-2&#34;</span>)
</span></span><span style="display:flex;"><span>    opponentAvatar.name = <span style="color:#4070a0">&#34;Andy&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>利用延迟来模拟在寻找对手。</p>
<p>在<code>foundOpponent()</code>里添加<code>delay(seconds: 4.0, completion: connectedToOpponent)</code>，然后然后在<code>ViewController</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-75-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-75-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">connectedToOpponent</span>() {
</span></span><span style="display:flex;"><span>    myAvatar.shouldTransitionToFinishedState = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    opponentAvatar.shouldTransitionToFinishedState = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>shouldTransitionToFinishedState</code>是<code>AvatarView</code>中自定义的属性，用于判断连接是否完成，在下面使用。</p>
<p>在<code>connectedToOpponent()</code>里添加<code>delay(seconds: 1.0, completion: completed)</code>，然后然后在<code>ViewController</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-76-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-76-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">completed</span>() {
</span></span><span style="display:flex;"><span>    status.text = <span style="color:#4070a0">&#34;Ready to play&#34;</span>
</span></span><span style="display:flex;"><span>    UIView.animate(withDuration: <span style="color:#40a070">0.2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.vs.alpha = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.searchAgain.alpha = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对手找到后，修改状态语，并显示重新搜索按钮。</p>
<p>效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxmn6zintyg308m0fn1kx.gif"></p>
<h3 id="连接成功后头像变成正方形">连接成功后头像变成正方形</h3>
<p>在<code>AvatarView</code>中添加一个属性<code>var isSquare = false</code>，用于判断头像是否需要转换为正方形。</p>
<p>在<code>bounceOff(point:morphSize:)</code>的第一个动画（<em>头像移动到指定位置</em>）的 <code>completion</code>闭包中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-77-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-77-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span> <span style="color:#007020;font-weight:bold">self</span>.shouldTransitionToFinishedState {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.animateToSquare()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中<code>animateToSquare()</code>为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-78-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-78-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 变换为正方形动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">func</span> <span style="color:#06287e">animateToSquare</span>() {
</span></span><span style="display:flex;"><span>    isSquare = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">squarePath</span> = UIBezierPath(rect: bounds).cgPath
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">morph</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;path&#34;</span>)
</span></span><span style="display:flex;"><span>    morph.duration = <span style="color:#40a070">0.25</span>
</span></span><span style="display:flex;"><span>    morph.fromValue = circleLayer.path
</span></span><span style="display:flex;"><span>    morph.toValue = squarePath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    circleLayer.add(morph, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>    maskLayer.add(morph, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    circleLayer.path = squarePath
</span></span><span style="display:flex;"><span>    maskLayer.path = squarePath
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>bounceOff(point:morphSize:)</code>的第二个动画（<em>头像移动到原来位置</em>）的 <code>completion</code>闭包添加判断：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-79-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-79-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">if</span> <span style="color:#666">!</span><span style="color:#007020;font-weight:bold">self</span>.isSquare {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">self</span>.bounceOff(point: point, morphSize: morphSize)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样的最终效果就是：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxmnjaf154g308m0fn1gb.gif"></p>
<h2 id="14-渐变动画">14-渐变动画</h2>
<p>本章通过以前iOS的屏幕“滑动解锁”效果来学习<strong>渐变动画(Gradient Animations)</strong>。</p>
<p><img alt="image-20181214171411641" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy6e4pohpmj307m01vq2r.jpg"></p>
<p><a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a>  <strong>SlideToReveal</strong>是一个简单的单页面项目，只有一个显示时间的<code>UILabel</code>，和一个之后用于渐变动画的自定义<code>UIView</code>子类<code>AnimateMaskLabel</code>。</p>
<h3 id="第一个渐变图层">第一个渐变图层</h3>
<p><code>CAGradientLayer</code>是<code>CALayer</code>的另一个子类，专门用于渐变的图层。</p>
<p>配置<code>CAGradientLayer</code>，在属性<code>gradientLayer</code>定义的函数块中添加:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-80-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-80-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-80-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-80-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>gradientLayer.startPoint = CGPoint(x: <span style="color:#40a070">0.0</span>, y: <span style="color:#40a070">0.5</span>)
</span></span><span style="display:flex;"><span>gradientLayer.endPoint = CGPoint(x: <span style="color:#40a070">1.0</span>, y: <span style="color:#40a070">0.5</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这定义了渐变的方向及其起点和终点。</p>
<p><img alt="image-20181128090956756" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxni7yuioaj30bl03j0sr.jpg"></p>
<blockquote>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-81-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-81-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">gradientLayer</span>: CAGradientLayer = {
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">gradientLayer</span> = CAGradientLayer()     
</span></span><span style="display:flex;"><span>        gradientLayer.startPoint = CGPoint(x: <span style="color:#40a070">0.0</span>, y: <span style="color:#40a070">0.5</span>)
</span></span><span style="display:flex;"><span>        gradientLayer.endPoint = CGPoint(x: <span style="color:#40a070">1.0</span>, y: <span style="color:#40a070">0.5</span>)
</span></span><span style="display:flex;"><span>        ...   
</span></span><span style="display:flex;"><span>    }()
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种写法表示定义函数后直接调用，返回值直接给属性。这中写法在其它语言中也比较常见，比如JS。</p>
</blockquote>
<p>继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-82-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-82-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">colors</span> = [
</span></span><span style="display:flex;"><span>    UIColor.black.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.white.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.black.cgColor
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>gradientLayer.colors = colors
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">locations</span>: [NSNumber] = [<span style="color:#40a070">0.25</span>, <span style="color:#40a070">0.5</span>, <span style="color:#40a070">0.75</span>]
</span></span><span style="display:flex;"><span>gradientLayer.locations = locations
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的定义方式和前面学习的<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#12-图层关键帧动画和结构属性">图层关键帧动画</a> 中的<code>values</code>和<code>keyTimes</code>有点类似。</p>
<p>结果就是渐变以黑色开始，中间白色，最后为黑色。通过<code>locations</code>指定这些颜色应该出现在渐变过程中的确切位置。当然也是可以很多个颜色点，和对应位置点的。</p>
<p>上面的效果就类似：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx6k8b06x9j30b403udfp.jpg"></p>
<p>在<code>layoutSubviews()</code>中定义渐变图层的<code>frame</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-83-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-83-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-83-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-83-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>gradientLayer.frame = bounds
</span></span><span style="display:flex;"><span>layer.addSublayer(gradientLayer)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这就把渐变的图层定义在<code>AnimateMaskLabel</code>。</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx6kb2e2fjj308v0fp3yc.jpg"></p>
<h3 id="给渐变图层添加动画">给渐变图层添加动画</h3>
<p>在<code>didMoveToWindow()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-84-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-84-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">gradientAnimation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;locations&#34;</span>)
</span></span><span style="display:flex;"><span>gradientAnimation.fromValue = [<span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.25</span>]
</span></span><span style="display:flex;"><span>gradientAnimation.toValue = [<span style="color:#40a070">0.75</span>, <span style="color:#40a070">1.0</span>, <span style="color:#40a070">1.0</span>]
</span></span><span style="display:flex;"><span>gradientAnimation.duration = <span style="color:#40a070">3.0</span>
</span></span><span style="display:flex;"><span>gradientAnimation.repeatCount = .infinity
</span></span><span style="display:flex;"><span>gradientLayer.add(gradientAnimation, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>repeatCount</code>设置为无穷大，动画持续3秒并将永远重复。效果如下：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx6kjtzpg0g308k08r3za.gif"></p>
<p>上面的效果可能一时不好理解，如果把渐变图层的<code>locations</code>分别设置成<code>[0.0, 0.0, 0.25]</code>和<code>[0.75, 1.0, 1.0]</code>，也就是动画开始点和结束点，情况分别是：</p>
<p><img alt="image-20181128094342790" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fxnj72m40uj3075026dfl.jpg"></p>
<p><img alt="image-20181128094501134" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxnj8fvy5sj307a02edfl.jpg"></p>
<p>动画的效果就是前者的状态到后者的状态，这样就方便理解了。</p>
<p>这看起来很漂亮，但渐变宽度有点小。 只需放大渐变边界，就会得到更温和的渐变。
在<code>layoutSubviews()</code>中找到<code>gradientLayer.frame = bounds</code>行，替代为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-85-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-85-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>gradientLayer.frame = CGRect(x: <span style="color:#666">-</span>bounds.size.width, y: bounds.origin.y, width: <span style="color:#40a070">3</span> <span style="color:#666">*</span> bounds.size.width, height: bounds.size.height)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这会将渐变框设置为可见区域宽度的三倍。 动画进入视图，直接穿过它，并从右侧退出：</p>
<p><img alt="image-20181128100059850" src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxnjp1sk7pj309101gmwz.jpg"></p>
<p>效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxnjl8seo5g308q060aal.gif"></p>
<h3 id="创建文本蒙版">创建文本蒙版</h3>
<p>在<code>AnimateMaskLabel</code>中创造一个文本属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-86-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-86-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">textAttributes</span>: [NSAttributedString.Key: <span style="color:#007020">Any</span>] = {
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">style</span> = NSMutableParagraphStyle()
</span></span><span style="display:flex;"><span>    style.alignment = .center
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> [
</span></span><span style="display:flex;"><span>        NSAttributedString.Key.font: UIFont(name: <span style="color:#4070a0">&#34;HelveticaNeue-Thin&#34;</span>, size: <span style="color:#40a070">28.0</span>)<span style="color:#666">!</span>,
</span></span><span style="display:flex;"><span>        NSAttributedString.Key.paragraphStyle: style
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}()
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，需要将文本渲染为图像。 在<code>text</code>属性的属性观察者中的<code>setNeedsDisplay()</code>之后添加以下代码:</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-87-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-87-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">image</span> = UIGraphicsImageRenderer(size: bounds.size).image { (<span style="color:#007020;font-weight:bold">_</span>) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>        text.draw(<span style="color:#007020;font-weight:bold">in</span>: bounds, withAttributes: textAttributes)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这里，使用图像渲染器来设置上下文。</p>
<p>使用该图像在渐变图层上创建蒙版，在上面代码后继续添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-88-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-88-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">maskLayer</span> = CALayer()
</span></span><span style="display:flex;"><span>maskLayer.backgroundColor = UIColor.clear.cgColor
</span></span><span style="display:flex;"><span>maskLayer.frame = bounds.offsetBy(dx: bounds.size.width, dy: <span style="color:#40a070">0</span>)
</span></span><span style="display:flex;"><span>maskLayer.contents = image.cgImage
</span></span><span style="display:flex;"><span>gradientLayer.mask = maskLayer
</span></span></code></pre></td></tr></table>
</div>
</div><p>现在效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx6l41g457g308k0600t0.gif"></p>
<h3 id="滑动手势">滑动手势</h3>
<p>在<code>viewDidLoad()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-89-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-89-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">swipe</span> = UISwipeGestureRecognizer(target: <span style="color:#007020;font-weight:bold">self</span>, action: <span style="color:#007020;font-weight:bold">#selector</span>(ViewController.didSlide))
</span></span><span style="display:flex;"><span>        swipe.direction = .<span style="color:#007020;font-weight:bold">right</span>
</span></span><span style="display:flex;"><span>        slideView.addGestureRecognizer(swipe)
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx6l9mrd4sg308k0fmaf4.gif"></p>
<h3 id="彩色渐变">彩色渐变</h3>
<p>修改渐变的图层的<code>colors</code>和<code>locations</code>，然之前的黑白变成彩色：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-90-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-90-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">colors</span> = [
</span></span><span style="display:flex;"><span>    UIColor.yellow.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.green.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.orange.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.cyan.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.red.cgColor,
</span></span><span style="display:flex;"><span>    UIColor.yellow.cgColor
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-91-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-91-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">locations</span>: [NSNumber] = [<span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.25</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p>并修改动画的<code>fromValue</code>和<code>toValue</code>：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-92-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-92-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>gradientAnimation.fromValue = [<span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.25</span>]
</span></span><span style="display:flex;"><span>gradientAnimation.toValue = [<span style="color:#40a070">0.65</span>, <span style="color:#40a070">0.8</span>, <span style="color:#40a070">0.85</span>, <span style="color:#40a070">0.9</span>, <span style="color:#40a070">0.95</span>, <span style="color:#40a070">1.0</span>]
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx6lgtu9xhg308k0600ss.gif"></p>
<p>本章的最终效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy6f1w4io8g308o0fpjw8.gif"></p>
<h2 id="15-stroke和路径动画">15-Stroke和路径动画</h2>
<blockquote>
<p><strong>注：</strong> stroke 可翻译成 笔画，但好像又不当恰当，就干脆不翻译😏。</p>
</blockquote>
<p><a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a>  <strong>PullToRefresh</strong></p>
<p><img alt="image-20181214182311997" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy6g4ixk82j309606m0t6.jpg"></p>
<p>有一个TableView，下拉新视图保持可见状态四秒钟，然后缩回。本章就是在这个下拉视图中做一个类似菊花转的动画。</p>
<h3 id="创建交互stroke动画">创建交互stroke动画</h3>
<p>构建动画的第一步是创建一个圆形。 打开<code>RefreshView.swift</code>并将以下代码添加到<code>init(frame:scrollView:)</code>中：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-93-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-93-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 飞机移动路线图层</span>
</span></span><span style="display:flex;"><span>ovalShapeLayer.strokeColor = UIColor.white.cgColor
</span></span><span style="display:flex;"><span>ovalShapeLayer.fillColor = UIColor.clear.cgColor
</span></span><span style="display:flex;"><span>ovalShapeLayer.lineWidth = <span style="color:#40a070">4.0</span>
</span></span><span style="display:flex;"><span>ovalShapeLayer.lineDashPattern = [<span style="color:#40a070">2</span>, <span style="color:#40a070">3</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">refreshRadius</span> = frame.size.height<span style="color:#666">/</span><span style="color:#40a070">2</span> <span style="color:#666">*</span> <span style="color:#40a070">0.8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ovalShapeLayer.path = UIBezierPath(ovalIn: CGRect(x: frame.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span> <span style="color:#666">-</span> refreshRadius, y: frame.size.height<span style="color:#666">/</span><span style="color:#40a070">2</span> <span style="color:#666">-</span> refreshRadius, width: <span style="color:#40a070">2</span> <span style="color:#666">*</span> refreshRadius, height: <span style="color:#40a070">2</span> <span style="color:#666">*</span> refreshRadius)).cgPath
</span></span><span style="display:flex;"><span>layer.addSublayer(ovalShapeLayer)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ovalShapeLayer</code>是一个类型为<code>CAShapeLayer</code>的<code>RefreshView</code>的属性。<code>CAShapeLayer</code>之前已经学过了， 在这里，只需设置笔触和填充颜色，并将圆直径设置为视图高度的80％，这样可确保形成舒适的边距。</p>
<p><code>lineDashPattern</code>属性是设置虚线模式，它是一个数组，其中包含短划线的长度和间隙的长度（以像素为单位），当然还可以设置很多种虚线，详细的可查看<a href="https://developer.apple.com/documentation/quartzcore/cashapelayer/1521921-linedashpattern">官方文档</a>。</p>
<p>在<code>redrawFromProgress()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-94-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-94-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>ovalShapeLayer.strokeEnd = progress
</span></span></code></pre></td></tr></table>
</div>
</div><p>把飞机图片添加到飞机图层中，在<code>init(frame:scrollView:)</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-95-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-95-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 添加飞机</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">airplaneImage</span> = UIImage(named: <span style="color:#4070a0">&#34;airplane.png&#34;</span>)<span style="color:#666">!</span>
</span></span><span style="display:flex;"><span>airplaneLayer.contents = airplaneImage.cgImage
</span></span><span style="display:flex;"><span>airplaneLayer.bounds = CGRect(x: <span style="color:#40a070">0.0</span>, y: <span style="color:#40a070">0.0</span>, width: airplaneImage.size.width, height: airplaneImage.size.height)
</span></span><span style="display:flex;"><span>airplaneLayer.position = CGPoint(x: frame.size.width<span style="color:#666">/</span><span style="color:#40a070">2</span> <span style="color:#666">+</span> frame.size.height<span style="color:#666">/</span><span style="color:#40a070">2</span> <span style="color:#666">*</span> <span style="color:#40a070">0.8</span>, y: frame.size.height<span style="color:#666">/</span><span style="color:#40a070">2</span>)
</span></span><span style="display:flex;"><span>layer.addSublayer(airplaneLayer)
</span></span><span style="display:flex;"><span>airplaneLayer.opacity = <span style="color:#40a070">0.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下拉时逐步更改飞机图层的不透明度，在<code>redrawFromProgress()</code>添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-96-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-96-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>airplaneLayer.opacity = <span style="color:#007020">Float</span>(progress)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="stroke的结尾">stroke的结尾</h3>
<p>在<code>beginRefreshing()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-97-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-97-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">strokeStartAnimation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;strokeStart&#34;</span>)
</span></span><span style="display:flex;"><span>strokeStartAnimation.fromValue = <span style="color:#666">-</span><span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>strokeStartAnimation.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">strokeEndAnimation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;strokeEnd&#34;</span>)
</span></span><span style="display:flex;"><span>strokeEndAnimation.fromValue = <span style="color:#40a070">0.0</span>
</span></span><span style="display:flex;"><span>strokeEndAnimation.toValue = <span style="color:#40a070">1.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>beginRefreshing()</code>的末尾添加以下代码以同时运行两个动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-98-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-98-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">strokeAnimationGroup</span> = CAAnimationGroup()
</span></span><span style="display:flex;"><span>strokeAnimationGroup.duration = <span style="color:#40a070">1.5</span>
</span></span><span style="display:flex;"><span>strokeAnimationGroup.repeatDuration = <span style="color:#40a070">5.0</span>
</span></span><span style="display:flex;"><span>strokeAnimationGroup.animations = [strokeEndAnimation, strokeEndAnimation]
</span></span><span style="display:flex;"><span>ovalShapeLayer.add(strokeAnimationGroup, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的代码中，创建一个动画组并重复动画五次。 这应该足够长，以便在刷新视图可见时保持动画运行。 然后，将两个动画添加到组中，并将组添加到加载层。</p>
<p>运行效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx7ioqqx88g308q08rjw3.gif"></p>
<h3 id="创建path关键帧动画">创建path关键帧动画</h3>
<p>在<a href="/blog/2018/12/ios-animation-3-layer-animations.html/#12-图层关键帧动画和结构属性">12-图层关键帧动画和结构属性</a> 学习了使用<code>values</code>属性来设置关键帧动画。下面学习另一种方式使用关键帧动画。</p>
<p>在<code>beginRefreshing()</code>的末尾添加飞机动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-99-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-99-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 飞机动画</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flightAnimation</span> = CAKeyframeAnimation(keyPath: <span style="color:#4070a0">&#34;position&#34;</span>)
</span></span><span style="display:flex;"><span>flightAnimation.path = ovalShapeLayer.path
</span></span><span style="display:flex;"><span>flightAnimation.calculationMode = CAAnimationCalculationMode.paced
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">flightAnimationGroup</span> = CAAnimationGroup()
</span></span><span style="display:flex;"><span>flightAnimationGroup.duration = <span style="color:#40a070">1.5</span>
</span></span><span style="display:flex;"><span>flightAnimationGroup.repeatDuration = <span style="color:#40a070">5.0</span>
</span></span><span style="display:flex;"><span>flightAnimationGroup.animations = [flightAnimation]
</span></span><span style="display:flex;"><span>airplaneLayer.add(flightAnimationGroup, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>CAAnimationCalculationMode.paced</code>是另一种控制动画时间的方法，这时核心动画会以恒定的速度设置动画，忽略设置的任何<code>keyTimes</code>，这对于在任意路径上生成平滑动画非常有用。</p>
<p><code>CAAnimationCalculationMode</code>还有其他几种模式，详细可查看<a href="https://developer.apple.com/documentation/quartzcore/caanimationcalculationmode?language=objc">官方文档</a>。</p>
<p>运行效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fx7ixtawarg308q08r0y7.gif"></p>
<p>这比较奇怪了，✈️移动时，角度也有相应的变化。</p>
<p>在创建<code>flightAnimationGrou</code>p的行上方插入以下新动画代码，来调整飞机移动时角度</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-100-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-100-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">airplaneOrientationAnimation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.rotation&#34;</span>)
</span></span><span style="display:flex;"><span>airplaneOrientationAnimation.fromValue = <span style="color:#40a070">0</span>
</span></span><span style="display:flex;"><span>airplaneOrientationAnimation.toValue = <span style="color:#40a070">2.0</span> <span style="color:#666">*</span> .pi
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终效果</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx7j42np9ig308q08r0w0.gif"></p>
<h2 id="16-复制动画">16-复制动画</h2>
<p>本章节学习<strong>复制动画(Replicating Animations)</strong>。</p>
<p><code>CAReplicatorLayer</code>是<code>CALayer</code>的另一个子类。它意思很简单，当创建了一些内容 —— 可以是一个形状，一个图像或任何可以用图层绘制的东西 —— 而<code>CAReplicatorLayer</code>可以在屏幕上复制它，如下所示：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fx7m9wkg4dj30bb05g74a.jpg"></p>
<p><strong>为什么需要复制形状或图像？</strong></p>
<p><code>CAReplicatorLayer</code>的超级强大之处，在于可以让每个复制体与母体略有不同。
例如，可以逐步更改每个副本的颜色。 原始图层可能是洋红色，而在创建每个副本时，将颜色向青色方向改变：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx7maaq340j30a2043a9u.jpg"></p>
<p>此外，还可以在副本之间应用转换(transform)。 例如，可以在每个副本之间应用简单的旋转转换，将它们绘制成圆形，如下所示：</p>
<p><img alt="image-20181114152157889" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fx7maqjd0yj309i050weq.jpg"></p>
<p>但最好的功能是每个副本都能够设置动画延迟。 当原始内容的<code>instanceDelay</code>设置0.2秒时，第一个副本将延迟0.2秒执行动画，第二个副本将延迟0.4秒执行动画，第三个副本将延迟0.6秒执行动画，依此类推。</p>
<p>可以使用这种方式来创建引人入胜且复杂的动画。</p>
<p>在本章中，将创建一个模仿Siri，听到声音后，根据声音而产生波浪状的动画。这个<a href="http://andyron.com/2018/iOS-Animation-0#%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81">开始项目</a> 命名为<strong>Iris</strong>。</p>
<p>这个项目将创建两个不同的复制。 首先，是在Iris会话时播放的视觉反馈动画，它看起来很像一个迷幻的正弦波：</p>
<p><img alt="image-20181214235839247" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy6ptjrw7dj307m03yjrl.jpg"></p>
<p>然后是一个交互式麦克风驱动的音频波，当用户说话时，它将提供视觉反馈：</p>
<p><img alt="image-20181214235912038" src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy6pu3z3g5j3097035mxq.jpg"></p>
<p>这两个动画覆盖了<code>CAReplicatorLayer</code>的大部分功能。</p>
<h3 id="replicating-like-rabbits">Replicating like rabbits</h3>
<h4 id="开始项目概述">开始项目概述</h4>
<p>打开<code>Main.storyboard</code>：</p>
<p><img alt="image-20181215000456402" src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy6q02u7wgj307208x3ye.jpg"></p>
<p>只有一个视图控制器，它具有一个按钮和一个标签。 用户在按下按钮时询问问题; 当他们释放按钮时，Iris会做出回应。 标签用来显示麦克风输入和Iris的答案。</p>
<p>在<code>ViewController.swift</code>中，按钮事件已连接到操作。当用户触摸按钮时，<code>actionStartMonitoring()</code>会触发；当用户抬起手指时，<code>actionEndMonitoring()</code>会触发。</p>
<p>另外还有两个超出本章范围的类：</p>
<p><code>Assistant</code>：人工智能助理。它预定义的有趣答案列表，并根据用户的问题说出来。
<code>MicMonitor</code>：监控iPhone麦克风上的输入，并反复调用您提供的闭包表达式。这是您有机会更新显示的地方。</p>
<p>下面开始！</p>
<h4 id="设置复制器层">设置复制器层</h4>
<p>打开<code>ViewController.swift</code>并添加以下两个属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-101-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-101-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-101-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-101-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">replicator</span> = CAReplicatorLayer()
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">dot</span> = CALayer()
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>dot</code>使用<code>CALayer</code>，用来绘制基本的简单形状。<code>replicator</code>作为复制器，用来之后复制<code>dot</code>。</p>
<p>下面添加一些常量 属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-102-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-102-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">dotLength</span>: CGFloat = <span style="color:#40a070">6.0</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">dotOffset</span>: CGFloat = <span style="color:#40a070">8.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>doLength</code>用作点图层的宽度和高度，<code>dotOffset</code>是每个点复制体之间的偏移量。</p>
<p>将复制器层添加到视图控制器的视图中，在<code>viewDidLoad()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-103-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-103-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-103-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-103-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>replicator.frame = view.bounds
</span></span><span style="display:flex;"><span>view.layer.addSublayer(replicator)
</span></span></code></pre></td></tr></table>
</div>
</div><p>下一步是设置点图层。 在<code>viewDidLoad()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-104-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-104-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>dot.frame = CGRect(x: replicator.frame.size.width <span style="color:#666">-</span> dotLength, y: replicator.position.y, width: dotLength, height: dotLength)
</span></span><span style="display:flex;"><span>dot.backgroundColor = UIColor.lightGray.cgColor
</span></span><span style="display:flex;"><span>dot.borderColor = UIColor(white: <span style="color:#40a070">1.0</span>, alpha: <span style="color:#40a070">1.0</span>).cgColor
</span></span><span style="display:flex;"><span>dot.borderWidth = <span style="color:#40a070">0.5</span>
</span></span><span style="display:flex;"><span>dot.cornerRadius = <span style="color:#40a070">1.5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>replicator.addSublayer(dot)
</span></span></code></pre></td></tr></table>
</div>
</div><p>先将点图层定位到复制器的右边缘，然后设置图层的背景颜色并添加边框等，最后将点图层加入复制器图层。运行结果：</p>
<p><img alt="image-20181215113735985" src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7a0ux659j308k04vt8m.jpg"></p>
<p>在继续下面之前，先介绍<code>CAReplicatorLayer</code>的三个属性：
<code>instanceCount</code>： 副本数
<code>instanceTransform</code>： 副本之间的转换
<code>instanceDelay</code>： 副本之间的动画延迟</p>
<p>在<code>viewDidLoad()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-105-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-105-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>replicator.instanceCount = <span style="color:#007020">Int</span>(view.frame.size.width <span style="color:#666">/</span> dotOffset)
</span></span><span style="display:flex;"><span>replicator.instanceTransform = CATransform3DMakeTranslation(<span style="color:#666">-</span>dotOffset, <span style="color:#40a070">0.0</span>, <span style="color:#40a070">0.0</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>屏幕宽度除以偏移量，根据不同屏幕宽度设置副本数。比如5.5英寸（宽度为414）的<code>instanceCount</code>是51，4.7英寸是46 。。。</p>
<p>每个副本向左（<code>-dotOffset</code>）移动8 。结果为：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy7n1s0gotj30a302ba9w.jpg"></p>
<h4 id="测试复制动画">测试复制动画</h4>
<p>添加一个小测试动画，来了解<code>instanceDelay</code>的作用。 在<code>viewDidLoad()</code>的末尾添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-106-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-106-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">move</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;position.y&#34;</span>)
</span></span><span style="display:flex;"><span>move.fromValue = dot.position.y
</span></span><span style="display:flex;"><span>move.toValue = dot.position.y <span style="color:#666">-</span> <span style="color:#40a070">50.0</span>
</span></span><span style="display:flex;"><span>move.duration = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>move.repeatCount = <span style="color:#40a070">10</span>
</span></span><span style="display:flex;"><span>dot.add(move, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个动画很简单，只是把点向上重复移动10次。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy7ao51phfg308q06074k.gif"></p>
<p>在上面代码的的末尾添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-107-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-107-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>replicator.instanceDelay = <span style="color:#40a070">0.02</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy7asendwmg308q060wfu.gif"></p>
<p>在继续之前，需要删除上面的测试动画，除了<code>instanceDelay</code>。</p>
<h3 id="复制多个动画">复制多个动画</h3>
<p>在本节中，您将学习在Iris讲话时播放的动画。 为此，您将结合使用具有不同延迟的多个简单动画来产生最终效果。</p>
<h4 id="缩放动画">缩放动画</h4>
<p>首先，在<code>startSpeaking()</code>中添加以下动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-108-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-108-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scale</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform&#34;</span>)
</span></span><span style="display:flex;"><span>scale.fromValue = NSValue(caTransform3D: CATransform3DIdentity)
</span></span><span style="display:flex;"><span>scale.toValue = NSValue(caTransform3D: CATransform3DMakeScale(<span style="color:#40a070">1.4</span>, <span style="color:#40a070">15</span>, <span style="color:#40a070">1.0</span>))
</span></span><span style="display:flex;"><span>scale.duration = <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>scale.repeatCount = .infinity
</span></span><span style="display:flex;"><span>scale.autoreverses = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>scale.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseOut)
</span></span><span style="display:flex;"><span>dot.add(scale, forKey: <span style="color:#4070a0">&#34;dotScale&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是一个简单的层动画，重点在<code>CATransform3DMakeScale</code>的几个参数选择。此处将点图层在垂直方向缩放15倍。</p>
<p>运行，并点击灰色按钮，分别先后调用<code>actionStartMonitoring</code>，<code>actionEndMonitoring()</code>，最后调用<code>startSpeaking()</code>，效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fx7p9fze8bg308o0cxgqy.gif"></p>
<p>可以尝试修改<code>CATransform3DMakeScale</code>的几个参数和<code>duration</code>来看看有什么不同效果。</p>
<h4 id="透明动画">透明动画</h4>
<p>在<code>startSpeaking()</code>添加淡出动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-109-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-109-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">fade</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;opacity&#34;</span>)
</span></span><span style="display:flex;"><span>fade.fromValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>fade.toValue = <span style="color:#40a070">0.2</span>
</span></span><span style="display:flex;"><span>fade.duration = <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>fade.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>fade.repeatCount = .infinity
</span></span><span style="display:flex;"><span>fade.autoreverses = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>fade.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseOut)
</span></span><span style="display:flex;"><span>dot.add(fade, forKey: <span style="color:#4070a0">&#34;dotOpacity&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>与缩放动画的持续时间相同，但延迟0.33秒，透明度从1.0到0.2，当“波浪”充分移动后，开始淡出效果。</p>
<p>当两个动画同时运行时，效果会更好一点：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy7c4qtgvyg308p03sq8m.gif"></p>
<h4 id="色彩动画">色彩动画</h4>
<p>设置点背景颜色变化动画，在<code>startSpeaking()</code>添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-110-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-110-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tint</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;backgroundColor&#34;</span>)
</span></span><span style="display:flex;"><span>tint.fromValue = UIColor.magenta.cgColor
</span></span><span style="display:flex;"><span>tint.toValue = UIColor.cyan.cgColor
</span></span><span style="display:flex;"><span>tint.duration = <span style="color:#40a070">0.66</span>
</span></span><span style="display:flex;"><span>tint.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.28</span>
</span></span><span style="display:flex;"><span>tint.fillMode = kCAFillModeBackwards
</span></span><span style="display:flex;"><span>tint.repeatCount = .infinity
</span></span><span style="display:flex;"><span>tint.autoreverses = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>tint.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseOut)
</span></span><span style="display:flex;"><span>dot.add(tint, forKey: <span style="color:#4070a0">&#34;dotColor&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>三种动画的效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7ce44tclg308p03pn29.gif"></p>
<h3 id="careplicatorlayer的属性">CAReplicatorLayer的属性</h3>
<p>前面已经通过复制器层制作了很多令人眼花缭乱的效果。 由于<code>CAReplicatorLayer</code>本身就是一个图层，因此也可以为其自身的一些属性设置动画。</p>
<p>可以为<code>CAReplicatorLayer</code>的基本属性（如<code>position</code>，<code>backgroundColor</code>或<code>cornerRadius</code>）设置动画，也可以通过其特殊的属性设置非常酷的动画。</p>
<p><code>CAReplicatorLayer</code>特有的可动画属性包括(前面已经介绍过三个)：</p>
<p><code>instanceDelay</code>：  副本之间的动画延迟
<code>instanceTransform</code>：副本之间的转换
<code>instanceColor</code>： 颜色
<code>instanceRedOffset</code>，<code>instanceGreenOffset</code>，<code>instanceBlueOffset</code>：应用增量以应用于每个实例颜色组件
<code>instanceAlphaOffset</code>： 透明度增量</p>
<p>在<code>startSpeaking()</code>的末尾添加一个动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-111-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-111-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">initialRotation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;instanceTransform.rotation&#34;</span>)
</span></span><span style="display:flex;"><span>initialRotation.fromValue = <span style="color:#40a070">0.0</span>
</span></span><span style="display:flex;"><span>initialRotation.toValue = <span style="color:#40a070">0.01</span>
</span></span><span style="display:flex;"><span>initialRotation.duration = <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>initialRotation.isRemovedOnCompletion = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>initialRotation.fillMode = kCAFillModeForwards
</span></span><span style="display:flex;"><span>initialRotation.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseOut)
</span></span><span style="display:flex;"><span>replicator.add(initialRotation, forKey: <span style="color:#4070a0">&#34;initialRotation&#34;</span>)     
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面只是有一个微小的旋转，效果：</p>
<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fy7cvzuc3pg308q03oagg.gif"></p>
<p>再需要一个上下扭动的效果，添加下面的动画以完成效果：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-7">7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-8">8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-112-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-112-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">rotation</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;instanceTransform.rotation&#34;</span>)
</span></span><span style="display:flex;"><span>rotation.fromValue = <span style="color:#40a070">0.01</span>
</span></span><span style="display:flex;"><span>rotation.toValue   = <span style="color:#666">-</span><span style="color:#40a070">0.01</span>
</span></span><span style="display:flex;"><span>rotation.duration = <span style="color:#40a070">0.99</span>
</span></span><span style="display:flex;"><span>rotation.beginTime = CACurrentMediaTime() <span style="color:#666">+</span> <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>rotation.repeatCount = .infinity
</span></span><span style="display:flex;"><span>rotation.autoreverses = <span style="color:#007020;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>rotation.timingFunction = CAMediaTimingFunction(name: kCAMediaTimingFunctionEaseInEaseOut)
</span></span><span style="display:flex;"><span>replicator.add(rotation, forKey: <span style="color:#4070a0">&#34;replicatorRotation&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是在<code>instanceTransform.rotation</code>上运行第二个动画，它在之前第一个动画完成后启动。将旋转从0.01弧度（第一个动画的最终值）设置到-0.01弧度，这就有了扭到的效果（不同方向的旋转）。
效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy7d9umm1tg308q03p486.gif"></p>
<p>下面模拟语音助手，假装回单。<code>startSpeaking()</code>的开始处添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-113-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-113-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-113-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-113-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-113-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-113-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>meterLabel.text = assistant.randomAnswer()
</span></span><span style="display:flex;"><span>assistant.speak(meterLabel.text!, completion: endSpeaking)
</span></span><span style="display:flex;"><span>speakButton.isHidden = <span style="color:#007020;font-weight:bold">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从<code>Assistant</code>类中随机获得一个答案，然后在<code>meterLabel</code>上显示，并且读处答案，读完后调用<code>endSpeaking</code>方法。这是过程中按钮需要隐藏。</p>
<p>之后，需要删除所有正在运行的动画，在<code>endSpeaking()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-114-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-114-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>replicator.removeAllAnimations()
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来，需要将点图层“优雅”地设置为原始比例的动画， 在<code>endSpeaking()</code>继续中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-115-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-115-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scale</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform&#34;</span>)
</span></span><span style="display:flex;"><span>scale.toValue = NSValue(caTransform3D: CATransform3DIdentity)
</span></span><span style="display:flex;"><span>scale.duration = <span style="color:#40a070">0.33</span>
</span></span><span style="display:flex;"><span>scale.isRemovedOnCompletion = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>scale.fillMode = kCAFillModeForwards
</span></span><span style="display:flex;"><span>dot.add(scale, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的动画，没有指定<code>fromValue</code> ，会从当前值开始动画，变换为<code>CATransform3DIdentiy</code>。</p>
<p>最后，删除<code>dot</code>中当前正在运行的其余动画，并恢复说话按钮状态。 在<code>endSpeaking()</code>继续中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-116-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-116-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-116-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-116-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-116-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-116-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-116-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-116-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>dot.removeAnimation(forKey: <span style="color:#4070a0">&#34;dotColor&#34;</span>)
</span></span><span style="display:flex;"><span>dot.removeAnimation(forKey: <span style="color:#4070a0">&#34;dotOpacity&#34;</span>)
</span></span><span style="display:flex;"><span>dot.backgroundColor = UIColor.lightGray.cgColor
</span></span><span style="display:flex;"><span>speakButton.isHidden = <span style="color:#007020;font-weight:bold">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>本节的效果：</p>
<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fy7e4a4sfvg308q07oar3.gif"></p>
<h3 id="交互式复制动画">交互式复制动画</h3>
<p>前面这有Iris回答时，才会有对应波动动画。这一节要做的是，当用户按住按钮说话（问问题）时也就对应波动动画。</p>
<p>在<code>actionStartMonitoring()</code>中添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-117-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-117-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    dot.backgroundColor = UIColor.green.cgColor
</span></span><span style="display:flex;"><span>    monitor.startMonitoringWithHandler { (level) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.meterLabel.text = <span style="color:#007020">String</span>(format: <span style="color:#4070a0">&#34;%.2f db&#34;</span>, level)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>当用户按下说话按钮时，触发<code>actionStartMonitoring</code>。为了表示“正在收听”，将点图层颜色更改为绿色。</p>
<p>然后在监视器实例上调用<code>startMonitoringWithHandler()</code>，它的参数是一个闭包块，会被重复执行，获取麦克风分贝数(db)。</p>
<p>这边的分贝数和我们平常见到分贝数范围有点不同， 它的值在-160.0 db到0.0 db的范围内，-160.0 db是最安静的，0.0 db意味着非常大的声音。</p>
<p>向上面的闭包中添加一段代码，添加完如下：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-118-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-118-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>    monitor.startMonitoringWithHandler { (level) <span style="color:#007020;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">self</span>.meterLabel.text = <span style="color:#007020">String</span>(format: <span style="color:#4070a0">&#34;%.2f db&#34;</span>, level)
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scaleFactor</span> = max(<span style="color:#40a070">0.2</span>, CGFloat(level) <span style="color:#666">+</span> <span style="color:#40a070">50</span>) <span style="color:#666">/</span> <span style="color:#40a070">2</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>scaleFactor</code>将存储介于0.1和25.0之间的值。</p>
<p>在<code>ViewController</code>新加一个属性：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-119-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-119-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">var</span> <span style="color:#bb60d5">lastTransformScale</span>: CGFloat = <span style="color:#40a070">0.0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于缩放动画，比例不断变化的，<code>lastTransformScale</code>保存最后一个缩放值。</p>
<p>在上面的麦克风处理闭包中添加用户声音动画：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-2">2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-3">3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-4">4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-5">5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-6">6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-120-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-120-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scale</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.scale.y&#34;</span>)
</span></span><span style="display:flex;"><span>scale.fromValue = <span style="color:#007020;font-weight:bold">self</span>.lastTransformScale
</span></span><span style="display:flex;"><span>scale.toValue = scaleFactor
</span></span><span style="display:flex;"><span>scale.duration = <span style="color:#40a070">0.1</span>
</span></span><span style="display:flex;"><span>scale.isRemovedOnCompletion = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>scale.fillMode = kCAFillModeForwards
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.dot.add(scale, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后，保存<code>lastTransformScale</code>，接着上面的代码添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-121-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-121-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">self</span>.lastTransformScale = scaleFactor
</span></span></code></pre></td></tr></table>
</div>
</div><p>当用户手指离开按钮时，需要重置动画并停止监听麦克风。 在<code>actionEndMonitoring()</code>开始处添加：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-1">1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-122-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-122-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>monitor.stopMonitoring()
</span></span><span style="display:flex;"><span>dot.removeAllAnimations()
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个时候，效果：</p>
<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fy7m6qgguag308o0881gt.gif"></p>
<h4 id="平滑麦克风输入和iris动画之间的过渡">平滑麦克风输入和Iris动画之间的过渡</h4>
<p>仔细之前的效果，我发现用户麦克风输入动画和Iris动画之间是没有过渡，是直接跳过。这是<code>actionEndMonitoring()</code>中的<code>dot.removeAllAnimations()</code>造成的。</p>
<p>把<code>dot.removeAllAnimations()</code>替代为：</p>
<div class="highlight"><div style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-1"> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-2"> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-3"> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-4"> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-5"> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-6"> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-7"> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-8"> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-9"> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-10">10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-11">11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-12">12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-13">13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-14">14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-15">15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-16">16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f" id="hl-123-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-123-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">// 麦克风输入和Iris动画之间的过渡</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">scale</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;transform.scale.y&#34;</span>)
</span></span><span style="display:flex;"><span>scale.fromValue = lastTransformScale
</span></span><span style="display:flex;"><span>scale.toValue = <span style="color:#40a070">1.0</span>
</span></span><span style="display:flex;"><span>scale.duration = <span style="color:#40a070">0.2</span>
</span></span><span style="display:flex;"><span>scale.isRemovedOnCompletion = <span style="color:#007020;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>scale.fillMode = kCAFillModeForwards
</span></span><span style="display:flex;"><span>dot.add(scale, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dot.backgroundColor = UIColor.magenta.cgColor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">let</span> <span style="color:#bb60d5">tint</span> = CABasicAnimation(keyPath: <span style="color:#4070a0">&#34;backgroundColor&#34;</span>)
</span></span><span style="display:flex;"><span>tint.fromValue = UIColor.green.cgColor
</span></span><span style="display:flex;"><span>tint.toValue = UIColor.magenta.cgColor
</span></span><span style="display:flex;"><span>tint.duration = <span style="color:#40a070">1.2</span>
</span></span><span style="display:flex;"><span>tint.fillMode = kCAFillModeBackwards
</span></span><span style="display:flex;"><span>dot.add(tint, forKey: <span style="color:#007020;font-weight:bold">nil</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>本章最后的效果：</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fy7mgff62bg308o0811bi.gif"></p>

        </div>

        
        
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">andyron</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2024-07-16
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>



        
        
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    
  </div>
</div>


        <footer class="post-footer">
          <div class="post-tags">
              <a href="http://localhost:1313/tags/ios%E5%8A%A8%E7%94%BB/">iOS动画</a>
                <a href="http://localhost:1313/tags/%E5%9B%BE%E5%B1%82%E5%8A%A8%E7%94%BB/">图层动画</a>
                <a href="http://localhost:1313/tags/layer-animations/">Layer Animations</a>
                <a href="http://localhost:1313/tags/%E6%A0%B8%E5%BF%83%E5%8A%A8%E7%94%BB/">核心动画</a>
                
            </div>


          
          <nav class="post-nav">
            
              <a class="prev" href="/blog/2018/12/ios-animation-4-view-controller-transition-animations.html/">
                
                <i class="iconfont">
                  <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

                </i>
                <span class="prev-text nav-default">系统学习iOS动画之四：视图控制器的转场动画</span>
                <span class="prev-text nav-mobile">上一篇</span>
              </a>
            
              <a class="next" href="/blog/2018/12/ios-animation-2-auto-layout.html/">
                <span class="next-text nav-default">系统学习iOS动画之二：自动布局</span>
                <span class="prev-text nav-mobile">下一篇</span>
                
                <i class="iconfont">
                  <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

                </i>
              </a>
          </nav>
        </footer>
      </article>

      
      


      
      

  

  
  
    <div class="post">
  <script
    src="https://giscus.app/client.js"
    data-repo="xianmin/comments---xianmin.org"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxNDAyNTY2MDI="
    data-category="Announcements"
    data-category-id="DIC_kwDOCFwlWs4CRRxW"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    
    crossorigin="anonymous"
    async
  ></script>
</div>

  

  
  

  

  

    

  

  


    </div>

    
    <nav class="toc" id="toc">
    <div class="toc-title">文章目录</div>
    <div class="toc-content custom-scrollbar">
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#8-图层动画入门">8-图层动画入门</a>
          <ul>
            <li><a href="#可动画属性">可动画属性</a>
              <ul>
                <li><a href="#位置-和-大小">位置 和 大小</a></li>
                <li><a href="#边">边</a></li>
                <li><a href="#阴影">阴影</a></li>
                <li><a href="#内容">内容</a></li>
              </ul>
            </li>
            <li><a href="#第一个图层动画">第一个图层动画</a></li>
            <li><a href="#更多图层动画知识">更多图层动画知识</a>
              <ul>
                <li><a href="#关于-fillmode">关于 <code>fillMode</code></a></li>
              </ul>
            </li>
            <li><a href="#动画-vs-真实内容">动画 vs 真实内容</a>
              <ul>
                <li><a href="#更新图层模型">更新图层模型</a></li>
              </ul>
            </li>
            <li><a href="#使用图层动画实现的淡入">使用图层动画实现☁️的淡入</a></li>
            <li><a href="#登录按钮背景颜色变化的动画">登录按钮背景颜色变化的动画</a></li>
            <li><a href="#登录按钮的圆角动画">登录按钮的圆角动画</a></li>
          </ul>
        </li>
        <li><a href="#9-动画的keys和代理">9-动画的Keys和代理</a>
          <ul>
            <li><a href="#动画代理介绍">动画代理介绍</a></li>
            <li><a href="#kvo">KVO</a></li>
            <li><a href="#动画keys">动画Keys</a></li>
            <li><a href="#修改的动画">修改☁️的动画</a></li>
          </ul>
        </li>
        <li><a href="#10-动画组和时间控制">10-动画组和时间控制</a>
          <ul>
            <li><a href="#caanimationgroup">CAAnimationGroup</a></li>
            <li><a href="#动画缓动">动画缓动</a></li>
            <li><a href="#更多动画时间控制的选项">更多动画时间控制的选项</a>
              <ul>
                <li><a href="#重复动画">重复动画</a></li>
                <li><a href="#改变动画的速度">改变动画的速度</a></li>
              </ul>
            </li>
            <li><a href="#把三个form的动画修改为动画组">把三个form的动画修改为动画组</a></li>
          </ul>
        </li>
        <li><a href="#11-图层弹簧动画">11-图层弹簧动画</a>
          <ul>
            <li><a href="#阻尼谐振子">阻尼谐振子</a></li>
            <li><a href="#视图弹簧动画-vs-图层弹簧动画">视图弹簧动画 vs 图层弹簧动画</a></li>
            <li><a href="#第一个图层弹簧动画">第一个图层弹簧动画</a></li>
            <li><a href="#弹簧动画属性">弹簧动画属性</a>
              <ul>
                <li><a href="#initialvelocity"><code>initialVelocity</code></a></li>
                <li><a href="#mass"><code>mass</code></a></li>
                <li><a href="#stiffness"><code>stiffness</code></a></li>
                <li><a href="#damping"><code>damping</code></a></li>
              </ul>
            </li>
            <li><a href="#特殊图层属性">特殊图层属性</a></li>
            <li><a href="#把登录按钮的圆角和背景色变化动画转化为弹性动画">把登录按钮的圆角和背景色变化动画转化为弹性动画</a></li>
          </ul>
        </li>
        <li><a href="#12-图层关键帧动画和结构属性">12-图层关键帧动画和结构属性</a>
          <ul>
            <li><a href="#介绍图层关键帧动画">介绍图层关键帧动画</a></li>
            <li><a href="#创建图层关键帧动画">创建图层关键帧动画</a></li>
            <li><a href="#animating-struct-values">Animating struct values</a></li>
            <li><a href="#热气球的关键帧动画">热气球的关键帧动画</a></li>
          </ul>
        </li>
        <li><a href="#13-形状和蒙版">13-形状和蒙版</a>
          <ul>
            <li><a href="#头像视图">头像视图</a></li>
            <li><a href="#反弹动画">反弹动画</a></li>
            <li><a href="#图像变形">图像变形</a></li>
            <li><a href="#搜索对手">搜索对手</a></li>
            <li><a href="#连接成功后头像变成正方形">连接成功后头像变成正方形</a></li>
          </ul>
        </li>
        <li><a href="#14-渐变动画">14-渐变动画</a>
          <ul>
            <li><a href="#第一个渐变图层">第一个渐变图层</a></li>
            <li><a href="#给渐变图层添加动画">给渐变图层添加动画</a></li>
            <li><a href="#创建文本蒙版">创建文本蒙版</a></li>
            <li><a href="#滑动手势">滑动手势</a></li>
            <li><a href="#彩色渐变">彩色渐变</a></li>
          </ul>
        </li>
        <li><a href="#15-stroke和路径动画">15-Stroke和路径动画</a>
          <ul>
            <li><a href="#创建交互stroke动画">创建交互stroke动画</a></li>
            <li><a href="#stroke的结尾">stroke的结尾</a></li>
            <li><a href="#创建path关键帧动画">创建path关键帧动画</a></li>
          </ul>
        </li>
        <li><a href="#16-复制动画">16-复制动画</a>
          <ul>
            <li><a href="#replicating-like-rabbits">Replicating like rabbits</a>
              <ul>
                <li><a href="#开始项目概述">开始项目概述</a></li>
                <li><a href="#设置复制器层">设置复制器层</a></li>
                <li><a href="#测试复制动画">测试复制动画</a></li>
              </ul>
            </li>
            <li><a href="#复制多个动画">复制多个动画</a>
              <ul>
                <li><a href="#缩放动画">缩放动画</a></li>
                <li><a href="#透明动画">透明动画</a></li>
                <li><a href="#色彩动画">色彩动画</a></li>
              </ul>
            </li>
            <li><a href="#careplicatorlayer的属性">CAReplicatorLayer的属性</a></li>
            <li><a href="#交互式复制动画">交互式复制动画</a>
              <ul>
                <li><a href="#平滑麦克风输入和iris动画之间的过渡">平滑麦克风输入和Iris动画之间的过渡</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
  </nav>


  </div>

      </main>

      <footer id="footer" class="footer">
        <div class="icon-links">
  
  
    <a href="mailto:rongming.2008@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/3133839/andyron" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://github.com/andyron" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://localhost:1313/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2025
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        andyron
        
      </span></span>

  
  

  
</div>

      </footer>

      <div class="button__back-to-top">
        <a href="#back-to-top">
          <i class="iconfont">
            
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

          </i>
        </a>
      </div>
    </div>
    
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.25d4b4ffb2db9a42760854fb017fe0cbe4413e299a94b43b52a058abedbf5ace.js" integrity="sha256-JdS0/7LbmkJ2CFT7AX/gy&#43;RBPimalLQ7UqBYq&#43;2/Ws4=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>




  <script src="/js/custom.js"></script>


  </body>
</html>
